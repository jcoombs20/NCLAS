<!DOCTYPE html>
<html>
  <head>
    <title>CLAS: Critical Loads Assessment by Site</title>
    <link rel="icon" type="image/png" href="images/tree_icon.png">

    <!--link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/-->
    <link rel="stylesheet" href="styles/bootstrap.min.css"/>
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/introjs.min.css"/-->
    <link rel="stylesheet" href="introjs.min.css"/>
    <!--link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/-->
    <link rel="stylesheet" href="leaflet.css"/>
    <!--link rel="stylesheet" href="leaflet_1.2/leaflet.css" /-->
    <!--link rel="stylesheet" href="http://colorbrewer2.org/export/colorbrewer.css"/-->
    <link rel="stylesheet" href="styles/jquery-ui.min.css"/>
    <link rel="stylesheet" href="colorbrewer.css"/>
    <link rel="stylesheet" href="styles/font-awesome-4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="styles/Control.BingGeocoder.css"/>
    <link rel="stylesheet" href="styles/Control.maxExtent.css"/>
    <link rel="stylesheet" href="styles/Control.mousePosition.css"/>
    <link rel="stylesheet" href="styles/Control.downLoadFile.css"/>
    <link rel="stylesheet" href="styles/Control.print.css"/>
    <link rel="stylesheet" href="styles/app.css"/>
    <link rel="stylesheet" href="styles/NCLAS.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!--script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script-->
    <script src="leaflet.js"></script>
    <!--script src="leaflet_1.2/leaflet.js"></script-->
    <!--script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script-->
    <script src="google.charts.js"></script>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script-->
    <script src="jquery-3.2.1.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="jquery-ui-touch-punch.0.0.3.min.js"></script>
    <!--script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script-->
    <script src="bootstrap.min.js"></script>
    <!--script src="https://maps.google.com/maps/api/js?v=3"></script-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk-pRMxjeu0G6yIfxqnZMPQE5LgLLB6P8"></script>
    <!--script src="bundle.js"></script-->
    <script src="Bing_tile.js"></script>
    <script src="Control.BingGeocoder.js"></script>
    <script src="Control.maxExtent.js"></script>
    <script src="Control.mousePosition.js"></script>
    <script src="Control.downLoadFile.js"></script>
    <script src="Control.print.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/intro.min.js"></script-->
    <script type="text/javascript" src="intro.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js"></script>


    <script src="https://nclas.ecosheds.org/socket.io/socket.io.js"></script>
    <script src="socket_emit.js"></script>
    <!--script src="http://d3js.org/d3.v3.min.js"></script-->
    <script src="d3.v3.min.js"></script>
    <!--script src="http://d3js.org/topojson.v1.min.js"></script-->
    <script src="topojson.v1.min.js"></script>
    <!--script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script-->
    <script src="d3-color.v3.min.js"></script>
    <!--script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script-->
    <script src="d3-interpolate.v3.min.js"></script>
    <!--script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script-->
    <script src="d3-scale-chromatic.v3.min.js"></script>
    <!--script src="http://colorbrewer2.org/export/colorbrewer.js"></script-->
    <script src="colorbrewer.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script-->
    <script src="queue.min.js"></script>
    <script src="crossfilter.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-150914675-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-150914675-1');
    </script>

  </head>

  <body>
    <nav id="mainMenu" class="navbar navbar-inverse">
      <div class="container-fluid">
        <ul class="nav navbar-nav" id="navMenu">
          <li id="home" title="Click to return to the main page" class="active"><a href="#">Home</a></li>
          <!--li id="basics" title="Click to see how to begin using CLAS"><a href="#">Overview</a></li-->
          <li id="approach" title="Click to view details about how CLAS functions"><a href="#">About CLAS</a></li>
          <li id="guide" title="Click to view information on how to use CLAS"><a href="#">Users Guide</a></li>
          <!--li id="tutorial" title="Click to view tutorials about CLAS and its uses"><a href="#">Tutorial</a></li-->
          <li id="data_sources" title="Click to view information about data used by the tool"><a href="#">Data Sources</a></li>
          <li id="version" title="Click to view information about updates made to CLAS"><a href="#">Version History</a></li>
          <li id="faq" title="Click to view answers to frequently asked questions"><a href="#">FAQ</a></li>
          <li id="glossary" title="Click to view the glossary"><a href="#">Glossary</a></li>
          <li id="feedback" title="Click to open a Google document where you can add feedback about CLAS"><a href="https://docs.google.com/document/d/1rF9yANAP-b5i_aCnn9JNFBDfLs3ciulytiQqMe0JmNg/edit?usp=sharing" target="_blank">Provide Feedback</a></li>
        </ul>
      </div>
    </nav>
    
    <div id="container">
      <div id="left_panel">
        <div id="left_panel_container">
          <div id="progIndDiv">
            <span id="prog1" class="progCircles visited" title="Areas"></span>
            <span id="prog2" class="progCircles" title="Ecosystem Components"></span>
            <span id="prog3" class="progCircles" title="Deposition"></span>
            <span id="prog4" class="progCircles" title="CL Type"></span>
            <span id="prog5" class="progCircles" title="Species"></span>
            <span id="prog6" class="progCircles" title="Preview"></span>
            <span id="prog7" class="progCircles" title="Results"></span>
          </div>
          <div id="selAreaDiv">
            <div class="selDiv disabled" id="selArea" title="Select area of interest" data-toggle="collapse" data-target="#selAreaTog"><span id="selAreaIcon" class="material-icons">label</span>Areas<span class="spacerSpan"></span><span class="headerSelSpan"></span></div>
            <div class="toggleDiv collapse" id="selAreaTog"></div>
          </div>
          <div id="selEcoDiv">
            <div class="selDiv disabled" id="selEco" title="Complete previous step to enable" data-toggle="collapse" data-target="#selEcoTog"><span id="selEcoIcon" class="material-icons">label</span>Ecosystem Components<span class="spacerSpan"></span><span class="headerSelSpan"></span></div>
            <div class="toggleDiv collapse" id="selEcoTog"></div>
          </div>
          <div id="selDepDiv">
            <div class="selDiv disabled" id="selDep" title="Complete previous step to enable" data-toggle="collapse" data-target="#selDepTog"><span id="selDepIcon" class="material-icons">label</span>Deposition<span class="spacerSpan"></span><span class="headerSelSpan"></span></div>
            <div class="toggleDiv collapse" id="selDepTog"></div>
          </div>
          <div id="selCLDiv">
            <div class="selDiv disabled" id="selCL" title="Complete previous step to enable" data-toggle="collapse" data-target="#selCLTog"><span id="selCLIcon" class="material-icons">label</span>CL Type<span class="spacerSpan"></span><span class="headerSelSpan">NA</span></div>
            <div class="toggleDiv collapse" id="selCLTog"></div>
          </div>
          <div id="selSppDiv">
            <div class="selDiv disabled" id="selSpp" title="Complete previous step to enable" data-toggle="collapse" data-target="#selSppTog"><span id="selSppIcon" class="material-icons">label</span>Species<span class="spacerSpan"></span><span class="headerSelSpan">NA</span></div>
            <div class="toggleDiv collapse" id="selSppTog"></div>
          </div>
          <div id="selOutDiv">
            <div class="selDiv disabled" id="selOut" title="Complete previous step to enable" data-toggle="collapse" data-target="#selOutTog"><span id="selOutIcon" class="material-icons">label</span>Preview<span class="spacerSpan"></span><span class="headerSelSpan"></span></div>
            <div class="toggleDiv collapse" id="selOutTog"></div>
          </div>
          <div id="selResDiv">
            <div class="selDiv disabled" id="selRes" title="Complete previous step to enable" data-toggle="collapse" data-target="#selResTog"><span id="selResIcon" class="material-icons">label</span>Outputs</div>
            <div class="toggleDiv collapse" id="selResTog"></div>
          </div>
        </div>
        <!--div id="left_collapse"><span id="left_collapse_glyph" class="glyphicon glyphicon-triangle-left"></span></div-->
      </div>
      <div id="map">
        <div id="toolbar"></div>
      </div>
      <div id="right_panel">
        <div id="right_panel_container"></div>
        <div id="right_collapse"><span id="right_collapse_glyph" class="glyphicon glyphicon-triangle-right"></span></div>
      </div>
    </div>

    <script type='text/javascript'>
      google.charts.load('current', {'packages':['corechart']});
      //google.charts.load('current', {'packages':['bar']});

      //******Connect to postgresql database
      socket_emit();

      //******Initialize bootstrap tooltip
      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();   
      });

      //******Call funtion to reposition windows on resize
      window.addEventListener('resize', resizePanels);

      localStorage.removeItem("tailorArray");

      function resizePanels() {
        var htmlRect = {};
        htmlRect.height = Math.max(window.innerHeight, $('html').height());
        htmlRect.top = 0;
        htmlRect.bottom = htmlRect.height;
        htmlRect.width = Math.max(window.innerWidth, $('html').width());
        htmlRect.left = 0;
        htmlRect.right = htmlRect.width;
        var tmpWindows = ["legendDiv", "attDiv", "histDiv", "downloadDiv","preferencesDiv"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > htmlRect.bottom) {
            d3.select("#" + win).style("top", htmlRect.height - winRect.height + "px");
          }
          if(winRect.right > htmlRect.right) {
            d3.select("#" + win).style("left", htmlRect.width - winRect.width + "px");
          }
        });

        var mapRect = document.getElementById("map").getBoundingClientRect();
        var tmpWindows = ["d3Tooltip"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > mapRect.bottom) {
            d3.select("#" + win).style("top", mapRect.height - winRect.height + "px");
          }
          if(winRect.right > mapRect.right) {
            d3.select("#" + win).style("left", mapRect.width - winRect.width + "px");
          }
        });

        //***Resize container-results width
        var tmpWidth = Math.max(window.innerWidth, 1280);
/*
        if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
          tmpWidth -= 165;
        }
        else {
          tmpWidth -= 15;
        }
*/
        if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
          tmpWidth -= 365;
        }
        else {
          tmpWidth -= 15;
        }

        d3.select("#container-results").style({"width":tmpWidth + "px"});

        //***Rescale chart canvas
        if(d3.select("#container-results").style("display") == "block" && d3.select(".canvasChartsLarge")[0][0] != null) {
          var tmpID = d3.select(".canvasChartsLarge").select("canvas").attr("id");
          var tmpIDSmall = tmpID.replace("Large","");
          var xTickFont = setFontSizeLarge(d3.select("#" + tmpIDSmall).attr("value"), tmpID);
          var canRectDiv = document.getElementById("canvasChartsLargeDiv").getBoundingClientRect();
          var widthPercent = (canRectDiv.width - 690)/(1830 - 690);
          var canRect = document.getElementById("container-results").getBoundingClientRect();
          var widthPercentCan = (Math.max(canRect.width, 730) - 730)/(1380 - 730);

          chartCanvas[tmpID].options.title.fontSize = (20 + (20 * widthPercent));

          if(tmpIDSmall == 'fig13b' || tmpIDSmall == 'fig13f' || tmpIDSmall.includes("fig6")) {
            chartCanvas[tmpID].options.legend.labels.fontSize = (9 + (9 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (9 + (9 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (9 + (9 * widthPercent));
          }
          else if(tmpIDSmall.includes('fig9b') || tmpIDSmall.includes('fig13g') || tmpIDSmall.includes('fig13c')) {
            chartCanvas[tmpID].options.legend.labels.fontSize = (13 + (13 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (13 + (13 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (13 + (13 * widthPercent));
          }
          else {
            chartCanvas[tmpID].options.legend.labels.fontSize = (12 + (12 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (12 + (12 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (12 + (12 * widthPercent));
          }
          chartCanvas[tmpID].options.scales.xAxes[1].scaleLabel.fontSize = (18 + (18 * widthPercent));          
          chartCanvas[tmpID].options.scales.xAxes[0].ticks.fontSize = (xTickFont + (xTickFont * (widthPercent)));          
          chartCanvas[tmpID].options.scales.xAxes[0].scaleLabel.fontSize = (14 + (14 * widthPercent));          
          chartCanvas[tmpID].options.scales.yAxes[0].scaleLabel.fontSize = (14 + (14 * widthPercent));
          if(tmpID.includes("tab")) {
            chartCanvas[tmpID].options.scales.yAxes[0].ticks.fontSize = (9 + (9 * widthPercent));
          }
          else {
            chartCanvas[tmpID].options.scales.yAxes[0].ticks.fontSize = (12 + (12 * widthPercent));
          }
          chartCanvas[tmpID].options.tooltips.titleFontSize = (16 + (6 * (1 - widthPercentCan)));
          chartCanvas[tmpID].options.tooltips.bodyFontSize = (14 + (6 * (1 - widthPercentCan)));

          if(tmpID.includes("tab4")) {
            chartCanvas[tmpID].options.layout.padding.top = (5 + (5 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (17 + (17 * widthPercentCan));
          }
          else if(tmpID.includes("tab2c") || tmpID.includes("tab1a")) {
            chartCanvas[tmpID].options.layout.padding.top = (15 + (45 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (35 + (20 * widthPercentCan));
          }
          else if(tmpID.includes("tab3")) {
            chartCanvas[tmpID].options.layout.padding.top = (30 + (60 * widthPercentCan));
          }
          else if(tmpID.includes("tab")) {
            chartCanvas[tmpID].options.layout.padding.top = (30 + (60 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (17 + (17 * widthPercentCan));
          }
       
          chartCanvas[tmpID].clear();
          chartCanvas[tmpID].render(0, true);
          chartCanvas[tmpID].update();

          if(tmpID.includes("tab")) {
            var tmpPrint = chartCanvas[tmpID];
            var tmpRect = document.getElementById(tmpID).getBoundingClientRect();
            if(tmpRect.width < 730) {
              setTimeout(function() {
                tmpRect = document.getElementById(tmpID).getBoundingClientRect();
                var widthPercentCan = (tmpRect.width - 730)/(1380 - 730);

                addInfo(tmpPrint, chartOpts[tmpIDSmall].large.cl[0], tmpRect, "large", widthPercentCan, tmpID);
              }, 500);
            }
            else {
              addInfo(tmpPrint, chartOpts[tmpIDSmall].large.cl[0], tmpRect, "large", widthPercentCan, tmpID);
            }
          }
        }
/*
        d3.select("#resTabsDiv").selectAll("canvas")[0].forEach(function(tmpCan) {
          chartCanvas[tmpCan.id + "Small"].update();
          var tmpPrint = chartCanvas[tmpCan.id + "Small"];
          var tmpRect = document.getElementById(tmpCan.id).getBoundingClientRect();
          addInfo(tmpPrint, chartOpts[tmpCan.id].small.cl[0], tmpRect, "small", 1, tmpCan.id)
        });
*/
        //***Resize species dropdown list
        d3.select("#speciesListDropdown").style("max-height", window.innerHeight - 143 + "px");
      }


      //******Add Map with custom zoom depending on screen size
      map = new L.Map('map', {zoomControl: false, minZoom: 2, maxZoom: 20, inertiaDeceleration: 1000, worldCopyJump: true});
      map.fitBounds([[24.5,-140],[50.7,-63]]);
      d3.select(".leaflet-control-attribution a").property("target", "_blank")

      //******Add map controls
      //******Bottom Right
      L.control.zoom({ position: 'topright', zoomInTitle: "Zoom in (can also be done with mouse wheel, double-click, '+' key, or by pressing the 'shift' key while clicking and dragging a rectangle)", zoomOutTitle: "Zoom out (can also be done with the mouse wheel or the '-' key)" }).addTo(map);
      L.control.maxExtent().addTo(map);

      //******Bottom Left
      L.control.scale({ position: 'bottomright', maxWidth: 200 }).addTo(map);
      L.control.mousePosition().addTo(map);

      //***Bing geocoder control
      var tmpPoint = new L.marker;
      var bingGeocoder = new L.Control.BingGeocoder('At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn', { callback: function (results) 
        {
        if(d3.select("#bingGeocoderInput").style("display") == "none") {
          d3.select("#bingGeocoderInput").style("display", "inline-block");
        }
        else if(d3.select("#bingGeocoderInput").property("value") == "") {
          d3.select("#bingGeocoderInput").style("display", "none");
        }
        else {
          if(results.statusCode == 200 && results.resourceSets[0].estimatedTotal > 0) {
            if(d3.select("#bingGeocoderSubmit").classed("glyphicon-search")) {
              $(document).ready(function(){
                $('[data-toggle="tooltip"]').tooltip();   
              });
              document.getElementById("bingGeocoderInput").blur();
              var bbox = results.resourceSets[0].resources[0].bbox,
                first = new L.LatLng(bbox[0], bbox[1]),
                second = new L.LatLng(bbox[2], bbox[3]),
                tmpBounds = new L.LatLngBounds([first, second]);
              //console.log(first + "\t" + second);
              console.log(results.resourceSets[0].resources[0].point.coordinates.join("\t"));
              this._map.fitBounds(tmpBounds);
              this._map.removeLayer(tmpPoint);
              tmpPoint = new L.marker(results.resourceSets[0].resources[0].point.coordinates);  //.bindPopup(results.resourceSets[0].resources[0].address.formattedAddress);
              this._map.addLayer(tmpPoint);
              d3.select("#bingGeocoderInput").property("value", results.resourceSets[0].resources[0].name);
              d3.select(".leaflet-marker-icon")
                .attr("id","mapIcon")
                .attr("value", results.resourceSets[0].resources[0].name)
                .attr("data-toggle", "tooltip")
                .attr("data-container", "body")
                .attr("data-placement", "auto top")
                .attr("data-html", "true")
                .attr("title", '<p><b><center>' + results.resourceSets[0].resources[0].name + '</center></b></p>');
              d3.select(tmpPoint)
                .on("click", function() { clearSearch(); });
              d3.select("#bingGeocoderSubmit")
                .classed("glyphicon-search", false)
                .classed("glyphicon-remove", true)
                .property("title", "Click to clear search results");
            }
            else {
              clearSearch();
            }
          }
          else {
            d3.select("#bingGeocoderInput").property("value","No matching results");            
          }
        }
        }
      });

     

      //******Clear the results of the geo search
      function clearSearch() {
        map.removeLayer(tmpPoint);
        d3.select(".tooltip").remove();
        d3.select("#bingGeocoderInput").property("value", "");

        d3.select("#bingGeocoderSubmit")
          .classed("glyphicon-remove", false)
          .classed("glyphicon-search", true)
          .style({"background":"", "color":""})
          .property("title", "Click to zoom to specified location");
      }

      //******Add base layers
      var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      }); 
      var googleStreet = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleTerrain = googleTerrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });

      var bingHybrid = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'AerialWithLabels'});
      var bingSatellite = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Aerial'});
      var bingStreet = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Road'});
      var usgsTopo = new L.tileLayer('https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 15,
            zIndex: 0,
            attribution: '<a href="https://www.doi.gov">U.S. Department of the Interior</a> | <a href="https://www.usgs.gov">U.S. Geological Survey</a> | <a href="https://www.usgs.gov/laws/policies_notices.html">Policies</a>'
            });
      var states = new L.tileLayer.wms("https://ecosheds.org/geoserver/birds/wms", {
          layers: 'us_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      var blank = new L.tileLayer('');


      //var tmpTypes = ["_LRC_type2", "_LRC_type2_unc", "_LRC_type3", "_LRC_type3_unc", "_LHG_type1", "_LHG_type1_unc", "_LHG_type2", "_LHG_type2_unc", "_LHG_type3", "_LHG_type3_unc"];
      var tmpTypes = ["_LRC_type2", "_LRC_type3", "_LHG_type1", "_LHG_type2", "_LHG_type3"];
      var tmpTypesArray = [];
      tmpTypes.forEach(function(type, i) {
        tmpTypesArray[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: "L_EXC_CompScore_S_2012" + type,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });

      //console.log(tmpTypesArray);


/*
      //******Study region layer
      var studyRegion = new L.tileLayer.wms("https://ecosheds.org/geoserver/CL/wms", {
          layers: 'ecoregions_dissolved',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      
      //******exc type 1 layer
      var exc_type1 = new L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: 'L_EXC_Trich_N_type1_final',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
*/
    

      //******Add Geoserver Layers

      //******Abiotic Layers
      var abioticID = ["CMAQ_N_2012", "CMAQ_S_2012", "n_tw_2017-2019", "s_tw_2017-2019"]; //, "L_EXC_Trich_N_type1_no_unc", "L_EXC_Trich_N_type2_no_unc", "L_EXC_Trich_N_type3_no_unc", "L_EXC_Trich_N_type1", "L_EXC_Trich_N_type2", "L_EXC_Trich_N_type3"];   //"n", "aspect", "bedrock", "clay", "coarse", "elevation", "permeability", "ph", "slope", "precip_annual", "precip_may_sept", "temp_jan", "temp_jul", "temp_may_sept"];
      var abioticTitles = ['CMAQ <span class="N_span_dropdown">N Dep</span> (2012)', 'CMAQ <span class="S_span_dropdown">S Dep</span> (2012)', 'T-Dep <span class="N_span_dropdown">N Dep</span> (2017-19)', 'T-Dep <span class="S_span_dropdown">S Dep</span> (2017-19)']; //, "EXC Type 1", "EXC Type 2", "EXC Type 3", "EXC Type 1 (Unc)", "EXC Type 2 (Unc)", "EXC Type 3 (Unc)"];   //"N Deposition (T-Dep)", "Aspect", "Depth to Bedrock", "% Clay in Soil", "% Coarse Sand", "Elevation", "Soil Permeability", "Soil pH", "Slope Gradient", "Precipitation (Annual)", "Precipitation (May-Sept)", "Temperature (Jan)", "Temperature (July)", "Temperature (May-Sept)"];
      var abioticUnits = {"CMAQ N Dep (2012)": "", "CMAQ N Dep (2012)": "", "T-Dep N Dep (2017-19)": "", "T-Dep S Dep (2017-19)": ""}; //, "EXC TYPE 1": "", "EXC TYPE 2": "", "EXC TYPE 3": "", "EXC TYPE 1 (Unc)": "", "EXC TYPE 2 (Unc)": "", "EXC TYPE 3 (Unc)": ""};   //"N Deposition (T-Dep)": "(kg/ha/yr)", "Aspect": "(Degrees)", "Depth to Bedrock": "(m)", "% Clay in Soil": "", "% Coarse Sand": "", "Elevation": "(m)", "Soil Permeability": "(cm/hr)", "Soil pH": "", "Slope Gradient": "(Degrees)", "Precipitation (Annual)": "(mm)", "Precipitation (May-Sept)": "(mm)", "Temperature (Jan)": "(C)", "Temperature (July)": "(C)", "Temperature (May-Sept)": "(C)"};
      var abioticLayers = [];
      var cropImg = {"top67": abioticID.slice(0), "top33":[]};
      cropImg.top67.splice(cropImg.top67.length,0,"cl_mins_min","cl_mins_max","cl_maxs_min","cl_maxs_max");


      abioticID.forEach(function(tmpID, i) {
        abioticLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });
/*
      //******Variables or Legend
      var opaVar = abioticLayers;
      infoObj = {"CMAQ_N_2012": "CMAQ N Dep (2012)", "CMAQ_S_2012": "CMAQ S Dep (2012)"};
      var overlays = {"CMAQ N Dep (2012)": abioticLayers[0], "CMAQ S Dep (2012)": abioticLayers[1]};
      var overlayTitles = d3.keys(overlays);
*/






      //******Aquatic national layers
      var aquaticID = [];
      var aquaticTitles = [];
      var aquaticUnits = {};
      var aquaticLayers = [];
      var aquaticLayersUnc = [];
      var aquaticLegImg = [];
      
      //var ecoComp = {"Trich": "Total species richness", "SSrich": "Sensitive-species richness", "ForageAbun": "Forage lichen abundance", "CyanoAbun": "Cyanolichen abundance", "CompScore": "Composite air score"};


      ["CL", "EXC"].forEach(function(meas) {
        //["Trich", "SSrich", "ForageAbun", "CyanoAbun", "CompScore"].forEach(function(comp, i) {
          ["NS", "S"].forEach(function(dep) {
            if(meas == "EXC") {
              aquaticID.push("A_EXC_" + dep + "_2017-2019_type1");
              if(dep == "NS") {
                aquaticTitles.push("Exceedance: " + ' <span class="N_span_dropdown">' + dep + " Dep</span>");
              }
              else {
                aquaticTitles.push("Exceedance: " + ' <span class="S_span_dropdown">' + dep + " Dep</span>");
              }
              aquaticUnits["Exceedance: " + dep + " Dep"] = "meq/m^2/yr";
              aquaticLegImg.push("images/aquatic_exc_type1.jpg");


              aquaticID.push("A_EXC_" + dep + "_2017-2019_type2");
              if(dep == "NS") {
                aquaticTitles.push("Magnitude of EXC: " + ' <span class="N_span_dropdown">' + dep + " Dep");
              }
              else {
                aquaticTitles.push("Magnitude of EXC: " + ' <span class="S_span_dropdown">' + dep + " Dep");
              }
              aquaticUnits["Magnitude of EXC: " + dep + " Dep"] = "meq/m^2/yr";
              aquaticLegImg.push("images/aquatic_exc_type2.jpg");


              aquaticID.push("A_EXC_" + dep + "_2017-2019_type3");
              if(dep == "NS") {
                aquaticTitles.push("Magnitude of EXC +/-: " + ' <span class="N_span_dropdown">' + dep + " Dep");
              }
              else {
                aquaticTitles.push("Magnitude of EXC +/-: " + ' <span class="S_span_dropdown">' + dep + " Dep");
              }
              aquaticUnits["Magnitude of EXC +/-: " + dep + " Dep"] = "meq/m^2/yr";
              aquaticLegImg.push("images/aquatic_exc_type3.jpg");
            }
            else {
              //if(comp != "CompScore") {
                aquaticID.push("A_CL_" + dep + "_2017-2019");
                if(dep == "NS") {
                  aquaticTitles.push("Critical Load: " + ' <span class="N_span_dropdown">' + dep + " Dep");
                }
                else {
                  aquaticTitles.push("Critical Load: " + ' <span class="S_span_dropdown">' + dep + " Dep");
                }
                aquaticUnits["Critical Load: " + dep + " Dep"] = "meq/m^2/yr";
                aquaticLegImg.push("images/aquatic_cl.jpg");
              //}
            }
          });
        //});
      });

      aquaticID.forEach(function(tmpID, i) {
        aquaticLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
        aquaticLayersUnc[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID + "_unc",
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });








      //******Lichen national layers
      var lichenID = [];
      var lichenTitles = [];
      var lichenUnits = {};
      var lichenLayers = [];
      var lichenLayersUnc = [];
      var lichenLegImg = [];
      
      var ecoComp = {"Trich": "Total species richness", "SSrich": "Sensitive-species richness", "ForageAbun": "Forage lichen abundance", "CyanoAbun": "Cyanolichen abundance", "CompScore": "Composite air score"};


      ["EXC", "CC"].forEach(function(meas) {
        ["Trich", "SSrich", "ForageAbun", "CyanoAbun", "CompScore"].forEach(function(comp, i) {
          ["N", "S"].forEach(function(dep) {
            if(meas == "EXC") {
              lichenID.push("L_EXC_" + comp + "_" + dep + "_2012_type1");
              if(dep == "N") {
                lichenTitles.push("Exceedance: " + ecoComp[comp] + ' <span class="N_span_dropdown">' + dep + " Dep</span>");
              }
              else {
                lichenTitles.push("Exceedance: " + ecoComp[comp] + ' <span class="S_span_dropdown">' + dep + " Dep</span>");
              }
              lichenUnits["Exceedance: " + ecoComp[comp] + " " + dep + " Dep"] = "kg/ha/yr";
              lichenLegImg.push("images/lichens_exc_type1.jpg");


              lichenID.push("L_EXC_" + comp + "_" + dep + "_2012_type2");
              if(dep == "N") {
                lichenTitles.push("Magnitude of EXC: " + ecoComp[comp] + ' <span class="N_span_dropdown">' + dep + " Dep");
              }
              else {
                lichenTitles.push("Magnitude of EXC: " + ecoComp[comp] + ' <span class="S_span_dropdown">' + dep + " Dep");
              }
              lichenUnits["Magnitude of EXC: " + ecoComp[comp] + " " + dep + " Dep"] = "kg/ha/yr";
              lichenLegImg.push("images/lichens_exc_type2.jpg");


              lichenID.push("L_EXC_" + comp + "_" + dep + "_2012_type3");
              if(dep == "N") {
                lichenTitles.push("Magnitude of EXC +/-: " + ecoComp[comp] + ' <span class="N_span_dropdown">' + dep + " Dep");
              }
              else {
                lichenTitles.push("Magnitude of EXC +/-: " + ecoComp[comp] + ' <span class="S_span_dropdown">' + dep + " Dep");
              }
              lichenUnits["Magnitude of EXC +/-: " + ecoComp[comp] + " " + dep + " Dep"] = "kg/ha/yr";
              lichenLegImg.push("images/lichens_exc_type3.jpg");
            }
            else {
              if(comp != "CompScore") {
                lichenID.push("L_CC_" + comp + "_" + dep + "_2012");
                if(dep == "N") {
                  lichenTitles.push("Current Condition: " + ecoComp[comp] + ' <span class="N_span_dropdown">' + dep + " Dep");
                }
                else {
                  lichenTitles.push("Current Condition: " + ecoComp[comp] + ' <span class="S_span_dropdown">' + dep + " Dep");
                }
                lichenUnits["Current Condition: " + ecoComp[comp] + " " + dep + " Dep"] = "%";
                lichenLegImg.push("images/lichens_cc.jpg");
              }
            }
          });
        });
      });

      lichenID.forEach(function(tmpID, i) {
        lichenLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
        lichenLayersUnc[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID + "_unc",
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });





      //******Tree community national layers
      var treeComID = [];
      var treeComTitles = [];
      var treeComUnits = {};
      var treeComLayers = [];
      var treeComLayersUnc = [];
      var treeComLegImg = [];
      
      var ecoComp = {"G": "Growth", "S": "Survival"};

      ["CL", "EXC"].forEach(function(meas) {
        ["Min"].forEach(function(comp, i) {
          ["G", "S"].forEach(function(type) {
            ["N", "S"].forEach(function(dep) {
              if(meas == "EXC") {
                treeComID.push("T_CEXC_" + comp + "_" + dep + type + "_2017-2019_type1");
                if(dep == "N") {
                  treeComTitles.push("Combined (min) Exceedance: " + ecoComp[type] + ' <span class="N_span_dropdown">' + dep + " Dep</span>");
                }
                else {
                  treeComTitles.push("Combined (min) Exceedance: " + ecoComp[type] + ' <span class="S_span_dropdown">' + dep + " Dep</span>");
                }
                treeComUnits["Combined (min) Exceedance: " + ecoComp[type] + dep + " Dep"] = "meq/m^2/yr";
                treeComLegImg.push("images/trees_exc_type1.jpg");


                treeComID.push("T_CEXC_" + comp + "_" + dep + type + "_2017-2019_type2");
                if(dep == "N") {
                  treeComTitles.push("Combined (min) Magnitude of EXC: " + ecoComp[type] + ' <span class="N_span_dropdown">' + dep + " Dep");
                }
                else {
                  treeComTitles.push("Combined (min) Magnitude of EXC: " + ecoComp[type] + ' <span class="S_span_dropdown">' + dep + " Dep");
                }
                treeComUnits["Combined (min) Magnitude of EXC: " + ecoComp[type] + dep + " Dep"] = "meq/m^2/yr";
                treeComLegImg.push("images/trees_exc_type2.jpg");


                treeComID.push("T_CEXC_" + comp + "_" + dep + type + "_2017-2019_type3");
                if(dep == "N") {
                  treeComTitles.push("Combined (min) Magnitude of EXC +/-: " + ecoComp[type] + ' <span class="N_span_dropdown">' + dep + " Dep");
                }
                else {
                  treeComTitles.push("Combined (min) Magnitude of EXC +/-: " + ecoComp[type] + ' <span class="S_span_dropdown">' + dep + " Dep");
                }
                treeComUnits["Combined (min) Magnitude of EXC +/-: " + ecoComp[type] + dep + " Dep"] = "meq/m^2/yr";
                treeComLegImg.push("images/trees_exc_type3.jpg");
              }
              else {
                //if(comp != "CompScore") {
                  treeComID.push("T_CCL_" + comp + "_" + dep + type + "_2017-2019");
                  if(dep == "N") {
                    treeComTitles.push("Combined (min) Critical Load: " + ecoComp[type] + ' <span class="N_span_dropdown">' + dep + " Dep");
                  }
                  else {
                    treeComTitles.push("Combined (min) Critical Load: " + ecoComp[type] + ' <span class="S_span_dropdown">' + dep + " Dep");
                  }
                  treeComUnits["Combined (min) Critical Load: " + ecoComp[type] + dep + " Dep"] = "meq/m^2/yr";
                  treeComLegImg.push("images/trees_cl.jpg");
                //}
              }
            });
          });
        });
      });

      treeComID.forEach(function(tmpID, i) {
        treeComLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
        treeComLayersUnc[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID + "_unc",
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });










      //******Species Layers
      var speciesID = [];
      var speciesTitles = [];
      var speciesNames = [];
      //var speciesID = ["ab_ba", "ac_ru", "ac_sa", "be_al", "be_pa", "ca_de", "fa_gr", "fr_am", "fr_pe", "ju_ci", "pi_ma", "pi_ru", "pi_re", "pi_ri", "pi_st", "po_gr", "po_tr", "qu_al", "qu_pr", "qu_ru", "th_oc", "ts_ca", "ul_am"];
      //var speciesTitles = ["Balsam Fir", "Red Maple", "Sugar Maple", "Yellow Birch", "Paper Birch", "American Chestnut", "American Beech", "White Ash", "Green Ash", "Butternut", "Black Spruce", "Red Spruce", "Red Pine", "Pitch Pine", "White Pine", "Bigtooth Aspen", "Quaking Aspen", "White Oak", "Chestnut Oak", "Red Oak", "Northern White Cedar", "Eastern Hemlock", "American Elm"];
      //var speciesNames = ["Abies balsamea", "Acer rubrum", "Acer saccharum", "Betula alleghaniensis", "Betula papyrifera", "Castanea dentata", "Fagus grandifolia", "Fraxinus americana", "Fraxinus pennsylvanica", "Juglans cinerea", "Picea mariana", "Picea rubens", "Pinus resinosa", "Pinus rigida", "Pinus strobus", "Populus grandidentata", "Populus tremuloides", "Quercus alba", "Quercus prinus", "Quercus rubra", "Thuja occidentalis", "Tsuga canadensis", "Ulmus americana"];
      var speciesLayers = [];
      var speciesJSON = {"Abies balsamea":"Balsam Fir", "Acer rubrum":"Red Maple", "Acer saccharum":"Sugar Maple", "Betula alleghaniensis":"Yellow Birch", "Betula papyrifera":"Paper Birch", "Castanea dentata":"American Chestnut", "Fagus grandifolia":"American Beech", "Fraxinus americana":"White Ash", "Fraxinus pennsylvanica":"Green Ash", "Juglans cinerea":"Butternut", "Picea mariana":"Black Spruce", "Picea rubens":"Red Spruce", "Pinus resinosa":"Red Pine", "Pinus rigida":"Pitch Pine", "Pinus strobus":"White Pine", "Populus grandidentata":"Bigtooth Aspen", "Populus tremuloides":"Quaking Aspen", "Quercus alba":"White Oak", "Quercus prinus":"Chestnut Oak", "Quercus rubra":"Red Oak", "Thuja occidentalis":"Northern White Cedar", "Tsuga canadensis":"Eastern Hemlock", "Ulmus americana":"American Elm"};

      var layerExt = ["_cl_mins", "_exc_mins", "_exc_maxs", "_range"];
      var layerExtTitles = ["Critical Load", "Exceedance Min", "Exceedance Max", "Species Range"];

      speciesID.forEach(function(tmpID, i) {
        speciesLayers[i] = [];
        layerExt.forEach(function(tmpExt, j) {
          speciesLayers[i][j] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
            layers: tmpID + tmpExt,
            format: 'image/png',
            transparent: true,
            version: '1.1.0',
            maxZoom: 20,
            zIndex: 1
          });
        });
      });


      //******Add Community Layers
      var commID = [];
      var commTitles = [];
      var commTooltip = [];
      //var commID = ["cl_mins_min", "cl_maxs_min", "cl_mins_max", "cl_maxs_max", "exc_cl_mins_min", "exc_cl_maxs_min", "exc_cl_mins_max", "exc_cl_maxs_max"]
      ////var commTitles = ["Most Protective CL", "Low Intermediate CL", "High Intermediate CL", "Least Protective CL", "EXC of Most Protective CL", "EXC of Low Intermediate CL", "EXC of High Intermediate CL", "EXC of Least Protective CL"];
      //var commTitles = ["CL", "TL-LOW", "TL-MID", "TL-HIGH", "EXC of CL", "EXC of TL-LOW", "EXC of TL-MID", "EXC of TL-HIGH"];
      //var commTooltip = ["Most protective Critical Load for most sensitive species (CL A)", "Critical Load at which at least one species is severely at risk (CL D)", "Most Protective CL for least sensitive species (CL C)", "Critical Load at which all species are severely at risk (CL B)", "Exceedance of most protective Critical Load for most sensitive species (EXC of CL A)", "Exceedance of Critical Load at which at least one species is severely at risk (EXC of CL D)", "Exceedance of most protective Critical Load for least sensitive species (EXC of CL C)", "Exceedance of Critical Load at which all species are severely at risk (EXC of CL B)"];
      ////var commID = ["cl_mins_min", "cl_mins_max", "cl_maxs_min", "cl_maxs_max", "exc_cl_mins_min", "exc_cl_mins_max", "exc_cl_maxs_min", "exc_cl_maxs_max"]
      ////var commTitles = ["Min CL (lower range)", "Max CL (lower range)", "Min CL (upper range)", "Max CL (upper range)", "Exceedance A (min min)", "Exceedance B (max min)", "Exceedance D (min max)", "Exceedance C (max max)"];
      var commLayers = [];

      commID.forEach(function(tmpID, i) {
        commLayers[i] = L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
          layers: tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });


      //******Add SVG Layers
      //******Area Select Layers
      //var areaID = ["state", "eco1", "eco2", "eco3", "fs_wild", "fs", "class1"];
      var areaID = ["class1", "admin", "tribal", "wild", "eco1", "eco2", "eco3"];
      //var areaTitles = ["States", "Ecoregions Level 1", "Ecoregions Level 2", "Ecoregions Level 3", "Forest Service Wilderness Areas", "Forest Service Admin Areas", "Class I Areas"];
      //var areaTitles = ["States", "Level I Ecoregions", "Level II Ecoregions", "Level III Ecoregions", "Forest Service Wilderness Areas", "Forest Service Admin Areas", "Class I Areas"];
      var areaTitles = ["Class I Areas", "Federal Administrative Areas", "Tribal Lands", "Wilderness Areas", "Level I Ecoregions", "Level II Ecoregions", "Level III Ecoregions"];
      var areaLayers = [];

      var topoSVG = d3.select(map.getPanes().overlayPane).append("svg");

      areaID.forEach(function(tmpID, i) {
        topoSVG.append("g").attr("class", "leaflet-zoom-hide").attr("id", tmpID + "G");
      });

      areaID.forEach(function(tmpID, i) {
        areaLayers[i] = d3.select("#" + tmpID + "G");
        areaLayers[i].onAdd = function(map) { addTopo(topos[tmpID]); };
        areaLayers[i].onRemove = function(map) { removeTopo(topos[tmpID]); };
      });


      //******Add topo layer to map
      function addTopo(topo) {
        var tmpFeats = topo.g.selectAll("." + topo.class)
            .data(topo.features)
          .enter().append("path")
            .attr("d", path)
            //.attr("id", function(d) { return d.id.split(" ").join("_"); })
            .attr("class", topo.class)
            .on("mouseenter", function() { 
              if(d3.select(this).style("opacity") > 0) {
                showIt(this.id);
                var tmpID = this.id;
                var tmpBi = 0;
                d3.select("#right_panel").selectAll("label")[0].some(function(d) {
                  if(d3.select(d).property("title") == tmpID) {
                    d3.select(d).style("color", "aqua");
                    tmpBi = 1;
                  }
                  return tmpBi == 1;
                });
              }
            })
            .on("mousemove", function() { tooltip.style("top", (d3.event.pageY-40) + "px").style("left", (d3.event.pageX+15) + "px"); resizePanels(); })
            .on("mouseleave", function() {
              tooltip.style("visibility", "hidden");
              var tmpID = this.id;
              var tmpBi = 0;
              d3.select("#right_panel").selectAll("label")[0].some(function(d) {
                if(d3.select(d).property("title") == tmpID) {
                  d3.select(d).style("color", "");
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });                              
            })
            .on("click", function(data) { 
              //console.log(data.id);
              d3.selectAll(".remLabel").each(function() {
                if(this.title == data.id) {
                  $(this).click();
                }
              });
              
/*
              if (d3.select(this).style("stroke-opacity") == "1") {
                d3.select(this).style({"fill-opacity": "", "stroke-opacity": ""}).classed("selected", false);
                d3.selectAll(".remCheck").property("checked", function() {if(this.value == data.id) {return false;} });
              } 
              else {
                d3.select(this).style({"fill-opacity": "0.5", "stroke-opacity": "1"}).classed("selected", true);
                d3.selectAll(".remCheck").property("checked", function() {if(this.value == data.id) {return true;} });
              }
*/
              //get_spp();
              get_abiotic_counts();
            });
        changeStyle("id", topo);
        //filterMap("featureid", topo, true);
        //d3.select("#" + topo.class + "Legend").style("display", "block");
      }


      //******Remove topo layer from map
      function removeTopo(topo) {
        var tmpFeats = topo.g.selectAll("." + topo.class);
        tmpFeats.remove();
        //d3.select("#" + topo.class + "Legend").style("display", "none");
      }



      //******Add in top menu divs
      d3.select("#container")
        .append("div")
        .attr("id", "container-basics")
        .attr("class", "container-menu")
        .html(''
/*
          + '<p style="font-size:24px;"><b><u>Overview</u></b></p>'
          + '<p style="font-size:16px">This tool is designed to synthesize information about nitrogen deposition, species sensitivity, site and current climate conditions into an easy-to-use, web-based geospatial tool (N-CLAS) to facilitate effective resource management across the northern forest region.</p><br>'
          + '<p style="font-size:16px">The N-CLAS tool allows land managers to determine critical loads (CL), quantify exceedance, and set targets for the purposes of land management and restoration. N-CLAS can be used to address questions about selected areas such as:</p>'
          + '<ul style="font-size:16px;">'
            + '<li>What proportion of my area is at risk from air pollution?</li>'
            + '<li>How does the sensitivity of my area compare with other locations?</li>'
            + '<li>What nitrogen deposition level would ensure protection of my forests?</li>'
            + '<li>Which species are the most sensitive?</li>'
          + '</ul><br>'
          + '<p style="font-size:16px">The interactive web interface provides maximum flexibility for the user to assess heterogeneous landscapes for specific areas and species of interest.  Outputs include downloadable maps, tables and figures summarizing critical loads and exceedance based on a range of customizable options, including output products that reflect the minimum CL value, range of CL values, or percent of the target area protected.</p><br>'
          + '<p style="font-size:16px">You can also download base layer maps of <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>N Deposition</center></b></u></p><p>N Deposition (Total Dep)</p>">N deposition</span>, <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Climate</center></b></u></p><p>Precipitation (Annual)<br>Precipitation (May-Sept)<br>Temperature (Jan)<br>Temperature (July)<br>Temperature (May-Sept)</p>">climate</span>, <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Soil</center></b></u></p><p>Bedrock Depth<br>Clay<br>Coarse<br>Permeability<br>pH</p>">soil</span>, and <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Topographic</center></b></u></p><p>Aspect<br>Elevation<br>Slope</p>">topographic</span> parameters.</p>'
          + '<img src="images/overview_download.png" title="Download menu" style="height:325px;"></img><br><br>'
          + '<p style=font-size:24px;"><b><u>How it Works</u></b></p>'
          + '<p style="font-size:16px">Nitrogen Critical Load Assessment by Site (N-CLAS) is a GIS-based tool designed for resource managers and policy makers to assess the effects of nitrogen deposition and climate change on forest ecosystems in the Northeastern United States.  N-CLAS uses geospatial data layers for key topographic, climactic, soil abiotic factors, and nitrogen deposition levels to predict whether growth at a site will be optimal or suboptimal for each of 23 significant tree species.  N-CLAS can then be used to assess critical loads and exceedance for individual species or summarized for all species combined  for user selected areas.</p><br>'
          + '<p style="font-size:16px"><i>Customize your output by setting your preferences for area unit (acres or hectares), and tree species name (Latin or common).</i><br></p>'
          + '<p style="font-size:16px;"><u><b>Step 1</b></u>: Select your target <span style="color:white;background:rgb(189,68,65);font-weight:bold;padding:2px;border:1px solid black;">Area</span></p>'
          + '<p style="font-size:16px;margin-left:30px">N-CLAS includes data aggregation by state, ecoregion, National Forest, National Park, and wilderness area classes. You can select one, or multiple areas for comparison within each class.</p><br>'
          + '<p style="font-size:16px;"><u><b>Step 2</b></u>: Select your <span style="color:white;background:rgb(118,147,60);font-weight:bold;padding:2px;border:1px solid black;">Species</span> of interest</p>'
          + '<p style="font-size:16px;margin-left:30px">A total of 23 tree species are included in the N-CLAS assessment. You may select a single species of interest, any combination of key species, or all species to better understand the forest as a whole.</p><br>'
          + '<p style="font-size:16px;"><u><b>Step 3</b></u>: Select your preferred <span style="color:white;background:rgb(54,96,146);font-weight:bold;padding:2px;border:1px solid black;">Output</span></p>'
          + '<p style="font-size:16px;margin-left:30px">Three levels of detail are provided for output maps, figures, and tables:</p>'
          + '<ul style="font-size:16px;margin-left:30px">'
            + '<li><b>Basic</b>: Summary figures and tables are limited to assessments for the <b>most protective critical load of most sensitive species</b>.<br></li>'
            + '<li><b>Tailored</b>: A set of screening questions about the key critical load and exceedance questions helps to guide the selection of the most informative output tables, figures, and maps.<br></li>'
            + '<li><b>Comprehensive</b>: All figures and tables. This selection will include outputs to address all range values of critical loads, and output data products.<br><br></li>'
            + '<li><i>You can preview example output and alter selected figures prior to running the analysis for all three levels.</i><br></li>'
          + '</ul><br>'
          + '<p style="font-size:16px;"><u><b>Step 4</b></u>: View your generated <span style="color:white;background:rgb(255,192,0);font-weight:bold;padding:2px;border:1px solid black;">Results</span></p>'
          + '<p style="font-size:16px;margin-left:30px">The results window allows users to explore a variety of graphs, tables, and figures generated according to their customized settings.<br><br></p>'


          + '<p style=font-size:24px;"><b><u>Outputs</u></b></p>'
          + '<p style="font-size:16px">The tool&#39;s output includes downloadable summary tables and figures as well as spatially explicit maps of CL and exceedance values across the landscape of interest.  Some outputs are designed to specifically address common questions  (see overview above), while others are designed to provide detailed comparisons across sites or species.</p><br>'
          + '<p style="font-size:16px">Various types of map products, data aggregation and summary statistics include:</p>'
          + '<ul style="font-size:16px;">'
            + '<li>Basic descriptive metrics for the area in exceedance and magnitude of exceedance for each species and area of interest</li>'
            + '<li>Cumulative frequency graphs to visualize the distribution of various CL and exceedance values across your selected landscape</li>'
            + '<li>Risk assessment (area protected or exceeded) at various deposition levels</li>'
            + '<li>High resolution maps of critical load and exceedance for individual species, as well as a summary of all species combined for a range  of CL thresholds</li>'
          + '</ul><br>'
*/
          + '')
        .style({"display":"none", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-approach")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>N-CLAS Overview</u></b></p>'
/*
          + '<div class="methodDiv">'
            + '<div class="approachLeftDiv">'
              + '<p class="approachP">N-CLAS is a GIS-based tool designed for resource managers to assess the effects of nitrogen deposition and determine <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Critical Loads</center></b></u></p><p>A critical load is defined as the level of deposition below which no harmful effects occur over the long term (UBA 2004). In N-CLAS, this is the amount of N deposition that will negatively impact the tree species present.</p>">critical loads</span> and <span class="hover" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Exceedance</center></b></u></p><p>The amount by which the actual load of deposition is greater than the critical load.<br><br>Exceedance of N = total N deposition - N critical load</p>">exceedance</span> for forest ecosystems in the Northeastern United States.<span class="glyphicon glyphicon-info-sign approachModalGlyph" style="display:none;margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p>'
              + '<ul class="approachUL">'
                + '<li data-toggle="collapse" data-target="#approachAnswer00" title="Click to show/hide answer">What factors does N-CLAS consider when determining CL?</li>'
                + '<div class="approachAnswer collapse" id="approachAnswer00">'
                  + '<p id="hyperlinkP">N-CLAS can be used to determine critical loads and exceedance for individual tree species or all tree species present for <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_F1.jpg&#34;);">user selected areas</span>, including national forests and parks, wilderness areas, and <a class="aLink" href="https://www.epa.gov/eco-research/ecoregions-north-america" target="_blank">ecoregions</a> (areas with similar ecosystem structure and function as defined by the Commission for Environmental Cooperation (CEC)).<br><br>N-CLAS uses geospatial data of abiotic modifying factors (topographic, climatic, and soil parameters) to predict whether growth in each 30 m x 30 m pixel is likely to be <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_2.2.jpg&#34;);">optimal or sub-optimal</span> for a given species. Sub-optimal growth conditions are expected to increase sensitivity to N deposition, whereas optimal growth conditions are expected to result in increased N demand and higher tolerance of N deposition.<br><br>N-CLAS combines the effect of the abiotic modifying factors on growth to determine if the critical load for a species will be in the bottom half or upper half of the species&#39; documented critical load range.<ul><li>In N-CLAS, suboptimal growth conditions are expected to increase sensitivity to N deposition and thus shift the critical load to the bottom half of the species&#39; critical loads range.</li><br><li>Optimal growth conditions are expected to result in increased N demand and thus shift the critical load to the upper half of the critical loads range.</li></ul></p>'
                + '</div>'

                + '<li data-toggle="collapse" data-target="#approachAnswer01" title="Click to show/hide answer">What tree species does N-CLAS include?</li>'
                + '<div class="approachAnswer collapse" id="approachAnswer01">'
                  + '<p>N-CLAS includes 23 species of management concern, of commercial interest and dominant species in the northern forest.</p>'
                  + '<img class="approachAnswerImg" src="images/about/table_2.1.jpg">'
                + '</div>'

                + '<li data-toggle="collapse" data-target="#approachAnswer02" title="Click to show/hide answer">What areas does N-CLAS include?</li>'
                + '<div class="approachAnswer collapse" id="approachAnswer02">'
                  + '<p>N-CLAS can be used to determine critical loads and exceedance for <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_2.1.jpg&#34;);">individual tree species</span> or all tree species present at user-selected areas, including national forests and parks, wilderness areas, and <a class="aLink" href="https://www.epa.gov/eco-research/ecoregions-north-america" target="_blank">ecoregions</a> (areas with similar ecosystem structure and function as defined by the Commission for Environmental Cooperation (CEC)).</p>'
                  + '<img class="approachAnswerImg" src="images/about/table_F1.jpg">'
                + '</div>'

                + '<li data-toggle="collapse" data-target="#approachAnswer03" title="Click to show/hide answer">What factors modify the CL in N-CLAS?</li>'
                + '<div class="approachAnswer collapse" id="approachAnswer03">'
                  + '<p>N-CLAS uses geospatial data for <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_2.4.jpg&#34;);">topographic, climatic, and soil parameters</span> to assess whether growth is likely to be optimal or sub-optimal for each species at a given location. N-CLAS then modifies the critical load for each species based on these factors.</p>'
                  + '<ul>'
                    + '<li>Topographic factors</li>'
                      + '<ul>'
                        + '<li>Elevation</li>'
                        + '<li>Aspect</li>'
                        + '<li>Slope gradient</li>'
                      + '</ul>'
                    + '<li>Climatic</li>'
                      + '<ul>'
                        + '<li>January, July and May-September temperature</li>'
                        + '<li>Annual and May-September precipitation</li>'
                      + '</ul>'
                    + '<li>Soil</li>'
                      + '<ul>'
                        + '<li>pH</li>'
                        + '<li>Clay and sand content</li>'
                        + '<li>Permeability</li>'
                        + '<li>Depth to bedrock</li>'
                      + '</ul>'
                  + '</ul>'
                + '</div>'

                + '<li data-toggle="collapse" data-target="#approachAnswer04" title="Click to show/hide answer">How do optimal growth conditions affect the CL in N-CLAS?</li>'
                + '<div class="approachAnswer collapse" id="approachAnswer04">'
                  + '<ul>'
                    + '<li>Optimal growth conditions are expected to result in increased N demand and thus shift the critical load to the <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_slide_6.jpg&#34;);">upper half of the species&#39; documented critical loads range</span>.</li>'
                    + '<img class="approachAnswerImg" src="images/about/fig_2.2.jpg" style="margin-bottom:5px;">'
                    + '<li>Sub-optimal growth conditions are expected to increase sensitivity to N deposition and thus shift the critical load to the <span class="hyperlink nonInfo"  onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_slide_6.jpg&#34;);">bottom half of the species&#39; documented critical loads range</span>.</li>'
                    + '<li>The combined effect of all the abiotic modifying factors on growth determines whether the critical load for a species will be in the bottom half or upper half of the species&#39; critical load range.</li>'
                + '</div>'

              + '</ul>'
            + '</div>'
            + '<div class="approachRightDiv">'
              + '<img class="approachImg" src="images/about/fig_A.jpg" style="max-width:500px">'
            + '</div>' 
          + '</div>'
          + '<br><br>'




          + '<p style="font-size:24px;"><b><u>N-CLAS Approach</u></b></p>'
          + '<div class="methodDiv">'
            + '<div class="approachLeftDiv">'
              + '<p class="approachP">N-CLAS uses a 5-step process to calculate critical loads.<span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p>'
              + '<a class="aLink" href="images/about/Methods_for_NCLAS_20180223.pdf" target="_blank">PDF containing detailed methodology</a>'
              + '<p class="approachP" style="margin-top:10px;">N-CLAS critical loads can be reported for individual species or aggregated for all tree species present.</p>'
              + '<p class="approachP">Steps N-CLAS uses to calculate the critical load:</p>' // <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p>'
              + '<ol>'

                + '<li><p class="approachP">Identify the species present <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p></li>'
                  + '<ul class="approachUL">'
                    + '<li data-toggle="collapse" data-target="#approachAnswer10" title="Click to show/hide answer">How does N-CLAS identify the species present?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer10">'
                      + '<p>N-CLAS uses <a class="aLink" href="https://www.landfire.gov" target="_blank">LANDFIRE</a> geospatial data, which provides SAF (Society of American Foresters) forest cover type fore existing vegetation.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer11" title="Click to show/hide answer">What species are included in each SAF Forest Cover Type?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer11">'
                      + '<p>Species composition of each forest cover type is derived from Eyre (1980), the USDA <a class="aLink" href="https://www.feis-crs.org/feis/" target="_blank">Fire Effects Information System</a>, and Little&#39;s <a class="aLink" href="https://esp.cr.usgs.gov/data/little/" target="_blank">Little&#39;s species range maps</a>. We created a list of species included in each SAF forest cover type used by LANDFIRE.</p>'
                    + '</div>'
                + '</ul>'
                + '<br>'

                + '<li><p class="approachP">Evaluate whether abiotic modifying factors are more likely to lead to optimal or sub-optimal conditions for growth <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p></li>'
                  + '<ul class="approachUL">'
                    + '<li data-toggle="collapse" data-target="#approachAnswer12" title="Click to show/hide answer">What is the optimal range for growth for each modifying factor?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer12">'
                      + '<p>For each tree species, <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/gtr/gtr_nrs172.pdf" target="_blank">Robin-Abbott and Pardo (2017)</a> identified the <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/download/gtr_nrs172_appendix2.pdf" target="_blank">optimal range for growth for specified topographic, climatic, and soil abiotic modifying factors</a>.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer13" title="Click to show/hide answer">How is the optimal range for growth determined?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer13">'
                      + '<p><a class="aLink" href="https://www.fs.fed.us/nrs/pubs/download/gtr_nrs172_appendix2.pdf" target="_blank">The optimal range for growth for specified topographic, climatic, and soil abiotic modifying factors</a> is based on <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/download/gtr_nrs172_appendix1.pdf" target="_blank">importance values and distribution data</a> from the Climate Change Tree Atlas (U.S. Forest Service, n.d.) and information from other sources, including the Forest Service silvics handbook "Silvics of North America" (Burns and Honkala, 1990); the PLANTS database (NRCS 2014); and additional literature sources.</p>'
                      + '<img class="approachAnswerImg" src="images/about/fig_2.3.jpg">'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer15" title="Click to show/hide answer">What is the spatial scale of N-CLAS?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer15">'
                      + '<p>N-CLAS makes calculations for each 30 m x 30 m pixel for each species present at that location.</p>'
                    + '</div>'
                + '</ul>'
                + '<br>'

                + '<li><p class="approachP">Weigh the strength of evidence for the response of each abiotic factor <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p></li>'
                  + '<ul class="approachUL">'
                    + '<li data-toggle="collapse" data-target="#approachAnswer16" title="Click to show/hide answer">What is the weight of evidence?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer16">'
                      + '<p>The weight of evidence is a way of quantifying the strength of the scientific evidence currently available for a species&#39; response to an abiotic factor.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer17" title="Click to show/hide answer">How is the weight of evidence determined?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer17">'
                      + '<p>The weight of evidence for abiotic modifying factor thresholds is set using FIA-based importance value data from the Climate Change Atlas.<br>The overall uncertainty rating was determined through the arithmatic mean of three weighting criteria:<ul><li>Number of samples included in the FIA assessment</li><li>Shape of the importance value response curve over the range of each factor</li><li>Accuracy of factor values</li></ul></p><p>The <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_2.2.jpg&#34;);">matrix used to assign</span> the weight of evidence for abiotic factors included in the Climate Change Atlas is described in <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/gtr/gtr_nrs172.pdf" target="_blank">Robin-Abbott and Pardo (2017)</a>.<br>Another <span class="hyperlink nonInfo" onclick="d3.select(&#34;#approachModalFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_2.3.jpg&#34;);">matrix</span> was used to assign the weight of evidence for abiotic modifying thresholds set using data from the Forest Service silvics handbook, "Silvics of North America" (Burns and Honkala, 1990), PLANTS database (NRCS 2014), or other literature sources.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer18" title="Click to show/hide answer">How does N-CLAS determine the net effect of the abiotic modifying factors?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer18">'
                      + '<p>Values for the weight of evidence are summed across all factors in the optimal range and then compared to the sum of the weights of evidence for all factors in the sub-optimal range. If the sum of the weight of evidence of sub-optimal factors is higher, overall growth is likely to be sub-optimal. If the sum of the weight of evidence of optimal factors is higher, overall growth is likely to be optimal.</p>'
                      + '<img class="approachAnswerImg" src="images/about/fig_1B.C.jpg">'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer19" title="Click to show/hide answer">How was the weighting system developed?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer19">'
                      + '<p>This weighting system is based on the endorsement theory, which is described in detail in Hall and Wadsworth (2010)</p>'
                    + '</div>'
                + '</ul>'
                + '<br>'

                + '<li><p class="approachP">Incorporate the relative ecological significance of each abiotic factor <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p></li>'
                + '</ul>'
                + '<br>'

                + '<li><p class="approachP">Adjust the critical load value based on the combined effect of all abiotic modifying factors <span class="glyphicon glyphicon-info-sign approachModalGlyph" style="margin:0;margin-left:5px;cursor:pointer;" title="Click to view detailed information"</span></p></li>'
                  + '<ul class="approachUL">'
                    + '<li data-toggle="collapse" data-target="#approachAnswer110" title="Click to show/hide answer">Why is the CL reported as a range?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer110">'
                      + '<p>The critical load is reported as a range to incorporate the variation in response to N deposition across sites and individuals.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer111" title="Click to show/hide answer">What does it mean if the adjusted CL is in the bottom half of the CL range for that species?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer111">'
                      + '<p>If the adjusted critical load is in the bottom half of the CL range, it means that in this area, the species is more sensitive to N deposition. Suboptimal growth conditions are expected to increase sensitivity to N deposition and thus shift the critical load to the bottom half of the species&#39; critical loads range.</p>'
                    + '</div>'
                    + '<li data-toggle="collapse" data-target="#approachAnswer112" title="Click to show/hide answer">What does it mean if the adjusted CL is in the upper half of the CL range for that species?</li>'
                    + '<div class="approachAnswer collapse" id="approachAnswer112">'
                      + '<p>If the adjusted critical load is in the upper half of the CL range, it means that in this area, the species is less sensitive to N deposition. Optimal growth conditions are expected to result in increased N demand and thus shift the critical load to the upper half of the critical loads range.</p>'
                    + '</div>'
                + '</ul>'
                + '<br>'

              + '</ol>'
            + '</div>'
 
            + '<div class="approachRightDiv">'
              + '<img class="approachImg" src="images/about/fig_2.2.jpg" style="max-width:500px">'
              + '<img class="approachImg" src="images/about/table_1A.jpg" style="max-width:500px">'
              + '<img class="approachImg" src="images/about/table_1B.jpg" style="max-width:500px">'
            + '</div>' 
          + '</div>'
*/
          + '')
        .style({"display":"none", "padding":"30px"});






      //******Add modal information div
      var modalContentP = [];
      modalContentP.push('<p>N-CLAS can be used to determine critical loads and exceedance for individual tree species or all tree species present for <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_F1.jpg&#34;);">user selected areas</span>, including national forests and parks, wilderness areas, and <a class="aLink" href="https://www.epa.gov/eco-research/ecoregions-north-america" target="_blank">ecoregions</a> (areas with similar ecosystem structure and function as defined by the Commission for Environmental Cooperation (CEC)).<br><br>N-CLAS uses geospatial data of abiotic modifying factors (topographic, climatic, and soil parameters) to predict whether growth in each 30 m x 30 m pixel is likely to be <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_2.2.jpg&#34;);">optimal or sub-optimal</span> for a given species. Sub-optimal growth conditions are expected to increase sensitivity to N deposition, whereas optimal growth conditions are expected to result in increased N demand and higher tolerance of N deposition.<br><br>N-CLAS combines the effect of the abiotic modifying factors on growth to determine if the critical load for a species will be in the bottom half or upper half of the species&#39; documented critical load range.<ul><li>In N-CLAS, suboptimal growth conditions are expected to increase sensitivity to N deposition and thus shift the critical load to the bottom half of the species&#39; critical loads range.</li><br><li>Optimal growth conditions are expected to result in increased N demand and thus shift the critical load to the upper half of the critical loads range.</li></ul></p>');
      //modalContentP.push('<p>N-CLAS calculates critical loads for individual species at each 30 m x 30 m pixel across the landscape. These critical loads can then be reported for individual species or aggregated across all tree species, which enables the identification of the lowest critical loads across <i>all</i> species present in that location. <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_2.4.jpg&#34;);">Abiotic modifying factors and spatial data layers</span> used in the N-CLAS GIS tool include topographic (elevation, aspect, slope gradient), climatic (measures of annual and seasonal temperature and precipitation), and soil (pH, clay and sand content, permeability, depth to bedrock) parameters.</p>');
      modalContentP.push('<p>The process by which N-CLAS calculates critical loads for each pixel includes: <ol><li>Identifying the species present.</li><li>Evaluating whether the effect of each abiotic modifying factor is more likely to lead to optimal or sub-optimal growth conditions for that species.</li><li>Weighing the strength of evidence for the relationship between abiotic factors and species&#39; growth.</li><li>Incorporating the relative ecological significance of each abiotic factor.</li><li>Adjusting the species critical load value based on the combined effect of all abiotic modifying factors.</li></ol></p>');
      modalContentP.push('<p>The first step is to determine which species are present in each pixel. N-CLAS uses <a class="aLink" href="https://www.landfire.gov" target="_blank">LANDFIRE</a> and SAF (Society of American Foresters) forest cover types to identify the presence or absence of species in a given pixel, assuming species composition of each cover type based on Eyre (1980), the USDA <a class="aLink" href="https://www.feis-crs.org/feis/" target="_blank">Fire Effects Information System</a>, and Little&#39;s <a class="aLink" href="https://esp.cr.usgs.gov/data/little/" target="_blank">Little&#39;s species range maps</a></p>');
      modalContentP.push('<p>The second step is to evaluate whether the abiotic conditions at a given location are optimal for growth of each species.'
          + '<ul>'
            + '<li>For each tree species in this study <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/gtr/gtr_nrs172.pdf" target="_blank">Robin-Abbott and Pardo (2017)</a> identified the <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/download/gtr_nrs172_appendix2.pdf" target="_blank">optimal range for growth for specified topographic, climatic, and soil abiotic modifying factors</a> based on <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/download/gtr_nrs172_appendix1.pdf" target="_blank">importance values and distribution data</a> from the Climate Change Tree Atlas (U.S. Forest Service, n.d.) and information from other sources, including the Forest Service silvics handbook "Silvics of North America" (Burns and Honkala, 1990); the PLANTS database (NRCS 2014); and additional literature sources.</li>'
            + '<li>Abiotic conditions outside of the range of optimal conditions for each species are considered sub-optimal</li>'
            + '<li>N-CLAS compares the actual abiotic factor value at a given location to the <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_2.2.jpg&#34;);">optimal range</span> for that species (Robin-Abbott and Pardo, 2017). Each abiotic modifying factor is then assigned to either the optimal (shown in green) or sub-optimal (lavendar) category.</li>'
          + '</ul>'
        + '</p>');
      modalContentP.push('<p>The weight of evidence for relationships between abiotic factors and species optimal growth is used to determine the impact of each abiotic modifying factor in N-CLAS calculations. A factor with more certainty will have a high weight of evidence, and will thus have more impact on the calculations that determine whether a site is more likely to be optimal or suboptimal for a species. The scale for the weight of evidence ranges from 1 (weak) to 5 (strong), in keeping with the 5-point scale for rating uncertainty in CL calculations in the US National Framework (Clark and Pardo, <i>in prep.</i>). The weight of evidence varies by factor and by species and is reported in <a class="aLink" href="https://www.fs.fed.us/nrs/pubs/gtr/gtr_nrs172.pdf" target="_blank">Robin-Abbott and Pardo (2017)</a>. Values for the weight of evidence are summed across all factors in the optimal range and then compared to the sum of the weights of evidence for all factors in the sub-optimal range. If the sum of weight of evidence of sub-optimal factors is higher, overall growth is likely to be sub-optimal. If the sum of the weight of evidence of optimal factors is higher, overall growth is likely to be optimal.</p>');
      modalContentP.push('<p>In the fourth step, N-CLAS assesses the weight of influence. Not all factors are equally important in determining the ultimate growth response of a given tree species and its susceptibility to N deposition. Note that the weight of influence reflects the ecological significance of the factor which is different than the weight of evidence which addresses the strength of the relationship shown by the data.<ul><li>In the current version of N-CLAS, climate factors are given the highest weight of influence.<ul><li>If any climate factor for a species in a pixel is suboptimal, growth is assumed to be suboptimal.</li><li>If all climate factors are optimal, N-CLAS assigns growth categories based on the weight of evidence calculation.</li></ul></li><li>In the future, if further information becomes available, the weight of influence could be adjusted.</li></ul></p>');
      modalContentP.push('<p>In the fifth step, for each species in the pixel, N-CLAS assigns critical load. The critical load will either be the bottom half of the critical loads range--if the net effect of the abiotic factors is sub-optimal--or the upper half of the critical loads range--if the net effect of the abiotic factors is optimal (<a class="aLink" href="https://www.fs.fed.us/nrs/pubs/gtr/gtr_nrs172.pdf" target="_blank">Robin-Abbott and Pardo, 2017</a>).</p>');


      d3.select("body")
        .append("div")
        .html(''
          + '<div class="modal fade" id="approachModal" role="dialog">'
            + '<div class="modal-dialog approachModal">'
              + '<div class="modal-content">'
                + '<div class="modal-body" id="modalContentP">'
                  //+ '<p>N-CLAS can be used to determine critical loads and exceedance for individual tree species or all tree species present for <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/table_F1.jpg&#34;);">user selected areas</span>, including national forests and parks, wilderness areas, and <a class="aLink" href="https://www.epa.gov/eco-research/ecoregions-north-america" target="_blank">ecoregions</a> (areas with similar ecosystem structure and function as defined by the Commission for Environmental Cooperation (CEC)).<br><br>N-CLAS uses geospatial data of abiotic modifying factors (topographic, climatic, and soil parameters) to predict whether growth in each 30 m x 30 m pixel is likely to be <span class="hyperlink info" onclick="d3.select(&#34;#infoFigImg&#34;).attr(&#34;src&#34;, &#34;images/about/fig_2.2.jpg&#34;);">optimal or sub-optimal</span> for a given species. Sub-optimal growth conditions are expected to increase sensitivity to N deposition, whereas optimal growth conditions are expected to result in increased N demand and higher tolerance of N deposition.<br><br>N-CLAS combines the effect of the abiotic modifying factors on growth to determine if the critical load for a species will be in the bottom half or upper half of the species&#39; documented critical load range.<ul><li>In N-CLAS, suboptimal growth conditions are expected to increase sensitivity to N deposition and thus shift the critical load to the bottom half of the species&#39; critical loads range.</li><br><li>Optimal growth conditions are expected to result in increased N demand and thus shift the critical load to the upper half of the critical loads range.</li></ul></p>'
                + '</div>'
                + '<div class="modal-footer"><button type="button" class="close" data-dismiss="modal">Close</button></div>'
              + '</div>'
            + '</div>'
          + '</div>'
          + '');







      //******Add modal figure div
      d3.select("body")
        .append("div")
        .html(''
          + '<div class="modal fade" id="approachModalFig" role="dialog">'
            + '<div class="modal-dialog">'
              + '<div class="modal-content">'
                + '<div class="modal-body">'
                  + '<img id="approachModalFigImg" src="images/about/table_2.1.jpg">'
                + '</div>'
                + '<div class="modal-footer"><button type="button" class="close" data-dismiss="modal">Close</button></div>'
              + '</div>'
            + '</div>'
          + '</div>'
          + '');






      //******Add info figure div
      d3.select("body")
        .append("div")
        .attr("id", "infoFigDiv")
        .html(''
          + '<div class="modal-content">'
            + '<div class="modal-body">'
              + '<img id="infoFigImg" src="images/about/table_2.1.jpg">'
            + '</div>'
            + '<div class="modal-footer"><button type="button" class="close" onclick="toolWindowToggle(&#34;infoFig&#34;)">Close</button></div>'
          + '</div>'
          + '');
      $('#infoFigDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      //******Make everything work when clicked
      d3.selectAll(".approachModalGlyph")[0].forEach(function(d,i) {
        $(d).click(function(){ 
          d3.select("#modalContentP").html(modalContentP[i]);
          $("#approachModal").modal();
          d3.selectAll(".hyperlink.info")[0].forEach(function(d,i) { $(d).click(function(){ if(d3.select("#infoFigDiv").style("opacity",0)) {toolWindowToggle("infoFig");} });});
        });
      });

      $("#approachModal").on("hide.bs.modal", function() { if(d3.select("#infoFigDiv").style("opacity",1)) {toolWindowToggle("infoFig");} });

      d3.selectAll(".hyperlink.nonInfo")[0].forEach(function(d,i) {
        $(d).click(function(){ $("#approachModalFig").modal(); });
      });

      //******Make images work for hyperlinks outside of .approachModalGlyph class
      //d3.select("#hyperlinkP").selectAll(".hyperlink.noninfo")[0].forEach(function(d,i) { $(d).click(function(){ if(d3.select("#infoFigDiv").style("opacity",0)) {toolWindowToggle("infoFig");} });});




      d3.select("#container")
        .append("div")
        .attr("id", "container-guide")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Instructions for Use</u></b></p>'
          + '<div class="guideHeader" title="Click to expand or collapse" data-toggle="collapse" data-target="#guideDiv1">The Outputs that CLAS Provides</div>'
          + '<div id="guideDiv1" class="guideDiv collapse">'
            + '<ul>'
              + '<li>CLAS produces map outputs of:'
                + '<ul class="ul2">'
                  + '<li>Exceedance of the critical load (CL) of nitrogen (N) and sulfur (S) deposition for:'
                      + '<ul class="ul3">'
                        + '<li>Sensitive <b>Lakes and Streams</b>,</li>'
                        + '<li><b>Epiphytic Lichens</b>, and</li>'
                        + '<li><b>Trees</b></li>'
                      + '</ul>'
                  + '</li>'
                + '</ul>'
              + '</li>'
              + '<li>You can access maps in the format of:'
                + '<ul class="ul2">'
                  + '<li><b>Nationwide</b> map layers</li>'
                  + '<li>Customized map outputs for a <b>specific site</b> of your choosing</li>'
                + '</ul>'
              + '</li>'
              + '<li>CLAS can also display <b>uncertainty</b> information spatially; layered on top of other map outputs</li>'
            + '</ul>'
          + '</div>'

          + '<div class="guideHeader" title="Click to expand or collapse" data-toggle="collapse" data-target="#guideDiv2">How to Access CLAS Outputs</div>'
          + '<div id="guideDiv2" class="guideDiv collapse">'
            + '<p class="guideSubheader">Access nationwide map layers</p>'
            + '<ol>'
              + '<li>To view <b>nationwide CL & EXC</b> maps,'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Open the "CL & EXC Map Layers" dropdown list in the upper right-hand corner of the black toolbar above the map viewing panel.'
                    + '<img class="guideImg" src="images/ugNationwide1.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Click on the ecosystem component you are interested in.</li>'
                  + '<li>&rarr; Click the checkbox next to your desired map to add it to the map viewing panel.</li>'
                  + '<li>&rarr; To remove a map from the viewing panel, click again on the checked-box in the dropdown list to deselect it.</li>'
                + '</ul>'
              + '</li>'
              + '<li>To view <b>nationwide deposition</b> maps,'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Open the "Abiotic Map Layers" dropdown list near the right-hand corner of the black toolbar above the map viewing panel.'
                    + '<img class="guideImg" src="images/ugNationwide2.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Click the checkbox next to your desired deposition layer to add it to the map viewing panel.</li>'
                  + '<li>&rarr; To remove a map from the viewing panel, click again on the checked-box in the dropdown list to deselect it.</li>'
                + '</ul>'
              + '</li>'
            + '</ol>'
            + '<p class="guideSubheader">Access map outputs for a specific site</p>'
            + '<p class="ugP">Proceed through the steps in the left-hand sidebar:</p>'
            + '<ol>'
              + '<li><b>Select your area</b>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Click on the "Areas" step at the top of the left-hand accordion.'
                    + '<img class="guideImg" src="images/ugNationwide3.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Use the "Area Layer" dropdown to select your area category.</li>'
                  + '<li>&rarr; Select your specific site by:'
                    + '<ul class="ul2">'
                      + '<li>Typing the name of your area into the areas search bar,</li>'
                      + '<li>Scrolling through the areas search bar and clicking on the name of your area, or</li>'
                      + '<li>Using the map viewing panel to click on your area on the map.</li>'
                    + '</ul>'
                  + '</li>'
                  + '<li>&rarr; Once you have selected your area, click "Next" to proceed.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>Select Ecosystem Component(s)</b>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Select the ecosystem component(s) you are interested in by clicking the checkbox(s) next to "Aquatic" and/or "Lichens" and/or "Trees".'
                    + '<img class="guideImg" src="images/ugNationwide4.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Once you have selected your ecosystem component(s), click "Next" to proceed.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>Select Deposition type(s)</b>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; For each selected ecosystem component, select the deposition layers you are interested in.'
                    + '<img class="guideImg" src="images/ugNationwide5.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Once you have selected your deposition layers(s), click "Next" to proceed.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>Select CL type(s)</b>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; If you selected either Lichens or Trees, you need to select the specific CL types you are interested in.'
                    + '<img class="guideImg" src="images/ugNationwide6.png"></img>'
                  + '</li>'
                  + '<li>'
                    + '<ul class="ul2">'
                      + '<li>For Lichens, select from the following CL types:'
                        + '<ol class="ulLowAlpha">'
                          + '<li>Total species richness</li>'
                          + '<li>Sensitive-species richness</li>'
                          + '<li>Forage lichen abundance</li>'
                          + '<li>Cyanolichen abundance</li>'
                          + '<li>Composite air score</li>'
                        + '</ol>'
                      + '</li>'
                      + '<li>For Trees, select from the following CL types:'
                        + '<ol class="ulLowAlpha">'
                          + '<li>Growth</li>'
                          + '<li>Survival</li>'
                        + '</ol>'
                      + '</li>'
                    + '</ul>'
                  + '</li>'
                  + '<li>&rarr; Once you have selected your CL type(s), click "Next" to proceed.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>Select species</b>'
                + '<p class="ugP">If you selected Trees, you need to answer additional questions during the species step.</p>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; First, indicate whether you are interested in <b>individual species</b> maps, <b>combined species</b> <span class="glyphicon glyphicon-info-sign ug"></span> maps, or both.</li>'
                  + '<li>&rarr; If you selected <b><u>individual species</u></b> maps, check the box next to each tree species for which you would like to receive outputs.</li>'
                  + '<li>&rarr; If you selected <b><u>combined species</u></b> maps, select your preferred way of displaying CL & EXC information: <span class="glyphicon glyphicon-info-sign ug"></span>'
                    + '<ul class="ul2">'
                      + '<li><b>Minimum</b> - use the CL of the species with the most protective CL in your selected area.</li>'
                      + '<li><b>Median</b> - use the median CL value of all individual Horn trees <span class="glyphicon glyphicon-info-sign ug"></span> present in your selected area.</li>'
                      + '<li><b>95th Percentile</b> - use the CL value that is protective of 95% of the individual Horn trees <span class="glyphicon glyphicon-info-sign ug"></span> present in your selected area.</li>'
                    + '</ul>'
                  + '</li>'
                  + '<li>&rarr; Once you have selected your tree species and/or preferred aggregation method(s), click "Next" to proceed.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>Preview your Outputs and Answer Preference Questions</b>'
                + '<p class="ugP">CLAS produces 3 different types of EXC map outputs: <span class="glyphicon glyphicon-info-sign ug"></span></p>'
                + '<ol style="list-style-position:inside;">'
                  + '<li><b>Exceedance</b>: shows whether deposition is below, at, or above the CL.</li>'
                  + '<li><b>Magnitude of EXC</b>: shows how much EXC there is. Blue indicates that there is no EXC (deposition does not exceed the CL).</li>'
                  + '<li><b>Magnitude of EXC +/-</b>: shows how much EXC there is. Includes how much lower deposition is than the CL (how much more pollution can be deposited before the CL is exceeded).</li>'
                + '</ol>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Begin the preview step by selecting the EXC map format(s) you want.'
                    + '<img class="guideImg" src="images/ugNationwide7.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Next, click on the "Preview outputs list" button to view a complete list of all the map outputs you selected.</li>'
                  + '<li>&rarr; If you are satisfied with your list of outputs, click "Next" to proceed to the final step.</li>'
                + '</ul>'
              + '</li>'
              + '<li><b>View your Map Outputs</b>'
                + '<ul class="ulNoBullett">'
                  + '<li>&rarr; Click on the "view maps" button'
                    + '<img class="guideImg" src="images/ugNationwide8.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Click on the ecosystem component you would like to review first. This will open a table of map layers that is segmented by deposition (<i>see the N Deposition and S Deposition tabs at the top of the table</i>).'
                    + '<img class="guideImg" src="images/ugNationwide9.png"></img>'
                  + '</li>'
                  + '<li>&rarr; Click on a map layer to view it.</li>'
                  + '<li>&rarr; To deselect a map layer, either click on it again or select a new map layer to replace it.'
                    + '<ul class="ul2">'
                      + '<li>Note: you can also view related resources for the area you selected by clicking on the button "Access additional CL & EXC information for <i><u>selected area name</u></i>".</li>'
                    + '</ul>'
                  + '</li>'
                + '</ul>'
              + '</li>'
            + '</ol>'
            + '<p class="guideSubheader">Access maps of uncertainty</p>'
            + '<p class="ugP">To view the uncertainty scores associated with a map:</p>'
            + '<ul class="ulNoBullett">'
              + '<li>&rarr; Add the map to the viewing panel.'
              + '<li>&rarr; Click on the "Show uncertainty" button.'
                + '<img class="guideImg" src="images/ugNationwide10.png"></img>'
              + '</li>'
              + '<li>&rarr; For more information about uncertainty, click on the <span class="glyphicon glyphicon-info-sign ug"></span> icon on top of the "show uncertainty" button.'
            + '</ul>'
          + '</div>'

          + '<div class="guideHeader" title="Click to expand or collapse" data-toggle="collapse" data-target="#guideDiv3">How to Download CLAS Outputs</div>'
          + '<div id="guideDiv3" class="guideDiv collapse">'
            + '<p class="guideSubheader">Download an individual map Image or Data</p>'
            + '<ul class="ulNoBullett">'
              + '<li>&rarr; Add the map layer you want to download to the viewing panel (either by selecting the layer from the "CL & EXC Map Layers" drop-down list, or by proceeding through the steps of CLAS to generate Outputs for a specific site).'
              + '<li>&rarr; Once the map is displayed in the viewing panel, click the button "Download current map" in the bottom right-hand corner.'
                + '<img class="guideImg" src="images/ugNationwide11.png"></img>'
              + '</li>'
              + '<li>&rarr; Use the "download specifications" box to select your preferred file format.'
                + '<img class="guideImg" src="images/ugNationwide12.png"></img>'
                + '<ul class="ulNoBullett">'
                  + '<li>- <b>Image</b> file types include:'
                    + '<ol>'
                      + '<li>JPG</li>'
                      + '<li>PDF</li>'
                    + '</ol>'
                  + '</li>'
                  + '<li>- <b>Data</b> file types include:'
                    + '<ol>'
                      + '<li>Geotiff</li>'
                      + '<li>ESRI shapefile</li>'
                      + '<li>KMZ</li>'
                    + '</ol>'
                  + '</li>'
                + '</ul>'
              + '</li>'
              + '<li>&rarr; Click "Download".'
                + '<img class="guideImg" src="images/ugNationwide13.png"></img>'
              + '</li>'
            + '</ul>'
            + '<p class="guideSubheader">Download all map outputs for a selected site at once</p>'
            + '<ul class="ulNoBullett">'
              + '<li>&rarr; Proceed through the 7 steps in the left-hand panel of CLAS (Areas, Ecosystem Components, Deposition, CL Type, Species, Preview, and Outputs).'
              + '<li>&rarr; Once you have reached the Outputs step, click the button "Download all map outputs" to open the download specifications box for all map outputs at once.'
                + '<img class="guideImg" src="images/ugNationwide14.png"></img>'
              + '</li>'
              + '<li>&rarr; Select your preferred file format.'
                + '<img class="guideImg" src="images/ugNationwide12.png"></img>'
                + '<ul class="ulNoBullett">'
                  + '<li>- <b>Image</b> file types include:'
                    + '<ol>'
                      + '<li>JPG</li>'
                      + '<li>PDF</li>'
                    + '</ol>'
                  + '</li>'
                  + '<li>- <b>Data</b> file types include:'
                    + '<ol>'
                      + '<li>Geotiff</li>'
                      + '<li>ESRI shapefile</li>'
                      + '<li>KMZ</li>'
                    + '</ol>'
                  + '</li>'
                + '</ul>'
              + '</li>'
              + '<li>&rarr; Click "Download".'
                + '<img class="guideImg" src="images/ugNationwide13.png"></img>'
              + '</li>'
            + '</ul>'
          + '</div>'

          + '<div class="guideHeader" title="Click to expand or collapse" data-toggle="collapse" data-target="#guideDiv4">General Tips for Use</div>'
          + '<div id="guideDiv4" class="guideDiv collapse">'
            + '<ol>'
              + '<li>For <b>more information</b>/guidance -'
                + '<ul class="ul2">'
                  + '<li>Click on <span class="glyphicon glyphicon-info-sign ug"></span> (information) buttons.</li>'
                  + '<li>When in doubt, hover your mouse over a feature for more information.</li>'
                  + '<li>Visit other tabs of the tool:'
                    + '<img class="guideImg" src="images/ugNationwide17.png"></img>'
                  + '</li>'
                + '</ul>'
              + '</li>'
              + '<li>Map <b>legends</b> -'
                + '<ul class="ul2">'
                  + '<li>To open the legend window, click on the icon in the upper left-hand corner of the tool.'
                    + '<img class="guideImg" src="images/ugNationwide18.png"></img>'
                  + '</li>'
                  + '<li>Multiple nationwide map layers can be selected at once.</li>'
                  + '<li>The layer at the top of the legend window corresponds to the top layer projected on the map.</li>'
                  + '<li>You can change the order of the map layers by dragging and dropping them in the legend window.</li>'
                  + '<li>To remove a layer from the map, click again on the checked-box of the active layer to deselect it.</li>'
                + '</ul>'
              + '</li>'
            + '</ol>'
          + '</div>'


          + '')
        .style({"display":"none", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-tutorial")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Tutorials</u></b></p>'
/*
          + '<ul style="font-size:16px;">'
            + '<li>N-CLAS starter - various intro buttons<br></li>'
            + '<li>Exploring abiotic factor map layers<br></li>'
            + '<li>User scenarios:<br></li>'
              + '<ul style="font-size:16px;">'
                + '<li>Basic<br></li>'
                + '<li>Example 2<br></li>'
                + '<li>Example 3<br></li>'
              + '</ul>'
            + '<li>Video guides and scenarios<br></li>'
          + '</ul><br>'
*/
          + '')
        .style({"display":"none", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-faq")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Frequently Asked Questions</u></b></p>'
/*
          + '<div id="faqQuestDiv">'
            + '<h3>How to use N-CLAS</h3>'
            + '<p><a href="#quest1">What is the best way to troubleshoot or get more information when using N-CLAS?</a></p>'
            + '<p><a href="#quest2">How do I clear the selections I have made in the tool to start over?</a></p>'
            + '<p><a href="#quest3">If there is white on the CL or EXC map (provided the baselayer is either &#39;State Outlines&#39; or &#39;None&#39;), what does this mean?</a></p>'
            + '<p><a href="#quest4">How are non-forested areas shown?</a></p>'
            + '<p><a href="#quest5">Which level of detail is appropriate for me for output selection?</a></p>'
            + '<p><a href="#quest6">How do I alter the assortment of outputs that N-CLAS selects for me?</a></p>'
            + '<p><a href="#quest7">How do I download figures and tables?</a></p>'
            + '<p><a href="#quest8">How do I download maps?</a></p>'
            + '<p><a href="#quest9">Can I save my settings?</a></p>'
            + '<p><a href="#quest10">How do I undo a selection?</a></p>'
            + '<p><a href="#quest11">How can I reset my preferences?</a></p>'
            + '<hr>'
            + '<h3>How N-CLAS works</h3>'
            + '<p><a href="#quest12">Why is N-CLAS by site?</a></p>'
            + '<p><a href="#quest13">Which species are included in the N-CLAS assessment?</a></p>'
            + '<p><a href="#quest14">How do the tree species critical loads included in N-CLAS differ from other critical loads?</a></p>'
            + '<p><a href="#quest15">How does N-CLAS differ from other critical load assessment tools?</a></p>'
            + '<p><a href="#quest16">How are the critical loads set?</a></p>'
            + '<p><a href="#quest17">How does N-CLAS adjust the critical load by site conditions?</a></p>'
            + '<p><a href="#quest18">How do the ranges for optimal growth vary by species for each abiotic factor?</a></p>'
            + '<p><a href="#quest19">What is the weight of evidence?</a></p>'
            + '<p><a href="#quest20">Where are the abiotic factor data from?</a></p>'
            + '<p><a href="#quest21">Where do the species ranges come from?</a></p>'
            + '<p><a href="#quest22">Which critical load value should I use (most or least sensitive)?</a></p>'
            + '<p><a href="#quest23">What does it mean if my entire site is in exceedance?</a></p>'
            + '<p><a href="#quest24">What does it mean if none of my area is in exceedance?</a></p>'
            + '<p><a href="#quest25">How can I get help interpreting my results?</a></p>'
          + '</div>'
          
          + '<div id="faqAnsDiv">'
            + '<h3>How to use N-CLAS</h3>'
            + '<div id="quest1">'
              + '<p class="faqQuestP">What is the best way to troubleshoot or get more information when using N-CLAS?</p>'
              + '<p class="faqAnsP">When in doubt, <b>hover</b>. Hovering will generally open a brief description of the item of interest. Many items in the web app contain an <b>info icon </b><span class="glyphicon glyphicon-info-sign" style="margin:0;"></span>. Hovering over these icons provides a summary of the function of each item.</p>'
            + '</div>'
            + '<div id="quest2">'
              + '<p class="faqQuestP">How do I clear the selections I have made in the tool to start over?</p>'
              + '<p class="faqAnsP">There is a refresh button <span class="glyphicon glyphicon-refresh" style="margin:0;"></span> in the upper right-hand corner of the home page.</p>'
            + '</div>'
            + '<div id="quest3">'
              + '<p class="faqQuestP">If there is white on the CL or EXC map (provided the baselayer is either &#39;State Outlines&#39; or &#39;None&#39;), what does this mean?</p>'
              + '<p class="faqAnsP">White on the map indicates that the area is not forested. Non-forested pixels contain no shading and thus expose the current baselayer.</p>'
            + '</div>'
            + '<div id="quest4">'
              + '<p class="faqQuestP">How are non-forested areas shown?</p>'
              + '<p class="faqAnsP">Non-forested areas are not shown on the map making whatever baselayer is present visible in those areas.</p>'
            + '</div>'
            + '<div id="quest5">'
              + '<p class="faqQuestP">Which level of detail is appropriate for me for output selection?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest6">'
              + '<p class="faqQuestP">How do I alter the assortment of outputs that N-CLAS selects for me?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest7">'
              + '<p class="faqQuestP">How do I download figures and tables?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest8">'
              + '<p class="faqQuestP">How do I download maps?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest9">'
              + '<p class="faqQuestP">Can I save my settings?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest10">'
              + '<p class="faqQuestP">How do I undo a selection?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest11">'
              + '<p class="faqQuestP">How can I reset my preferences?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<hr>'
            + '<h3>How N-CLAS works</h3>'
            + '<div id="quest12">'
              + '<p class="faqQuestP">Why is N-CLAS by site?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest13">'
              + '<p class="faqQuestP">Which species are included in the N-CLAS assessment?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest14">'
              + '<p class="faqQuestP">How do the tree species critical loads included in N-CLAS differ from other critical loads?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest15">'
              + '<p class="faqQuestP">How does N-CLAS differ from other critical load assessment tools?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest16">'
              + '<p class="faqQuestP">How are the critical loads set?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest17">'
              + '<p class="faqQuestP">How does N-CLAS adjust the critical load by site conditions?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest18">'
              + '<p class="faqQuestP">How do the ranges for optimal growth vary by species for each abiotic factor?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest19">'
              + '<p class="faqQuestP">What is the weight of evidence?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest20">'
              + '<p class="faqQuestP">Where are the abiotic factor data from?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest21">'
              + '<p class="faqQuestP">Where do the species ranges come from?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest22">'
              + '<p class="faqQuestP">Which critical load value should I use (most or least sensitive)?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest23">'
              + '<p class="faqQuestP">What does it mean if my entire site is in exceedance?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest24">'
              + '<p class="faqQuestP">What does it mean if none of my area is in exceedance?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'
            + '<div id="quest25">'
              + '<p class="faqQuestP">How can I get help interpreting my results?</p>'
              + '<p class="faqAnsP">Need answer</p>'
            + '</div>'

          + '</div>'
*/
          + '')
        .style({"display":"none", "padding":"30px"});






      d3.select("#container")
        .append("div")
        .attr("id", "container-data_sources")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Data Sources</u></b></p>'
          + '<p>The data sources listed on this page reflect the current version of CLAS. Visit the Version History tab to see the contents and date ranges of prior versions.</p>'
          + '<br>'
          + '<h4>Deposition</h4>'
          + '<table class="data_sourceTable">'
            + '<tr>'
              + '<th>'
                + '<p></p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">YEAR</p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">SOURCE</p>'
              + '</th>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">CMAQ v 5.0.2</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2012</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://www.epa.gov/cmaq/download-cmaq" target="_blank">https://www.epa.gov/cmaq/download-cmaq</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">T-Dep v 2018.02</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2017-2019</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://nadp.slh.wisc.edu/committees/tdep/tdepmaps/" target="_blank">https://nadp.slh.wisc.edu/committees/tdep/tdepmaps/</a></p>'
              + '</td>'
            + '</tr>'
          + '</table>'

          + '<br>'
          + '<h4>Ecosystem Components</h4>'
          + '<table class="data_sourceTable">'
            + '<tr>'
              + '<th>'
                + '<p></p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">YEAR</p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">SOURCE</p>'
              + '</th>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord" title="The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams">Aquatic</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2020</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Lynch, J.A., Phelan, J., Pardo, L.H., McDonnell, T.C., Clark, C.M., and Bell, M.D.  2020. Detailed Documentation of the National Critical Load Database (NCLD) for U.S. Critical Loads of Sulfur and Nitrogen, version 3.1, National Atmospheric Deposition Program, Wisconsin State Laboratory of Hygiene, Madison, WI.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord" title="Epiphytic lichens">Lichens</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2019</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Geiser, L.H., P.R. Nelson, S. Jovan, H.T. Root, and C.M. Clark. 2019. Assessing ecological risks from atmospheric deposition of nitrogen and sulfur to US forests using epiphytic macrolichens. <i>Diversity</i> 11(6): 87. <a href="https://doi.org/10.3390/d11060087" target="_blank">doi:10.3390/d11060087</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2021</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Geiser, L.H., H.T. Root, R.J. Smith, S. Jovan, L. St. Clair, , and K.L. Dillman. 2021. Lichen-based critical loads for deposition of nitrogen and sulfur in US forests. <i>Environmental Pollution</i> 291: 118187. <a href="https://doi.org/10.1016/j.envpol.2021.118187" target="_blank">doi:10.1016/j.envpol.2021.118187</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2020</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Jovan, S., S. Will-Wolf, L. Geiser, K. Dillman, M. Halderman, and R. Shory. 2020. <i>User guide for the national Forest Inventory and Analysis lichen database</i> (Version 1.0). Gen. Tech. Rep. PNW-GTR-988. Portland, OR: U.S. Department of Agricutlure, Forest Service, Pacific Northwest Research Station. 83 p.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2020</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Lynch, J.A., J. Phelan, L.H. Pardo, T.C. McDonnell, C.M. Clark, M.D. Bell, L.H. Geiser, and R.J. Smith. 2020. <i>National Critical Load Database (NCLD) for U.S. Critical Loads of Sulfur and Nitrogen (version 3.2)</i>. National Atmospheric Deposition Program, Wisconsin State Laboratory, Madison, WI.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2022</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Smith, R.J., T. Ohlert, and L.H. Geiser. 2022. Embracing uncertainty and probabilistic outcomes for ecological critical loads. <i>Ecosystems</i>. In review.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Trees</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2018</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Horn, K.J., Thomas, R.Q., Clark, C.M., Pardo, L.H., Fenn, M.E., Lawrence, G.B., Perakis, S.S., Smithwick, E.A., Baldwin, D., Braun, S. and Nordin, A., 2018. Growth and survival relationships of 71 tree species with nitrogen and sulfur deposition across the conterminous US. PloS one, 13(10), p.e0205296.</p>'
              + '</td>'
            + '</tr>'
          + '</table>'

          + '<br>'
          + '<h4>Area Boundaries</h4>'
          + '<table class="data_sourceTable">'
            + '<tr>'
              + '<th>'
                + '<p></p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">YEAR</p>'
              + '</th>'
              + '<th>'
                + '<p class="glossDef">SOURCE</p>'
              + '</th>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Class 1</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2020</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://www.arcgis.com/home/item.html?id=65d1ba1e458c4874955b6694fb72ae55" target="_blank">https://www.arcgis.com/home/item.html?id=65d1ba1e458c4874955b6694fb72ae55</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Fish & Wildlife Service</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2015</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://www.fws.gov/refuges/AirQuality/maps.html" target="_blank">https://www.fws.gov/refuges/AirQuality/maps.html</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Forest Service</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2021</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.AdministrativeForest.xml" target="_blank">https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.AdministrativeForest.xml</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">National Park Service</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2021</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://irma.nps.gov/DataStore/Reference/Profile/2224545?lnv=True" target="_blank">https://irma.nps.gov/DataStore/Reference/Profile/2224545?lnv=True</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Tribal Lands</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2018</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://edg.epa.gov/metadata/catalog/search/resource/details.page?uuid=%7B8077CD55-74FB-4107-8047-3DEC0D55966A%7D" target="_blank">https://edg.epa.gov/metadata/catalog/search/resource/details.page?uuid=%7B8077CD55-74FB-4107-8047-3DEC0D55966A%7D</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Wilderness</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://wilderness.net/visit-wilderness/gis-gps.php" target="_blank">https://wilderness.net/visit-wilderness/gis-gps.php</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Level 1-3 Ecoregions</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">2010</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="https://www.epa.gov/eco-research/ecoregions-north-america" target="_blank">https://www.epa.gov/eco-research/ecoregions-north-america</a></p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Ecological Classification System (ECS)</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"></p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef"><a href="" target="_blank"></a></p>'
              + '</td>'
            + '</tr>'
          + '</table>'

          + '')
        .style({"display":"none", "padding":"30px"});







      d3.select("#container")
        .append("div")
        .attr("id", "container-version")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Version History</u></b></p>'

        + '')
        .style({"display":"none", "padding":"30px"});







      d3.select("#container")
        .append("div")
        .attr("id", "container-glossary")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Glossary</u></b></p>'
          + '<table id="glossTable">'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Aquatic</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The aquatic ecosystem component in CLAS includes acidification critical load & exceedance information for ~170,000 sensitive lakes and streams.</p>'
                //+ '<div class="glossDefDiv">'
                  //+ '<p>Topographic - elevation, slope, aspect<br>Climactic - temperature, precipitation<br>Soil parameters - drainage, pH</p>'
                //+ '</div>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">CL for decrease in Growth</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The level of deposition below which there is no decrease in the growth rate of a particular tree species.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">CL for decrease in Survival</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The level of deposition below which there is no decrease in the survival rate of a particular tree species.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Class I Area</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Class I federal lands include areas such as national parks, national wilderness areas, and national monuments. These areas are granted special air quality protections under Section 162(a) of the federal Clean Air Act.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">CMAQ</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">CMAQ (The Community Multiscale Air Quality Modeling System) is an open-source EPA development project that includes maps of nitrogen and sulfur total deposition. CMAQ deposition maps were used to calculate exceedances for the Lichen ecosystem component. </p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Composite airscore CL</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">A Composite airscore is a community-weighted mean of the deposition values at which each species experiences its peak detection frequency. Airscores represent the collective pollution tolerance of species in a plot. The composite airscore CL is the level of deposition above which there is a non-zero shift from low to high airscores.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Critical Load (CL)</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">A critical load is defined as the level of deposition below which no harmful effects occur over the long term (UBA 2004).</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Cyanolichen abundance CL</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Cyanolichen abundance is the sum of abundance ratings for cyanolichens detected at a site, for species with abundance ratings of 3 or 4. The cyanolichen abundance CL is the level of deposition above which there is a 20% decline from peak abundance of sensitive cyanolichen species.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Ecological Classification System (ECS) Area</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The ECS areas in CLAS are at the Sections level. This shows units that are alike based on origin of glacial deposits, regional elevation, distribution of plants, and regional climate.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Ecoregion</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Ecoregions are areas where ecosystems are generally similar. The CEC ecoregion classification system has four levels, of which only the first three are currently included in CLAS. "Level I" divides North America into 15 broad ecoregions. "Level 2" subdivides those regions again into 52 smaller ecoregions. "Level 3" subdivides those regions again into 182 ecoregions.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Epiphytic macrolichens</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Epiphytic macrolichens are those that grow on trees and shrubs. They are sensitive to N-and S-containing air pollutants due to their exposed location in tree canopies, dependence on atmospheric sources of nutrition, and unique physiology and morphology.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Exceedance (EXC)</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The amount by which the actual load of deposition is greater than the critical load.<br>Exceedance = total deposition - critical load.<br>Exceedance is a simple way to characterize the risk to an ecosystem from deposition.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Federal Administrative Area</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Federal Administrative Areas included in CLAS are: Fish and Wildlife Service designated wilderness areas and wilderness study areas, Forest Service national forest system lands, and National Park Service national park system units.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Forage lichen abundance CL</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Forage lichen abundance is the sum of abundance ratings for forage lichens at a site, for species with abundance ratings of 3 or 4. The forage lichen abundance CL is the level of deposition above which there is a 20% decline from peak abundance of sensitive forage lichen species.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Harmful Ecological Effects</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Harmful ecological effects include: detrimental responses for lichens and trees at the tissue level (nutrient deficiencies, nutrient imbalances), at the plant level (declines in growth, survival, and health), at the community level (decreased species richness, shifts in community composition), and at the ecosystem level (increases in watershed nitrate export); and a shift from N limitation to P limitation, acidification impacts, and eutrophication responses in sensitive lakes and streams.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Lichens</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The lichen ecosystem component in CLAS includes critical load & exceedance information for epiphytic macrolichens which are recognized as "sensitive receptors" that are highly responsive to air pollution.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Negative Consequences of Increased N or S Deposition</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Negative consequences of increased N or S deposition include: detrimental responses for lichens and trees at the tissue level (nutrient deficiencies, nutrient imbalances), at the plant level (declines in growth, survival, and health), at the community level (decreased species richness, shifts in community composition), and at the ecosystem level (increases in watershed nitrate export); and a shift from N limitation to P limitation, acidification impacts, and eutrophication responses in sensitive lakes and streams.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Nitrogen Deposition</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The input of nitrogen from the atmosphere to ecosystems in wet and dry forms (including rain, snow, fog, gas, particles). Nitrogen is a pollutant emitted during fossil fuel combustion and farming.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Nitrogen+Sulfur Deposition</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">For the aquatic ecosystem component, CLAS offers a total acid inputs deposition type which includes the combined effect of Nitrogen deposition + Sulfur deposition.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Optimal Growth</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Based on ecology and plant nutrition, for a given species, there is a range of values for each parameter within which that species grows best.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Sensitive-species richness CL</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Sensitive-species richness is the count of N- and S-sensitive species at a site. The sensitive-species richness CL is the level of deposition above which there is a 20% decline from peak richness of the most sensitive species.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Sulfur Deposition</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The input of sulfur from the atmosphere to ecosystems in wet and dry forms (including rain, snow, fog, gas, particles). Sulfur is a pollutant emitted during fossil fuel combustion.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Summary of all tree species</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">CLAS provides tree maps summarizing the CL/EXC information for all Horn et al. (2018) species present in a plot. The CL and EXC are presented in three ways, based on: (1) Minimum CL - the most protective critical load for a plot. (2) Median - the median CL value for all Horn et al. (2018) trees in a plot. (3) 5th Percentile - the CL value that protects 95% of the Horn et al. (2018) trees present in a plot.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">TDep</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Maps summing dry and wet deposition of nitrogen and sulfur (total deposition) are created as part of the National Atmospheric Deposition Program. TDep deposition maps were used to calculate exceedances for the Aquatic and Trees ecosystem components.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Total species richness CL</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">Total species richness is the count of all of epiphytic macrolichen species at a site. The total species richness CL is the level of deposition above which there is a 20% decline from peak species richness.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Trees</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The tree ecosystem component in CLAS includes critical load & exceedance information for the 94 tree species analyzed by Horn et al. (2018) at ~120,000 FIA plot locations.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Tribal Land</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">The Tribal Lands area layer includes locations of American Indian Tribal lands in the lower 48 states. The areas include all lands associated with Federally recognized tribal entities.</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Uncertainty</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">CLAS uses a 5-point scale to rate uncertainty for each ecosystem component where 5 represents the best score (most certain) and 1 represents the worst score (least certain).</p>'
              + '</td>'
            + '</tr>'
            + '<tr>'
              + '<td>'
                + '<p class="glossWord">Wilderness Area</p>'
              + '</td>'
              + '<td>'
                + '<p class="glossDef">A Wilderness area is a potected area of undeveloped federal land retaining its primeval character and influence, without permanent improvements or human habitation; where the earth and community of life are untrammeled by humans.</p>'
              + '</td>'
            + '</tr>'
          + '</table>'
          + '')
        .style({"display":"none", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-results")
        //.attr("class", "container-menu")
        .html('<span id="results_glyph" class="glyphicon glyphicon-remove-circle pull-right" onclick="d3.select(\'#container-results\').style(\'display\', \'none\'); d3.selectAll(\'.canvasChart\').classed(\'selected\', false);" title="Click to close results window"></span><img id="resImg">');



      //******Add menu actions
      d3.select("#home").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#right_panel").style("display", "none");});
      d3.select("#basics").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#approach").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#guide").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#tutorial").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#faq").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#data_sources").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#version").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#glossary").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#feedback").on("click", function() {var tmpAct = d3.select("#mainMenu").select(".active"); d3.select("#mainMenu").selectAll("li").classed("active", false); tmpAct.classed("active", true);});








      //******Make splash screen
      d3.select("body")
        .append("div")
        .attr("id","splashScreen")
        .attr("class", "msgBackgroundDiv")
        .append("div")
        .attr("id", "splashScreenDiv")
        .attr("class", "popupDiv")
        .append("p")
        .attr("id", "splashWelcome")
        .attr("class", "popupTitle")
        .html('Welcome to CLAS!');

      d3.select("#splashScreenDiv")
        .append("div")
        //.style({"margin-left":"-54px", "margin-right":"-44px"})
        .html('<div id="welcomeBannerDiv"><img id="welcomeBannerImg" src="images/welcome_banner.png"></img></div>');
        //.html('<div class="welcomeBanner" style="background:#D44821;z-index:7"></div><div class="welcomeBanner" style="background:#FFA200;z-index:6;"></div><div class="welcomeBanner" style="background:#ADAD48;z-index:5;"></div><div class="welcomeBanner" style="background:#5C8A5C;z-index:4;"></div><div class="welcomeBanner" style="background:#2D7E86;z-index:3;"></div><div class="welcomeBanner" style="background:#175282;z-index:2;"></div><div class="welcomeBanner" style="background:#8C406C;z-index:1;"></div>');

      d3.select("#splashScreenDiv")
        .append("p")
        .html('CLAS is a <b>critical load</b> and <b>exceedance</b> mapping tool that facilitates assessment of risk to forest and aquatic ecosystems for resource managers and policy makers.')
        .style({"font-size":"23px","margin-top":"30px","text-align":"left"}); 

      d3.select("#splashScreenDiv")
        .append("p")
        .html('You can access maps of exceedance of the critical load of <span class="N_span"><b>Nitrogen</b></span> and <span class="S_span"><b>Sulfur</b></span> deposition for:')
        .style({"font-size":"22px","text-align":"left", "margin-top":"30px"});

      d3.select("#splashScreenDiv")
        .append("div")
        .style({"width":"80%", "margin":"auto"})
        .html('<div class="welcomePics" title="The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams"><img class="welcomeImg" src="images/aquatic.png"></img><p class="welcomeP">Sensitive<br>Lakes & Streams</p></div>'
          + '<div class="welcomePics" title="Epiphytic Lichens"><img class="welcomeImg" src="images/lichens.png"></img><p class="welcomeP">Lichens</p></div>'
          + '<div class="welcomePics" title="Trees"><img class="welcomeImg" src="images/trees.png"></img><p class="welcomeP">Trees</p></div>'
        );



      d3.select("#splashScreenDiv")
        .append("div")
        .style("display", "inline-block")
        .append("label")
        .style({"font-weight": "normal", "margin": "0"})
        .property("title", "Check box to prevent this screen from displaying on future website visits")
        .html('<input type="checkbox" id="disableSplash" style="margin-right:5px;position:relative;top:3px;">Check to prevent default display</input>');

      d3.select("#splashScreenDiv")
        .append("div")
        .attr("id", "welContDiv")
        .html('<button id="welContBtn" class="nxtBtn" title="Click to continue to tutorial">Continue</button>');

      d3.selectAll("#splashScreen,#welContBtn")
        .on("click", function() { 
          d3.select("#splashScreen").style("display", "none"); 
          localStorage.setItem('disableSplash', d3.select("#disableSplash").property("checked"));
          startIntro();
        });

      d3.select("#splashScreenDiv")
        .on("click", function() { event.stopPropagation(); });

 




      //******Make exceedance pop up
      d3.select("body")
        .append("div")
        .attr("id","excScreen")
        .attr("class", "msgBackgroundDiv")
        .append("div")
        .attr("id", "excScreenDiv")
        .attr("class", "popupDiv")
        .html(''
          + '<h3><b>Exceedance (EXC) Map Types</b></h3>'
          + '<p style="text-align:left;font-size:18px;">CLAS produces three different types of EXC map outputs:</p>'
          + '<div id="excListDiv">'
            + '<div><div class="excListNumber">1.</div><div class="excListTerm"><b>Exceedance :</b></div><div class="excListDef">Shows whether deposition is below, at, or above the CL.</div></div>'
            + '<div><div class="excListNumber">2.</div><div class="excListTerm"><b>Magnitude of EXC :</b></div><div class="excListDef">Shows how much EXC there is. Blue indicates that there is no EXC (deposition does not exceed the CL).</div></div>'
            + '<div><div class="excListNumber">3.</div><div class="excListTerm"><b>Magnitude of EXC +/- :</b></div><div class="excListDef">Shows how much EXC there is. Includes how much lower deposition is than the CL (how much more pollution can be deposited before the CL is exceeded).</div></div>'
          + '</div>'

          + '<div id="infoAquaticImgDiv">'
            + '<img class="excImg" src="images/aquatic_exc_type1_popup.jpg"></img>'
            + '<img class="excImg" src="images/aquatic_exc_type2_popup.jpg"></img>'
            + '<img class="excImg" src="images/aquatic_exc_type3_popup.jpg" style="margin-right:0px;"></img>'
            + '<p style="text-align:left;margin:0px;">In CLAS:'
              + '<ul style="list-style-type:none;text-align:left;">'
                + '<li>Deposition <b>Below</b> CL = deposition \<3 meq (m<sup>2</sup>)<sup>-1</sup> yr<sup>1</sup> below the CL.</li>'
                + '<li>Deposition <b>At</b> CL = deposition within <u>+</u>3 meq (m<sup>2</sup>)<sup>-1</sup> yr<sup>1</sup> of the CL.</li>'
                + '<li>Deposition <b>Above</b> CL = deposition \>3 meq (m<sup>2</sup>)<sup>-1</sup> yr<sup>1</sup> above the CL.</li>'
              + '</ul>'
            + '</p>'
          + '</div>'

          + '<div id="infoLichensImgDiv">'
            + '<img class="excImg" src="images/lichens_exc_type1_popup.jpg"></img>'
            + '<img class="excImg" src="images/lichens_exc_type2_popup.jpg"></img>'
            + '<img class="excImg" src="images/lichens_exc_type3_popup.jpg" style="margin-right:0px;"></img>'
            + '<p style="text-align:left;margin:0px;">In CLAS:'
              + '<ul style="list-style-type:none;text-align:left;">'
                + '<li>Deposition <b>Below</b> CL = deposition \<0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> below the CL.</li>'
                + '<li>Deposition <b>At</b> CL = deposition within <u>+</u>0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> of the CL.</li>'
                + '<li>Deposition <b>Above</b> CL = deposition \>0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> above the CL.</li>'
              + '</ul>'
            + '</p>'
          + '</div>'

          + '<div id="infoTreesImgDiv">'
            + '<img class="excImg" src="images/trees_exc_type1_popup.jpg"></img>'
            + '<img class="excImg" src="images/trees_exc_type2_popup.jpg"></img>'
            + '<img class="excImg" src="images/trees_exc_type3_popup.jpg" style="margin-right:0px;"></img>'
            + '<p style="text-align:left;margin:0px;">In CLAS:'
              + '<ul style="list-style-type:none;text-align:left;">'
                + '<li>Deposition <b>Below</b> CL = deposition \<0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> below the CL.</li>'
                + '<li>Deposition <b>At</b> CL = deposition within <u>+</u>0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> of the CL.</li>'
                + '<li>Deposition <b>Above</b> CL = deposition \>0.5 kg ha<sup>-1</sup> yr<sup>-1</sup> above the CL.</li>'
              + '</ul>'
            + '</p>'
          + '</div>'
        );


      d3.selectAll("#excScreen,#excScreenDiv")
        .on("click", function() { 
          d3.select("#excScreen").style("display", "none"); 
        });







     //******Make layer controller
      //***baselayers
      var layerNames = { "unc": {} };
      layerNames.baseLayers = {"Google Terrain": googleTerrain, "Google Hybrid": googleHybrid, "Google Satellite": googleSatellite, "Google Street": googleStreet, "Bing Hybrid": bingHybrid, "Bing Satellite": bingSatellite, "Bing Street": bingStreet, "USGS Topo": usgsTopo, "State Outlines": states, "None": blank};
      layerNames.baseLayers.keys = d3.keys(layerNames.baseLayers);
      layerNames.baseLayers.values = d3.values(layerNames.baseLayers);

      //***Abiotic layers
      layerNames.abiotics = {};
      abioticTitles.forEach(function(tmpTitle,i) {
        layerNames.abiotics[tmpTitle] = abioticLayers[i];
      });
      layerNames.abiotics.keys = d3.keys(layerNames.abiotics);
      layerNames.abiotics.values = d3.values(layerNames.abiotics);

      //***Aquatic layers
      layerNames.aquatic = {};
      layerNames.unc.aquatic = {};
      aquaticTitles.forEach(function(tmpTitle,i) {
        layerNames.aquatic[tmpTitle] = aquaticLayers[i];
        layerNames.unc.aquatic[tmpTitle + "_unc"] = aquaticLayersUnc[i];
      });
      layerNames.aquatic.keys = d3.keys(layerNames.aquatic);
      layerNames.aquatic.values = d3.values(layerNames.aquatic);

      //***Lichen layers
      layerNames.lichens = {};
      layerNames.unc.lichens = {};
      lichenTitles.forEach(function(tmpTitle,i) {
        layerNames.lichens[tmpTitle] = lichenLayers[i];
        layerNames.unc.lichens[tmpTitle + "_unc"] = lichenLayersUnc[i];
      });
      layerNames.lichens.keys = d3.keys(layerNames.lichens);
      layerNames.lichens.values = d3.values(layerNames.lichens);

      //***Tree community layers
      layerNames.trees = {};
      layerNames.unc.trees = {};
      treeComTitles.forEach(function(tmpTitle,i) {
        layerNames.trees[tmpTitle] = treeComLayers[i];
        layerNames.unc.trees[tmpTitle + "_unc"] = treeComLayersUnc[i];
      });
      layerNames.trees.keys = d3.keys(layerNames.trees);
      layerNames.trees.values = d3.values(layerNames.trees);


      //***Area layers
      layerNames.areas = {};
      areaTitles.forEach(function(tmpTitle,i) {
        layerNames.areas[tmpTitle] = areaLayers[i];
      });
      layerNames.areas.keys = d3.keys(layerNames.areas);
      layerNames.areas.values = d3.values(layerNames.areas);
      //***FS Wilderness that are Class 1
      layerNames.areas.fs_wild_class1 = ["Boundary Waters Canoe Area Wilderness", "Great Gulf Wilderness", "Lye Brook Wilderness", "Presidential Range-Dry River Wilderness", "Rainbow Lake Wilderness"];

      //***Species layers
      layerNames.species = {};
      speciesID.forEach(function(tmpTitle,i) {
        layerNames.species[tmpTitle] = {}
        layerExt.forEach(function(tmpExt,j) {
          layerNames.species[tmpTitle][tmpExt] = speciesLayers[i][j];
        });
      });
      layerNames.species.keys = d3.keys(layerNames.species); 
      layerNames.species.values = d3.values(layerNames.species);
      layerNames.species.keys.forEach(function(key) {
        layerNames.species[key].keys = d3.keys(layerNames.species[key]);
        layerNames.species[key].values = d3.values(layerNames.species[key]);
      });

      //***Community layers
      layerNames.community = {};
      commTitles.forEach(function(tmpTitle,i) {
        layerNames.community[tmpTitle] = commLayers[i];
      });
      layerNames.community.keys = d3.keys(layerNames.community);
      layerNames.community.values = d3.values(layerNames.community);
      
      

      //******Add spacer span to toolbar
      d3.select("#toolbar")
        .append("span")
        .attr("class", "spacerSpan");




      //******Add toolbar tools
      //***Baselayers
      d3.select("#toolbar")
        .on("dblclick", function() { event.stopPropagation(); })
        .append("div")
        .attr("id", "mapTools")
        .append("div")
        .attr("id", "baselayerSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "baselayerList")
        .attr("class", "cl_select")
        .property("title", "Click to change map baselayer")
        .html('<span class="layerHeader">Map Baselayer</span><span id="baselayerListHeader">Change Map Baselayer</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#baselayerListDropdown").style("display") == "none") {d3.select("#baselayerListDropdown").style("display", "inline-block");} else {d3.select("#baselayerListDropdown").style("display", "none");} });;

      d3.select("#baselayerSelect")
        .append("div")
        .attr("id", "baselayerListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add baselayer options
      d3.select("#baselayerListDropdown").selectAll("div")
        .data(layerNames.baseLayers.keys)
        .enter()
          .append("div")
          .attr("class", function(d,i) { if(i == 8) {d3.select("#baselayerListHeader").text(d); return "layerName activeLayer";} else {return "layerName";} })
          //.text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeBaselayer(this); })
          .append("span")
          .attr("class", function(d,i) { if(i == 8) {return "glyphicon glyphicon-check";} else {return "glyphicon glyphicon-unchecked";} })
          .style("order", "0");
          //.style("visibility", function(d,i) { if(i == 8) {return "visible";} else {return "hidden";} });

      d3.select("#baselayerListDropdown").selectAll("div")
        .append("span")
        .text(function(d) { return d;});


      //******Initialize baselayer
      map.addLayer(states);
      var oldBaseLayerIndex = 8;



      //******Function to change baselayer on select change
      function changeBaselayer(tmpDiv) {
        //***Remove old layer
        var layerDivs = d3.select("#baselayerListDropdown").selectAll("div");
        
        layerDivs[0].forEach(function(tmpLayer) {
          if(d3.select(tmpLayer).classed("activeLayer")) {
            d3.select(tmpLayer).classed("activeLayer", false);
            d3.select(tmpLayer).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
            map.removeLayer(layerNames.baseLayers.values[d3.select(tmpLayer).property("value")]);
          }
          //if(d3.select(tmpLayer).select("span").style("visibility") == "visible") {
          //  d3.select(tmpLayer).select("span").style("visibility", "hidden");
          //  map.removeLayer(layerNames.baseLayers.values[d3.select(tmpLayer).property("value")]);
          //}
        });

        //***Add new layer
        //d3.select(tmpDiv).select("span").style("visibility", "visible");
        d3.select(tmpDiv).classed("activeLayer", true);
        d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
        d3.select("#baselayerListHeader").text(tmpDiv.title);
        map.addLayer(layerNames.baseLayers.values[tmpDiv.value]);
        layerNames.baseLayers.values[tmpDiv.value].bringToBack();       
      }






      //***Abiotic layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "abioticSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "abioticList")
        .attr("class", "cl_select")
        .property("title", "Click to select abiotic layers to display on map")
        .html('<span id="abioticListHeader">Deposition Map Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#abioticListDropdown").style("display") == "none") {d3.select("#abioticListDropdown").style("display", "inline-block");} else {d3.select("#abioticListDropdown").style("display", "none");} });;

      d3.select("#abioticSelect")
        .append("div")
        .attr("id", "abioticListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add abiotic options
      d3.select("#abioticListDropdown").selectAll("div")
        .data(layerNames.abiotics.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          //.text(function(d) { return d; })
          .attr("data-img", "geoserver")
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeAbiotic(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");
          //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

      d3.select("#abioticListDropdown").selectAll("div")
        //.append("span")
        .append("div")
        .style("margin", 0).style("display", "inline-block")
        .html(function(d) { return d; });

      //******Add Geoserver Deerfield HUC8 layer to map
      //map.addLayer(gsHuc8);

      //******Function to add/remove abiotic layer
      function changeAbiotic(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeLayer")) {
          d3.select(tmpDiv).classed("activeLayer", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
          //map.removeLayer(layerNames.abiotics.values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
        else {
          //***remove any added layer
          d3.select("#abioticListDropdown").selectAll(".activeLayer").each(function() {
            $(this).click();
          });

          d3.select(tmpDiv).classed("activeLayer", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
          //map.addLayer(layerNames.abiotics.values[tmpDiv.value]);
          //layerNames.abiotics.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.abiotics.values[tmpDiv.value], ["abiotics",tmpDiv.title], tmpDiv);
        }
      }




      //***Species layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "speciesSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "speciesList")
        .attr("class", "cl_select")
        .property("title", "Click to select species layers to display on map")
        .html('<span id="speciesListHeader">CL & EXC Map Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#speciesListDropdown").style("display") == "none") {d3.select("#speciesListDropdown").style("display", "inline-block");} else {d3.select("#speciesListDropdown").style("display", "none");} });;

      d3.select("#speciesSelect")
        .append("div")
        .attr("id", "speciesListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") })
        .on("dblclick", function() { event.stopPropagation(); })
        .on("wheel", function() { event.stopPropagation(); })
        .on("mousemove", function() { event.stopPropagation(); })
        .append("div")
        .attr("id", "indSppDiv")
        .attr("class", "collapse in");

      //******Add species options
      d3.select("#indSppDiv").selectAll("div")
        .data(layerNames.species.keys)
        .enter()
          .append("div")
          .html(function(d,i) { return '<div class="indSpp" value="' + i + '" name="' + d + '" title="' + speciesTitles[i] + " (" + speciesNames[i] + ")" + '" data-toggle="collapse" data-target="#' + d + 'Suboptions">' + speciesTitles[i] + '<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="' + d + 'Suboptions" value="' + i + '" name="' + d + '"></div>'; });

      //***Add species layer suboptions
      d3.selectAll(".sppSuboptDiv")[0].forEach(function(tmpDiv,i) {
        d3.select(tmpDiv).selectAll("div")
          .data(layerNames.species[d3.select(tmpDiv).attr("name")].keys)
          .enter()
            .append("div")
            .attr("class", "sppSubopt")
            //.text(function(d,i) { return layerExtTitles[i]; })
            .property("value", function(d,i) { return i; })
            .property("name", function(d,i) { return d3.select(tmpDiv).attr("name") + layerExt[i]; }) 
            .property("title", function(d,i) { return speciesTitles[d3.select(tmpDiv).attr("value")] + " " + layerExtTitles[i]; })
            .on("click", function(d,i) { changeSpecies(this, d3.select(tmpDiv).attr("name"), layerExt[i]); })
            .append("span")
            .attr("class", "glyphicon glyphicon-unchecked");
            //.style("visibility", "hidden");

        d3.select(tmpDiv).selectAll("div")
          .append("span")
          .text(function() { return this.parentNode.title; });
      });

/*
      //******Function to add/remove species layer
      function changeSpecies(tmpDiv, spp, filePart) {
        if(!d3.select(tmpDiv).classed("activeLayer")) {
          d3.select(tmpDiv).classed("activeLayer", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
          if(d3.select(tmpDiv.parentNode).attr("id") == spp + "Suboptions") {
            if(document.getElementById(spp + "SuboptionsMap")) {
              d3.select(d3.select("#" + spp + "SuboptionsMap").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "visible");
            }
          }
          else {
            d3.select(d3.select("#" + spp + "Suboptions").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "visible");
          }
          //map.addLayer(layerNames.species[spp].values[tmpDiv.value]);
          //layerNames.species[spp].values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.species[spp].values[tmpDiv.value], ["species",spp,filePart]);
        } 
        else {
          d3.select(tmpDiv).classed("activeLayer", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
          if(d3.select(tmpDiv.parentNode).attr("id") == spp + "Suboptions") {
            if(document.getElementById(spp + "SuboptionsMap")) {
              d3.select(d3.select("#" + spp + "SuboptionsMap").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "hidden");
            }
          }
          else {
            d3.select(d3.select("#" + spp + "Suboptions").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "hidden");
          }
          //map.removeLayer(layerNames.species[spp].values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
      }
*/



      //******Add Components to CL, CC, and EXC dropdown

      //******Aquatic
      d3.select("#speciesListDropdown")
        .append("div")
        //.style("border-top", "2px solid #666666")
        .html('<div class="layerName dropHeader" title="The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams" data-toggle="collapse" data-target="#aquaticExcDiv">Aquatic<span class="spacerSpan"</span><span class="glyphicon glyphicon-triangle-bottom pull-right excSpan"></span></div><div class="sppSuboptDiv collapse" id="aquaticExcDiv"></div>'
          + '<div class="layerName dropHeader" title="Epiphytic Lichens" data-toggle="collapse" data-target="#lichenExcDiv">Lichens<span class="spacerSpan"</span><span class="glyphicon glyphicon-triangle-bottom pull-right excSpan"></span></div><div class="sppSuboptDiv collapse" id="lichenExcDiv"></div>'
          + '<div class="layerName dropHeader" title="Trees" data-toggle="collapse" data-target="#treeExcDiv">Trees<span class="spacerSpan"</span><span class="glyphicon glyphicon-triangle-bottom pull-right excSpan"></span></div><div class="sppSuboptDiv collapse" id="treeExcDiv"></div>'
        );

      //******Split N and S
      d3.select("#aquaticExcDiv").html(''
        + '<div id="natMapsAquaticN" class="resMenuSubHeader N active" data-toggle="collapse" data-target="#natMapsAquaticSubMenuN">N+S Deposition</div>'
        + '<div id="natMapsAquaticS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#natMapsAquaticSubMenuS">S Deposition</div>'              
        + '<div id="natMapsAquaticSubMenuN" class="collapse in"></div>'
        + '<div id="natMapsAquaticSubMenuS" class="collapse"></div>'
      );

      //***Split keys into deposition type
      var nKeys = layerNames.aquatic.keys.filter(function(key) { return key.includes(">NS Dep"); });
      var sKeys = layerNames.aquatic.keys.filter(function(key) { return key.includes(">S Dep"); });

      //******Add aquatic options
      var tmpDiv = ["#natMapsAquaticSubMenuN", "#natMapsAquaticSubMenuS"];
      [nKeys, sKeys].forEach(function(keyData, i) {
        d3.select(tmpDiv[i]).selectAll("div")
        //d3.select("#aquaticExcDiv").selectAll("div")
          //.data(layerNames.aquatic.keys)
          .data(keyData)
          .enter()
            .append("div")
            .attr("class", "layerName")
            .attr("data-img", function(d, i) { return aquaticLegImg[layerNames.aquatic.keys.indexOf(d)]; })
            .attr("data-layer", function(d) {
              if(d.includes("Critical")) {
                if(d.includes("NS Dep")) {
                  return '<p><b>Critical Load for acidification</b><br>Aquatic<br><span class="N_span">N+S Deposition</span></p>';
                }
                else {
                  return '<p><b>Critical Load for acidification</b><br>Aquatic<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("Exceedance:")) {
                if(d.includes("NS Dep")) {
                  return '<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class="N_span">N+S Deposition</span></p>';
                }
                else {
                  return '<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC:")) {
                if(d.includes("NS Dep")) {
                  return '<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class="N_span">N+S Deposition</span></p>';
                }
                else {
                  return '<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC +/-:")) {
                if(d.includes("NS Dep")) {
                  return '<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class="N_span">N+S Deposition</span></p>';
                }
                else {
                  return '<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;S_span&quot;>S Deposition</span></p>';
                }
              }
            })
            .attr("data-comp", "Aquatic")
            .property("value", function(d,i) { return layerNames.aquatic.keys.indexOf(d); })
            .property("title", function(d) { return d; })
            .property("name", function(d,i) { return aquaticID[layerNames.aquatic.keys.indexOf(d)]; })
            .on("click", function() { changeAquatic(this); })
            .append("span")
            .attr("class", "glyphicon glyphicon-unchecked");
            //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

        //d3.select("#aquaticExcDiv").selectAll("div")
        d3.select(tmpDiv[i]).selectAll("div")
          .append("div")
          .style("margin", 0).style("display", "inline-block")
          .html(function(d) { return d; });

        //******Function to add/remove abiotic layer
        function changeAquatic(tmpDiv) {
          if(d3.select(tmpDiv).classed("activeLayer")) {
            d3.select(tmpDiv).classed("activeLayer", false);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
            remLegendImg(tmpDiv.name);
          }
          else {
            //***remove any added layer
            d3.selectAll("#speciesListDropdown,#resMapsDiv").selectAll(".activeLayer,.added").each(function() {
              $(this).click();
            });

            d3.select(tmpDiv).classed("activeLayer", true);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
            addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.aquatic.values[tmpDiv.value], ["aquatic",tmpDiv.title], tmpDiv);
          }
        }
      });




      //******Lichens
      //******Split N and S
      d3.select("#lichenExcDiv").html(''
        + '<div id="natMapsLichenN" class="resMenuSubHeader N active" data-toggle="collapse" data-target="#natMapsLichenSubMenuN">N Deposition</div>'
        + '<div id="natMapsLichenS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#natMapsLichenSubMenuS">S Deposition</div>'              
        + '<div id="natMapsLichenSubMenuN" class="collapse in"></div>'
        + '<div id="natMapsLichenSubMenuS" class="collapse"></div>'
      );

      //***Split keys into deposition type
      var nKeys = layerNames.lichens.keys.filter(function(key) { return key.includes(">N Dep"); });
      var sKeys = layerNames.lichens.keys.filter(function(key) { return key.includes(">S Dep"); });

      //******Add lichen options
      var tmpDiv = ["#natMapsLichenSubMenuN", "#natMapsLichenSubMenuS"];
      [nKeys, sKeys].forEach(function(keyData, i) {
        d3.select(tmpDiv[i]).selectAll("div")
        //d3.select("#lichenExcDiv").selectAll("div")
          //.data(layerNames.lichens.keys)
          .data(keyData)
          .enter()
            .append("div")
            .attr("class", "layerName")
            .attr("data-img", function(d, i) { return lichenLegImg[layerNames.lichens.keys.indexOf(d)]; })
            .attr("data-layer", function(d) {
              if(d.includes("Current")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Current Condition of' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Current Condition of' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("Exceedance:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Exceedance of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Exceedance of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Magnitude of Exceedance of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Magnitude of Exceedance of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC +/-:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Magnitude of Exceedance (+/-) of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Magnitude of Exceedance (+/-) of the CL for' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Lichens<br><span class=&quot;S_span&quot;>S Deposition</span></p>';
                }
              }
            })
            .attr("data-comp", "Lichens")
            .property("value", function(d,i) { return layerNames.lichens.keys.indexOf(d); })
            .property("title", function(d) { return d; })
            .property("name", function(d,i) { return lichenID[layerNames.lichens.keys.indexOf(d)]; })
            .on("click", function() { changeLichen(this); })
            .append("span")
            .attr("class", "glyphicon glyphicon-unchecked");
            //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

        d3.select(tmpDiv[i]).selectAll("div")
        //d3.select("#lichenExcDiv").selectAll("div")
          .append("div")
          .style("margin", 0).style("display", "inline-block")
          .html(function(d) { return d; });

        //******Add Geoserver Deerfield HUC8 layer to map
        //map.addLayer(gsHuc8);

        //******Function to add/remove abiotic layer
        function changeLichen(tmpDiv) {
          if(d3.select(tmpDiv).classed("activeLayer")) {
            d3.select(tmpDiv).classed("activeLayer", false);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
            //map.removeLayer(layerNames.lichens.values[tmpDiv.value]);
            remLegendImg(tmpDiv.name);
          }
          else {
            //***remove any added layer
            d3.selectAll("#speciesListDropdown,#resMapsDiv").selectAll(".activeLayer,.added").each(function() {
              $(this).click();
            });

            d3.select(tmpDiv).classed("activeLayer", true);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
            //map.addLayer(layerNames.lichens.values[tmpDiv.value]);
            //layerNames.lichens.values[tmpDiv.value].bringToFront();
            addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.lichens.values[tmpDiv.value], ["lichens",tmpDiv.title], tmpDiv);
          }
        }
      });





      //******Trees
      //******Split N and S
      d3.select("#treeExcDiv").html(''
        + '<div id="natMapsTreeN" class="resMenuSubHeader N active" data-toggle="collapse" data-target="#natMapsTreeSubMenuN">N Deposition</div>'
        + '<div id="natMapsTreeS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#natMapsTreeSubMenuS">S Deposition</div>'              
        + '<div id="natMapsTreeSubMenuN" class="collapse in"></div>'
        + '<div id="natMapsTreeSubMenuS" class="collapse"></div>'
      );

      //***Split keys into deposition type
      var nKeys = layerNames.trees.keys.filter(function(key) { return key.includes(">N Dep"); });
      var sKeys = layerNames.trees.keys.filter(function(key) { return key.includes(">S Dep"); });

      //******Add tree options
      var tmpDiv = ["#natMapsTreeSubMenuN", "#natMapsTreeSubMenuS"];
      [nKeys, sKeys].forEach(function(keyData, i) {
        d3.select(tmpDiv[i]).selectAll("div")
        //d3.select("#treeExcDiv").selectAll("div")
          //.data(layerNames.trees.keys)
          .data(keyData)
          .enter()
            .append("div")
            .attr("class", "layerName")
            .attr("data-img", function(d, i) { return treeComLegImg[layerNames.trees.keys.indexOf(d)]; })
            .attr("data-layer", function(d) {
              if(d.includes("Critical")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Critical Load for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Critical Load for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("Exceedance:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Exceedance of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Exceedance of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Magnitude of Exceedance of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Magnitude of Exceedance of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="S_span">S Deposition</span></p>';
                }
              }
              else if(d.includes("EXC +/-:")) {
                if(d.includes("N Dep")) {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Magnitude of Exceedance (+/-) of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class="N_span">N Deposition</span></p>';
                }
                else {
                  return '<p><b>Combined ' + d.slice(d.indexOf("("), d.indexOf(")") + 1) + ' Magnitude of Exceedance (+/-) of the CL for ' + d.slice(d.indexOf(":") + 1, d.indexOf("<span") - 1) + '</b><br>Trees<br><span class=&quot;S_span&quot;>S Deposition</span></p>';
                }
              }
            })
            .attr("data-comp", "Trees")
            .property("value", function(d,i) { return layerNames.trees.keys.indexOf(d); })
            .property("title", function(d) { return d; })
            .property("name", function(d,i) { return treeComID[layerNames.trees.keys.indexOf(d)]; })
            .on("click", function() { changeTrees(this); })
            .append("span")
            .attr("class", "glyphicon glyphicon-unchecked");
            //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

        d3.select(tmpDiv[i]).selectAll("div")
        //d3.select("#treeExcDiv").selectAll("div")
          .append("div")
          .style("margin", 0).style("display", "inline-block")
          .html(function(d) { return d; });

        //******Function to add/remove abiotic layer
        function changeTrees(tmpDiv) {
          if(d3.select(tmpDiv).classed("activeLayer")) {
            d3.select(tmpDiv).classed("activeLayer", false);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
            remLegendImg(tmpDiv.name);
          }
          else {
            //***remove any added layer
            d3.selectAll("#speciesListDropdown,#resMapsDiv").selectAll(".activeLayer,.added").each(function() {
              $(this).click();
            });

            d3.select(tmpDiv).classed("activeLayer", true);
            d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
            addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.trees.values[tmpDiv.value], ["trees",tmpDiv.title], tmpDiv);
          }
        }
      });








/*
      d3.select("#speciesListDropdown")
        .insert("div", ":first-child")
        .style("border-top", "2px solid #666666")
        .html('<div class="layerName" title="Individual Species" data-toggle="collapse" data-target="#indSppDiv">Individual Species<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="indSppSuboptions" name="indSpp"></div>');
*/
/*
      d3.select("#speciesListDropdown")
        .insert("div", ":first-child")
        .html('<div class="layerName" name="all" title="Combined Species" data-toggle="collapse" data-target="#allSuboptions">Combined Species<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="allSuboptions" name="all"></div>');

      d3.select("#allSuboptions").selectAll("div")
        .data(layerNames.community.keys)
        .enter()
          .append("div")
          .attr("class", "sppSubopt")
          //.text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("name", function(d,i) { return commID[i]; })
          .property("title", function(d,i) { return commTooltip[i]; })
          .on("click", function() { changeCommunity(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");
          //.style("visibility", "hidden");

      d3.select("#allSuboptions").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      d3.select("#allSuboptions")
        .insert("div", ":nth-child(5)")
        .attr("class", "commTitle")
        .text("Exceedance")
        .property("title", "Exceedance (Exc) layers");

      d3.select("#allSuboptions")
        .insert("div", ":first-child")
        .attr("class", "commTitle")
        .text("Critical Load")
        .property("title", "Critical Load (CL) layers");
*/
/*
      //******Function to add/remove area layer
      function changeCommunity(tmpDiv) {
        if(!d3.select(tmpDiv).classed("activeLayer")) {
          d3.select(tmpDiv).classed("activeLayer", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
          if(d3.select(tmpDiv.parentNode).attr("id") == "allSuboptions") {
            if(document.getElementById("allSuboptionsMap")) {
              d3.select(d3.select("#allSuboptionsMap").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "visible");
            }
          }
          else {
            d3.select(d3.select("#allSuboptions").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "visible");
          }
          map.addLayer(layerNames.community.values[tmpDiv.value]);
          layerNames.community.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, d3.select(tmpDiv).text(), layerNames.community.values[tmpDiv.value], ["community", d3.select(tmpDiv).text()]);
        } 
        else {
          d3.select(tmpDiv).classed("activeLayer", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
          if(d3.select(tmpDiv.parentNode).attr("id") == "allSuboptions") {
            if(document.getElementById("allSuboptionsMap")) {
              d3.select(d3.select("#allSuboptionsMap").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "hidden");
            }
          }
          else {
            d3.select(d3.select("#allSuboptions").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "hidden");
          }
          map.removeLayer(layerNames.community.values[tmpDiv.value]);
        }
      }
*/

      


        






      //******Add geolocater
      //d3.select("#toolbar")
      d3.select("#mapTools")
        .append("div")
        .attr("id", "bingGeoLocate");
        //.attr("class", "layerList");

      document.getElementById('bingGeoLocate').appendChild(bingGeocoder.onAdd(map));
      d3.select("#bingGeocoderInput")
        .classed("cl_select", true)
        .on("mouseup", function() { if(this.value == "No matching results") { this.value = ""; } else { $(this).select(); } })
        .on("blur", function() { modifySearch(this, "blur"); })
        .on("keyup", function() { modifySearch(this, "key"); }); // if(d3.event.keyCode == 13) { if(d3.select("#bingGeocoderSubmit").classed("glyphicon-remove") == true) { $("#bingGeocoderSubmit").click(); } } });



      function modifySearch(tmpEl, tmpEvent) {
        if(tmpEvent == "blur") {
          if((tmpEl.value == "" || tmpEl.value == "No matching results") && document.getElementById("mapIcon")) { 
            tmpEl.value = d3.select("#mapIcon").attr("value"); 
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
          else if(tmpEl.value == "No matching results" && !document.getElementById("mapIcon")) {
            tmpEl.value = "";
          }
        } 
        else if(document.getElementById("mapIcon")) {
          if(tmpEl.value != d3.select("#mapIcon").attr("value")) {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", false).classed("glyphicon-search", true);
          }
          else {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
        }
      }




      //******Make div for preferences and welcome
/*      d3.select("#toolbar")
        .append("div")
        .attr("id", "prefWelDiv")
        .html(''
            //+ '<div id="preferences" class="prefWel"><a href="#">Preferences</a></div>'
            + '<div id="welcome" class="prefWel"><a href="#">Welcome</a></div>'
          + '');

      //d3.select("#preferences").on("click", function() {toolWindowToggle("preferences");});
      d3.select("#welcome").on("click", function() {d3.select("#splashScreen").style("display", "flex");});
*/




/*
      //******Make div for legend
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "legendDiv");

      $('#legendDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#legendDiv")
        .append("h4")
        .text("Legend")
        .attr("class", "legTitle")
        .attr("id", "legendTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Legend</center></b></u></p><p>Displays legends for added map layers enabling their interpretation along with control over their transparency.</p>"</span>');
 
      d3.select("#legendTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Layers window")
        .on("click", function() { toolWindowToggle("legend"); });

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendDefault")
        .text("Add a map layer to view its legend...");

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendImgDiv")
        .html('<span id="legendPrev" class="glyphicon glyphicon-menu-left pull-left" title="View previous legend" onclick="changeLegend(\'prev\')"></span><span id="legendNext" class="glyphicon glyphicon-menu-right pull-right" title="View next legend" onclick="changeLegend(\'next\')"></span>');





      //******Change transparency of current legend layer
      function layerOpacity(tmpSlider, tmpLayer) {
        var tmpOpacity = tmpSlider.value/100; 
        tmpSlider.title = "Opacity: " + tmpSlider.value + "%"; 
        tmpLayer.setOpacity(tmpOpacity);
      } 
*/








      //******Make div for attribute retrieval
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "attDiv");

      $('#attDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#attDiv")
        .append("h4")
        .text("Identify")
        .attr("class", "legTitle")
        .attr("id", "attTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto" data-html="true" title="<p><u><b>Identify</b></u></p><p>Displays attribute value for visible overlay layers for a clicked point on the map</p>"</span>');
/* 
      d3.select("#infoTitle")
        .html(d3.select("#infoTitle").html() + '<div class="exitDiv"><span id="hideInfo" class="fa fa-times-circle" data-toggle="tooltip" data-container="body" data-placement="auto" data-html="true" title="<p>Click to hide window</p>"</span></div>'); 

      d3.select("#hideInfo")
        .on("click", function() { toolWindowToggle("info"); });
*/

      d3.select("#attTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Identify window")
        .on("click", function() { toolWindowToggle("att"); });

      d3.select("#attDiv")
        .append("div")
        .attr("id", "att")
        .append("p")
        .attr("id", "attP")
        .text("Test: nice");






  //map.addEventListener("click", getInfo);

  function getInfo(e) {
    console.log(e.latlng.lat.toFixed(3) + ", " + e.latlng.lng.toFixed(3));
    var i = -1;
    var tmpLayers = "";
    var visLayers = [];
    map.eachLayer(function(layer) { 
      i += 1;
      //***Exclude baselayer and points layer
      if(typeof layer.options.layers != "undefined" && layer.options.layers.includes("bbox_mi") == false) {
        if(tmpLayers == "") {
          tmpLayers = layer.options.layers;
        }
        else {
          tmpLayers = layer.options.layers + "," + tmpLayers;
        }
        var tmpName = layer.options.layers.split(":")[1];
        //if(infoDataType[tmpName] == "raster") {
        //  visLayers.splice(0,0,tmpName);
        //}
      }
    });

    var bbox = map.getBounds(); //.toBBoxString();
    var tmpStr = bbox._southWest.lat + "," + bbox._southWest.lng + "," + bbox._northEast.lat + "," + bbox._northEast.lng;
    var tmpWidth = map.getSize().x;
    var tmpHeight = map.getSize().y;
    var tmpI = map.layerPointToContainerPoint(e.layerPoint).x;
    var tmpJ = map.layerPointToContainerPoint(e.layerPoint).y;

    var tmpUrl = 'https://ecosheds.org/geoserver/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=' + tmpLayers + '&QUERY_LAYERS=' + tmpLayers + '&BBOX=' + tmpStr + '&FEATURE_COUNT=' + (i * 5) + '&HEIGHT=' + tmpHeight + '&WIDTH=' + tmpWidth + '&INFO_FORMAT=application/json&CRS=EPSG:4326&i=' + tmpI + '&j=' + tmpJ;
    console.log(tmpUrl);

    //send the request using jQuery $.ajax
    $.ajax({
      url: tmpUrl,
      dataType: "json",
      type: "GET",
      success: function(data) {
        //console.log(visLayers);
        var j = 0;
        var tmpText = "";
        data.features.forEach(function(tmpFeat) {
          console.log(tmpFeat);
/*
          var tmpID = tmpFeat.id.split(".")[0];
          if(tmpID != "") {
            addInfo(tmpID, tmpFeat.properties[infoIDField[tmpID]]);
          }
          else if(tmpID == "") {
            if(typeof tmpFeat.properties.PALETTE_INDEX !== "undefined") {
              var tmpObj = "PALETTE_INDEX";
            }
            else if(typeof tmpFeat.properties.GRAY_INDEX !== "undefined") {
              var tmpObj = "GRAY_INDEX";
            }
            else {
              var tmpObj = "NULL";
            }
            addInfo(visLayers[j], Math.round(tmpFeat.properties[tmpObj]));
            j += 1;
          }
          else {
            addInfo(tmpID, "");
          }
*/
        });
        d3.select("#attP").text(tmpText);
        if(d3.select("#attDiv").style("opacity") == 0) { toolWindowToggle("att"); }
        resizePanels();

        function addInfo(tmpId, tmpInfo) {
          if(tmpText == "") {
            tmpText = infoObj[tmpId] + ": " + tmpInfo;
          }
          else {
            tmpText += "\n" + infoObj[tmpId] + ": " + tmpInfo;
          }
        }
      }
    });
  }










      //******Make div for legend
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "legendDiv");

      $('#legendDiv').draggable({containment: "html", cancel: ".toggle-group,.layerLegend,textarea,button,select,option"});

      d3.select("#legendDiv")
        .append("h4")
        .text("Legend")
        .attr("class", "legTitle")
        .attr("id", "legendTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto" data-html="true" title="<p><u><b>Legend</b></u></p><p>Displays legends for active map layers.<br><br>Drag and drop layers to change their order on the map.</p>"</span>');
 /*
  d3.select("#legendTitle")
    .html(d3.select("#legendTitle").html() + '<div class="exitDiv"><span id="hideLegend" class="glyphicon glyphicon-remove pull-right minimize-button" data-toggle="tooltip" data-container="body" data-placement="auto" data-html="true" title="<p>Click to hide window</p>"</span></div>'); 

  d3.select("#hideLegend")
    .on("click", function() { toolWindowToggle("legend"); });
*/
      d3.select("#legendTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Layers window")
        .on("click", function() { toolWindowToggle("legend"); });

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendDefault")
        .text("Add a map layer to view its legend...");

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendImgDiv");

        $("#legendImgDiv").sortable({appendTo: "#legendImgDiv", containment: "#legendImgDiv", cancel: "input,textarea,button,select,option", forcePlaceholderSize: true, placeholder: "sortable-placeholder", helper: "original", tolerance: "pointer", stop: function(event, ui) { reorder(event, ui); }, start: function(event, ui) { helperPlaceholder(event, ui); }});


  //******Change the layer orders after drag and drop
  function reorder(tmpEvent, tmpUI) {
    var tmpCnt = tmpEvent.target.children.length;
    var i = 0
    for (let child of tmpEvent.target.children) {
      var tmpPath = d3.select(child).attr("value").split(",");
      curLegend[i] = d3.select(child).attr("id").slice(0,-6);
      curType[i] = tmpPath[0];
      curTitle[i] = tmpPath[1];
      if(tmpPath[0] == "abiotics") {
        curLayers[i] = layerNames[tmpPath[0]][tmpPath[1]];
      }
      else if(tmpPath[0] == "output") {
        if(d3.select("#togUncBtn").text() == "Show uncertainty") {
          curLayers[i] = resArray[0];
        }
        else {
          curLayers[i] = resArrayUnc[0];
        }
      }
      else {
        if(d3.select("#togUncBtn").text() == "Show uncertainty") {
          curLayers[i] = layerNames[tmpPath[0]][tmpPath[1]];
        }
        else {
          curLayers[i] = layerNames.unc[tmpPath[0]][tmpPath[1] + "_unc"];
        }
      }
      curLayers[i].setZIndex(tmpCnt - i);
      //layerNames[tmpPath[0]][tmpPath[1]].setZIndex(tmpCnt - i);
      i += 1;
    }

    //***Change slider layer
    curLegend.forEach(function(leg, i) {
      $("#" + leg + "LegendSlider").slider({slide: function(event, ui) { layerOpacity(ui, curLayers[i]); } });
    });


  }

  //******Style the helper and placeholder when dragging/sorting
  function helperPlaceholder(tmpEvent, tmpUI) {
    d3.select(".ui-sortable-placeholder.sortable-placeholder").style("width", d3.select("#" + tmpUI.item[0].id).style("width")).style("height", "37px");  //.style("background", "rgba(255,255,255,0.25)"); 
  }


  //******Adds images to the legend
  var curLegend = [];
  var curType = [];
  var curTitle = [];
  var curLayers = [];
  function addLegendImg(tmpName, tmpTitle, tmpLayer, tmpPath, tmpDiv) {
    curLegend.splice(0, 0, tmpName);
    curType.splice(0, 0, tmpPath[0]);
    curTitle.splice(0, 0, tmpPath[1]);
    if(tmpPath[0] == "abiotics") {
      curLayers.splice(0, 0, layerNames[tmpPath[0]][tmpPath[1]]);
    }
    else if(tmpPath[0] == "output") {
      if(d3.select("#togUncBtn").text() == "Show uncertainty") {
        curLayers.splice(0, 0, resArray[0]);
      }
      else {
        curLayers.splice(0, 0, resArrayUnc[0]);
      }
    }
    else {
      d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "block");
      d3.selectAll("#togUncBtn,#uncBtnI").style("display", "block");
      if(d3.select("#togUncBtn").text() == "Show uncertainty") {
        curLayers.splice(0, 0, layerNames[tmpPath[0]][tmpPath[1]]);
      }
      else {
        curLayers.splice(0, 0, layerNames.unc[tmpPath[0]][tmpPath[1] + "_unc"]);
      }
      //***Update map info modal box
      updateInfoBox(d3.select(tmpDiv).attr("data-layer"), output[d3.select(tmpDiv).attr("data-comp")].depSource, output[d3.select(tmpDiv).attr("data-comp")].depYear);
    }

    map.addLayer(curLayers[0]);
    curLayers[0].bringToFront();

    var tmpOpa = 1;
    curLayers[0].setOpacity(tmpOpa);

    d3.select("#legendImgDiv")
      .insert("div", ":first-child")
      .attr("id", tmpName + "Legend")
      .attr("value", tmpPath)
      .attr("class", "layerLegend")
      .attr("data-type", d3.select(tmpDiv).attr("data-type"))
      .append("div")
      .attr("id", tmpName + "LegendHeader")
      .attr("data-toggle", "collapse")
      .attr("data-target", "#" + tmpName + "collapseDiv")
      .on("click", function() { changeCaret(d3.select(this).select(".exitDiv").select("span")[0][0]); })
      .append("div")
      .attr("class", "legendTitle")
      .html('<h6>' + tmpTitle + '</h6><div class="exitDiv"><span class="fa fa-caret-up legendCollapse" title="Hide legend"></span></div>');


    function changeCaret(tmpSpan) {
      if(d3.select(tmpSpan).classed("fa-caret-down")) {
        d3.select(tmpSpan).classed("fa-caret-down", false).classed("fa-caret-up", true).property("title", "Hide legend");
      }
      else {
        d3.select(tmpSpan).classed("fa-caret-up", false).classed("fa-caret-down", true).property("title", "View legend");
      }
    }

    d3.select("#" + tmpName + "Legend")
      .append("div")
      .attr("id", tmpName + "collapseDiv")
      .attr("class", "collapseDiv collapse in")
      .append("div")
      .attr("id", tmpName + "LegImgDiv")
      .attr("class","legImgDiv")
      .append("img")
      .attr("id", tmpName + "LegendImg")
      .attr("class", "legendImg")
      .attr("data-img", d3.select(tmpDiv).attr("data-img"))
      .style("width", function() { if(tmpPath[0] != "abiotics") { if(d3.select("#togUncBtn").text() == "Show uncertainty") { return "198px"; } else { return "350px"; } } })
      .property("title", tmpTitle);

    $("#" + tmpName + "collapseDiv").on("shown.bs.collapse", function() { resizePanels(); });
    $("#" + tmpName + "collapseDiv").on("hidden.bs.collapse", function() { resizePanels(); });


    //***Set div width and offset after the image has been loaded
    if(d3.select(tmpDiv).attr("data-img") == "geoserver") {
      var tmpSrc = "https://ecosheds.org/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=nn-clas:" + tmpName;
    }
    else {
      if(d3.select("#togUncBtn").text() == "Show uncertainty") {
        var tmpSrc = d3.select(tmpDiv).attr("data-img");
      }
      else {
        var tmpSrc = d3.select(tmpDiv).attr("data-img").slice(0,-4) + "_unc.jpg";
      }
    }
    d3.select("#" + tmpName + "LegendImg").attr("src", tmpSrc);
/*
    $("#" + tmpName + "LegendImg").one("load", function() {
      var tmpRect = document.getElementById(tmpName + "LegendImg").getBoundingClientRect();
      d3.select("#" + tmpName + "LegImgDiv").style({"max-height":tmpRect.height - 67 + "px", "max-width": tmpRect.width + "px"});
      d3.select("#" + tmpName + "Legend").style("opacity", "1");     
    }).attr("src", tmpSrc);
*/

    d3.select("#" + tmpName + "collapseDiv")
      .append("div")
      .attr("id", tmpName + "LegendSlider")
      .property("title", tmpTitle + " Layer Opacity: " + tmpOpa * 100 + "%");

    $("#" + tmpName + "LegendSlider").slider({animate: "fast", min: 0, max: 100, value: tmpOpa * 100, slide: function(event, ui) { layerOpacity(ui, curLayers[0]); } });

    d3.select("#legendDefault").style("display", "none");

    d3.select("#legendImgDiv")
      .style("display", "block");

    if(d3.select("#legendDiv").style("opacity") == 0) {
      toolWindowToggle("legend");
    }

    //***Update slider layer
    curLegend.forEach(function(leg, i) {
      $("#" + leg + "LegendSlider").slider({slide: function(event, ui) { layerOpacity(ui, curLayers[i]); } });
    });

    resizePanels();
  }


  //******Removes images to the legend
  function remLegendImg(tmpName) {
    var i = curLegend.indexOf(tmpName);
    map.removeLayer(curLayers[i]);
    curLegend.splice(i, 1);
    curType.splice(i, 1);
    curTitle.splice(i, 1);
    curLayers.splice(i, 1);

    d3.select("#" + tmpName + "Legend").remove();

    var cnt = 0;
    curType.forEach(function(type) {
      if(type != "abiotic") {
        cnt += 1;
      }
    });
    if(cnt == 0) { 
      d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "none");
      d3.selectAll("#togUncBtn,#uncBtnI").style("display", "none"); 
    }

    if(d3.select("#legendImgDiv").selectAll("div")[0].length == 0) {
      d3.select("#legendImgDiv").style("display", "none");
      d3.select("#legendDefault").style("display", "block");
    }
  }


  //******Change transparency of current legend layer
  function layerOpacity(tmpSlider, tmpLayer) {
    var tmpOpacity = tmpSlider.value/100; 
    tmpSlider.title = "Opacity: " + tmpSlider.value + "%"; 
    tmpLayer.setOpacity(tmpOpacity);
  } 







      //******Make div for histograms
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "histDiv");

      $('#histDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#histDiv")
        .append("h4")
        .text("Abiotic Distributions")
        .attr("class", "legTitle")
        .attr("id", "histTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Abiotic Distributions</center></b></u></p><p>Displays frequency distributions for specified abiotic factors for currently selected areas on the map.</p>"</span>');
 
      d3.select("#histTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Abiotic Distributions window")
        .on("click", function() { toolWindowToggle("hist"); });

      d3.select("#histDiv")
        .append("div")
        .attr("id", "histDefault")
        .text("Select an area to view distributions for its abiotic factors...");

      d3.select("#histDiv")
        .append("div")
        .attr("id", "histImgDiv")
        .append("div")
        .attr("id", "histList")
        .attr("class", "cl_select")
        .property("title", "Click to select which abiotic factors to view distributions for")
        .html('<span id="abioticListHeader">Select Abiotic Factors</span><span class="glyphicon glyphicon-triangle-right pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#histListDropdown").style("display") == "none") {d3.select("#histListDropdown").style("display", "inline-block");} else {d3.select("#histListDropdown").style("display", "none");} });;
 
      d3.select("#histImgDiv")
        .append("div")
        .attr("id", "histListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      d3.select("#histImgDiv")
        .append("div")
        .attr("id", "histFigDiv");


      //******Add abiotic options
      d3.select("#histListDropdown").selectAll("div")
        .data(layerNames.abiotics.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .property("name", function(d,i) { return abioticID[i]; })
          .style("border-radius", function(d,i) { if(i == 0 || i == (layerNames.abiotics.keys.length - 1)) { return "4px"; } else { return "0"; } })
          .on("click", function() { changeAbioticHist(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeAbiotic")
          .style("visibility", "hidden");


      //******Function to add/remove abiotic histograms 
      function changeAbioticHist(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
        }
        get_abiotic_counts();
      }






      //*****Make div for preferences
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "preferencesDiv");

      $('#preferencesDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#preferencesDiv")
        .append("h4")
        .text("Preferences")
        .attr("class", "legTitle")
        .attr("id", "preferencesTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Preferences</center></b></u></p><p>Set preferences for area measurement unit and species naming convention for output figures and tables, and whether to display the boundary of the target ecoregions on the map.</p>"></span>');
 
      d3.select("#preferencesTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Preferences window")
        .on("click", function() { toolWindowToggle("preferences"); });

      d3.select("#preferencesDiv")
        .append("div")
        .attr("id", "preferencesOptions")
        .append("div")
        .html(''
          + '<div id="prefOptDivUnit" class="prefOptDiv" style="margin-bottom:20px">'
          + '<p>Preferred units for area measurements:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outUnitAcres" value="acres" class="prefCheck" name="outUnit" checked><span>Acres</span></label><label><input type="radio" id="outUnitHectares" value="hectares" class="prefCheck" name="outUnit"><span>Hectares</span></label>'
          + '</div>'
          + '<div id="prefOptDivName" class="prefOptDiv" style="margin-bottom:20px">'
          + '<p>Preferred naming convention for species titles:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outSpeciesLatin" value="latin" class="prefCheck" name="outSpecies" checked><span>Latin Names</span></label><label><input type="radio" id="outSpeciesCommon" value="common" class="prefCheck" name="outSpecies"><span>Common Names</span></label>'
          + '</div>'
          + '<div id="prefOptDivDisplay" class="prefOptDiv" style="margin-bottom:20px">'
          + '<p>Show boundaries of target ecoregions on map:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outDisplayShow" value="show" class="prefCheck" name="outDisplay"><span>Show</span></label><label><input type="radio" id="outDisplayHide" value="hide" class="prefCheck" name="outDisplay" checked><span>Hide</span></label>'
          + '</div>'
          + '<div id="showPrefDiv" style="margin-top:30px;text-align:center;"><label style="font-weight:normal;margin-left:0;" title="Checking this option will prevent this window from automatically displaying on page load"><input type="checkbox" id="showPrefCheck" style="position:relative;top:2px;"></input><span>Check to hide this window on page load</span></label></div>'
        );

      d3.select("#showPrefCheck")
        .property("checked", function() { if(localStorage.getItem("showPref") == "true") { return true; } })
        .on("click", function() { localStorage.setItem('showPref', d3.select(this).property("checked")); });

      d3.select("#prefOptDivDisplay").selectAll("input")
        .on("change", function() { localStorage.setItem('outDisplay', document.querySelector('input[name=outDisplay]:checked').value); if(document.querySelector('input[name=outDisplay]:checked').value == "show") {map.addLayer(studyRegion);} else {map.removeLayer(studyRegion);} })
        .property("checked", function() { if(this.value == "show") { if(localStorage.getItem('outDisplay') == "show") {map.addLayer(studyRegion); return true; }} });

      d3.select("#prefOptDivUnit").selectAll("input")
        .on("change", function() { localStorage.setItem('outUnit', document.querySelector('input[name=outUnit]:checked').value); outUnit = document.querySelector('input[name=outUnit]:checked').value; if(d3.select("#outputQuestions").style("display") == "block") {refineHTML();} if(d3.select("#outputPreview").style("display") == "block") {addThumbs();} })
        .property("checked", function() { if(this.value == "hectares") { if(localStorage.getItem('outUnit') == "hectares") {return true;}} });

      d3.select("#prefOptDivName").selectAll("input")
        .on("change", function() {outSpecies = document.querySelector('input[name=outSpecies]:checked').value; localStorage.setItem('outSpecies', document.querySelector('input[name=outSpecies]:checked').value); })
        .property("checked", function() { if(this.value == "common") { if(localStorage.getItem('outSpecies') == "common") {return true;}}; outSpecies = document.querySelector('input[name=outSpecies]:checked').value });

      var outUnit = document.querySelector('input[name=outUnit]:checked').value;
      var outSpecies = document.querySelector('input[name=outSpecies]:checked').value;







      //*****Make div for downloads
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "downloadDiv");

      $('#downloadDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#downloadDiv")
        .append("h4")
        .text("Downloads")
        .attr("class", "legTitle")
        .attr("id", "downloadTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Downloads</center></b></u></p><p>Download zip files containing GeoTIFFs for Abiotic and Species layers, shapefiles for Area layers, and CSV files for CL, EXC, and Abiotic regional data.</p>"></span>');
 
      d3.select("#downloadTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Downloads window")
        .on("click", function() { toolWindowToggle("download"); });

      d3.select("#downloadDiv")
        .append("div")
        .attr("id", "downloadOptions")
        .append("div")
        .style("height", "123px")
        .html('<select id="downloadCat" class="downloadSelect"></select><select id="downloadSpecies" class="downloadSelect"></select><select id="downloadLayer" class="downloadSelect"></select>');

      d3.select("#downloadOptions")
        .append("div")
        .attr("id", "downloadButton")
        .attr("class", "cl_select disabled")
        .style({"margin":"10px", "width":"calc(100% - 20px)", "padding":"0px"})
        .property("title", "Click to download selected layer")
        .html('<a id="dlLink" href="#"><span> Download Layer </span></a>');

      var dlCat = ["Select category...", "Abiotic Layers", "Area Layers", "Combined Species Layers", "Individual Species Layers", "CL, EXC, & Abiotic Data"];
      d3.select("#downloadCat")
        .property("title", "Select the category containing the layer you wish to download")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  
          d3.select(this).style("font-style", "normal");
          if(d3.select("#downloadCat").property("selectedOptions")[0].value  == "Individual Species Layers") {
            d3.select("#downloadSpecies").style("display", "inline-block");
            d3.select("#downloadLayer").style("display", "none");
             d3.select("#downloadButton").classed("disabled", true);
          }
          else {
            d3.select("#downloadSpecies").style("display", "none");
            dlLoadLayers(d3.select("#downloadCat").property("selectedOptions")[0].value);
          }
        })
        .selectAll("options")
        .data(dlCat)
        .enter()
          .append("option")
          .attr("value", function(d,i) { return d; })
          .property("disabled", function(d, i) { if(i == 0) {return "disabled";} }) 
          .property("title", function(d) { return d; })
          .text(function(d) { return d; });



      d3.select("#downloadSpecies")
        .property("title", "Select the species containing the layer you wish to download")
        .style("display", "none")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  d3.select(this).style("font-style", "normal"); dlLoadLayers("Individual Species Layers"); });

      d3.select("#downloadSpecies").selectAll("option")
        .data(layerNames.species.keys)
        .enter()
          .append("option")
          .attr("value", function(d,i) { return d; })
          .property("title", function(d,i) { return speciesTitles[i] + " (" + speciesNames[i] + ")"; })
          .text(function(d,i) { return speciesTitles[i]; });

        d3.select("#downloadSpecies")
          .style("font-style", "")
          .insert("option", ":first-child")
          .property("disabled", true)
          .text("Select species...");

        d3.select("#downloadSpecies")
          .property("selectedIndex", 0);


        

      d3.select("#downloadLayer")
        .property("title", "Select the layer you wish to download")
        .style("display", "none")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  
          d3.select(this).style("font-style", "normal"); 
          d3.select("#downloadButton").classed("disabled", false);
          d3.select("#dlLink").attr("href", function() { return set_dl_link(); });
        })
        .append("option")
        .property("disabled", true)
        .text("Select layer...");




      //******Function to load layer names in download select
      function dlLoadLayers(tmpCat) {
        switch (tmpCat) {
          case "Abiotic Layers":
            var tmpData = layerNames.abiotics.keys;
            var tmpVals = abioticID;
            break;
          case "Area Layers":
            var tmpData = layerNames.areas.keys;
            var tmpVals = areaID;
            break;
          case "Combined Species Layers":
            var tmpData = layerNames.community.keys;
            var tmpVals = commID;
            break;
          case "Individual Species Layers":
            var tmpData = layerExtTitles;
            var tmpVals = layerExt;
            break;
          case "CL, EXC, & Abiotic Data":
            var tmpData = ["Data Files"];
            var tmpVals = ["N-CLAS_data_11-10-17"];
        }

        d3.select("#downloadLayer").selectAll("option").remove()

        d3.select("#downloadLayer")
          .style("display", "inline-block")
          .selectAll("option")
          .data(tmpData)
          .enter()
            .append("option")
            .attr("class", "dlOpt")
            .attr("value", function(d,i) { return tmpVals[i]; })
            .text(function(d,i) { return d; });

        d3.select("#downloadLayer")
          .style("font-style", "")
          .insert("option", ":first-child")
          .property("disabled", true)
          .text("Select layer...");

        d3.select("#downloadLayer")
          .property("selectedIndex", 0);

        d3.select("#downloadButton").classed("disabled", true);
      }





     //******Function to set download button href property
     function set_dl_link() {
       if(d3.select("#downloadCat").property("selectedOptions")[0].value == "Individual Species Layers") {
         return "zips/" + d3.select("#downloadSpecies").property("selectedOptions")[0].value + d3.select("#downloadLayer").property("selectedOptions")[0].value + ".zip";
       }
       else {
         return "zips/" + d3.select("#downloadLayer").property("selectedOptions")[0].value + ".zip";
       }
     }






      //******Set z-indexes of moveable divs so that clicked one is always on top
      d3.selectAll("#legendDiv,#attDiv,#histDiv,#downloadDiv,#preferencesDiv")
        .on("mousedown", function() { setZ(this); });

      function setZ(tmpWin) {
        if (d3.select("#map").classed("introjs-showElement") == false) {
          d3.selectAll("#legendDiv,#attDiv,#histDiv,#downloadDiv,#preferencesDiv").style("z-index", function() { if(d3.select(this).style("opacity") == 1) {return 1001;} else {return 7500;} }); 
          d3.select(tmpWin).style("z-index", function() { if(tmpWin.id == "preferencesDiv") { return 1003;} else { return 1002;} });
        }
      }









      //******Add collapse ability to left_panel
      d3.select("#left_collapse")
        .on("click", function() { toggleSelections(this.id); })
        .property("title", "Click to hide panel");

      //******Add collapse ability to right_panel
      d3.select("#right_collapse")
        .on("click", function() { toggleSelections(this.id); })
        .property("title", "Click to hide panel");

      //******Function to toggle left & right panels
      function toggleSelections(tmpID) {
        var tmpDir = tmpID.slice(0,tmpID.indexOf("_"));

        if(tmpDir == "left") {
          var oppDir = "right";
        }
        else {
          var oppDir = "left";
        }

        if(d3.select("#" + tmpID + "_glyph").classed("glyphicon-triangle-" + tmpDir)) {
          d3.select("#" + tmpID + "_glyph")
            .classed("glyphicon-triangle-" + tmpDir, false)
            .classed("glyphicon-triangle-" + oppDir, true);
          d3.select("#" + tmpID).property("title", "Click to show panel");
          if(tmpDir == "left") {
            d3.select("#left_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"0px"});
            d3.selectAll(".leaflet-left").transition().duration(500).ease("cubic-in-out").style({"margin-left":"20px"});
            if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 380) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 30) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"left":"15px","width":tmpWidth});
          }
          else {
            d3.select("#right_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"0px"});
            d3.selectAll(".leaflet-right").transition().duration(500).ease("cubic-in-out").style({"margin-right":"20px"});
/*
            if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 180) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 30) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"width":tmpWidth});
*/
          }
        }
        else {
          d3.select("#" + tmpID + "_glyph")
            .classed("glyphicon-triangle-" + oppDir, false)
            .classed("glyphicon-triangle-" + tmpDir, true);
          d3.select("#" + tmpID).property("title", "Click to hide panel");
          if(tmpDir == "left") {
            d3.select("#left_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"150px"});
            d3.selectAll(".leaflet-left").transition().duration(500).ease("cubic-in-out").style({"margin-left":"170px"});
            if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 530) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 180) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"left":"165px","width":tmpWidth});
          }
          else {
            d3.select("#right_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"350px"});
            d3.selectAll(".leaflet-right").transition().duration(500).ease("cubic-in-out").style({"margin-right":"370px"});
/*
            if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 530) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 380) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"width":tmpWidth});
*/
          }
        }
        setTimeout(function() {
          resizePanels();
        }, 520);
      }         





      //******Take appropriate action when step is clicked
      d3.selectAll(".selDiv")
        .on("click", function() {
          var tmpDiv = this;
          if(d3.select(this).classed("disabled") == false) {
            d3.selectAll(".selDiv")
              .classed("active", false)
              .selectAll("span")
              .classed("active", false);
            d3.selectAll(".selDiv").each(function() { 
              if(this.id != tmpDiv.id) {
                $("#" + this.id + "Tog").collapse("hide");
                if(this.id == "selRes") {
                  //d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "none");
                }  
              }
            });
            d3.select(this).classed("active", true)
              .select("span").classed("active", true);

            if(this.id == "selArea") {
              toggleFeats();
            }
            else if(this.id == "selRes") {
              setOutputList();
              d3.selectAll(".resOption").each(function() {
                if(d3.select(this).attr("data-gs") == resAdded) {
                  d3.select(this).classed("added", true);
                  d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "block");
                }
              })
            }
          }
        });

      function stepAction(tmpEl) {
        if(d3.select(tmpEl).classed("disabled") == false) {
          d3.selectAll(".selDiv").classed("selected", false);
          d3.select(tmpEl).classed("selected", true);
          if(tmpEl.id != "selOut") {
            d3.selectAll(".choice").style("display", "none");
          }
          switch (tmpEl.id) {
            case "selArea":
              d3.select("#areaChoice").style("display", "block");
              classInactive(false);
              if(d3.select("#areaOptions").selectAll("*")[0].length == 0) {
                d3.select("#areaListDropdown").style("display", "inline-block");
              }
              break;
            case "selSpp":
              d3.select("#sppChoice").style("display", "block");
              classInactive(true);
              break;
            case "selRes":
              d3.select("#resChoice").style("display", "block");
              classInactive(true);
              break;
          }
          if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-left") == true) {
            toggleSelections("right_collapse");
          }
        }
      }

      

      

      function classInactive(tmpSwitch) {
        if(d3.select("#areaList").attr("value")) {
          if(tmpSwitch == true) {
            if(d3.select("." + area2layer[d3.select("#areaList").attr("value")]).classed("inactive") == false) {
              topoClickArray = [];
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])[0].forEach(function(d) {
                topoClickArray.push(d3.select(d).on("click"));
              });
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])
                .classed("inactive", true)
                .on("click", null);
            }
          }
          else {
            if(tmpSwitch == false) {
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])[0].forEach(function(d,i) {
                d3.select(d).on("click", topoClickArray[i]);
              });
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")]).classed("inactive", false)
            }
          }
        }
      }


      //******Add area div
      //d3.select("#right_panel_container")
      d3.select("#selAreaTog")
        .append("div")
        .attr("id", "areaChoice")
        .attr("class", "choice")
        .style("display", "block")
        .append("div")
        .attr("id", "areaHeader");

      d3.select("#areaHeader")
        .append("div")
        .attr("id", "areaSelect")
        .attr("class", "layerList")
        //.style("float", "none")
        .append("div")
        .attr("id", "areaList")
        .attr("class", "cl_select progSel")
        .property("title", "Click to display list of area layers")
        .html('<span style="order:0;"><span id="areaListHeader" class="progHeader">Area Layer</span><span id="areaListSelected"></span></span><span class="spacerSpan"></span><span class="glyphicon glyphicon-triangle-bottom progIcon"></span>')
        .on("click", function() { 
          if(d3.select("#areaListDropdown").style("display") == "none") {
            d3.select("#areaOptions").style("display", "none");
            d3.select("#agencyListDropdown").style("display", "none");
            d3.select("#areaListDropdown").style("display", "inline-block");
          }
          else {
            d3.select("#areaListDropdown").style("display", "none");
          }
        });


      d3.select("#areaSelect")
        .append("div")
        .attr("id", "areaListDropdown")
        .attr("class", "layerListDropdown");
        //.style("display", "inline-block")
        //.on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add area options
      d3.select("#areaListDropdown").selectAll("div")
        .data(layerNames.areas.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .attr("data-sel", function(d,i) { return areaID[i]; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeArea(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeArea")
          .style("visibility", function(d) { if(d == "All Ecoregions") {return "visible";} else {return "hidden";} });




      d3.select("#areaChoice")
        .append("div")
        .attr("id", "agencyHeader");

      d3.select("#agencyHeader")
        .append("div")
        .attr("id", "agencySelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "agencyList")
        .attr("class", "cl_select progSel")
        .attr("value", "All Agencies")
        .property("title", "Click to display list of federal agencies")
        .html('<span style="order:0;"><span id="agencyListHeader" class="progHeader">Agency</span><span id="agencyListSelected"></span></span><span class="spacerSpan"></span><span class="glyphicon glyphicon-triangle-bottom progIcon"></span>')
        .on("click", function() { 
          if(d3.select("#agencyListDropdown").style("display") == "none") {
            d3.select("#areaListDropdown").style("display", "none");
            d3.select("#areaOptions").style("display", "none");
            d3.select("#agencyListDropdown").style("display", "inline-block");
          }
          else {
            d3.select("#agencyListDropdown").style("display", "none");
          }
        });


      d3.select("#agencySelect")
        .append("div")
        .attr("id", "agencyListDropdown")
        .attr("class", "layerListDropdown");

      //******Add agency options
      var agencies = ["All Agencies", "Fish & Wildlife Service", "Forest Service", "National Park Service"];
      d3.select("#agencyListDropdown").selectAll("div")
        .data(agencies)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          //.attr("data-sel", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeAgency(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeArea")
          .style("visibility", function(d) { if(d == "All Ecoregions") {return "visible";} else {return "hidden";} });

      //***Select All Agencies as default
      $("#agencyListDropdown div:first-child").click();



/*
      //***Add federal admin agency selector
      d3.select("#areaChoice")
        .append("div")
        .attr("id", "agencyOptionsSelect")
        .attr("class", "layerList")
        //.style("float", "none")
        .append("span")
        .attr("id", "agencyListOptionsHeader")
        .attr("class", "progHeader selected")
        .text("Refine");

      d3.select("#agencyOptionsSelect")
        .append("input")
        .attr("id", "agencyListOptions")
        .attr("class", "cl_select progSel")
        .property("title", "Click to select an agency")
        .property("autocomplete", "off")
        //.html('<span style="order:0;"><span id="areaListOptionsHeader" class="progHeader">Search</span><span id="areaListOptionsSelected"></span></span><span class="spacerSpan"></span><span class="glyphicon glyphicon-triangle-bottom progIcon"></span>')
        .on("keyup", function() { filterAgencyList(this.value); })
        .on("click", function() { 
          if(d3.select("#agencyOptions").style("display") == "none") {
            d3.select("#agencyListDropdown").style("display", "none");
            d3.select("#agencyOptions").style("display", "inline-block");
          }
          else {
            d3.select("#agencyOptions").style("display", "none");
          }
        });

      d3.select("#agencyOptionsSelect")
        .append("div")
        .attr("id", "agencyOptions")
        .attr("class", "layerListDropdown");
*/




      //***Add area selector
      d3.select("#areaChoice")
        .append("div")
        .attr("id", "areaOptionsSelect")
        .attr("class", "layerList")
        //.style("float", "none")
        .append("span")
        .attr("id", "areaListOptionsHeader")
        .attr("class", "progHeader selected")
        .text("Search");


      d3.select("#areaOptionsSelect")
        .append("input")
        .attr("id", "areaListOptions")
        .attr("class", "cl_select progSel")
        .property("title", "Click to select an area")
        .property("autocomplete", "off")
        //.html('<span style="order:0;"><span id="areaListOptionsHeader" class="progHeader">Search</span><span id="areaListOptionsSelected"></span></span><span class="spacerSpan"></span><span class="glyphicon glyphicon-triangle-bottom progIcon"></span>')
        .on("keyup", function() { filterAreaList(this.value); })
        .on("click", function() { 
          if(d3.select("#areaOptions").style("display") == "none") {
            d3.select("#areaListDropdown").style("display", "none");
            d3.select("#areaOptions").style("display", "inline-block");
          }
          else {
            d3.select("#areaOptions").style("display", "none");
          }
        });



      d3.select("#areaOptionsSelect")
        .append("div")
        .attr("id", "areaOptions")
        .attr("class", "layerListDropdown");

      d3.select("#areaChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selAreaNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selAreaNxtBtn")
        .on("click", function() { progClick(this); });


      function progClick(btn) {
        d3.select(".selDiv.active").classed("active", false)
          .select(".material-icons.active").classed("active", false);
        var tmpBtn = btn.id.slice(0,btn.id.length - 6);

        switch(tmpBtn) {
          case "selArea":
            $("#selAreaTog").collapse("hide");
            d3.select("#selEco").classed("disabled", false);
            d3.select("#selArea").select(".headerSelSpan").style("display", "inline-block");
            d3.select("#prog2").classed("visited", true);
            $("#selEco").click();
            toggleFeats();
            break;
          case "selEco":
            $("#selEco").click();
            d3.select("#selDep").classed("disabled", false);
            d3.select("#selEco").select(".headerSelSpan").style("display", "inline-block");
            d3.select("#prog3").classed("visited", true);
            $("#selDep").click();              
            break;
          case "selDep":
            $("#selDep").click();
            d3.select("#selDep").select(".headerSelSpan").style("display", "inline-block");
            if(d3.select("#ecoLichens").classed("activeEco") == true || d3.select("#ecoTrees").classed("activeEco") == true) {
              d3.select("#prog4").classed("visited", true);
              d3.select("#selCL").classed("disabled", false);
              $("#selCL").click();
            }
            else {
              d3.selectAll("#prog4, #prog5, #prog6").classed("visited", true);
              d3.selectAll("#selCL,#selSpp").selectAll(".headerSelSpan").style("display", "inline-block");
              d3.select("#selOut").classed("disabled", false);
              $("#selOut").click();
            }
            break;
          case "selCL":
            $("#selCL").click();
            d3.select("#selCL").select(".headerSelSpan").style("display", "inline-block");
            if(d3.select("#ecoTrees").classed("activeEco") == true) {
              d3.select("#prog5").classed("visited", true);
              d3.select("#selSpp").classed("disabled", false);
              $("#selSpp").click();
            }
            else {
              d3.selectAll("#prog5, #prog6").classed("visited", true);
              d3.select("#selSpp").select(".headerSelSpan").style("display", "inline-block");
              d3.select("#selOut").classed("disabled", false);
              $("#selOut").click();
            }            
            break;
          case "selSpp":
            $("#selSppTog").collapse("hide");
            d3.select("#selOut").classed("disabled", false);
            d3.select("#selSpp").select(".headerSelSpan").style("display", "inline-block");
            d3.select("#prog6").classed("visited", true);
            $("#selOut").click();
            break;
          case "selOut":
            $("#selOutTog").collapse("hide");
            d3.select("#selRes").classed("disabled", false);
            d3.select("#selOut").select(".headerSelSpan").style("display", "inline-block");
            d3.select("#prog7").classed("visited", true);
            $("#selRes").click();
            break;
        }
      }



      //******Filter Federal Admin Areas based on agency
      function filterFeats(tmpAgency) {
        if(tmpAgency == "All Agencies") {
          d3.selectAll("." + d3.select("#areaList").attr("data-sel")).style("display", "block");
        }
        else {
          d3.selectAll("." + d3.select("#areaList").attr("data-sel")).each(function() {
            if(d3.select(this).data()[0].properties.agency_ful == tmpAgency) {
              d3.select(this).style("display", "block");
            }
            else {
              d3.select(this).style("display", "none");
            }
          });
        }            
      }



      //******Hide/show all unselected features
      function toggleFeats() {
        if(d3.select("#selArea").classed("active")) {
          if(d3.select("#areaList").attr("data-sel") == "admin") {
            filterFeats(d3.select("#agencyList").attr("value"));
            d3.select("." + d3.select("#areaList").attr("data-sel") + ".selected.inactive").classed("inactive", false);
          }
          else {
            d3.selectAll("." + d3.select("#areaList").attr("data-sel")).style("display", "block").classed("inactive", false);
          }
          map.fitBounds([[24.5,-140],[50.7,-63]]);
        }
        else {
          d3.selectAll("." + d3.select("#areaList").attr("data-sel")).style("display", "none");
          d3.select("." + d3.select("#areaList").attr("data-sel") + ".selected").style("display", "block").classed("inactive", true);
          zoomFeat(d3.select("." + d3.select("#areaList").attr("data-sel") + ".selected")[0][0]);
        }
      }


      //******Zoom to feature
      function zoomFeat(feat) {
        var bbox = d3.select(feat).node().getBBox();
        var UL = map.containerPointToLatLng([bbox.x, bbox.y]);
        var LR = map.containerPointToLatLng([(bbox.x + bbox.width), (bbox.y + bbox.height)]);
        map.fitBounds([[UL.lat, UL.lng],[LR.lat, LR.lng]]);
      }




      //******Add click event to progCircles
      d3.selectAll(".progCircles")
        .on("click", function() {
          switch(this.id) {
            case "prog1":
              $("#selArea").click();
              break;
            case "prog2":
              $("#selEco").click();
              break;
            case "prog3":
              $("#selDep").click();
              break;
            case "prog4":
              $("#selCL").click();
              break;
            case "prog5":
              $("#selSpp").click();
              break;
            case "prog6":
              $("#selOut").click();
              break;
            case "prog7":
              $("#selRes").click();
              break;
          }
        });
         

      //******Add procedural steps action
      //d3.select("#selArea").on("click", function() { stepAction(this); });


      //******Reset area select
      function resetArea() {
        //***Remove old layer
        d3.select("#areaListDropdown").selectAll("div")[0].forEach(function(tmpLayer) {
          if(d3.select(tmpLayer).classed("active")) {
            d3.select(tmpLayer).classed("active", false);
            map.removeLayer(layerNames.areas.values[d3.select(tmpLayer).property("value")]);
          }
        });

        //***Reset progCircles
        d3.selectAll(".progCircles").each(function() {
          if(this.title !="Areas") {
            d3.select(this).classed("visited", false);
          }
        });

        //***Reset active options
        d3.selectAll(".activeEco").each(function() { $(this).click(); });
        d3.selectAll(".activeDep").each(function() { $(this).click(); });
        d3.selectAll(".activeCL").each(function() { $(this).click(); });
        d3.selectAll(".activeSpp").each(function() { $(this).click(); });
        d3.selectAll(".activeOut").each(function() { $(this).click(); });

        //***Collapse and remove active class
        d3.selectAll(".selDiv").each(function() {
          $("#" + this.id + "Tog").collapse("hide");
          if(this.id != "selArea") {
            d3.select(this).classed("disabled", true);
          }
          d3.select(this).classed("active", false).select(".material-icons").classed("active", false);
          d3.select(this).select(".headerSelSpan").text("");
        });

        //***Reset
        d3.select("#areaList").attr("value", null).attr("data-sel", null);
        d3.select("#areaListHeader").classed("selected", false);
        d3.select("#areaListSelected").text("").style("display", "none");
        d3.select("#agencyHeader").style("display", "none");
        d3.select("#areaOptions").style("top", "");
        d3.select("#areaOptionsSelect").style("display", "none");
        d3.select("#areaListDropdown").style("display", "none");
        d3.select("#selAreaNxtBtn").classed("disabled", true);
      }




      //******Function to add/remove area layer
      function changeArea(tmpDiv) {
        if(!d3.select(tmpDiv).classed("active")) {
          //***Remove old layer
          d3.select("#areaListDropdown").selectAll("div")[0].forEach(function(tmpLayer) {
            if(d3.select(tmpLayer).classed("active")) {
              d3.select(tmpLayer).classed("active", false);
              map.removeLayer(layerNames.areas.values[d3.select(tmpLayer).property("value")]);
            }
          });

          //***Add new layer
          d3.select(tmpDiv).classed("active", true)
          d3.select("#areaList").attr("value", layerNames.areas.keys[tmpDiv.value]).attr("data-sel", d3.select(tmpDiv).attr("data-sel"));
          d3.select("#areaListHeader").classed("selected", true);
          d3.select("#areaListSelected").text(layerNames.areas.keys[tmpDiv.value]).style("display", "block");
          $("#agencyListDropdown div:first-child").click();
          d3.select("#areaListOptions").attr("placeholder", "Search " + layerNames.areas.keys[tmpDiv.value]).property("value", "").classed("selected", false);
          d3.select("#areaListOptionsHeader").text("Search " + layerNames.areas.keys[tmpDiv.value]).style("display", "");
          if(tmpDiv.title == "Federal Administrative Areas") {
            d3.select("#agencyHeader").style("display", "block");
            d3.select("#areaOptions").style("top", "290px");
          }
          else {
            d3.select("#agencyHeader").style("display", "none");
            d3.select("#areaOptions").style("top", "");
          }
          d3.select("#areaOptionsSelect").style("display", "flex");
          d3.select("#areaListDropdown").style("display", "none");
          d3.select("#selAreaNxtBtn").classed("disabled", true);
          d3.select("#selArea").select(".headerSelSpan").text("");

          map.addLayer(layerNames.areas.values[tmpDiv.value]);
          addAreaNames(tmpDiv.value);
          getCoords(tmpDiv.value);
          //get_spp();
          get_abiotic_counts();
          //***Adjust histogram divs
          //d3.select("#histDefault").style("display", "none");
          //d3.select("#histImgDiv").style("display", "block");
        }
      }



      //******Function to filter Federal Admin Areas by agency
      function changeAgency(tmpDiv) {
        if(!d3.select(tmpDiv).classed("active")) {
          //***Remove old layer
          d3.select("#agencyListDropdown").selectAll("div").classed("active", false);

          //***Filter by new agency
          d3.select(tmpDiv).classed("active", true)
          d3.select("#agencyList").attr("value", tmpDiv.title);
          d3.select("#agencyListHeader").classed("selected", true);
          d3.select("#agencyListSelected").text(tmpDiv.title).style("display", "block");
          d3.select("#areaListOptions").property("value", "").classed("selected", false).attr("placeholder", function() { if(tmpDiv.title == "All Agencies") { return "Search Federal Administrative Areas"; } else { return "Search " + tmpDiv.title; } });
          d3.select("#areaListOptionsHeader").style("display", "").text(function() { if(tmpDiv.title == "All Agencies") { return "Search Federal Administrative Areas"; } else { return "Search " + tmpDiv.title; } });
          d3.select("#agencyListDropdown").style("display", "none");
          //d3.select("." + d3.select("#areaList").attr("data-sel") + ".selected").classed("selected", false);
          d3.selectAll(".remCheck").each(function(d) { 
            if(d3.select(this).property("checked")) {
              d3.select(this).property("checked", false);
              colorFeat(this, areaID.indexOf(d3.select("#areaList").attr("data-sel")));
            }
          });


          //***filter areaOptions by selection
          filterAreaListByAgency(tmpDiv.title);
          filterFeats(tmpDiv.title);
        }
      }


      function filterAreaListByAgency(agency) {
        if(agency == "All Agencies") {
          d3.selectAll(".remLabel").style("display", "").classed("filtered", false);          
        }
        else {
          d3.selectAll(".remLabel").each(function() {
            if(this.id != "areaAllLabel") {
              var tmpTitle = d3.select(this).property("title").replace(/ /g, "_");
              if(topos.admin.agency[tmpTitle] == agency) {
                d3.select(this).style("display", "").classed("filtered", true);
              }
              else {
                d3.select(this).style("display", "none").classed("filtered", false);
              }
            }
          });
        }
      }


      function filterAreaList(tmpStr) {
        //console.log(tmpStr);
        tmpStr = tmpStr.toUpperCase();
        d3.selectAll(".remLabel").each(function() {
          if(this.id != "areaAllLabel") {
            if(d3.select("#agencyList").attr("value") == "All Agencies" || d3.select("#areaList").attr("data-sel") != "admin") {
              if(d3.select(this).select("span").text().toUpperCase().indexOf(tmpStr) > -1) {
                d3.select(this).style("display", "");
              }
              else {
                d3.select(this).style("display", "none");
              }
            }
            //***Account for agency filter when Federal Admin Areas layer is selected
            else {
              if(d3.select(this).select("span").text().toUpperCase().indexOf(tmpStr) > -1 && d3.select(this).classed("filtered")) {
                d3.select(this).style("display", "");
              }
              else {
                d3.select(this).style("display", "none");
              }
            }
          }
        });
      }


      function getCoords(i) {
/*
        var tmpLabels = d3.selectAll(".remLabel")[0];
        d3.selectAll("." + areaID[i])[0].forEach(function(d) {
          var tmpBi = 0;
          tmpLabels.some(function(tmpLab) {
            if(tmpLab.title == d.id) {
              var bbox = d3.select(d).node().getBBox();
              var UL = map.containerPointToLatLng([bbox.x, bbox.y]);
              var LR = map.containerPointToLatLng([(bbox.x + bbox.width), (bbox.y + bbox.height)]);
              d3.select(tmpLab)
                .attr("data-ulLat", UL.lat)
                .attr("data-ulLng", UL.lng)
                .attr("data-lrLat", LR.lat)
                .attr("data-lrLng", LR.lng);
              tmpBi = 1;
            }
            return tmpBi == 1;
          });
        });
*/
        var tmpLabels = d3.selectAll(".remLabel")[0];
        topos[areaID[i]].features.forEach(function(d) {
          var tmpBi = 0;
          tmpLabels.some(function(tmpLab) {
            if(tmpLab.title == d.id) {
              var bbox = d3.geo.bounds(d);
              d3.select(tmpLab)
                .attr("data-llLat", bbox[0][1])
                .attr("data-llLng", bbox[0][0])
                .attr("data-urLat", bbox[1][1])
                .attr("data-urLng", bbox[1][0]);
              tmpBi = 1;
            }
            return tmpBi == 1;
          });
        });          
      }


      //******Populate area field with choices
      function addAreaNames(i) {
        var allLabels = d3.selectAll(".remLabel,.fs_wild_key")
        allLabels.remove();
        topos[areaID[i]].names.forEach(function(d,j) {
          d3.select("#areaOptions")
            .append("label")
            .attr("class", "remLabel")
            .property("title", d)
            .on("mouseenter", function() {
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  if(d3.select(tmpLabel).select("input").property("checked") == false) {
                    d3.select(d).style({"fill-opacity":"0.4", "Stroke-opacity":"0.99", "stroke":"#30D6D9"});
                  }
                  else {
                    d3.select(d).style({"stroke":"#30D6D9"});
                  }
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("mouseleave", function() {
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  if(d3.select(tmpLabel).select("input").property("checked") == false) {
                    //d3.select(d).style({"fill-opacity":"", "Stroke-opacity":"", "stroke":function() { if(d3.select("#areaList").attr("value").includes("Ecoregion")) { return topos[areaID[areaTitles.indexOf(d3.select("#areaList").attr("value"))]].color[d.id.replace(/ /g, "_")] } else { return ""; } } });
                    d3.select(d).style({"fill-opacity":"", "Stroke-opacity":"", "stroke":function() { return topos[d3.select("#areaList").attr("data-sel")].color[d.id.replace(/ /g, "_")] } });
                  }
                  else {
                    d3.select(d).style({"stroke":function() { return topos[d3.select("#areaList").attr("data-sel")].color[d.id.replace(/ /g, "_")] } });
                  }
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("dblclick", function() { 
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  var bbox = d3.select(d).node().getBBox();
                  var UL = map.containerPointToLatLng([bbox.x, bbox.y]);
                  var LR = map.containerPointToLatLng([(bbox.x + bbox.width), (bbox.y + bbox.height)]);
                  map.fitBounds([[UL.lat, UL.lng],[LR.lat, LR.lng]]);
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("click", function() {
              d3.selectAll(".remCheck").each(function(d) { 
                if(d3.select(this).property("checked")) {
                  d3.select(this).property("checked", false);
                  colorFeat(this, i);
                }
              });

              d3.select(this).select(".remCheck").property("checked", true);
              colorFeat(d3.select(this).select("input")[0][0], i);
              d3.selectAll(".remLabel").classed("active", false);
              d3.select(this).classed("active", true);
              d3.select("#areaOptions").style("display", "none");
              d3.select("#areaListOptions").property("value", d3.select(this).property("title")).classed("selected", true);
              d3.select("#areaListOptionsHeader").style("display", "block");              
              d3.select("#selAreaNxtBtn").classed("disabled", false);
              d3.select("#selArea").select(".headerSelSpan").text(d3.select(".remLabel.active").attr("title"));
              d3.select("#resViewReportsBtnSpan").text(d3.select(this).property("title"));
            })
            //.html('<input id="area-' + j + '" class="remCheck" type="checkbox" value="' + d + '" onchange="get_spp(); get_abiotic_counts();"></input><span value="' + d + '"> ' + d + ' </span><br>');
            .html('<input id="area-' + j + '" class="remCheck" type="checkbox" value="' + d + '" onchange="get_abiotic_counts();"></input><span value="' + d + '"> ' + d + ' </span><br>');
        });

        d3.selectAll(".remLabel")
          .classed("fsWildClass1",  function() { return (areaID[i] == "fs_wild" && layerNames.areas.fs_wild_class1.indexOf(d3.select(this).property("title")) > -1) })
          .select("span")
            .text(function() { if(areaID[i] == "fs_wild" && layerNames.areas.fs_wild_class1.indexOf(d3.select(this).attr("value")) > -1) {return d3.select(this).text() + "*";} else {return d3.select(this).text();} });

        d3.select("#areaOptions")
          .append("label")
          .attr("id", "areaAllLabel")
          .attr("class", "remLabel")
          .style("margin-top", "10px")
          .property("title", "Select all options")
          .on("click", function() { 
            checkAreas(i); 
            //get_spp(); 
            get_abiotic_counts(); 
          })
          .html('<input id="areaAll" type="checkbox"></input><span> Select All </span>');

        if(areaID[i] == "fs_wild") {
          d3.select("#areaOptions")
            .append("div")
            .attr("class", "fs_wild_key")
            .html('<p style="color:yellow;margin-top:10px;margin-bottom:0px;text-align:right;">Class 1 Area*</p><p style="margin-bottom:0px;text-align:right;">Class 2 Area</p>');
        }

        checkAreas(i);  
      }


      //******Get name values of selected areas and query database for species with positive exceedance values
      function get_spp() {
        //***Remove existing labels
        d3.select("#sppChoice").selectAll("label").remove();

        var tmpVals = [];
        d3.selectAll(".remCheck")[0].forEach(function(d) { if(d.checked) { tmpVals.push(d.value); } });
        if(tmpVals.length > 0) {
          d3.select("#selSpp").classed("disabled", false).property("title", "Select species");
          socket.emit('get_spp', tmpVals);
        }
        else {
          d3.select("#selSpp").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          d3.select("#container-results").style("display", "none");
        }
        checkOutput();
      }





      //******Get abiotic factor count data for selected areas to construct histograms
      function get_abiotic_counts() {
        if(d3.select("#areaList").attr("value") != null) {
          var tmpVals = {};
          //tmpVals.area = d3.select("#areaList").attr("value");
          tmpVals.area = findArea();
          var tmpAreas = [];
          d3.selectAll(".remCheck")[0].forEach(function(d) { if(d.checked) { tmpAreas.push(d.value); } });
          if(tmpAreas.length > 0) {
            tmpVals.areas = tmpAreas;
            var tmpHists = [];
            d3.select("#histListDropdown").selectAll(".layerName")[0].forEach(function(d) { if(d3.select(d).select("span").style("visibility") == "visible") { tmpHists.push(d3.select(d).property("title")); } });
            if(tmpHists.length > 0) {
              tmpVals.hists = tmpHists;
              socket.emit('get_abiotic', tmpVals);
            }
            else {
              d3.selectAll(".histFig").remove();
              d3.select("#histFigDiv").text("Please select one or more abiotic factors...");
            }
          }
          else {
            d3.selectAll(".histFig").remove();
            d3.select("#histFigDiv").text("Please select one or more area options...");
          }
        }
        else {
          d3.selectAll(".histFig").remove();
        }
      }




      //******Adjust fill opacity for selected features
      function colorFeat(tmpObj, i) {
        topos[areaID[i]].g.selectAll("." + areaID[i])[0].forEach(function(feat) {
          if(feat.id == tmpObj.value) {
            if(tmpObj.checked == true) {
              d3.select(feat).style({"fill-opacity": "0.5", "stroke-opacity": "1"}).classed("selected", true);
            }
            else {
              d3.select(feat).style({"fill-opacity": "", "stroke-opacity": ""}).classed("selected", false);
            }
          }
        });
      }


      //******Evaluate 'Select All' areas state
      function checkAreas(i) {
        if(d3.select("#areaAll").property("checked") == true) {
          d3.selectAll(".remCheck").property("checked", true);
          d3.select("#areaAllLabel").property("title", "Deselect all options")
            .select("span")
              .text("Deselect All");
        } 
        else { 
          d3.selectAll(".remCheck").property("checked", false);
          d3.select("#areaAllLabel").property("title", "Select all options")
            .select("span")
              .text("Select All");
        }

        d3.selectAll(".remCheck")[0].forEach(function(tmpObj) { colorFeat(tmpObj, i); });
      }






      //******Add ecosystem components div
      d3.select("#selEcoTog")
        .append("div")
        .attr("id", "ecoChoice")
        .attr("class", "choice")
        .style("display", "block");
        //.html('<span>Aquatic</span><span>Lichens</span><span>Trees</span>');


      //***Add ecosystem component choices
      d3.select("#ecoChoice").selectAll("div")
        .data(["Aquatic", "Lichens", "Trees"])
        .enter()
          .append("div")
          .attr("id", function(d) { return "eco" + d; })
          .attr("class", "layerName progSpan")
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { if(d == "Aquatic") { return "The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams"; } else if(d == "Lichens") { return "Epiphytic Lichens"; } else { return d; } })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeEco(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");
          //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

      d3.select("#ecoChoice").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      d3.select("#ecoChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selEcoNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selEcoNxtBtn")
        .on("click", function() { progClick(this); });


      //******Function to select
      function changeEco(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeEco")) {
          d3.select(tmpDiv).classed("activeEco", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
 
          if(tmpDiv.title == "The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams") {
            d3.select("#depAquaticDiv").style("display", "none")
              .selectAll(".activeDep").each(function() { $(this).click(); });
          }
          else if(tmpDiv.title == "Epiphytic Lichens") {
            d3.select("#lichenCLType").style("display", "none")
              .selectAll(".activeCL").each(function() { $(this).click(); });
            d3.select("#depLichensDiv").style("display", "none")
              .selectAll(".activeDep").each(function() { $(this).click(); });
          }
          else if(tmpDiv.title == "Trees") {
            d3.select("#treeCLType").style("display", "none")
              .selectAll(".activeCL").each(function() { $(this).click(); });
            d3.select("#depTreesDiv").style("display", "none")
              .selectAll(".activeDep").each(function() { $(this).click(); });
          }
        }
        else {
          d3.select(tmpDiv).classed("activeEco", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);

          if(tmpDiv.title == "The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams") {
            d3.select("#depAquaticDiv").style("display", "block");
          }
          else if(tmpDiv.title == "Epiphytic Lichens") {
            d3.select("#lichenCLType").style("display", "block");
            d3.select("#depLichensDiv").style("display", "block");
          }
          else if(tmpDiv.title == "Trees") {
            d3.select("#treeCLType").style("display", "block");
            d3.select("#depTreesDiv").style("display", "block");
          }          
        }

        if(d3.selectAll(".activeEco")[0].length == 0) {
          d3.select("#selEcoNxtBtn").classed("disabled", true);
          d3.select("#selEco").select(".headerSelSpan").text("");
        }
        else {
          d3.select("#selEcoNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeEco").each(function() { tmpSel.push(this.value); });
          d3.select("#selEco").select(".headerSelSpan").text(tmpSel.join());
        }          

        toggleDep();
        toggleCL();
        disableSelDivs(d3.select("#selEco")[0][0]);
      }

      function disableSelDivs(tmpDiv) {
        var i = 0;
        var j = d3.selectAll(".selDiv")[0].length;
        d3.selectAll(".selDiv").each(function() {
          if(this.id == tmpDiv.id) {
            j = i;
          }
          if(i > j) {
            d3.select(this).classed("disabled", true);
          }
          i += 1;
        });

        d3.selectAll(".added").each(function() { $(this).click(); });
      }






      //******Add Deposition div
      d3.select("#selDepTog")
        .append("div")
        .attr("id", "depChoice")
        .attr("class", "choice")
        .style("display", "block");
        //.html('<span>Aquatic</span><span>Lichens</span><span>Trees</span>');

      //***Add ecosystem component divs
      d3.select("#depChoice").selectAll("div")
        .data(["Aquatic", "Lichens", "Trees"])
        .enter()
          .append("div")
          .attr("id", function(d) { return "dep" + d + "Div"; })
          .attr("class", "depChoice")
          .attr("value", function(d) { return d; })
          .html(function(d) { return '<h5 class="h5title">' + d + ':</h5>'; });


      //***Add deposition choices
      d3.select("#depChoice").selectAll(".depChoice").each(function() {
        if(d3.select(this).attr("value") == "Aquatic") {
          var tmpData = ["Nitrogen + Sulfur", "Sulfur"];
        }
        else {
          var tmpData = ["Nitrogen", "Sulfur"];
        }
        d3.select(this).selectAll("div")
          .data(tmpData)
          .enter()
            .append("div")
            .attr("class", "layerName progSpan")
            .property("value", function(d,i) { return d; })
            .property("title", function(d) { return d; })
            //.property("name", function(d,i) { return abioticID[i]; })
            .on("click", function() { changeDep(this); })
            .append("span")
            .attr("class", "glyphicon glyphicon-unchecked");
            //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });
          });

      d3.selectAll(".depChoice").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      d3.select("#depChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selDepNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selDepNxtBtn")
        .on("click", function() { progClick(this); });


      //******Function to select
      function changeDep(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeDep")) {
          d3.select(tmpDiv).classed("activeDep", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
        }
        else {
          d3.select(tmpDiv).classed("activeDep", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
        }

        toggleDep();
        toggleCL();
        disableSelDivs(d3.select("#selDep")[0][0]);
      }


      //******Check if Deposition options are selected
      function toggleDep() {
        var tmpBi = 1;
        d3.selectAll(".depChoice").each(function() {
          var tmpDiv = d3.select(this);
          if(tmpDiv.style("display") == "block") {
            if(tmpDiv.selectAll(".activeDep")[0].length == 0) {
              tmpBi = 0;
            }
          }
        });

        if(tmpBi == 1) {
          d3.select("#selDepNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeDep").each(function() { tmpSel.push(this.title); });
          d3.select("#selDep").select(".headerSelSpan").text(tmpSel.join());
        }
        else {
          d3.select("#selDepNxtBtn").classed("disabled", true);
          d3.select("#selDep").select(".headerSelSpan").text("");
        }
      }      






      //******Add CL Type div
      d3.select("#selCLTog")
        .append("div")
        .attr("id", "clChoice")
        .attr("class", "choice")
        .style("display", "block");

      //***Add CL Type choices
      d3.select("#clChoice")
        .html('<div id="lichenCLType" class="CLTypeDiv"><h5 class="h5title">Lichens:</h5></div><div id="treeCLType" class="CLTypeDiv"><h5 class="h5title">Trees:</h5></div>');

      //***Add lichen CL types
      d3.select("#lichenCLType").selectAll("div")
        .data(["Total species richness", "Sensitive-species richness", "Forage lichen abundance", "Cyanolichen abundance", "Composite air score"])
        .enter()
          .append("div")
          .attr("class", "layerName progSpan lichens")
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeCL(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");

      d3.select("#lichenCLType").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      //***Add tree CL types
      d3.select("#treeCLType").selectAll("div")
        .data(["Growth", "Survival"])
        .enter()
          .append("div")
          .attr("class", "layerName progSpan trees")
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeCL(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");

      d3.select("#treeCLType").selectAll("div")
        .append("span")
        .text(function(d) { return d; });


      d3.select("#clChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selCLNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selCLNxtBtn")
        .on("click", function() { progClick(this); });


      //******Function to select
      function changeCL(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeCL")) {
          d3.select(tmpDiv).classed("activeCL", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
        }
        else {
          d3.select(tmpDiv).classed("activeCL", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
        }

        if(d3.selectAll(".activeCL")[0].length == 0) {
          d3.select("#selCLNxtBtn").classed("disabled", true);
          d3.select("#selCL").select(".headerSelSpan").text("");
        }
        else {
          d3.select("#selCLNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeCL").each(function() { tmpSel.push(this.title); });
          d3.select("#selCL").select(".headerSelSpan").text(tmpSel.join());
        }          

        toggleCL();
        disableSelDivs(d3.select("#selCL")[0][0]);
      }

      //******Check if Deposition options are selected
      function toggleCL() {
        var tmpBi = 1;
        d3.selectAll(".CLTypeDiv").each(function() {
          var tmpDiv = d3.select(this);
          if(tmpDiv.style("display") == "block") {
            if(tmpDiv.selectAll(".activeCL")[0].length == 0) {
              tmpBi = 0;
            }
          }
        });

        if(tmpBi == 1) {
          d3.select("#selCLNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeCL").each(function() { tmpSel.push(this.title); });
          d3.select("#selCL").select(".headerSelSpan").text(tmpSel.join());
        }
        else {
          d3.select("#selCLNxtBtn").classed("disabled", true);
          d3.select("#selCL").select(".headerSelSpan").text("");
        }
      }









      //******Add species div
      d3.select("#selSppTog")
        .append("div")
        .attr("id", "sppChoice")
        .attr("class", "choice")
        .style("display", "block");

      //***Add Spp Type choices
      d3.select("#sppChoice")
        .html(''
          + '<p class="selP">Would you like maps of individual tree species <span id="sppIndI" class="glyphicon glyphicon-info-sign help-tooltip spp" title="Click to view details about individual species outputs"></span>,<br>a summary of all species present <span id="sppComI" class="glyphicon glyphicon-info-sign help-tooltip spp" title="Click to view details about combined species outputs"></span>, or both?</p>'
          + '<div id="sppType"></div>'
          + '<div class="sppIndDiv" style="margin-top:10px;">'
            + '<p class="selP" title="Select all the tree species for which you would like to receive individual exceedance map outputs.">Individual tree species:</p>'
            + '<div id="sppExc"><p class="decText">Species with exceedance</p></div>'
            + '<div id="sppNoExc"><p class="decText">Species without exceedance</p></div>'
          + '</div>'
          + '<div class="sppComDiv" style="margin-top:10px;">'
            + '<p class="selP">Method for summarizing all species present: <span id="sppSumI" class="glyphicon glyphicon-info-sign help-tooltip spp" title="Click to view details about species summarization methods"></span></p>'
            + '<div id="sppSum"></div>'
          + '</div>'
      );


      //***Add species output types
      d3.select("#sppType").selectAll("div")
        .data(["Individual species", "Summary of all species"])
        .enter()
          .append("div")
          .attr("class", "layerName progSpan type")
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeSpp(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");

      d3.select("#sppType").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      //***********************************Remove disable when individual species available***************
      d3.select("#sppType").select("div").classed("disabled", true);

      //***Add summarizing method types
      d3.select("#sppSum").selectAll("div")
        .data(["Minimum", "Median", "5th Percentile"])
        .enter()
          .append("div")
      //**********************************Revert when median and 5th percentile layers are available********
          //.attr("class", "layerName progSpan method")
          .attr("class", function(d) { if(d == "Minimum") { return "layerName progSpan method"; } else { return "layerName progSpan method disabled"; } }) 
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeSpp(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");

      d3.select("#sppSum").selectAll("div")
        .append("span")
        .text(function(d) { return d; });


      d3.select("#sppChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selSppNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selSppNxtBtn")
        .on("click", function() { progClick(this); });


      //******Function to select
      function changeSpp(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeSpp")) {
          d3.select(tmpDiv).classed("activeSpp", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);

          if(tmpDiv.title == "Individual species") {
            d3.selectAll(".sppIndDiv").style("display", "none");
          }
          else if(tmpDiv.title == "Summary of all species") {
            d3.selectAll(".sppComDiv").style("display", "none");
          }
        }
        else {
          d3.select(tmpDiv).classed("activeSpp", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);

          if(tmpDiv.title == "Individual species") {
            d3.selectAll(".sppIndDiv").style("display", "block");
          }
          else if(tmpDiv.title == "Summary of all species") {
            d3.selectAll(".sppComDiv").style("display", "block");
          }
        }


        if(d3.select("#sppType").selectAll(".activeSpp")[0].length == 0) {
          d3.select("#selSppNxtBtn").classed("disabled", true);
          d3.select("#selSpp").select(".headerSelSpan").text("");
        }
        else if(d3.select(".sppIndDiv").style("display") == "block" & d3.select(".sppIndDiv").selectAll(".activeSpp")[0].length == 0) {
          d3.select("#selSppNxtBtn").classed("disabled", true);
          d3.select("#selSpp").select(".headerSelSpan").text("");
        }
        else if(d3.select(".sppComDiv").style("display") == "block" & d3.select(".sppComDiv").selectAll(".activeSpp")[0].length == 0) {
          d3.select("#selSppNxtBtn").classed("disabled", true);
          d3.select("#selSpp").select(".headerSelSpan").text("");
        }
        else {
          d3.select("#selSppNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeSpp").each(function() { tmpSel.push(this.title); });
          d3.select("#selSpp").select(".headerSelSpan").text(tmpSel.join());
        }          

        disableSelDivs(d3.select("#selSpp")[0][0]);
      }

      //******Check if Deposition options are selected
      function toggleSpp() {
        var tmpBi = 1;
        d3.selectAll(".CLTypeDiv").each(function() {
          var tmpDiv = d3.select(this);
          if(tmpDiv.style("display") == "block") {
            if(tmpDiv.selectAll(".activeCL")[0].length == 0) {
              tmpBi = 0;
            }
          }
        });

        if(tmpBi == 1) {
          d3.select("#selCLNxtBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeCL").each(function() { tmpSel.push(this.title); });
          d3.select("#selCL").select(".headerSelSpan").text(tmpSel.join());
        }
        else {
          d3.select("#selCLNxtBtn").classed("disabled", true);
          d3.select("#selCL").select(".headerSelSpan").text("");
        }
      }


/*
      d3.select("#right_panel_container")
        .append("div")
        .attr("id", "sppChoice")
        .attr("class", "choice")
        .append("div")
        .attr("id", "sppHeader")
        .html('<div class="choiceHeader" style="background:rgb(118,147,60);">Species</div><ul id="ulSpp" class="nav nav-pills"><li id="comSpp" class="active"><a href="#">Common Names</a></li><li id="sciSpp"><a href="#">Scientific Names</a></li></ul><hr style="margin-top:5px;margin-bottom:5px;">');  //<label><input id="sppAll" type="checkbox"></input><span> Select All </span><br></input><hr style="margin-top:5px;margin-bottom:5px;"></label>');

      //******Add procedural steps action
      //d3.select("#selSpp").on("click", function() { stepAction(this); });

      //******Add pill functionality
      d3.select("#comSpp")
        .on("click", function() {
          d3.select("#ulSpp").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          addSpp(speciesTitles, "normal");
        });

      d3.select("#sciSpp")
        .on("click", function() {
          d3.select("#ulSpp").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          addSpp(speciesNames, "italic");
        });

      d3.select("#sppChoice")
        .append("div")
        .attr("id", "sppOptions");


      //******Add species names
      function addSpeciesNames(ExcArr, NoExcArr) {
        //***Add exceedance species first
        if(ExcArr.length > 0) {
          d3.select("#sppOptions")
            .append("label")
            .attr("class", "sppCheck")
            .text("Species with Exceedance of Minimum CL")
            .style({"text-decoration":"underline","font-size":"15px","color":"lightcoral"});

          speciesNames.forEach(function(spp, i) {
            if(ExcArr.indexOf(spp) > -1) {
              d3.select("#sppOptions")
                .append("label")
                .property("title", speciesTitles[i] + " (" + speciesNames[i] + ")")
                .html('<input id="spp-' + i + '" class="sppCheck excYes" type="checkbox" onclick="checkOutput()" value="' + i + '"></input><span class="sppSpan" value="' + i + '"> ' + speciesTitles[i] + ' </span><br>');
            }
          });

          d3.select("#sppOptions")
            .append("label")
            .attr("id", "sppExcAllLabel")
            .style("margin-top", "10px")
            .property("title", "Select all species with exceedance")
            .on("click", function() { checkSppAll("Yes"); checkOutput(); })
            .html('<input id="sppExcAll" type="checkbox"></input><span class="italic">Select All</span>');
        }

        //***Add No exceedance species second
        if(NoExcArr.length > 0) {
          d3.select("#sppOptions")
            .append("label")
            .attr("class", "sppCheck")
            .text("Species without Exceedance of Minimum CL")
            .style({"text-decoration":"underline","font-size":"15px","color":"lightgreen","margin-top":function() {if(ExcArr.lenght == 0) {return "";} else {return "10px";} } });

          speciesNames.forEach(function(spp, i) {
            if(NoExcArr.indexOf(spp) > -1) {
              d3.select("#sppOptions")
                .append("label")
                .property("title", speciesTitles[i] + " (" + speciesNames[i] + ")")
                .html('<input id="spp-' + i + '" class="sppCheck excNo" type="checkbox" onclick="checkOutput()" value="' + i + '"></input><span class="sppSpan" value="' + i + '"> ' + speciesTitles[i] + ' </span><br>');
            }
          });

          d3.select("#sppOptions")
            .append("label")
            .attr("id", "sppNoExcAllLabel")
            .style("margin-top", "10px")
            .property("title", "Select all species without exceedance")
            .on("click", function() { checkSppAll("No"); checkOutput(); })
            .html('<input id="sppNoExcAll" type="checkbox"></input><span class="italic">Select All</span>');

        }
        else {  //No species without exceedance
          d3.select("#sppOptions")
            .append("label")
            .attr("class", "sppCheck")
            .text("Species without Exceedance of Minimum CL")
            .style({"text-decoration":"underline","font-size":"15px","color":"lightgreen","margin-top":function() {if(ExcArr.lenght == 0) {return "";} else {return "10px";} } });

          d3.select("#sppOptions")
            .append("label")
            .property("title", "None")
            .html('<span class="italic" style="font-weight:normal;">none</span><br>');
        }
      }

      function checkSppAll(type) {
        if(type == "Yes") {
          if(d3.select("#sppExcAll").property("checked") == true) {
            d3.selectAll(".excYes").property("checked", true);
            d3.select("#sppExcAllLabel")
              .property("title", "Deselect all species with exceedance")
              .select("span")
                .text("Deselect All");
          }
          else {
            d3.selectAll(".excYes").property("checked", false);
            d3.select("#sppExcAllLabel")
              .property("title", "Select all species with exceedance")
              .select("span")
                .text("Select All");
          }
        }
        else if(type == "No") {
          if(d3.select("#sppNoExcAll").property("checked") == true) {
            d3.selectAll(".excNo").property("checked", true);
            d3.select("#sppNoExcAllLabel")
              .property("title", "Deselect all species without exceedance")
              .select("span")
                .text("Deselect All");
          }
          else {
            d3.selectAll(".excNo").property("checked", false);
            d3.select("#sppNoExcAllLabel")
              .property("title", "Select all species without exceedance")
              .select("span")
                .text("Select All");
          }
        }
      }
          
        
      //******Swap species names between common and scientific
      function addSpp(sppArray, tmpStyle) {
        var tmpSpp = d3.selectAll(".sppSpan")
          //.data(sppArray);
        tmpSpp[0].forEach(function(spp) {
          d3.select(spp).text(function() { return " " + sppArray[d3.select(spp).attr("value")] + " "; });
        });
        tmpSpp.style("font-style", tmpStyle);
      }

      //******Evaluate 'Select All' species state
      function checkSpp() {
        if(d3.select("#sppAll").property("checked") == true) {
          d3.selectAll(".sppCheck").property("checked", true); 
        } 
        else { 
          d3.selectAll(".sppCheck").property("checked", false);
        }
        //d3.selectAll(".sppCheck")[0].forEach(function(tmpObj) {addSppRange(tmpObj);});
      }

      //******Add species range when species is selected
      function addSppRange(tmpObj) {
        if(tmpObj.checked == true) {
          d3.select("#" + speciesID[tmpObj.value] + "Layer-3").property("checked", true);
          layerToggle(true, speciesLayers[tmpObj.value][3]);
        }
        else {
          d3.select("#" + speciesID[tmpObj.value] + "Layer-3").property("checked", false);
          layerToggle(false, speciesLayers[tmpObj.value][3]);
        }          
      }
*/







      //******Add Output div
      d3.select("#selOutTog")
        .append("div")
        .attr("id", "outChoice")
        .attr("class", "choice")
        .style("display", "block");

      //***Add preview exceedance types
      d3.select("#outChoice").selectAll("div")
        .data(["Exceedance", "Magnitude of EXC", "Magnitude of EXC +/-"])
        .enter()
          .append("div")
          .attr("id", function(d) { return "out" + d; })
          .attr("class", "layerName progSpan")
          .property("value", function(d,i) { return d; })
          .property("title", function(d) { return d; })
          //.property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeOut(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-unchecked");
          //.style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

      d3.select("#outChoice").selectAll("div")
        .append("span")
        .text(function(d) { return d; });

      d3.select("#outChoice").insert("div", ":first-child").html('<p id="prevP" class="selP">CLAS produces 3 different EXC map outputs.<span id="prevI" class="glyphicon glyphicon-info-sign help-tooltip" title="Click to view details about the 3 exceedance outputs"></span><br>Select your preferred EXC map format(s):</p>');

      d3.select("#prevI")
        .on("click", function() { d3.select("#infoAquaticImgDiv").style("display", "none"); d3.select("#infoLichensImgDiv").style("display", "block"); d3.select("#infoTreesImgDiv").style("display", "none"); d3.select("#excScreen").style("display", "flex"); });

      //***Add output preview
      d3.select("#outChoice")
        .append("div")
        .on("click", function() { 
          setOutputList();
          $("#outputDiv").modal("show"); 
        })
        .html('<button id="outPrevBtn" class="viewBtn disabled" title="Click to view list of outputs to be produced based on current selections">Preview outputs list</button>');

      d3.select("#outChoice")
        .append("div")
        .attr("class", "progNxtDiv")
        .html('<button id="selOutNxtBtn" class="nxtBtn disabled" title="Click to proceed to next step">Next</button>');

      d3.select("#selOutNxtBtn")
        .on("click", function() { progClick(this); });

      //******Function to select
      function changeOut(tmpDiv) {
        if(d3.select(tmpDiv).classed("activeOut")) {
          d3.select(tmpDiv).classed("activeOut", false);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", false).classed("glyphicon-unchecked", true);
        }
        else {
          d3.select(tmpDiv).classed("activeOut", true);
          d3.select(tmpDiv).select("span").classed("glyphicon-check", true).classed("glyphicon-unchecked", false);
        }

        if(d3.selectAll(".activeOut")[0].length == 0) {
          d3.select("#selOutNxtBtn").classed("disabled", true);
          d3.select("#outPrevBtn").classed("disabled", true);
          d3.select("#selOut").select(".headerSelSpan").text("");
        }
        else {
          d3.select("#selOutNxtBtn").classed("disabled", false);
          d3.select("#outPrevBtn").classed("disabled", false);
          var tmpSel = [];
          d3.selectAll(".activeOut").each(function() { tmpSel.push(this.value); });
          d3.select("#selOut").select(".headerSelSpan").text(tmpSel.join());
        }          

      }


     



      var output = {"Aquatic": {}, "Lichens": {}, "Trees": {}};
      output.Aquatic = {"Nitrogen": {}, "Sulfur": {}};
      output.Aquatic.Nitrogen = {"CL": {}, "EXC": {}};
      output.Aquatic.Sulfur = {"CL": {}, "EXC": {}};
      output.Lichens = {"Nitrogen": {}, "Sulfur": {}};
      output.Lichens.Nitrogen = {"EXC": {}, "Current Condition": {}};
      output.Lichens.Sulfur = {"EXC": {}, "Current Condition": {}};
      output.Trees = {"Nitrogen": {}, "Sulfur": {}};
      output.Trees.Nitrogen = {"CL": {}, "EXC": {}};
      output.Trees.Sulfur = {"CL": {}, "EXC": {}};
      areaID.forEach(function(area) {
        output.Aquatic.Nitrogen.CL[area] = {};
        output.Aquatic.Nitrogen.EXC[area] = {};
        output.Lichens.Nitrogen.EXC[area] = {};
        output.Lichens.Nitrogen["Current Condition"][area] = {};
        output.Trees.Nitrogen.CL[area] = { "2017-2019": {} };
        output.Trees.Nitrogen.EXC[area] = { "2017-2019": {} };
        output.Aquatic.Sulfur.CL[area] = {};
        output.Aquatic.Sulfur.EXC[area] = {};
        output.Lichens.Sulfur.EXC[area] = {};
        output.Lichens.Sulfur["Current Condition"][area] = {};
        output.Trees.Sulfur.CL[area] = { "2017-2019": {} };
        output.Trees.Sulfur.EXC[area] = { "2017-2019": {} };
      });

      //******Lichens
      //***Class 1 Areas
      output.Aquatic.Nitrogen.CL.class1["2017-2019"] = "A_CL_NS_2017-2019_class1";
      output.Aquatic.Sulfur.CL.class1["2017-2019"] = "A_CL_S_2017-2019_class1";
      output.Aquatic.Nitrogen.EXC.class1["2017-2019"] = "A_EXC_NS_2017-2019_class1";
      output.Aquatic.Sulfur.EXC.class1["2017-2019"] = "A_EXC_S_2017-2019_class1";

      output.Lichens.Nitrogen.EXC.class1["2012"] = {"Total species richness": "L_EXC_Trich_N_2012_class1", "Sensitive-species richness": "L_EXC_SSrich_N_2012_class1", "Forage lichen abundance": "L_EXC_ForageAbun_N_2012_class1", "Cyanolichen abundance": "L_EXC_CyanoAbun_N_2012_class1", "Composite air score": "L_EXC_CompScore_N_2012_class1"};
      output.Lichens.Sulfur.EXC.class1["2012"] = {"Total species richness": "L_EXC_Trich_S_2012_class1", "Sensitive-species richness": "L_EXC_SSrich_S_2012_class1", "Forage lichen abundance": "L_EXC_ForageAbun_S_2012_class1", "Cyanolichen abundance": "L_EXC_CyanoAbun_S_2012_class1", "Composite air score": "L_EXC_CompScore_S_2012_class1"};
      output.Lichens.Nitrogen["Current Condition"].class1["2012"] = {"Total species richness": "L_CC_Trich_N_2012_class1", "Sensitive-species richness": "L_CC_SSrich_N_2012_class1", "Forage lichen abundance": "L_CC_ForageAbun_N_2012_class1", "Cyanolichen abundance": "L_CC_CyanoAbun_N_2012_class1", "Composite air score": "L_CC_CompScore_N_2012_class1"};
      output.Lichens.Sulfur["Current Condition"].class1["2012"] = {"Total species richness": "L_CC_Trich_S_2012_class1", "Sensitive-species richness": "L_CC_SSrich_S_2012_class1", "Forage lichen abundance": "L_CC_ForageAbun_S_2012_class1", "Cyanolichen abundance": "L_CC_CyanoAbun_S_2012_class1", "Composite air score": "L_CC_CompScore_S_2012_class1"};
      
      var methods = {"Minimum": "Min", "Median": "Med", "5th Percentile": "5th"};
      ["Minimum", "Median", "5th Percentile"].forEach(function(meas) {
        output.Trees.Nitrogen.CL.class1["2017-2019"][meas] = {"Growth": "T_CCL_" + methods[meas] + "_NG_2017-2019_class1", "Survival": "T_CCL_" + methods[meas] + "_NS_2017-2019_class1"};
        output.Trees.Sulfur.CL.class1["2017-2019"][meas] = {"Growth": "T_CCL_" + methods[meas] + "_SG_2017-2019_class1", "Survival": "T_CCL_" + methods[meas] + "_SS_2017-2019_class1"};
        output.Trees.Nitrogen.EXC.class1["2017-2019"][meas] = {"Growth": "T_CEXC_" + methods[meas] + "_NG_2017-2019_class1", "Survival": "T_CEXC_" + methods[meas] + "_NS_2017-2019_class1"};
        output.Trees.Sulfur.EXC.class1["2017-2019"][meas] = {"Growth": "T_CEXC_" + methods[meas] + "_SG_2017-2019_class1", "Survival": "T_CEXC_" + methods[meas] + "_SS_2017-2019_class1"};
      });


      //***Federal Administrative Areas
      output.Lichens.Nitrogen.EXC.admin = {"Total species richness": "L_EXC_Trich_N_admin", "Sensitive-species richness": "L_EXC_SSrich_N_admin", "Forage lichen abundance": "L_EXC_ForageAbun_N_admin", "Cyanolichen abundance": "L_EXC_CyanoAbun_N_admin", "Composite air score": "L_EXC_CompScore_N_admin"};
      output.Lichens.Sulfur.EXC.admin = {"Total species richness": "L_EXC_Trich_S_admin", "Sensitive-species richness": "L_EXC_SSrich_S_admin", "Forage lichen abundance": "L_EXC_ForageAbun_S_admin", "Cyanolichen abundance": "L_EXC_CyanoAbun_S_admin", "Composite air score": "L_EXC_CompScore_S_admin"};
      output.Lichens.Nitrogen["Current Condition"].admin = {"Total species richness": "L_CC_Trich_N_admin", "Sensitive-species richness": "L_CC_SSrich_N_admin", "Forage lichen abundance": "L_CC_ForageAbun_N_admin", "Cyanolichen abundance": "L_CC_CyanoAbun_N_admin", "Composite air score": "L_CC_CompScore_N_admin"};
      output.Lichens.Sulfur["Current Condition"].admin = {"Total species richness": "L_CC_Trich_S_admin", "Sensitive-species richness": "L_CC_SSrich_S_admin", "Forage lichen abundance": "L_CC_ForageAbun_S_admin", "Cyanolichen abundance": "L_CC_CyanoAbun_S_admin", "Composite air score": "L_CC_CompScore_S_admin"};
      //***Tribal Lands
      output.Lichens.Nitrogen.EXC.tribal = {"Total species richness": "L_EXC_Trich_N_tribal", "Sensitive-species richness": "L_EXC_SSrich_N_tribal", "Forage lichen abundance": "L_EXC_ForageAbun_N_tribal", "Cyanolichen abundance": "L_EXC_CyanoAbun_N_tribal", "Composite air score": "L_EXC_CompScore_N_tribal"};
      output.Lichens.Sulfur.EXC.tribal = {"Total species richness": "L_EXC_Trich_S_tribal", "Sensitive-species richness": "L_EXC_SSrich_S_tribal", "Forage lichen abundance": "L_EXC_ForageAbun_S_tribal", "Cyanolichen abundance": "L_EXC_CyanoAbun_S_tribal", "Composite air score": "L_EXC_CompScore_S_tribal"};
      output.Lichens.Nitrogen["Current Condition"].tribal = {"Total species richness": "L_CC_Trich_N_tribal", "Sensitive-species richness": "L_CC_SSrich_N_tribal", "Forage lichen abundance": "L_CC_ForageAbun_N_tribal", "Cyanolichen abundance": "L_CC_CyanoAbun_N_tribal", "Composite air score": "L_CC_CompScore_N_tribal"};
      output.Lichens.Sulfur["Current Condition"].tribal = {"Total species richness": "L_CC_Trich_S_tribal", "Sensitive-species richness": "L_CC_SSrich_S_tribal", "Forage lichen abundance": "L_CC_ForageAbun_S_tribal", "Cyanolichen abundance": "L_CC_CyanoAbun_S_tribal", "Composite air score": "L_CC_CompScore_S_tribal"};
      //***Wilderness Areas
      output.Lichens.Nitrogen.EXC.wilder = {"Total species richness": "L_EXC_Trich_N_wilder", "Sensitive-species richness": "L_EXC_SSrich_N_wilder", "Forage lichen abundance": "L_EXC_ForageAbun_N_wilder", "Cyanolichen abundance": "L_EXC_CyanoAbun_N_wilder", "Composite air score": "L_EXC_CompScore_N_wilder"};
      output.Lichens.Sulfur.EXC.wilder = {"Total species richness": "L_EXC_Trich_S_wilder", "Sensitive-species richness": "L_EXC_SSrich_S_wilder", "Forage lichen abundance": "L_EXC_ForageAbun_S_wilder", "Cyanolichen abundance": "L_EXC_CyanoAbun_S_wilder", "Composite air score": "L_EXC_CompScore_S_wilder"};
      output.Lichens.Nitrogen["Current Condition"].wilder = {"Total species richness": "L_CC_Trich_N_wilder", "Sensitive-species richness": "L_CC_SSrich_N_wilder", "Forage lichen abundance": "L_CC_ForageAbun_N_wilder", "Cyanolichen abundance": "L_CC_CyanoAbun_N_wilder", "Composite air score": "L_CC_CompScore_N_wilder"};
      output.Lichens.Sulfur["Current Condition"].wilder = {"Total species richness": "L_CC_Trich_S_wilder", "Sensitive-species richness": "L_CC_SSrich_S_wilder", "Forage lichen abundance": "L_CC_ForageAbun_S_wilder", "Cyanolichen abundance": "L_CC_CyanoAbun_S_wilder", "Composite air score": "L_CC_CompScore_S_wilder"};
      //***Level I Ecoregions
      output.Lichens.Nitrogen.EXC.eco1 = {"Total species richness": "L_EXC_Trich_N", "Sensitive-species richness": "L_EXC_SSrich_N", "Forage lichen abundance": "L_EXC_ForageAbun_N", "Cyanolichen abundance": "L_EXC_CyanoAbun_N", "Composite air score": "L_EXC_CompScore_N"};
      output.Lichens.Sulfur.EXC.eco1 = {"Total species richness": "L_EXC_Trich_S", "Sensitive-species richness": "L_EXC_SSrich_S", "Forage lichen abundance": "L_EXC_ForageAbun_S", "Cyanolichen abundance": "L_EXC_CyanoAbun_S", "Composite air score": "L_EXC_CompScore_S"};
      output.Lichens.Nitrogen["Current Condition"].eco1 = {"Total species richness": "L_CC_Trich_N", "Sensitive-species richness": "L_CC_SSrich_N", "Forage lichen abundance": "L_CC_ForageAbun_N", "Cyanolichen abundance": "L_CC_CyanoAbun_N", "Composite air score": "L_CC_CompScore_N"};
      output.Lichens.Sulfur["Current Condition"].eco1 = {"Total species richness": "L_CC_Trich_S", "Sensitive-species richness": "L_CC_SSrich_S", "Forage lichen abundance": "L_CC_ForageAbun_S", "Cyanolichen abundance": "L_CC_CyanoAbun_S", "Composite air score": "L_CC_CompScore_S"};
      //***Level II Ecoregions
      output.Lichens.Nitrogen.EXC.eco2 = {"Total species richness": "L_EXC_Trich_N", "Sensitive-species richness": "L_EXC_SSrich_N", "Forage lichen abundance": "L_EXC_ForageAbun_N", "Cyanolichen abundance": "L_EXC_CyanoAbun_N", "Composite air score": "L_EXC_CompScore_N"};
      output.Lichens.Sulfur.EXC.eco2 = {"Total species richness": "L_EXC_Trich_S", "Sensitive-species richness": "L_EXC_SSrich_S", "Forage lichen abundance": "L_EXC_ForageAbun_S", "Cyanolichen abundance": "L_EXC_CyanoAbun_S", "Composite air score": "L_EXC_CompScore_S"};
      output.Lichens.Nitrogen["Current Condition"].eco2 = {"Total species richness": "L_CC_Trich_N", "Sensitive-species richness": "L_CC_SSrich_N", "Forage lichen abundance": "L_CC_ForageAbun_N", "Cyanolichen abundance": "L_CC_CyanoAbun_N", "Composite air score": "L_CC_CompScore_N"};
      output.Lichens.Sulfur["Current Condition"].eco2 = {"Total species richness": "L_CC_Trich_S", "Sensitive-species richness": "L_CC_SSrich_S", "Forage lichen abundance": "L_CC_ForageAbun_S", "Cyanolichen abundance": "L_CC_CyanoAbun_S", "Composite air score": "L_CC_CompScore_S"};

      //***Level III Ecoregions
      output.Lichens.Nitrogen.EXC.eco3 = {"Total species richness": "L_EXC_Trich_N", "Sensitive-species richness": "L_EXC_SSrich_N", "Forage lichen abundance": "L_EXC_ForageAbun_N", "Cyanolichen abundance": "L_EXC_CyanoAbun_N", "Composite air score": "L_EXC_CompScore_N"};
      output.Lichens.Sulfur.EXC.eco3 = {"Total species richness": "L_EXC_Trich_S", "Sensitive-species richness": "L_EXC_SSrich_S", "Forage lichen abundance": "L_EXC_ForageAbun_S", "Cyanolichen abundance": "L_EXC_CyanoAbun_S", "Composite air score": "L_EXC_CompScore_S"};
      output.Lichens.Nitrogen["Current Condition"].eco3 = {"Total species richness": "L_CC_Trich_N", "Sensitive-species richness": "L_CC_SSrich_N", "Forage lichen abundance": "L_CC_ForageAbun_N", "Cyanolichen abundance": "L_CC_CyanoAbun_N", "Composite air score": "L_CC_CompScore_N"};
      output.Lichens.Sulfur["Current Condition"].eco3 = {"Total species richness": "L_CC_Trich_S", "Sensitive-species richness": "L_CC_SSrich_S", "Forage lichen abundance": "L_CC_ForageAbun_S", "Cyanolichen abundance": "L_CC_CyanoAbun_S", "Composite air score": "L_CC_CompScore_S"};

      //***Add deposition years and source
      output.Aquatic.depSource = "T-dep";
      output.Aquatic.depYear = "2017-2019";
      output.Lichens.depSource = "CMAQ v. 5.0.2";
      output.Lichens.depYear = "2012";
      output.Trees.depSource = "T-dep";
      output.Trees.depYear = "2017-2019";

      //console.log(output);

      


      //******Function to populate the output list
      function setOutputList() {
        var comps = [];
        d3.selectAll(".activeEco").each(function() { comps.push(this.value); });

        var deps = {"Aquatic": [], "Lichens": [], "Trees": []};
        d3.select("#depAquaticDiv").selectAll(".activeDep").each(function() { deps.Aquatic.push(this.title); });
        d3.select("#depLichensDiv").selectAll(".activeDep").each(function() { deps.Lichens.push(this.title); });
        d3.select("#depTreesDiv").selectAll(".activeDep").each(function() { deps.Trees.push(this.title); });

        var clLichens = [];
        d3.selectAll(".activeCL.lichens").each(function() { clLichens.push(this.title); });

        var clTrees = [];
        d3.selectAll(".activeCL.trees").each(function() { clTrees.push(this.title); });

        var sppType = [];
        d3.select("#sppType").selectAll(".activeSpp").each(function() { sppType.push(this.title); });

        var sppInd = [];
        d3.select(".sppIndDiv").selectAll(".activeSpp").each(function() { sppInd.push(this.title); });      

        var sppComMeth = [];
        d3.select(".sppComDiv").selectAll(".activeSpp").each(function() { sppComMeth.push(this.title); });

/*
        console.log(deps);
        console.log(comps);
        console.log(deps);
        console.log(clLichens);
        console.log(clTrees);
        console.log(sppType);
        console.log(sppComMeth);
*/

        var tmpHtml = "";
        var resHtmlAN = "";
        var resHtmlAS = "";
        var resHtmlLN = "";
        var resHtmlLS = "";
        var resHtmlTN = "";
        var resHtmlTS = "";

        //***Hide divs and redisplay below if ecosystem component is selected
        d3.selectAll("#resMapsAquaticDiv,#resMapsLichenDiv,#resMapsTreeDiv").style("display", "none");


        comps.forEach(function(comp) {
          if(comp == "Aquatic") {
            d3.select("#resMapsAquaticDiv").style("display", "block");
            tmpHtml += '<p class="outputListTitle">Aquatic Maps</p>'
            var outs = ["CL", "EXC"];
            outs.forEach(function(out) {
              if(out == "CL") {
                tmpHtml += '<p class="prevType">Critical Load:</p>';
              }
              else if(out == "EXC") {
                tmpHtml += '<p class="prevType">Exceedance: <span id="aquaticPrevI" class="glyphicon glyphicon-info-sign help-tooltip"></span></p>';
                //tmpHtml += '<p class="prevType">Exceedance:</p>';
                tmpHtml += '<p class="excNote"><span class="excCntSpan">Three versions</span> (<span class="excSpan1">[1] Exceedance</span><span class="excSpan2">, [2] Magnitude of EXC</span><span class<span class="excSpan3">, [3] Magnitude of EXC +/-</span>) will be generated for each EXC map below:</h5>';
              }
              tmpHtml += '<ol>';
              //var tmpActive = 0;
              deps.Aquatic.forEach(function(dep) {
                if(dep == "Nitrogen + Sulfur") {
                  tmpHtml += '<li><span class="N_span">N+S Dep</span></li>';
                  if(out == "CL") {
                    resHtmlAN += '<p class="resOption n" data-gs="' + output[comp]["Nitrogen"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">' + out + ': <span class="N_span">N+S Dep</span></p>';
                  }
                  else if(out == "EXC") {
                    resHtmlAN += '<p class="resOption n type1" data-gs="' + output[comp]["Nitrogen"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p>';
                    resHtmlAN += '<p class="resOption n type2" data-gs="' + output[comp]["Nitrogen"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p>';
                    resHtmlAN += '<p class="resOption n type3" data-gs="' + output[comp]["Nitrogen"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>';
                  }
                  //***Make output active
                  //$("#resMapsAquaticN").click();
                  //tmpActive = 1;
                }
                else if(dep == "Sulfur") {
                  tmpHtml += '<li><span class="S_span">S Dep</span></li>';
                  if(out == "CL") {
                    resHtmlAS += '<p class="resOption s" data-gs="' + output[comp]["Sulfur"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">' + out + ': <span class="S_span">S Dep</span></p>';
                  }
                  else if(out == "EXC") {
                    resHtmlAS += '<p class="resOption s type1" data-gs="' + output[comp]["Sulfur"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Exceedance: <span class="S_span">S Dep</span></p>';
                    resHtmlAS += '<p class="resOption s type2" data-gs="' + output[comp]["Sulfur"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC: <span class="S_span">S Dep</span></p>';
                    resHtmlAS += '<p class="resOption s type3" data-gs="' + output[comp]["Sulfur"][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear] + '_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC +/-: <span class="S_span">S Dep</span></p>';
                  }
                  //if(tmpActive == 0) {
                  //  $("#resMapsAquaticS").click();
                  //}
                }
              });
              tmpHtml += '</ol>'
            });
          }
          else if(comp == "Lichens") {
            d3.select("#resMapsLichenDiv").style("display", "block");
            tmpHtml += '<p class="outputListTitle">Lichen Maps</p>'
            var outs = ["EXC", "Current Condition"];
            outs.forEach(function(out) {
              if(out == "EXC") {
                tmpHtml += '<p class="prevType">Exceedance: <span id="lichensPrevI" class="glyphicon glyphicon-info-sign help-tooltip"></span></p>';
                //tmpHtml += '<p class="prevType">Exceedance:</p>';
                tmpHtml += '<p class="excNote"><span class="excCntSpan">Three versions</span> (<span class="excSpan1">[1] Exceedance</span><span class="excSpan2">, [2] Magnitude of EXC</span><span class<span class="excSpan3">, [3] Magnitude of EXC +/-</span>) will be generated for each EXC map below:</h5>';
                //tmpHtml += '<p class="excNote">Three versions ([1] Exceedance, [2] Magnitude of EXC, [3] Magnitude of EXC +/-) will be generated for each EXC map below:</h5>';
              }
              else if(out == "Current Condition") {
                tmpHtml += '<p class="prevType">Current Condition:</p>';
              }
              tmpHtml += '<ol>';
              //var tmpActive = 0;
              deps.Lichens.forEach(function(dep) {
                clLichens.forEach(function(cl) {
                  if(out == "Current Condition" && cl == "Composite air score") {
                    //No entries for that combination
                  }
                  else {
                    if(dep == "Nitrogen") {
                      tmpHtml += '<li><b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></li>';
                      if(out == "EXC") {
                        resHtmlLN += '<p class="resOption n type1" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type1" data-img="images/lichens_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Exceedance: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                        resHtmlLN += '<p class="resOption n type2" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type2" data-img="images/lichens_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                        resHtmlLN += '<p class="resOption n type3" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type3" data-img="images/lichens_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC +/-: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                      }
                      else if(out == "Current Condition") {
                        resHtmlLN += '<p class="resOption n" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '" data-img="images/lichens_cc.jpg" data-layer="<p><b>Current Condition of ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">' + out + ': <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                      }
                      //***Make output active
                      //$("#resMapsLichenN").click();
                      //tmpActive = 1;
                    }
                    else if(dep == "Sulfur") {
                      tmpHtml += '<li><b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></li>';
                      if(out == "EXC") {
                        resHtmlLS += '<p class="resOption s type1" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type1" data-img="images/lichens_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Exceedance: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                        resHtmlLS += '<p class="resOption s type2" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type2" data-img="images/lichens_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                        resHtmlLS += '<p class="resOption s type3" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '_type3" data-img="images/lichens_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Magnitude of EXC +/-: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                      }
                      else if(out == "Current Condition") {
                        resHtmlLS += '<p class="resOption s" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][cl] + '" data-img="images/lichens_cc.jpg" data-layer="<p><b>Current Condition of ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">' + out + ': <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                      }
                      //if(tmpActive == 0) {
                      //  $("#resMapsLichenS").click();
                      //}
                    }
                  }
                });
              });
              tmpHtml += '</ol>'
            });
          }
          else if(comp == "Trees") {
            var methods = {"Minimum": "min", "Median": "med", "5th Percentile": "5th %"};
            d3.select("#resMapsTreeDiv").style("display", "block");
            tmpHtml += '<p class="outputListTitle">Tree Maps</p>'
            var outs = ["CL", "EXC"];
            outs.forEach(function(out) {
              if(out == "CL") {
                tmpHtml += '<p class="prevType">Critical Load:</p>';
              }
              else if(out == "EXC") {
                tmpHtml += '<p class="prevType">Exceedance: <span id="treesPrevI" class="glyphicon glyphicon-info-sign help-tooltip"></span></p>';
                //tmpHtml += '<p class="prevType">Exceedance:</p>';
                tmpHtml += '<p class="excNote"><span class="excCntSpan">Three versions</span> (<span class="excSpan1">[1] Exceedance</span><span class="excSpan2">, [2] Magnitude of EXC</span><span class<span class="excSpan3">, [3] Magnitude of EXC +/-</span>) will be generated for each EXC map below:</h5>';
                //tmpHtml += '<p class="excNote">Three versions ([1] Exceedance, [2] Magnitude of EXC, [3] Magnitude of EXC +/-) will be generated for each EXC map below:</h5>';
              }
              tmpHtml += '<ol>';
              //var tmpActive = 0;
              deps.Trees.forEach(function(dep) {
                clTrees.forEach(function(cl) {
                  sppType.forEach(function(type) {
                    if(type == "Summary of all species") {
                      sppComMeth.forEach(function(method) {
                        if(dep == "Nitrogen") {
                          tmpHtml += '<li><b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></li>';
                          if(out == "CL") {
                            resHtmlTN += '<p class="resOption n" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '" data-img="images/trees_cl.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Critical Load for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') ' + out + ': <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                          }
                          else if(out == "EXC") {
                            resHtmlTN += '<p class="resOption n type1" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type1" data-img="images/trees_exc_type1.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Exceedance: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                            resHtmlTN += '<p class="resOption n type2" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type2" data-img="images/trees_exc_type2.jpg" data-layer="<p><b>Combined (' + methods[method] + ')Magnitude of Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Magnitude of EXC: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                            resHtmlTN += '<p class="resOption n type3" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type3" data-img="images/trees_exc_type3.jpg" data-layer="<p><b>Combined (' + methods[method] + ')Magnitude of Exceedance (+/-) of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;N_span&quot;>N Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Magnitude of EXC +/-: <b>' + cl + '</b>&nbsp<span class="N_span">N Dep</span></p>';
                          }
                          //***Make output active
                          //$("#resMapsTreeN").click();
                          //tmpActive = 1;
                        }
                        else if(dep == "Sulfur") {
                          tmpHtml += '<li><b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></li>';
                          if(out == "CL") {
                            resHtmlTS += '<p class="resOption s" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '" data-img="images/trees_cl.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Critical Load for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') ' + out + ': <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                          }
                          else if(out == "EXC") {
                            resHtmlTS += '<p class="resOption s type1" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type1" data-img="images/trees_exc_type1.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Exceedance: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                            resHtmlTS += '<p class="resOption s type2" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type2" data-img="images/trees_exc_type2.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Magnitude of Exceedance of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Magnitude of EXC: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                            resHtmlTS += '<p class="resOption s type3" data-gs="' + output[comp][dep][out][d3.select("#areaList").attr("data-sel")][output[comp].depYear][method][cl] + '_type3" data-img="images/trees_exc_type3.jpg" data-layer="<p><b>Combined (' + methods[method] + ') Magnitude of Exceedance (+/-) of the CL for ' + cl + '</b><br>' + comp + '<br><span class=&quot;S_span&quot;>S Deposition</span></p>" data-dep="' + output[comp].depSource + '" data-years="' + output[comp].depYear + '" onclick="addRes(this)">Combined (' + methods[method] + ') Magnitude of EXC +/-: <b>' + cl + '</b>&nbsp<span class="S_span">S Dep</span></p>';
                          }
                          //if(tmpActive == 0) {
                          //  $("#resMapsTreeS").click();
                          //}
                        }
                      });
                    }
                  });
                });
              });
              tmpHtml += '</ol>'
            });
          }
        });

        d3.select("#outputListDiv").html(tmpHtml);
        d3.select("#resMapsAquaticSubMenuN").html(resHtmlAN);
        d3.select("#resMapsAquaticSubMenuS").html(resHtmlAS);
        if(resHtmlAN != "") {
          if(d3.select("#resMapsAquaticN").classed("active") == false) {
            $("#resMapsAquaticN").click();
          }
        }
        else if(resHtmlAS != "") {
          if(d3.select("#resMapsAquaticS").classed("active") == false) {
            $("#resMapsAquaticS").click();
          }
        }
        
        d3.select("#resMapsLichenSubMenuN").html(resHtmlLN);
        d3.select("#resMapsLichenSubMenuS").html(resHtmlLS);
        if(resHtmlLN != "") {
          if(d3.select("#resMapsLichenN").classed("active") == false) {
            $("#resMapsLichenN").click();
          }
        }
        else if(resHtmlLS != "") {
          if(d3.select("#resMapsLichenS").classed("active") == false) {
            $("#resMapsLichenS").click();
          }
        }

        d3.select("#resMapsTreeSubMenuN").html(resHtmlTN);
        d3.select("#resMapsTreeSubMenuS").html(resHtmlTS);
        if(resHtmlTN != "") {
          if(d3.select("#resMapsTreeN").classed("active") == false) {
            $("#resMapsTreeN").click();
          }
        }
        else if(resHtmlTS != "") {
          if(d3.select("#resMapsTreeS").classed("active") == false) {
            $("#resMapsTreeS").click();
          }
        }

        
        //***update exceedance text in preview modal box
        var excCnt = d3.selectAll(".activeOut")[0].length;
        if(excCnt == 1) {
          d3.selectAll(".excCntSpan").text("One version");
        }
        else if(excCnt == 2) {
          d3.selectAll(".excCntSpan").text("Two versions");
        }
        else {
          d3.selectAll(".excCntSpan").text("Three versions");
        }

        var i = 0;
        d3.selectAll(".activeOut").each(function() {
          i += 1;
          if(i == 1) {
            d3.selectAll(".excSpan" + i).text("[" + i + "] " + this.title);
          }
          else {
            d3.selectAll(".excSpan" + i).text(", [" + i + "] " + this.title);
          }
        });

        if(i == 1) {
          d3.selectAll(".excSpan2, .excSpan3").text("");
        }
        else if(i == 2) {
          d3.selectAll(".excSpan3").text("");
        }
        

        


        d3.select("#aquaticPrevI")
          .on("click", function() { d3.select("#infoAquaticImgDiv").style("display", "block"); d3.select("#infoLichensImgDiv").style("display", "none"); d3.select("#infoTreesImgDiv").style("display", "none"); d3.select("#excScreen").style("display", "flex"); });

        d3.select("#lichensPrevI")
          .on("click", function() { d3.select("#infoAquaticImgDiv").style("display", "none"); d3.select("#infoLichensImgDiv").style("display", "block"); d3.select("#infoTreesImgDiv").style("display", "none"); d3.select("#excScreen").style("display", "flex"); });

        d3.select("#treesPrevI")
          .on("click", function() { d3.select("#infoAquaticImgDiv").style("display", "none"); d3.select("#infoLichensImgDiv").style("display", "none"); d3.select("#infoTreesImgDiv").style("display", "block"); d3.select("#excScreen").style("display", "flex"); });

        //Class based on exceedance map selection
        d3.select("#outChoice").selectAll(".progSpan").each(function() {
          if(this.title == "Exceedance") {
            if(d3.select(this).classed("activeOut")) {
              d3.selectAll(".type1").classed("vis", true);
            }
            else {
              d3.selectAll(".type1").classed("vis", false);
            }
          }
          else if(this.title == "Magnitude of EXC") {
            if(d3.select(this).classed("activeOut")) {
              d3.selectAll(".type2").classed("vis", true);
            }
            else {
              d3.selectAll(".type2").classed("vis", false);
            }
          }
          else if(this.title == "Magnitude of EXC +/-") {
            if(d3.select(this).classed("activeOut")) {
              d3.selectAll(".type3").classed("vis", true);
            }
            else {
              d3.selectAll(".type3").classed("vis", false);
            }
          }
        });
      }




      //******Add results layer to map
      resAdded = "";
      var resArray = [];
      var resArrayUnc = [];
      function addRes(gs) {
        console.log(d3.select(gs).attr("data-gs"));

        if(d3.select(gs).classed("added") == false) {
          d3.select("#speciesListDropdown").selectAll(".activeLayer").each(function() {
            $(this).click();
          });

          d3.selectAll(".resOption").each(function() {
            var tmpOpt = d3.select(this);
            if(tmpOpt.classed("added")) {
              tmpOpt.classed("added", false);
              //map.removeLayer(resArray[0]);
              remLegendImg(tmpOpt.attr("data-gs"));
            }
          });
          d3.select(gs).classed("added", true);

          //var tmpLayer = "";
          //if(d3.select("#togUncBtn").text() == "Show uncertainty") {
            var tmpLayer = d3.select(gs).attr("data-gs");
          //}
          //else {
            //tmpLayer = d3.select(gs).attr("data-gs") + "_unc";
          //}

          resArray[0] = new L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
            layers: tmpLayer,
            format: 'image/png',
            transparent: true,
            version: '1.1.0',
            maxZoom: 20,
          });

          resArrayUnc[0] = new L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
            layers: tmpLayer + "_unc",
            format: 'image/png',
            transparent: true,
            version: '1.1.0',
            maxZoom: 20,
          });


          var tmpTitle = d3.select(gs).html();
          tmpTitle = tmpTitle.replace("_span", "_span_dropdown");
          tmpTitle = tmpTitle.replace("<b>", "");
          tmpTitle = tmpTitle.replace("</b>", "");
          tmpTitle += " (Output)";

          addLegendImg(tmpLayer, tmpTitle , resArray[0], ["output",tmpTitle], gs);

          //map.addLayer(resArray[0]);
          //resArray[0].bringToFront();
          d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "block");
          d3.selectAll("#togUncBtn,#uncBtnI").style("display", "block");
          resAdded = tmpLayer;

          //***Update map info modal box
          updateInfoBox(d3.select(gs).attr("data-layer"), d3.select(gs).attr("data-dep"), d3.select(gs).attr("data-years"));
        }
        else {
          d3.select(gs).classed("added", false);
          //map.removeLayer(resArray[0]);
          remLegendImg(d3.select(gs).attr("data-gs"));
          resArray.splice(0,1);
          d3.selectAll("#resExtDownloadDiv,#mapInfoBtn").style("display", "none");
          //d3.select("#togUncBtn").style("display", "none");
          resAdded = "";
        }
      }





      function updateInfoBox(layer,dep,years) {
        d3.select("#infoLayer").html(layer);
        d3.select("#infoDep").html(dep);
        d3.select("#infoYears").html(years);
      }






      //******Add Results div
      d3.select("#selResTog")
        .append("div")
        .attr("id", "resChoice")
        .attr("class", "choice")
        .style("display", "block");


      //***Add output preview
      d3.select("#resChoice")
        .append("div")
        .html(''
          + '<div id="resMapsDiv" class="resDiv">'
            + '<button id="resViewMapsBtn" class="viewBtn" title="Click to view interactive list of map results" data-toggle="collapse" data-target="#resMapsMenuDiv">View maps</button>'
            + '<div id="resMapsMenuDiv" class="collapse">'
              + '<div id="resMapsAquaticDiv" class="resMapsCompDiv">'
                + '<div id="resMapsAquaticHeader" class="resMenuHeader" title="The Aquatic ecosystem component includes CL & EXC information for ~170,000 sensitive lakes and streams" data-toggle="collapse" data-target="#resMapsAquaticSubHeaderDiv">Aquatic<span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;opacity:1;font-size:12px;margin-right: 5px;"></span></div>'
                + '<div id="resMapsAquaticSubHeaderDiv" class="resMenuSubHeaderDiv collapse">'
                  + '<div id="resMapsAquaticN" class="resMenuSubHeader N" data-toggle="collapse" data-target="#resMapsAquaticSubMenuN">N+S Deposition</div>'
                  + '<div id="resMapsAquaticS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#resMapsAquaticSubMenuS">S Deposition</div>'              
                  + '<div id="resMapsAquaticSubMenuN" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="N_span">N Dep</span></p>'
                  + '</div>'
                  + '<div id="resMapsAquaticSubMenuS" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="S_span">S Dep</span></p>'
                  + '</div>'
                + '</div>'
              + '</div>'
              + '<div id="resMapsLichenDiv" class="resMapsCompDiv">'
                + '<div id="resMapsLichenHeader" class="resMenuHeader" title="Epiphytic Lichens" data-toggle="collapse" data-target="#resMapsLichenSubHeaderDiv">Lichens<span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;opacity:1;font-size:12px;margin-right: 5px;"></span></div>'
                + '<div id="resMapsLichenSubHeaderDiv" class="resMenuSubHeaderDiv collapse">'
                  + '<div id="resMapsLichenN" class="resMenuSubHeader N" data-toggle="collapse" data-target="#resMapsLichenSubMenuN">N Deposition</div>'
                  + '<div id="resMapsLichenS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#resMapsLichenSubMenuS">S Deposition</div>'              
                  + '<div id="resMapsLichenSubMenuN" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="N_span">N Dep</span></p>'
                  + '</div>'
                  + '<div id="resMapsLichenSubMenuS" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="S_span">S Dep</span></p>'
                  + '</div>'
                + '</div>'
              + '</div>'
              + '<div id="resMapsTreeDiv" class="resMapsCompDiv">'
                + '<div id="resMapsTreeHeader" class="resMenuHeader" title="Trees" data-toggle="collapse" data-target="#resMapsTreeSubHeaderDiv">Trees<span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;opacity:1;font-size:12px;margin-right: 5px;"></span></div>'
                + '<div id="resMapsTreeSubHeaderDiv" class="resMenuSubHeaderDiv collapse">'
                  + '<div id="resMapsTreeN" class="resMenuSubHeader N" data-toggle="collapse" data-target="#resMapsTreeSubMenuN">N Deposition</div>'
                  + '<div id="resMapsTreeS" class="resMenuSubHeader S" data-toggle="collapse" data-target="#resMapsTreeSubMenuS">S Deposition</div>'              
                  + '<div id="resMapsTreeSubMenuN" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="N_span">N Dep</span></p>'
                  + '</div>'
                  + '<div id="resMapsTreeSubMenuS" class="collapse">'
                    //+ '<p class="resOption">CL: <span class="S_span">S Dep</span></p>'
                  + '</div>'
                + '</div>'
              + '</div>'
            + '</div>'
              
          + '</div>'
          + '<div id="resReportsDiv" class="resDiv">'
            + '<button id="resDownloadDataBtn" class="viewBtn dlBtn" title="Click to download all map outputs">Download all map outputs</button>'
            //+ '<button id="resDownloadMapsBtn" class="viewBtn dlBtn" title="Click to download all map images">Download all map images</button>'
          + '</div>'

          + '<div id="resViewReportsDiv">'
            + '<button id="resViewReportsBtn" class="viewBtn" title="Click to view interactive list of reports" data-toggle="collapse" data-target="#resReportsMenuDiv">Access additional CL & EXC information for <br><span id="resViewReportsBtnSpan"></span></button>'
            + '<div id="resReportsMenuDiv" class="collapse>'
              //+ '<div id="resReportsLichenHeader" class="resMenuHeader" data-toggle="collapse" data-target="#resReportsLichenMenu" title="Lichens">Lichens</div>'
              //+ '<div id="resReportsLichenMenu" class="collapse">'
              + '</div>'
            + '</div>'
          + '</div>'
        );

        //******Open download window
        d3.select("#resDownloadDataBtn")
          .on("click", function() { $("#mapDownloadDiv").modal("show"); });


        //******Class selected resMenuSubHeader
        d3.selectAll(".resMenuSubHeader")
          .on("click", function() {
            var tmpDiv = this;
            if(d3.select(this).classed("active") == false) {
              d3.select(d3.select(this).node().parentNode).selectAll(".resMenuSubHeader").each(function() {
                if(this.id != tmpDiv.id) { 
                  $(d3.select(this).attr("data-target")).collapse("hide");
                  d3.select(this).classed("active", false);
                }
                else {
                  d3.select(this).classed("active", true);
                }
              });
            }

            $(d3.select(tmpDiv).attr("data-target")).collapse("show");
            d3.event.stopPropagation();
          });


        d3.select("#container")
          .append("div")
          .attr("id", "resExtDiv")
          .html( ''
            + '<div id="resExtDownloadDiv">'
              + '<button id="resExtDownloadDataBtn" class="viewBtn dlBtn ext" title="Click to download current map data">Download current map</button>'
              //+ '<button id="resExtDownloadMapBtn" class="viewBtn dlBtn ext" title="Click to download current map image">Download map image</button>'
            + '</div>'
            + '<div style="height:36px;">'
              + '<button id="togUncBtn" class="viewBtn dlBtn ext" title="Click to show uncertainty shading on exceedance maps">Show uncertainty</button>'
              + '<span id="uncBtnI" class="glyphicon glyphicon-info-sign help-tooltip"></span>'
            + '</div>'
            + '<div>'
              + '<button id="mapInfoBtn" class="viewBtn dlBtn ext" title="Click to view map layer information">Map information</button>'
            + '</div>'
          );

        d3.select("#togUncBtn")
          .on("click", function() { togUnc(this); });

        d3.select("#mapInfoBtn")
          .on("click", function() { $("#mapInfoDiv").modal("show"); });

        d3.select("#resExtDownloadDataBtn")
          .on("click", function() { $("#mapDownloadDiv").modal("show"); });





        //******Toggle uncertainty styling for mapped exceedance layers
        function togUnc(tmpBtn) {
          var tmpText = d3.select(tmpBtn).text();
          if(tmpText == "Show uncertainty") {
            d3.select(tmpBtn).text("Hide uncertainty");

            //***Change added abiotic and national layers
            curLegend.forEach(function(leg, i) {
              if(curType[i] != "abiotics") {
                map.removeLayer(curLayers[i]);
                if(curType[i] == "output") {
                  curLayers[i] = resArrayUnc[0];
                }
                else {
                  curLayers[i] = layerNames.unc[curType[i]][curTitle[i] + "_unc"];
                }
                map.addLayer(curLayers[i]);
                d3.select("#" + leg + "LegendImg").attr("src", d3.select("#" + leg + "LegendImg").attr("data-img").slice(0,-4) + "_unc.jpg").style("width", "350px");
                $("#" + leg + "LegendSlider").slider({slide: function(event, ui) { layerOpacity(ui, curLayers[i]); } });
                var tmpOpacity = $("#" + leg + "LegendSlider").slider("value")/100; 
                curLayers[i].setOpacity(tmpOpacity);
              }
            });
              
            //***Set layers order
            curLegend.forEach(function(leg, i) {
              curLayers[i].setZIndex(curLegend.length - i);
            });
/*
            //***Change added output layer
            if(resAdded != "") {
              resAdded += "_unc";
              map.removeLayer(resArray[0]);
              resArray.splice(0,1);
              resArray[0] = new L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
                layers: resAdded,
                format: 'image/png',
                transparent: true,
                version: '1.1.0',
                maxZoom: 20,
              });
              map.addLayer(resArray[0]);
              resArray[0].bringToFront();
            }
*/
          }
          else {
            d3.select(tmpBtn).text("Show uncertainty");

            //***Change added abiotic and national layers
            curLegend.forEach(function(leg, i) {
              if(curType[i] != "abiotics") {
                map.removeLayer(curLayers[i]);
                if(curType[i] == "output") {
                  curLayers[i] = resArray[0];
                }
                else {
                  curLayers[i] = layerNames[curType[i]][curTitle[i]];
                }
                map.addLayer(curLayers[i]);
                d3.select("#" + leg + "LegendImg").attr("src", d3.select("#" + leg + "LegendImg").attr("data-img")).style("width", "198px");
                $("#" + leg + "LegendSlider").slider({slide: function(event, ui) { layerOpacity(ui, curLayers[i]); } });
                var tmpOpacity = $("#" + leg + "LegendSlider").slider("value")/100; 
                curLayers[i].setOpacity(tmpOpacity);
              }
            });

            //***Set layers order
            curLegend.forEach(function(leg, i) {
              curLayers[i].setZIndex(curLegend.length - i);
            });
/*
            //***Change added output layer
            if(resAdded != "") {
              resAdded = resAdded.slice(0, -4);
              map.removeLayer(resArray[0]);
              resArray.splice(0,1);
              resArray[0] = new L.tileLayer.wms("https://ecosheds.org/geoserver/nn-clas/wms", {
                layers: resAdded,
                format: 'image/png',
                transparent: true,
                version: '1.1.0',
                maxZoom: 20,
              });
              map.addLayer(resArray[0]);
              resArray[0].bringToFront();
            }
*/
          }
        }





      //******Function to enable/disable 'select output' button
      function checkOutput() {
        var tmpBi = 0;
        d3.selectAll(".sppCheck")[0].forEach(function(tmpCheck) {
          if(d3.select(tmpCheck).property("checked") == true) {
            tmpBi = 1;
          }
        });

        if(tmpBi == 0) {
          d3.selectAll("#selOut,#selRes").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          d3.select("#selOut").attr("data-toggle", "");
          if(d3.select("#resChoice").style("display") == "block") {
            d3.select("#resChoice").style("display", "none");
            d3.select("#areaChoice").style("display", "block");
          }
        }
        else {
          d3.select("#selOut").classed("disabled", false).property("title", "Select output").attr("data-toggle", "modal");
          d3.select("#selRes").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          if(d3.select("#resChoice").style("display") == "block") {
            d3.select("#resChoice").style("display", "none");
            d3.select("#areaChoice").style("display", "block");
          }
        }
        d3.select("#container-results").style("display", "none");
      }






      //******Add map info modal div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "mapInfoDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "mapInfo")
        .html('<h3><b><u>Map Layer Information</u></b></h3>'
          + '<div class="infoDiv"><div class="infoDiv1"><p class="p1">Map layer:</p></div><div id="infoLayer" class="infoDiv2"></div></div>'
          + '<div class="infoDiv"><div class="infoDiv1"><p class="p1">Deposition data source:</p></div><div id="infoDep" class="infoDiv2"></div></div>'
          + '<div class="infoDiv"><div class="infoDiv1"><p class="p1">Years of deposition:</p></div><div id="infoYears" class="infoDiv2"></div></div>'
        );




      //******Add map uncertainty info modal div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "uncInfoDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "uncInfo")
        .html('<h3><b><u>Uncertainty Framework</u></b></h3>'
          + '<ul class="ulAlignLeft">'
            + '<li>CLAS uses a 5-point scale to rate uncertainty for each ecosystem component.</li>'
            + '<li>In this framework, 5 represents the best score (most certain) and 1 represents the worst score (least certain).</li>'
            + '<li>Uncertainty scores are shown spatially by decreasing the saturation of a map layer as the scores decrease from 5 to 1.</li>'
          + '</ul>'
          + '<p>Below is an example of the legend for a Lichen EXC map without (left) and with (right) uncertainty shading:</p>'
          + '<div id="uncInfoImgDiv">'
            + '<img id="uncInfoImg1" src="images/lichens_exc_type3.jpg"></img>'
            + '<img id="uncInfoImg2" src="images/lichens_exc_type3_unc.jpg"></img>'
          + '</div>'
        );


        d3.select("#uncBtnI")
          .on("click", function() { $("#uncInfoDiv").modal("show"); });







      //******Add individual species info modal div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "indInfoDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "indInfo")
        .html('<h3><b>Individual tree species</b></h3>'
          + '<p class="sppInfoP">CLAS includes CL information for 94 species based on <a href="https://doi.org/10.1371/journal.pone.0205296" target="_blank">Horn et al. (2018)</a>. These 94 species are referred to as <i>Horn species</i>. You can choose from the subset of Horn species that are present in your selected area and receive exceedance maps for those individual species.</p>'
        );


        d3.select("#sppIndI")
          .on("click", function() { $("#indInfoDiv").modal("show"); });







      //******Add all species info modal div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "allSppInfoDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "allSppInfo")
        .html('<h3><b>Summary of all tree species present</b></h3>'
          + '<p class="sppInfoP">CLAS includes CL information for 94 species based on <a href="https://doi.org/10.1371/journal.pone.0205296" target="_blank">Horn et al. (2018)</a>. These 94 species are referred to as <i>Horn species</i>. (Note that there may be species present in a plot for which no CL information is available. These species are not included in this analysis.)</p>'
          + '<p class="sppInfoP">CLAS provides maps summarizing the CL/EXC information for all Horn species present in a plot. The CL and EXC are presented in three ways, based on:</p>'

          + '<div><div class="excListNumber">1.</div><div class="excListTerm"><b>Minimum CL :</b></div><div class="excListDef">The most protective critical load for a plot.</div></div>'
          + '<div><div class="excListNumber">2.</div><div class="excListTerm"><b>Median :</b></div><div class="excListDef">The median CL value for all trees in a plot.</div></div>'
          + '<div><div class="excListNumber">3.</div><div class="excListTerm"><b>5<sup>th</sup> Percentile :</b></div><div class="excListDef">The CL value that protects 95% of the trees present in a plot.</div></div>'
/*
          + '<ol>'
            + '<li><b>Minimum CL:</b><span class="sumLiSpan"> The most protective critical load for a plot.</span></li>'
            + '<li><b>Median:</b><span class="sumLiSpan"> The median CL value for all trees in a plot.</span></li>'
            + '<li><b>5<sup>th</sup> Percentile:</b><span class="sumLiSpan"> The CL value that protects 95% of the trees present in a plot.</span></li>'
          + '</ol>'
*/
        );


        d3.selectAll("#sppComI, #sppSumI")
          .on("click", function() { $("#allSppInfoDiv").modal("show"); });







      //******Add download modal div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "mapDownloadDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "mapDownload")
        .html('<h3><b><u>Download Specifications</u></b></h3>'
          + '<p id="downloadP">File type:</p>'
          + '<select name="fileType" id="mapDownloadSelect" title="Select file format of download"></select>'
          + '<button id="downloadBtn" class="nxtBtn" title="Click to download current map">Download</button>'
        );


        d3.select("#mapDownloadSelect")
          .selectAll("options")
          .data(["JPG", "PDF", "Geotiff", "ESRI shapefile", "KMZ"])
          .enter()
            .append("option")
            .attr("value", function(d) { return d; })
            .property("title", function(d) { return d; })
            .text(function(d) { return d; });

        d3.select("#downloadBtn")
          .on("click", function() { 
            console.log(d3.select("#mapDownloadSelect")[0][0].options[d3.select("#mapDownloadSelect").property("selectedIndex")].text); 
            var tmpParams = {};
            tmpParams.layer = d3.select("#areaList").attr("data-sel");
            tmpParams.area = d3.select("#areaListOptions").property("value");
            tmpParams.raster = d3.select(".resOption.added").attr("data-gs").slice(0,-(7 + tmpParams.layer.length)).toLowerCase();
            //socket.emit("get_rid_nclas", tmpParams);
          });





      //******Add output modal div
      //***Output choice (Basic, Tailored, Comprehensive)
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "outputDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputList")
        //.attr("id", "outputOptions");
        .html('<div><h3><b>Preview Outputs List</b></h3><p><i>The following is the list of maps that will be generated if you proceed to the Outputs step with your current selections:</i></p></div><div id="outputListDiv"></div><p><i>If you are satisfied with this list of outputs, press "Next". Otherwise, adjust your prior selections until this preview screen includes all your desired outputs.</i></p><div id="prevNxtBtnDiv" class="proNxtDiv"><button id="prevNxtBtn" class="nxtBtn" title="Click to proceed to next step">Next</button></div>');


      d3.select("#prevNxtBtn")
        .on("click", function() {
          $("#outputDiv").modal("hide");
          $("#selOutNxtBtn").click();
          progClick(d3.select("#selOutNxtBtn")[0][0]);
        });
/*
      d3.select("#outputOptions")
        .append("div")
        .attr("id", "outChoice")
        .attr("class", "outChoice")
        .html('<div id="outDiv" class="choiceHeader outputHeader">Select Output Format</div>'); //<ul id="ulOut" class="nav nav-pills"><li id="comOut" class="active"><a href="#">Combined Species</a></li><li id="indOut"><a href="#">Individual Species</a></li></ul><hr style="margin-top:5px;margin-bottom:5px;"><div id="comOutDiv" class="output"></div><div id="indOutDiv" class="output"></div>');

      d3.select("#outDiv")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Output Format</center></b></u></p><p>Choose an option to determine initial output selections to produce.<br><br>All options eventually proceed to a preview window where output selections can be modified before being produced.</p>"></span>');

      d3.select("#outDiv")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Selections");

      //******Add procedural steps action
      //d3.select("#selOut").on("click", function() { stepAction(this); });

      //******Add in output options
      d3.select("#outChoice")
        .append("div")
        .attr("id", "outRadioDiv")
        .style({"text-align":"left"})
        .html('<label><input id="outBasic" type="radio" name="outRadio" value="basic" checked></input><span class="outLabel"> Basic Output </span></label><p><i>Simple output maps, summary figures, and tables (most protective critical load: most sensitive of all species present)</i></p><label><input id="outTail" type="radio" name="outRadio" value="tail"></input><span class="outLabel"> Tailored Output </span></label><p><i>Select from a checklist of questions to determine which output materials exactly suit your needs</i></p><label><input id="outComp" type="radio" name="outRadio" value="comp"></input><span class="outLabel"> Comprehensive Output </span></label><p><i>All relevant figures, tables, and maps</i></p>')
        .style("display", "block");

      //******Add button to advance to next screen
      d3.select("#outChoice")
        .append("div")
        .attr("id","outOptButton")
        .attr("class", "outButton")
        .text("Proceed with Selected Output Format")
        .property("title", "Proceed with output selection using the chosen output format")
        .on("click", function() { 
          d3.select("#outputOptions").style("display", "none");
          if(document.querySelector('input[name=outRadio]:checked').value == "tail") {
            d3.select("#areaScreen").text(d3.select("#areaList").attr("value"));
            checkTailorAnswers();
            d3.select("#outputTailor").style("display", "block");
          }
          else {
            addThumbs();
            setFigChecks(document.querySelector('input[name=outRadio]:checked').value);
            d3.select("#outputPreview").style("display", "block");
          }
        });




      //***Output Tailor Screen
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputTailor")
        .append("div")
        .attr("id", "outTailorChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivTailor" class="choiceHeader outputHeader">Tailored Output Screening Questions</div>');

      d3.select("#outDivTailor")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Screening Questions</center></b></u></p><p>These initial creening questions are used to determine which output best match your interests.<br><br>Depending on your answers, as you proceed to the next screen some figures might be excluded and/or some questions may be disabled. Your answers can always be changed by using the <b>Back Arrow</b> located in the lower left corner to return to this screen.</p>"></span>');

      d3.select("#outDivTailor")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Window");

      //******Add screening questions
      d3.select("#outTailorChoice")
        .append("div")
        .attr("id", "outTailorScreen")
        .style("background", "white")
        .html('<p>1. Would you like to see only the most protective critical load or critical loads for a range of<br>&nbsp;&nbsp;&nbsp;&nbsp;levels of protection?<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen1A" class="outCheck" name="outScreen1"><span>Most Protective CL</span></label><label><input type="radio" id="outScreen1B" class="outCheck" name="outScreen1"><span>Range of CLs</span></label>'
          + '<p>2. Would you like to see outputs for individual species, all species combined, or both?</label><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen2A" class="outCheck" name="outScreen2"><span>Individual Species Outputs</span></label><label><input type="radio" id="outScreen2B" class="outCheck" name="outScreen2"><span>Combined Species Outputs</span></label><label><input type="radio" id="outScreen2C" class="outCheck" name="outScreen2"><span>Both</span></label>'
          + '<p>3. Would you like to compare your site to other <span id="areaScreen"></span>?<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen3A" class="outCheck" name="outScreen3" style="margin-bottom:20px"><span>Yes</span></label><label><input type="radio" id="outScreen3B" class="outCheck" name="outScreen3"  style="margin-bottom:20px"><span>No</span></label>'
        );

      d3.select("#outTailorScreen").selectAll("label")
        .on("click", function() { checkTailorAnswers(); });

      //******Store screening question answers
      var outArrayStr = localStorage.getItem('outArray');
      if(outArrayStr != null) {
        var outArray = outArrayStr.split(",");
        if(Array.isArray(outArray)) {
          outArray.forEach(function(d) {
            d3.select("#" + d).property("checked", true);
          });
        }
      }

      //******Add back arrow
      d3.select("#outTailorChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputTailor").style("display", "none");
          d3.select("#outputOptions").style("display", "block");
        });
          

      //******Add button to proceed to next window
      d3.select("#outTailorChoice")
        .append("div")
        .attr("id", "outButtonTailor")
        .attr("class", "outButton disabledButton")
        .property("title", "Answer above questions to enable button")
        .text("Proceed to Output Refinement");


      //******Function to assess if all questions are answered
      function checkTailorAnswers() {
        if($("input[name=outScreen1]:checked").length > 0 && $("input[name=outScreen2]:checked").length > 0 && $("input[name=outScreen3]:checked").length > 0) {
          d3.select("#outButtonTailor")
            .classed("disabledButton", false)
            .property("title", "Proceed to further refine output based on the above selections")
            .on("click", function() {
              refineHTML();
              localStorage.setItem('outArray', [document.querySelector('input[name=outScreen1]:checked').id, document.querySelector('input[name=outScreen2]:checked').id, document.querySelector('input[name=outScreen3]:checked').id])
              d3.select("#outputTailor").style("display", "none");
              d3.select("#outputQuestions").style("display", "block");
            });
        }
      }






      //***Output Tailor Questions
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputQuestions")
        .append("div")
        .attr("id", "outQuestionsChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivQuestions" class="choiceHeader outputHeader">Tailored Output Refining Questions</div>');

      d3.select("#outDivQuestions")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Refining Questions</center></b></u></p><p>Refining questions further determine which output best match your interests. Please note that there are four pages of questions which are accessed through the <b><i>Page x</i></b> options below the question panel.<br><br>All but one question have example figures associated with them that will be selected for production if checked. For questions with multiple figures (multiple dots at the bottom of the figure), the additional figures can be viewed by clicking on either of the arrows at the edges of the figure or by clicking on a dot.<br><br>Disabled questions (slightly transparent, no mouse interaction) are the result of your answers to the screening questions on the previous window (use the <b>Back Arrow</b> to return to that window).</p>"></span>');

      d3.select("#outDivQuestions")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Window");

      //******Add screening questions
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "outRefineDiv");

*/

      function refineHTML() {
        $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();   
        });

        if(outUnit == "hectares") {
          var offsetPix = 127;
        }
        else {
          var offsetPix = 161;
        }
        
        d3.select("#outRefineDiv").html('' 
          + '<div id="exampleFigsPageDiv">Page <span id="currentPage" title="The current page of screening questions. To change the page click on the desired &#39;Page&#39; button towards the bottom of the window">1</span> of 4</div>'
          + '<div id="exampleFigs">Example Figures</div>'
          + '<div id="questionsExc" class="outRefineDivs" style="display:block;">'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);border-radius:4px 4px 0 0;">'
              + '<label style="position:relative;top:35px;"><input type="checkbox" class="refCheck" value="0"><span>Is there exceedance in the area?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);">'
              + '<label style="margin-left:50px;"><input type="checkbox" class="refCheck" value="1"><span>What percentage of my area is exceeded?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel1" class="carousel slide" data-ride="carousel" style="margin-left:44px">'
/*
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel1" data-slide-to="0" class="active"></li>'
                + '</ol>'
*/
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig15a.jpg" alt="fig15a" style="width:100%;">'
                  + '</div>'
                + '</div>'
/*
                + '<a class="left carousel-control" href="#refCarousel1" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel1" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
*/
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);">'
              + '<label style="margin-left:50px;"><input type="checkbox" class="refCheck" value="2"><span>How many ' + outUnit + ' have critical load<br>exceedance?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel2" class="carousel slide" data-ride="carousel" style="margin-left:' + offsetPix + 'px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel2" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel2" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig15b_' + outUnit + '.jpg" alt="fig15b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig15bi_' + outUnit + '.jpg" alt="fig15bi" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel2" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel2" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="3"><span>Which species have the most exceedance?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel3" class="carousel slide" data-ride="carousel" style="margin-left:78px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel3" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel3" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel3" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig2a.jpg" alt="fig2a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig2b_' + outUnit + '.jpg" alt="fig2b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig2bi_' + outUnit + '.jpg" alt="fig2b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel3" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel3" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsExcEM" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);">'
              + '<label><input type="checkbox" class="refCheck" value="4"><span>What is the extent and magnitude of exceedance<br>in my area?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel4" class="carousel slide" data-ride="carousel" style="margin-left:49px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel4" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel4" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel4" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig11a.jpg" alt="fig11a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig12a.jpg" alt="fig12a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig12b.jpg" alt="fig12b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel4" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel4" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);">'
              + '<label><input type="checkbox" class="refCheck" value="5"><span>What is the extent and magnitude of exceedance<br>by species?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel5" class="carousel slide" data-ride="carousel" style="margin-left:49px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel5" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel5" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel5" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig3a.jpg" alt="fig3a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig4a.jpg" alt="fig4a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig4c.jpg" alt="fig4c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel5" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel5" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,254,241);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="6"><span>How sensitive is my area to N deposition based<br>on site conditions?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel6" class="carousel slide" data-ride="carousel" style="margin-left:65px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel6" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel6" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig1a.jpg" alt="fig1a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig1b_' + outUnit + '.jpg" alt="fig1b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel6" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel6" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsNdepExc" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);">'
              + '<label><input type="checkbox" class="refCheck" value="7"><span>What percent of my area is <b>exceeded</b> at a given<br>N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel7" class="carousel slide" data-ride="carousel" style="margin-left:56px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel7" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel7" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel7" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13e.jpg" alt="fig13e" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13h.jpg" alt="fig13h" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13g.jpg" alt="fig13g" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel7" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel7" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);">'
              + '<label><input type="checkbox" class="refCheck" value="8"><span>What percent of my area is <b>exceeded</b> for each<br>species at a given N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel8" class="carousel slide" data-ride="carousel" style="margin-left:73px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel8" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel8" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/tab3b.jpg" alt="tab3b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig6c.jpg" alt="fig6c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel8" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel8" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="9"><span>How does the percentage of my area that is<br><b>exceeded</b> at a given N deposition level<br>compared to other areas of the same<br>type?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel9" class="carousel slide" data-ride="carousel" style="margin-left:106px">'
/*
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel9" data-slide-to="0" class="active"></li>'
                + '</ol>'
*/
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13f.jpg" alt="fig13f" style="width:100%;">'
                  + '</div>'
                + '</div>'
/*
                + '<a class="left carousel-control" href="#refCarousel9" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel9" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
*/
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsNdepPro" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);">'
              + '<label><input type="checkbox" class="refCheck" value="10"><span>What percent of my area is <b>protected</b> at a given<br>N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel10" class="carousel slide" data-ride="carousel" style="margin-left:56px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel10" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel10" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel10" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13a.jpg" alt="fig13a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13d.jpg" alt="fig13d" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13c.jpg" alt="fig13c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel10" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel10" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);">'
              + '<label><input type="checkbox" class="refCheck" value="11"><span>What percent of my area is <b>protected</b> for each<br>species at a given N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel11" class="carousel slide" data-ride="carousel" style="margin-left:73px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel11" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel11" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/tab3c.jpg" alt="tab3c" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig6a.jpg" alt="fig6a" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel11" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel11" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="12"><span>How does the percentage of my area that is<br><b>protected</b> at a given N deposition level<br>compare to other areas of the same<br>type?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel12" class="carousel slide" data-ride="carousel" style="margin-left:106px">'
/*
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel12" data-slide-to="0" class="active"></li>'
                + '</ol>'
*/
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13b.jpg" alt="fig13b" style="width:100%;">'
                  + '</div>'
                + '</div>'
/*
                + '<a class="left carousel-control" href="#refCarousel12" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel12" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
*/
              + '</div>'
            + '</div>'
          + '</div>'
        )

        //***Check boxes for previous in session selections
        var tailorArrayStr = localStorage.getItem('tailorArray');
        if(tailorArrayStr != null) {
          var tailorArray = tailorArrayStr.split(",");
          if(Array.isArray(tailorArray)) {
            d3.select("#outRefineDiv").selectAll(".refCheck")[0].forEach(function(tmpChk,i) {
              if(tailorArray[i] == "true") {
                d3.select(tmpChk).property("checked", true);
              }
              else {
                d3.select(tmpChk).property("checked", false);
              }
            });
          }
        }

        
        //***Add styles and titles
        d3.select("#outRefineDiv").selectAll("label,input")
          .style("cursor", "pointer")
          .property("title", "Check to produce the associated example figures for your output");

        d3.select("#outRefineDiv").selectAll(".carousel").property("title", "Example of output that will be produced when this option is checked");

        //******Adjust images to accomodate screening question answers
        //***Question 1
        if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1A") {
          d3.select(d3.select("#refCarousel4").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel4").select("ol").selectAll("li")[0][2]).remove();

          d3.select(d3.select("#refCarousel7").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel7").select("ol").selectAll("li")[0][2]).remove();
          d3.select(d3.select("#refCarousel7").select("div").selectAll("div")[0][1]).remove();
          d3.select(d3.select("#refCarousel7").select("ol").selectAll("li")[0][1]).remove();
          d3.select("#refCarousel7").selectAll(".left,.right,.carousel-indicators").remove();

          d3.select(d3.select("#refCarousel10").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel10").select("ol").selectAll("li")[0][2]).remove();
          d3.select(d3.select("#refCarousel10").select("div").selectAll("div")[0][1]).remove();
          d3.select(d3.select("#refCarousel10").select("ol").selectAll("li")[0][1]).remove();
          d3.select("#refCarousel10").selectAll(".left,.right,.carousel-indicators").remove();
        }

        //***Question 2
        if(document.querySelector('input[name=outScreen2]:checked').id == "outScreen2A") {
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][0]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
        }
        else if(document.querySelector('input[name=outScreen2]:checked').id == "outScreen2B") {
          d3.select(d3.select("#questionsExc").selectAll(".refQuestCatDiv")[0][3]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsNdepExc").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsNdepPro").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
        }

        //***Question 3
        if(document.querySelector('input[name=outScreen3]:checked').id == "outScreen3B") {
          d3.select(d3.select("#questionsNdepExc").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});          
          d3.select(d3.select("#questionsNdepPro").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});          
        }     

        //***Display div with the active dot
        d3.selectAll(".outRefineDivs").style("display", "none");
        d3.select("#" + d3.select("#refineDots").select(".active").attr("value")).style("display", "block");
        d3.select("#currentPage").text(d3.select("#refineDots").select(".active").attr("data-page"));

        //***Set slide change time
        $('.carousel').carousel({
          interval: false
        })
      }




      //******Add dots to change questions
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "refineDots")
        .html('<div id="dotExc" class="refineDots active" value="questionsExc" data-page="1" title="Exceedance by area and species">Page 1</div><div id="dotExcEM" class="refineDots" value="questionsExcEM" data-page="2" title="Exceedance extent, magnitude, and sensitivity by area, species, and site conditions">Page 2</div><div id="dotNdepExc" class="refineDots" value="questionsNdepExc" data-page="3" title="Area in EXCEEDANCE for a given N deposition level">Page 3</div><div id="dotNdepPro" class="refineDots" value="questionsNdepPro" data-page="4" title="Area PROTECTED for a given N deposition level">Page 4</div>');

      d3.selectAll(".refineDots")
        .on("click", function() { 
          d3.selectAll(".refineDots").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".outRefineDivs").style("display", "none");
          d3.select("#" + d3.select(this).attr("value")).style("display", "block");
          d3.select("#currentPage").text(d3.select(this).attr("data-page"));
        });

      //******Add back arrow
      d3.select("#outQuestionsChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputQuestions").style("display", "none");
          d3.select("#outputTailor").style("display", "block");
        });
          

      //******Add button to proceed to next window
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "outButtonQuestions")
        .attr("class", "outButton")
        .style({"margin-top":"0","float":"right","margin-right":"10px","width":"30%"})
        .property("title", "Proceed to preview examples of outputs based on the above selections")
        .text("Proceed to Output Preview")
        .on("click", function() {
          var tailorArray = [];
          d3.select("#outRefineDiv").selectAll(".refCheck")[0].forEach(function(tmpChk,i) {
            tailorArray.push(d3.select(tmpChk).property("checked"));
          });
          localStorage.setItem("tailorArray", tailorArray);
          addThumbs();
          setFigChecks("tail");
          d3.select("#outputQuestions").style("display", "none");
          d3.select("#outputPreview").style("display", "block");
        });







      //******Function to disable figure thumbs for unselected figures
      function setFigChecks(tmpOut) {
        if(tmpOut == "basic") {
          var outArray = {"fig15a": true, ["fig15b_" + outUnit]: true, ["fig15bi_" + outUnit]: false, "fig2a": true, ["fig2b_" + outUnit]: false, ["fig2bi_" + outUnit]: false, "fig11a": false, "fig12a": false, "fig12b": false, "fig3a": false, "fig4a": false, "fig4c": false, "fig1a": false, ["fig1b_" + outUnit]: false, "fig9a": false, "fig9b": false, "fig13e": false, "fig13h": false, "fig13g": false, "fig6c": false, "fig13f": false, "fig13a": false, "fig13d": false, "fig13c": false, "fig6a": false, "fig13b": false, "tab3b": true, "tab3c": true}; //, "tab2c": false, "tab2a": false, "tab1c": false, "tab1a": false};
        }
        else if(tmpOut == "tail") {
          var outArray = {"fig15a": false, ["fig15b_" + outUnit]: false, ["fig15bi_" + outUnit]: false, "fig2a": false, ["fig2b_" + outUnit]: false, ["fig2bi_" + outUnit]: false, "fig11a": false, "fig12a": false, "fig12b": false, "fig3a": false, "fig4a": false, "fig4c": false, "fig1a": false, ["fig1b_" + outUnit]: false, "fig9a": false, "fig9b": false, "fig13e": false, "fig13h": false, "fig13g": false, "fig6c": false, "fig13f": false, "fig13a": false, "fig13d": false, "fig13c": false, "fig6a": false, "fig13b": false, "tab3b": false, "tab3c": false}; //, "tab2c": false, "tab2a": false, "tab1c": false, "tab1a": false};
          var tmpChecked = d3.selectAll(".refCheck")[0];
          tmpChecked.forEach(function(tmpEl) {
            if(d3.select(tmpEl).property("checked")) {
              switch (d3.select(tmpEl).attr("value")) {
                case "0":
                  
                  break;
                case "1":
                  outArray.fig15a = true;
                  break;
                case "2":
                  outArray["fig15b_" + outUnit] = true;
                  outArray["fig15bi_" + outUnit] = true;
                  break;
                case "3":
                  outArray.fig2a = true;
                  outArray["fig2b_" + outUnit] = true;
                  outArray["fig2bi_" + outUnit] = true;
                  break;
                case "4":
                  outArray.fig11a = true;
                  outArray.fig12a = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig12b = true;
                  }
                  break;
                case "5":
                  outArray.fig3a = true;
                  outArray.fig4a = true;
                  outArray.fig4c = true;                  
                  break;
                case "6":
                  outArray.fig1a = true;
                  outArray["fig1b_" + outUnit] = true;
                  break;
                case "7":
                  outArray.fig13e = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig13h = true;
                    outArray.fig13g = true;
                  }
                  break;
                case "8":
                  outArray.fig6c = true;
                  outArray.tab3b = true;
                  break;
                case "9":
                  outArray.fig13f = true;
                  break;
                case "10":
                  outArray.fig13a = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig13d = true;
                    outArray.fig13c = true;
                  }
                  break;
                case "11":
                  outArray.fig6a = true;
                  outArray.tab3c = true;
                  break;
                case "12":
                  outArray.fig13b = true;
                  break;
              }
            }
          });
        }
        else if(tmpOut == "comp") {
          var outArray = {"fig15a": true, ["fig15b_" + outUnit]: true, ["fig15bi_" + outUnit]: true, "fig2a": true, ["fig2b_" + outUnit]: true, ["fig2bi_" + outUnit]: true, "fig11a": true, "fig12a": true, "fig12b": true, "fig3a": true, "fig4a": true, "fig4c": true, "fig1a": true, ["fig1b_" + outUnit]: true, "fig9a": true, "fig9b": true, "fig13e": true, "fig13h": true, "fig13g": true, "fig6c": true, "fig13f": true, "fig13a": true, "fig13d": true, "fig13c": true, "fig6a": true, "fig13b": true, "tab3b": true, "tab3c": true}; //, "tab2c": true, "tab2a": true, "tab1c": true, "tab1a": true};
        }

        var outArrayKeys = d3.keys(outArray);

        outArrayKeys.forEach(function(key) {
          if(outArray[key] == false) {
            $("#" + key + "Check").click();
          }
        });

      }









      //***Output Preview
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputPreview")
        .append("div")
        .attr("id", "outPreviewChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivPreview" class="choiceHeader outputHeader">Preview Examples of Selected Output</div>');

      d3.select("#outDivPreview")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Example Output Preview</center></b></u></p><p>This window provides thumbnails of example output figures and serves as a summary of which ones are currently selected to be produced for your data.<br><br>Click <span class=&quot;glyphicon glyphicon-ok-sign figCheck&quot; style=&quot;color:slategray;margin:0;&quot;></span> to select an output that is not selected.<br><br>Click <span class=&quot;glyphicon glyphicon-ok-sign figCheck&quot; style=&quot;color:royalblue;margin:0;&quot;></span> to deselect an output that is selected.<br><br>More information about a figure is accessed by clicking on the figure. This will place a copy of the figure in the upper right panel and a text description in the lower right panel. To zoom in on the figure further scroll over it with the cursor.<br><br>Please note that there are two pages of figures which are accessed by clicking on the <span class=&quot;previewDots active&quot; style=&quot;margin:0;&quot;>Page <i>x</i></span> option below the thumbnail panel.</p>"></span>');

      d3.select("#outDivPreview")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Selections");

      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "outPreviewDiv")
        .html('<div id="prevThumbs"></div><div id="prevLarge" style="border-radius:0 4px 0 0;border-top:1px solid gray;"><p id="prevLargeP">Click on an image to view here</p><img id="prevLargeImg"></img><p id="prevZoomP">Mouseover above figure to zoom in</p></div><div id="prevDescribe" style="border-radius:0 0 4px 0;"><p id="prevDescribeP"></p></div>');

      d3.select("#prevThumbs")
        .html('<div id="prevExc" class="outPreviewDivs" style="display:block;"></div><div id="prevNdep" class="outPreviewDivs" style="display:none;"></div><div id="prevHoverImgDiv"><img id="prevHoverImg"></img></div>');



      //***Add thumbnail images to preview screen
      function addThumbs() {
        $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();   
        });

        //outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + 
        var thumbArrayExc = [["fig15a", "fig15b_" + outUnit, "fig11a", "fig4c"], ["fig2a", "fig15bi_" + outUnit, "fig12a", "fig3a"], ["fig2b_" + outUnit, "fig2bi_" + outUnit, "fig12b", "fig4a"], ["fig1a", "fig1b_" + outUnit, "fig9a", "fig9b"]];
        var iconTitleArrayExc = [["% Area in EXC of Min CL (site)", "Area in EXC of Min CL (site)", "EXC Magnitude (combined spp.)", "EXC Magnitude (all spp.)"], ["% Area in EXC Min CL (species)", "Area in EXC of Min CL (site)", "EXC Magnitude (combined spp.)", "EXC Magnitude (ind. spp.)"], ["Area in EXC of Min CL (species)", "Area in EXC of Min CL (species)", "EXC Magnitude (multi-CL)", "EXC Magnitude (ind. spp.)"], ["% Area Sensitive to N Dep", "Area Sensitive to N Dep", "Cum. % Area (min CL)", "Cum. % Area (multi-CL)"]];
        var hoverArrayExc = [["% area in exceedance of the most protective CL for all species combined at the selected areas", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of the most protective CL for all species combined at the selected areas", "Info for fig11a", "Info for fig4c"],["% area in exceedance of the most protective CL for all selected individual species at the given site", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of the most protective CL for all species combined at the selected areas (red bars) and the area with NO exceedance (blue bars)", "Info for fig12a", "The extent and magnitude of exceedance of most protective critical load for a single species at the given site"],[outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of most protective critical load for all selected individual species at the given site", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of most protective critical load stacked (for relativity) with area not in exceedance of most protective critical load for all selected individual species at the given site", "Info for fig12b", "The extent and magnitude of exceedance of most protective critical load for a single species at the given site"],["Percent of the area occupied by each species where adjusted CL falls in the more sensitive portion of the CL range based on site and climate conditions", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " occupied by each species more sensitive to N deposition (adjusted CL falls into the bottom half of the CL range [purple]) and less sensitive to N deposition (adjusted CL falls into the top half of the CL range [green])", "Info for fig9a", "Info for fig9b"]];
        var figDescArrayExc = [["This figure shows the percent of the area for which at least one species of all the species present has exceedance of the most protective CL. In each pixel, the most protective CL is set based on the most sensitive species. The area in exceedance is at risk of detrimental effects from N deposition.", "This figure shows the area (" + outUnit + ") for which at least one species of all the species present has exceedance of the most protective CL. In each pixel, the most protective CL is set based on the most sensitive species. The area in exceedance is at risk of detrimental effects from N deposition. Since the size of the areas being compared varies, this figure may have a different order of areas in ranking them from lowest to greatest area exceeded than the figure arranged by % of area in exceedance.", "Figure description for fig11a", "Figure description for fig4c"]];
          figDescArrayExc.push(["Figure description for fig2a", "This figure shows the " + outUnit + " for which at least one species of all the species present has exceedance of the most protective CL (red bars) and the area with NO exceedance (blue bars). The area in exceedance is at risk of detrimental effects from N deposition. Since the size of the areas being compared varies, this figure may have a different order of areas in ranking them from lowest to greatest area exceeded than the figure arranged by % of area in exceedance.", "Figure description for fig12a", "Figure description for fig3a"]);
          figDescArrayExc.push(["Figure description for fig2b", "Figure description for fig2bi", "Figure description for fig12b", "Figure description for fig4a"]);
          figDescArrayExc.push(["This figure shows percent of the area occupied by this species that is more susceptible to negative effects from N deposition based on site conditions. This is the percent of area covered by this species for which the CL is adjusted to the bottom half of the CL range (more sensitive) for all selected individual species at the given site. The percent of the area covered by the species may be the same as the total area or it may be less. This figure gives a sense of the extent to which the site conditions create suboptimal growing conditions for the given species, potentially exacerbating the effects of N deposition.", "This figure shows the " + outUnit + " occupied by this species that are more susceptible to negative effects from N deposition based on site conditions (purple bars) and the " + outUnit + " that are less susceptible to negative effects from N deposition (green bars). This is the " + outUnit + " covered by this species for which the CL is adjusted to the bottom half of the CL range (more sensitive-purple bars) or for which the CL is adjusted to the top half of the CL range for all selected individual species at the given site. This figure gives a sense of the area over which optimal or suboptimal growing conditions exist for each species.", "Figure description for fig9a", "Figure description for fig9b"]);

        var figUseArrayExc = [["This information gives an overview of the potential risk of detrimental effects from N deposition. Additional figures will provide information about the area in exceedance and the individual species patterns.", "This information allows comparison of " + outUnit + " in exceedance for different " + d3.select('#areaList').attr('value') + ". Additional figures will provide information about the " + outUnit + " in exceedance and the individual species patterns.", "Application for fig11a", "Application for fig4c"]];
          figUseArrayExc.push(["Application for fig2a", "This information allows comparison of the size of the area in exceedance for different " + d3.select("#areaList").attr("value") + ". It also combines the information from the % area exceeded figure, so that it is possible to see the size of the area in exceedance and also what fraction of the area is exceeded. Additional figures will provide information about the area in exceedance and the individual species patterns.", "Application for fig12a", "Application for fig3a"]);
          figUseArrayExc.push(["Application for fig2b", "Application for fig2bi", "Application for fig12b", "Application for fig4a"]);
          figUseArrayExc.push(["This information is useful in assessing about how the area might respond to other environmental stressors. For example, if most of the area covered by the species has site conditions which are not optimal for growth, another stressor (for example, climate change) might further compromise the success of the species in this area.", "This information can be used to determine the extent (area) of sub-optimal or optimal growing conditions and is useful for determining the extent to which a site might be compromised by N deposition or susceptible to secondary environmental stressors.", "Application for fig9a", "Application for fig9b"]);

        var colorArrayExc = [["pink", "pink", "blue", "blue"], ["pink", "pink", "blue", "blue"], ["pink", "pink", "blue", "blue"], ["yellow", "yellow", "yellow", "yellow"]];



        var thumbArrayNdep = [["fig13e", "tab3b", "fig13a", "tab3c"], ["fig13f", "fig13h", "fig13b", "fig13d"], ["fig13g", "fig6c", "fig13c", "fig6a"]];
        var iconTitleArrayNdep = [["% Area Exceeded (min CL)", "% Area Exceeded (species)", "% Area Protected (min CL)", "% Area Protected (species)"], ["% Area Exceeded (multi-site)", "% Area Exceeded (sensitive CLs)", "% Area Protected (multi-site)", "% Area Protected (sensitive CLs)"], ["% Area Exceeded (multi-CLs)", "% Area Exceeded (species)", "% Area Protected (multi-CLs)", "% Area Protected (species)"]];
        var hoverArrayNdep = [["Cumulative percent of the total area at risk from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios at a single site", "Percent of the selected area occupied by each species at risk from negative N deposition impacts using the most protective CL threshold across a range of N deposition levels", "Cumulative percent of the total area protected from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios at a single site", "Percent of the selected area occupied by each species protected from negative N deposition impacts using the most protective CL threshold across a range of N deposition scenarios and selected sites"],["Cumulative percent of the total area where N deposition is in exceedance of the most protective CL threshold, considering all species present, across a range of N deposition scenarios and selected sites", "Info for fig13h", "Cumulative percent of the total area protected from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios and selected sites", "Info for fig13d"],["Info for fig13g", "Info for fig6c", "Info for fig13c", "Info for fig6a"]];
        var figDescArrayNdep = [["Figure description for fig13e", "This figure gives a sense of how changing N deposition levels may alter the proportion of area occupied by each species that is likely to experience negative impacts across a range of N deposition levels.", "Figure description for fig13a", "This figure gives a sense of how changing N deposition levels may alter the proportion of area occupied by each species that is protected from negative impacts at the selected area."]];
          figDescArrayNdep.push(["This figure gives a sense of how changing N deposition levels may alter the proportion of forest community as a whole (considering all species present) that is likely to experience negative impacts across a range of N deposition levels, with relative comparisons across selected sites.", "Figure description for fig13h", "This figure gives a sense of how changing N deposition levels may alter the proportion of area protected from negative impacts to the forest community as a whole (considering all species present), with relative comparisons across selected sites.", "Figure description for fig13d"]);
          figDescArrayNdep.push(["Figure description for fig13g", "Figure description for fig6c", "Figure description for fig13c", "Figure description for fig6a"]);

        var figUseArrayNdep = [["Application for fig13e", "This information helps understand how the proportion of area negatively impacted by N deposition may change for each species if deposition levels increased (increasing area in exceedance), or decreased (decreasing area in exceedance).", "Application for fig13e", "This information helps understand how the proportion of area protected against negative impacts may change for each species if deposition levels increased (decreasing protected area), or decreased (increasing protected area)."]];
          figUseArrayNdep.push(["This information helps understand how the proportion of overall forested area that may be impacted by N deposition may change if deposition levels increased (increasing area in exceedance), or decreased (decreasing area in exceedance).", "Application for fig13h", "This information helps understand how the proportion of overall forested area protected against negative impacts may change if N deposition levels increased (reducing protected area), or decreased (increasing protected area).", "Application for fig13d"]);
          figUseArrayNdep.push(["Application for fig13g", "Application for fig6c", "Application for fig13c", "Application for fig6a"]);

        var colorArrayNdep = [["mauve", "mauve", "green", "green"], ["mauve", "mauve", "green", "green"], ["mauve", "mauve", "green", "green"]];




        d3.select("#prevExc").selectAll("*").remove();

        thumbArrayExc.forEach(function(rowArray, i) {
          d3.select("#prevExc")
            .append("div")
            .attr("id", "prevExcRow" + i);

          rowArray.forEach(function(fig, j) {
            d3.select("#prevExcRow" + i)
              .append("div")
              .attr("id", fig + "Div")
              .attr("class", function() { return "prevThumbImgDiv " + colorArrayExc[i][j]; })
              .append("p")
              .text(iconTitleArrayExc[i][j]);

            d3.select("#" + fig + "Div")
              .append("img")
              .attr("id", fig + "Img")
              .attr("class", "prevThumbImg Exc")
              .attr("value", [i,j])
              .property("title", hoverArrayExc[i][j])
              .attr("src", "images/" + fig + ".jpg");

            d3.select("#" + fig + "Div")
              .append("div")
              .attr("class", "thumbGlyphsDiv")
              .html('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figDescArrayExc[i][j] + '"></span><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figUseArrayExc[i][j] + '"></span><span id="' + fig + 'Check" value="' + fig + '" class="glyphicon glyphicon-ok-sign figCheck" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="Click to exclude figure from produced output"></span>');
          });
        });

        //***reset large preview image
        d3.select("#prevLargeImg").style("display", "none");
        d3.select("#prevZoomP").style("display", "none");


        //***Add enlarged view links
        d3.selectAll(".prevThumbImg.Exc")
          .on("click", function() {
            var tmpVals = d3.select(this).attr("value").split(",");
            d3.select("#prevLargeP").text(iconTitleArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevLargeImg")
              .attr("src", "images/" + thumbArrayExc[tmpVals[0]][tmpVals[1]] + ".jpg")
              .style("display", "block")
              .on("mouseover", function() { d3.select("#prevHoverImgDiv").style("display", "block"); })
              .on("mouseout", function() { d3.select("#prevHoverImgDiv").style("display", "none"); });
            d3.select("#prevZoomP").style("display", "block");
            d3.select("#prevDescribeP").html('<b><u>Information</u></b><br>' + figDescArrayExc[tmpVals[0]][tmpVals[1]] + '<br><br><b><u>Application</u></b><br>' + figUseArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImgDiv").attr("class", colorArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImg").attr("src", "images/" + thumbArrayExc[tmpVals[0]][tmpVals[1]] + ".jpg");
          });





        d3.select("#prevNdep").selectAll("*").remove();
        thumbArrayNdep.forEach(function(rowArray, i) {
          d3.select("#prevNdep")
            .append("div")
            .attr("id", "prevNdepRow" + i);

          rowArray.forEach(function(fig, j) {
            d3.select("#prevNdepRow" + i)
              .append("div")
              .attr("id", fig + "Div")
              .attr("class", function() { return "prevThumbImgDiv " + colorArrayNdep[i][j]; })
              .append("p")
              .text(iconTitleArrayNdep[i][j]);

            d3.select("#" + fig + "Div")
              .append("img")
              .attr("id", fig + "Img")
              .attr("class", "prevThumbImg Ndep")
              .attr("value", [i,j])
              .property("title", hoverArrayNdep[i][j])
              .attr("src", "images/" + fig + ".jpg");

            d3.select("#" + fig + "Div")
              .append("div")
              .attr("class", "thumbGlyphsDiv")
              .html('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figDescArrayNdep[i][j] + '"></span><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figUseArrayNdep[i][j] + '"></span><span id="' + fig + 'Check" value="' + fig + '" class="glyphicon glyphicon-ok-sign figCheck" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="Click to exclude figure from produced output"></span>');
          });
        });

        d3.selectAll(".prevThumbImg.Ndep")
          .on("click", function() {
            var tmpVals = d3.select(this).attr("value").split(",");
            d3.select("#prevLargeP").text(iconTitleArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevLargeImg")
              .attr("src", "images/" + thumbArrayNdep[tmpVals[0]][tmpVals[1]] + ".jpg")
              .style("display", "block")
              .on("mouseover", function() { d3.select("#prevHoverImgDiv").style("display", "block"); })
              .on("mouseout", function() { d3.select("#prevHoverImgDiv").style("display", "none"); });
            d3.select("#prevDescribeP").html('<b><u>Information</u></b><br>' + figDescArrayNdep[tmpVals[0]][tmpVals[1]] + '<br><br><b><u>Application</u></b><br>' + figUseArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImgDiv").attr("class", colorArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImg").attr("src", "images/" + thumbArrayNdep[tmpVals[0]][tmpVals[1]] + ".jpg");
          });


        //***Add disable function to check mark icon
        d3.selectAll(".figCheck")
          //.property("title", "Click to exclude figure from produced output")
          .on("click", function() {
            if(d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected") == false) {
              d3.select(this)
                .property("title", "Click to include figure in produced output")
                .attr("data-original-title", "Click to include figure in produced output");
              d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected", true);
            }
            else {
              d3.select(this)
                .attr("data-original-title", "Click to exclude figure from produced output");
              d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected", false);
            }
          });
      }




      //******Add dots to change preview graphs
      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "previewDots")
        .html('<div id="prevDotExc" class="previewDots active" value="prevExc" title="Exceedance by area and species">Page 1</div><div id="prevDotNdep" class="previewDots" value="prevNdep" title="Area exceedance/protection for a given N deposition level">Page 2</div>');

      d3.selectAll(".previewDots")
        .on("click", function() { 
          d3.selectAll(".previewDots").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".outPreviewDivs").style("display", "none");
          d3.select("#" + d3.select(this).attr("value")).style("display", "block");
        });

      //******Add back arrow
      d3.select("#outPreviewChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputPreview").style("display", "none");
          if(document.querySelector('input[name=outRadio]:checked').value == "tail") {
            d3.select("#outputQuestions").style("display", "block");
          }
          else {
            d3.select("#outputOptions").style("display", "block");
          }
        });

      //******Add button to generate results
      d3.select("#outPreviewChoice")
        .append("div")
        .attr("class", "outButton")
        .style("margin-top", "0")
        .text("Generate Results")
        .property("title", "Produce the selected figures and their associated tables for your data")
        .on("click", function() { 
          get_output();
          d3.select("#waitingDiv").style("display", "block");
          d3.select("#container-results").style("display", "none");
          d3.select("#selRes").classed("disabled", false).property("title", "View results");
          //d3.selectAll(".selDiv").classed("selected", false);
          //d3.select("#selRes").classed("selected", true);
        });

      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "waitingDiv")
        .html('<img src="images/animated-gears.gif"></img><h3>Processing</h3>');






      function get_output() {
        var tmpAreas = [];
        d3.selectAll(".remCheck")[0].forEach(function(d) { if(d.checked) { tmpAreas.push(d.value); } });

        var tmpSpp = [];
        d3.selectAll(".sppCheck")[0].forEach(function(d) { if(d.checked) { tmpSpp.push(speciesNames[d.value]); } });

        switch(document.querySelector('input[name=outRadio]:checked').value) {
          case "basic":
            var tmpVals = {"type":"comp", "area": findArea(), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
          case "tail":
            var tmpVals = {"type":"comp", "area": findArea(), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
          case "comp":
            //var tmpVals = {"type":"comp", "area": d3.select("#areaList").attr("value"), "areas": tmpAreas, "species": tmpSpp};
            var tmpVals = {"type":"comp", "area": findArea(), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
        }
      }



      function findArea() {
        var tmpArea = d3.select("#areaList").attr("value");
        if(tmpArea == "Level III Ecoregions") {
          return "Ecoregions Level 3";
        }
        else if(tmpArea == "Level II Ecoregions") {
          return "Ecoregions Level 2";
        }
        else {
          return tmpArea;
        }
      }




/*
      //******Add results div
      d3.select("#right_panel_container")
        .append("div")
        .attr("id", "resChoice")
        .attr("class", "choice")
        .style("display", "block")
        .append("div")
        .attr("id", "resHeader")
        .html('<div class="choiceHeader" style="background:rgb(255,192,0);">Results</div><ul id="ulRes" class="nav nav-pills"><li id="resFigs" class="active" title="Graph output"><a href="#">Graphs</a></li><li id="resTabs" title="Table output"><a href="#">Tables</a></li><li id="resMaps" title="Critical load and exceedance maps for combined species and selected individual species"><a href="#">Maps</a></li></ul><hr style="margin:0;">');

      d3.select("#resChoice")
        .append("div")
        .attr("id", "resSubHeader")
        .html('<div><ul id="ulResSub" class="nav nav-pills"><li id="resFigsCurrent" class="active" title="Critical load and exceedance output for current N deposition levels"><a href="#">Current Condition</a></li><li id="resFigsResponse" title="Cumulative exceedance and protection output for varying levels of N deposition"><a href="#">Response to N Dep</a></li></ul></div><hr style="margin:0;"><div id="resSubSubHeader"><div id="resSubSubCurrent" class="resSubSub"><ul id="ulResSubSubCurrent" class="nav nav-pills"></ul></div><div id="resSubSubResponse" class="resSubSub"><ul id="ulResSubSubResponse" class="nav nav-pills"></ul></div><hr style="margin:0;"></div>');
        //.html('<div><ul id="ulResSub" class="nav nav-pills"><li id="resFigsCurrent" class="active" title="Critical load and exceedance output for current N deposition levels"><a href="#" style="background-color:rgb(180,198,231);">Current Condition</a></li><li id="resFigsResponse" title="Cumulative exceedance and protection output for varying levels of N deposition"><a href="#" style="background-color:rgb(255,230,153);">Response to N Dep</a></li></ul></div><hr style="margin:0;"><div id="resSubSubHeader"><div id="resSubSubCurrent" class="resSubSub"><ul id="ulResSubSubCurrent" class="nav nav-pills"></ul></div><div id="resSubSubResponse" class="resSubSub"><ul id="ulResSubSubResponse" class="nav nav-pills"></ul></div><hr style="margin:0;"></div>');

      d3.select("#ulResSubSubCurrent")
        .html('<li id="ExAreaPill" class="li3 active" title="Measures of exceedance for areas and species"><a href="#" class="pink">EXC Area</a></li><li id="ExMagPill" class="li3" title="Extent and magnitude of exceedance for areas and species" style="width:33%;"><a href="#" class="blue">EXC Magnitude</a></li><li id="CLPill" class="li3" title="Critical load sensitivities to N deposition for species and areas based on site conditions"><a href="#" class="yellow">CL</a></li>')
        .selectAll("li")
          .on("click", function() {
            d3.select("#ulResSubSubCurrent").selectAll("li").classed("active", false);
            d3.select(this).classed("active", true);
            setSubHeader();
          });

      d3.select("#ulResSubSubResponse")
        .html('<li id="ExcPill" class="li2 active" title="Cumulative measure of increase in exceedance over varying levels of N deposition"><a href="#" class="mauve">Area Exceeded</a></li><li id="ProPill" class="li2" title="Cumulative measure of decrease in protection over varying levels of N deposition"><a href="#" class="green">Area Protected</a></li>')
        .selectAll("li")
          .on("click", function() {
            d3.select("#ulResSubSubResponse").selectAll("li").classed("active", false);
            d3.select(this).classed("active", true);
            setSubHeader();
          });

      d3.select("#resChoice")
        .append("div")
        .attr("id", "resOptions")
        .html('<div id="resFigsDiv" class="results"><div id="resFigsExArea"></div><div id="resFigsExMag"></div><div id="resFigsCL"></div><div id="resFigsExc"></div><div id="resFigsPro"></div></div><div id="resTabsDiv" class="results"><div id="resTabsCurrent"></div><div id="resTabsResponse"></div></div><div id="resMapsDiv" class="results"></div>');
        //.html('<div id="resFigsDiv" class="results"><div id="resFigsExArea"></div><div id="resFigsExMag"></div><div id="resFigsCL"></div><div id="resFigsExc"></div><div id="resFigsPro"></div></div><div id="resTabsDiv" class="results"><div id="resTabsExArea"></div><div id="resTabsExMag"></div><div id="resTabsCL"></div><div id="resTabsExc"></div><div id="resTabsPro"></div></div><div id="resMapsDiv" class="results"></div>');
      
      d3.select("#resFigsDiv").selectAll("div").attr("class", "resFigsSub");
      d3.select("#resTabsDiv").selectAll("div").attr("class", "resTabsSub");

      //******Add pill functionality
      d3.select("#resFigs")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 166px");
          d3.select("#resFigsDiv").style("display", "block");
        });

      d3.select("#resTabs")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 128px");
          d3.select("#resTabsDiv").style("display", "block");
          setTimeout(function() {
            d3.select("#resTabsDiv").selectAll("canvas")[0].forEach(function(tmpCan) {
              chartCanvas[tmpCan.id + "Small"].update();
              var tmpPrint = chartCanvas[tmpCan.id + "Small"];
              var tmpRect = document.getElementById(tmpCan.id).getBoundingClientRect();
              addInfo(tmpPrint, chartOpts[tmpCan.id].small.cl[0], tmpRect, "small", 1, tmpCan.id);
            });
          }, 300);
        });

      d3.select("#resMaps")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 87px");
          d3.select("#resMapsDiv").style("display", "block");
          setSubHeader();
          //d3.select("#speciesListDropdown").style("display", "inline-block");
          d3.select("#container-results").style("display", "none");
          //if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left")) {
          //  toggleSelections("left_collapse");
          //}
        });


      //***Subhead pill functionality
      d3.select("#resFigsCurrent")
        .on("click", function() {
          d3.select("#ulResSub").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
        });

      d3.select("#resFigsResponse")
        .on("click", function() {
          d3.select("#ulResSub").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
        });



      //******Add procedural steps action
      //d3.select("#selRes").on("click", function() { stepAction(this); });

      //*****Initialize display
      setSubHeader();
      d3.select("#resFigsDiv").style("display", "block");




      //*******Function to change which output is displayed
      function setSubHeader() {
        if(d3.select("#ulRes").select(".active").attr("id") == "resFigs") {
          d3.select("#resSubHeader").style("display", "block");
          d3.select("#resSubSubHeader").style("display", "block");         
          d3.selectAll(".resSubSub").style("display", "none");
          d3.selectAll(".resFigsSub").style("display", "none");

          if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsCurrent") {
            d3.select("#resSubSubCurrent").style("display", "block");
            d3.select("#resFigs" + d3.select("#ulResSubSubCurrent").select(".active").attr("id").replace("Pill","")).style("display", "block");              
          }
          else if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsResponse") {
            d3.select("#resSubSubResponse").style("display", "block");
            d3.select("#resFigs" + d3.select("#ulResSubSubResponse").select(".active").attr("id").replace("Pill","")).style("display", "block");
          }
        }
        else if(d3.select("#ulRes").select(".active").attr("id") == "resTabs") {
          d3.select("#resSubHeader").style("display", "block"); 
          d3.select("#resSubSubHeader").style("display", "none");         
          d3.selectAll(".resSubSub").style("display", "none");
          d3.selectAll(".resTabsSub").style("display", "none");

          if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsCurrent") {
            d3.select("#resTabsCurrent").style("display", "block");
            //d3.select("#resSubSubCurrent").style("display", "block");
            //d3.select("#resTabs" + d3.select("#ulResSubSubCurrent").select(".active").attr("id").replace("Pill","")).style("display", "block");              
          }
          else if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsResponse") {
            d3.select("#resTabsResponse").style("display", "block");
            //d3.select("#resSubSubResponse").style("display", "block");
            //d3.select("#resTabs" + d3.select("#ulResSubSubResponse").select(".active").attr("id").replace("Pill","")).style("display", "block");
          }
        }
        else if(d3.select("#ulRes").select(".active").attr("id") == "resMaps") {
          d3.select("#resSubHeader").style("display", "none");
        }

      }
*/



      function addFigure(src) {
        d3.select("#resImg").property("src", src);
        d3.selectAll(".container-menu").style("display", "none");
        d3.select("#container-results").style("display", "block");
      }


      //d3.select("body").append("img").attr("src", "graphs/n_protection_eco3.png").style({"position": "fixed", "top": "100px"});

      //d3.select(".leaflet-control-layers-base").property("title", "Click on radio button to change the baselayer option");
      //d3.select(".leaflet-control-layers-overlays").property("title", "Check the box to add layer to map (may be slight delay)");

      //******Add custom weighting tool
      //var customWeight = new L.Control.customWeight();
      //map.addControl(customWeight);
      //completePrioritization();

      //******Add graph tool
      //L.control.graph().addTo(map);

      //******Add Download tool - use temporarily as graph display
      //var downLoadFile = new L.Control.downLoadFile();
      //map.addControl(downLoadFile);
      //completeGraph();

      //******Add Print/download tool
      //var printMap = new L.Control.print();
      //map.addControl(printMap);
      d3.select("#toolbar") //("#mainMenu").select(".container-fluid")
        .append("div")
        //.attr("class", "pull-right")
        .attr("id", "printDownload")
        .html(''
          + '<span id="welcome" class="glyphicon glyphicon-info-sign" title="Click to view welcome screen" onclick="d3.select(&quot;#splashScreen&quot;).style(&quot;display&quot;, &quot;flex&quot;)"></span>'
          + '<span id="resetControl" class="glyphicon glyphicon-refresh" title="Click to deselect active map layers" onclick="resetSelections()"></span>'
          + '<span id="legendControl" class="glyphicon glyphicon-list" title="Click to view legend window" onclick="toolWindowToggle(&quot;legend&quot;)"></span>'
          + '<div id="tutorial" class="prefWel" title="Click to launch tutorial" onclick="startIntro()">Tutorial</div>'
          //+ '<span id="histControl" class="glyphicon glyphicon-stats" title="View abiotic distributions window" onclick="toolWindowToggle(&quot;hist&quot;)"></span>'
          //+ '<span id="downloadControl" class="glyphicon glyphicon-download-alt" title="Download spatial data" onclick="toolWindowToggle(&quot;download&quot;)"></span>'
          //+ '<span id="printControl" class="glyphicon glyphicon-print" title="Print current map" onclick="window.print()"></span>'
          //+ '<span id="preferences" class="glyphicon glyphicon-cog" title="Set tool preferences" onclick="toolWindowToggle(&quot;preferences&quot;)"></span>'
          + '');

      d3.select("#welcome").on("click", function() {d3.select("#splashScreen").style("display", "flex");});



      //******Function to reset all selections
      function resetSelections() {
        d3.selectAll(".activeLayer, .added").each(function() {
          $(this).click();
        });
/*
        d3.selectAll(".remCheck")[0].forEach(function(d) {
          if(d3.select(d).property("checked") == true) {
            $(d).click();
          }
        });

        d3.selectAll(".activeArea")[0].forEach(function(d) {
          if(d3.select(d).style("visibility") == "visible") {
            $(d).click();
          }
        });
        stepAction(d3.select("#selArea")[0][0]);
        //d3.select("#areaListDropdown").style("display", "inline-block");

        //***zoom to initial extent
        map.fitBounds([[24.5,-140],[50.7,-63]]);

        //***reset baselayer
        $("#baselayerListDropdown div:nth-child(9)").click();

        //***remove any abiotic layers from map
        d3.select("#abioticListDropdown").selectAll("div").each(function() {
          if(d3.select(this).select("span").style("visibility") == "visible") {
            $(this).click();
          }
        });

        //***remove any CL and Exceedance layers from map
        d3.selectAll(".sppSubopt").each(function() {
          if(d3.select(this).select("span").style("visibility") == "visible") {
            $(this).click();
          }
        });

        //***toggle any open windows
        ["legend","hist","preferences","download"].forEach(function(tmpWin) {
          if(d3.select("#" + tmpWin + "Div").style("opacity") == 1) {
            toolWindowToggle(tmpWin);
          }
        });

        //***Reset output selection window
        d3.select("#outputDiv").selectAll(".modal-dialog,modal-lg").style("display", "none");
        d3.select("#outputOptions").style("display", "block");
*/
      }


      //******Make tooltip for displaying attribute data
      var tooltip = d3.select("body")
        .append("div")
        .attr("id", "d3Tooltip")
        .attr("class", "d3Tooltip");

      //******Make header div
      d3.select("body")
        .append("div")
        .attr("class", "header")
        .attr("id", "banner")
        //.style({"padding":"5px 10px", "height":"75px", "background-image":"url('images/forest_banner.jpg')", "background-size":"cover", "bottom-border":"2px solid black"})
        .html('<div class="bannerTitle">'
          + '<span>CLAS</span>'
          + '<div id="bannerDiv">'
            + '<h1>Critical Loads Assessment by Site</h1><h2>High resolution, spatially explicit critical load and exceedance mapping to inform sustainable forest management</h2>'
          + '</div>'
          + '</div>'
          + '<span class="spacerSpan"></span>'
          + '<div id="bannerDivA">'
            + '<a href="https://www.fs.fed.us/" target="_blank"><img src="images/shield_color.png" title="U.S. Forest Service"></a>'
            + '<a href="https://www.usda.gov/" target="_blank"><img src="images/USDA color.jpg" title="United States Department of Agriculture"></a>'
          + '</div>');

      //*******Make LOADING div
      d3.select("body")
        .append("div")
        .attr("class", "helpBackground")
        .attr("id", "loadingDiv")
        .append("h1")
        .text("LOADING...")
        .style("font-weight", "bold")
        .attr("id", "loading"); 

      //*******Make Help/information div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "helpDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "infoDiv")
        .append("div")
        .attr("class", "helpHeader")
        .text("N-CLAS: Nitrogen Critical Loads Explorer")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove-sign pull-right minimize-button")
        .attr("data-toggle", "modal")
        .attr("data-target", "#helpDiv")
        .property("title", "Close help");
        
      d3.select("#infoDiv")
        .append("hr")
        .attr("class", "hr");

      d3.select("#infoDiv")
        .append("div")
        .text("Helpful information coming soon...");

      function changeGlyph(tmpEl) {
        var selEl = d3.select("#" + tmpEl.id);
        if (selEl.classed("glyphicon-minus-sign")) {
          selEl.classed("glyphicon-minus-sign", false);
          selEl.classed("glyphicon-plus-sign", true);
          tmpEl.title = "Click to maximize panel";
        }
        else {
          selEl.classed("glyphicon-plus-sign", false);
          selEl.classed("glyphicon-minus-sign", true);
          tmpEl.title = "Click to minimize panel";
        }
      }




      //******Make variables for d3 topoJSON and TSV data
      var topos = {};  //global topoJSON files variable
      var brush = {};   //global brush variable
      var hist = {};   //global histogram object variable
      var graphs = [];   //global list of current graphs variable
      var layers = [];   //global list of topoJSON map layers
      var area2layer = {};   //global object for getting topojson layer name
      var topoClickArray = []  //global topojson feature click function array for storage when disabling click events
      var layersShow = []; //global list of topoJSON map layer formal names
      var crossingCov = [];  //global array of crossing covariate data 
      var toggleWords = {"legend":"Layers", "preferences":"Preferences", "download":"Downloads"}
      var legendDivs = [];   //global array of active legends
      var chartOpts = {};   //global chart option variable
      var chartCanvas = {};   //global canvas id variable
      var outSpecies = localStorage.getItem('outSpecies');   //global species naming convention for output
      var sppColors = {"Abies balsamea":"255, 0, 0", "Acer rubrum":"255, 79, 0", "Acer saccharum":"255, 116, 0", "Betula alleghaniensis":"255, 146, 0", "Betula papyrifera":"255, 173, 0", "Castanea dentata":"255, 198, 0", "Fagus grandifolia":"255, 223, 0", "Fraxinus americana":"255, 247, 0", "Fraxinus pennsylvanica":"215, 231, 0", "Juglans cinerea":"155, 197, 0", "Picea mariana":"94, 162, 0", "Picea rubens":"0, 128, 0", "Pinus resinosa":"75, 107, 88", "Pinus rigida":"88, 83, 150", "Pinus strobus":"72, 50, 212", "Populus grandidentata":"31, 0, 243", "Populus tremuloides":"60, 0, 208", "Quercus alba":"71, 0, 174", "Quercus prinus":"75, 0, 141", "Quercus rubra":"105, 28, 149", "Thuja occidentalis":"149, 62, 178", "Tsuga canadensis":"193, 96, 208", "Ulmus americana":"238, 130, 238"};  //Colors for species in graphs
      //var sppColors = {"Abies balsamea":"#ff0000", "Acer rubrum":"#ff4f00", "Acer saccharum":"#ff7400", "Betula alleghaniensis":"#ff9200", "Betula papyrifera":"#ffad00", "Castanea dentata":"#ffc600", "Fagus grandifolia":"#ffdf00", "Fraxinus americana":"#fff700", "Fraxinus pennsylvanica":"#d7e700", "Juglans cinerea":"#9bc500", "Picea mariana":"#5ea200", "Picea rubens":"#008000", "Pinus resinosa":"#4b6b58", "Pinus rigida":"#585396", "Pinus strobus":"#4832d4", "Populus grandidentata":"#1f00f3", "Populus tremuloides":"#3c00d0", "Quercus alba":"#4700ae", "Quercus prinus":"#4b008d", "Quercus rubra":"#691c95", "Thuja occidentalis":"#953eb2", "Tsuga canadensis":"#c160d0", "Ulmus americana":"#ee82ee"};  //Colors for species in graphs
      var areaColors = {};
      areaColors["States"] = ['#ff0000','#ff6200','#ff9000','#ffb700','#ffdc00','#ffff00','#a7cc00','#4c9900','#427147','#584da2','#0000ff','#3e00cb','#4a009a','#6c1f97','#ac50c2','#ee82ee'];
      areaColors["Level I Ecoregions"] = ['#ffa500'];
      //areaColors["Ecoregions Level 2"] = ['#cc5200','#0000ff','#00e600'];
      areaColors["Level II Ecoregions"] = ['#cc5200','#0000ff','#00e600'];
      //areaColors["Ecoregions Level 3"] = ['#4D2600','#FFB3FF','#004D00','#990099','#000000','#B35900','#000099','#FFFF00','#FF0000','#0066FF','#00FF00','#FF9900'];
      areaColors["Level III Ecoregions"] = ['#4D2600','#FFB3FF','#004D00','#990099','#000000','#B35900','#000099','#FFFF00','#FF0000','#0066FF','#00FF00','#FF9900'];
      areaColors["Forest Service Wilderness Areas"] = ['#ff0000','#ff4300','#ff6200','#ff7a00','#ff9000','#ffa500','#ffb700','#ffca00','#ffdc00','#ffed00','#ffff00','#d3e500','#a7cc00','#7bb200','#4c9900','#008000','#427147','#556075','#584da2','#4b35d0','#0000ff','#2e00e5','#3e00cb','#4600b2','#4a009a','#4b0082','#6c1f97','#8c38ac','#ac50c2','#cd69d8','#ee82ee'];
      areaColors["Forest Service Admin Areas"] = ['#ff0000','#ff8b00','#ffd300','#c8df00','#008000','#503cc4','#4200bf','#74259c','#ee82ee'];
      areaColors["Class I Areas"] = ['#ff0000','#ff7a00','#ffb700','#ffed00','#a7cc00','#008000','#584da2','#2e00e5','#4a009a','#8c38ac','#ee82ee'];
      var legImg = [];
      legImg[0] = new Image();
      legImg[0].src = "images/tab3bLegend.jpg";
      legImg[1] = new Image();
      legImg[1].src = "images/tab3cLegend.jpg";


      Chart.plugins.register({
        beforeDraw: function(chartInstance) {
          var ctx = chartInstance.chart.ctx;
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
        }
      });

      Chart.defaults.global.defaultFontColor = 'black';
      //var red_white_red
      chartOpts.default = {};
      chartOpts.default.bar = {
        type: 'bar',
        data: {
          //labels: tmpAreasFiltSplit,
          datasets: [{
            //data: tmpPercentFilt,
            backgroundColor: 'rgba(192, 0, 0, 1)',
            borderColor: 'rgba(192, 0, 0, 1)',
            borderWidth: 2,
            hoverBackgroundColor: 'rgba(192, 0, 0, 0.8)',
            hoverBorderColor : 'black'
          }]
        },
        options: {
          layout: {
            padding: {
              layout: {
                left: 5,
                right: 5,
                top: 5,
                bottom: 5
              }
            }
          },
          title: {
            display: true,
            fontSize: 8,
            //text: 'Exceedance of Most Protective Critical Load'
          },
          legend: {
            display: false,
            labels: {
              padding: 10
            }
          },
          scales: {
            yAxes: [{
              position: 'left',
              scaleLabel: {
                display: true,
                //labelString: '% Area in Exceedance of CL',
                fontSize: 7
              },
              ticks: {
                beginAtZero:true,
                fontSize: 6,
                maxTicksLimit: 6
              },
              gridLines: {
                color: 'rgba(0,0,0,0.3)'
              }
            }],
            xAxes: [{
              position: 'bottom',
              barPercentage: 0.3,
              categoryPercentage: 1,
              ticks: {
                autoSkip: false,
                beginAtZero: true,
                min: 0,
                display: true,
                fontStyle: 'normal',
                //fontSize: setFontSizeSmall(d3.select("#areaList").attr("value")),
                stepSize: 1
              },
              gridLines: {
                color: 'rgba(0,0,0,0.3)',
                display: false
              }
            }, {
              position: 'top',
              barPercentage: 0.3,
              categoryPercentage: 1,
              scaleLabel: {
                display: true,
                //labelString: d3.select("#areaList").attr("value") + ", Combined Species",
                fontSize: 8
              },
              ticks: {
                display: false
              },
              gridLines: {
                display: false
              }
            }]
          }
        }
      }



      //******Add in custom color pallate for streams
      colorbrewer.streams = {};
      colorbrewer.streams["5"] = ["#081d58","#253494","#225ea8","#1d91c0","#41b6c4"];
      colorbrewer.streams["6"] = ["#081d58","#253494","#225ea8","#1d91c0","#41b6c4", "#7fcdbb"];



      //******Wait for all topoJSON files to load
      queue()
        //.defer(d3.json, 'class_1_areas_topo.json')
        .defer(d3.json, 'class_1_areas_lower48.json')
        .defer(d3.json, 'admin_areas_merged_wgs84_lower48.json')
        .defer(d3.json, 'tribal_lower48_wgs84_dissolved.json')
        .defer(d3.json, 'wilderness_areas_lower48_wgs84.json')
        .defer(d3.json, 'eco_level3_wgs84_no_water.json')
        .defer(d3.json, 'eco_level2_wgs84_no_water.json')
        .defer(d3.json, 'eco_level1_wgs84_no_water.json')
        //.defer(d3.tsv, 'crossings_covariates_rof_delay.tsv')
        //.defer(d3.tsv, 'catchments_covariates.tsv')
        //.defer(d3.tsv, 'streams_covariates.tsv')
        //.defer(d3.tsv, 'catchments_political.tsv')
        //.defer(d3.tsv, 'covariate_info.tsv')
        .await(displayIt);







      //******Bind topoJSON data
      //function displayIt(error, class1Data, fsWildData, fsData, eco3Data, eco2Data, eco1Data, stateData) {
      function displayIt(error, class1Data, adminData, tribalData, wildData, eco3Data, eco2Data, eco1Data) {
        //topos.class1 = topojson.feature(class1Data, class1Data.objects.class_1_wilderness_areas_ecoregions_wgs84);
        topos.class1 = topojson.feature(class1Data, class1Data.objects.class_1_areas_lower48);
        topos.wild = topojson.feature(wildData, wildData.objects.wilderness_areas_lower48_wgs84);
        topos.admin = topojson.feature(adminData, adminData.objects.admin_areas_merged_wgs84_lower48);
        topos.eco3 = topojson.feature(eco3Data, eco3Data.objects.eco_level3_wgs84_no_water);
        topos.eco2 = topojson.feature(eco2Data, eco2Data.objects.eco_level2_wgs84_no_water);
        topos.eco1 = topojson.feature(eco1Data, eco1Data.objects.eco_level1_wgs84_no_water);
        topos.tribal = topojson.feature(tribalData, tribalData.objects.tribal_lower48_wgs84_dissolved);

        //******Add properties to topos and push layer (class name, SVG g object, unique identifier short_heading, colorbrewer class)
        areaID.forEach(function(tmpID, i) {
          addProps(tmpID, areaLayers[i], "unique_id", "RdYlBu");
        });

        //topos.eco1.color = {"Eastern_Temperate_Forests": "#4D2600", "Great_Plains": "#FFB3FF", "Marine_West_Coast_Forest": "#004D00", "Mediterranean_California": "#990099", "North_American_Deserts": "#000000", "Northern_Forests": "#B35900", "Northwestern_Forested_Mountains": "#000099", "Southern_Semiarid_Highlands": "#FFFF00", "Temperate_Sierras": "#FF0000", "Tropical_Wet_Forests": "#0066FF", "Water": "#00FF00"};
        //topos.eco2.color = {"Atlantic_Highlands": "#4D2600", "Central_USA_Plains": "#FFB3FF", "Cold_Deserts": "#004D00", "Everglades": "#990099", "Marine_West_Coast_Forest": "#000000", "Mediterranean_California": "#B35900", "Mississippi_Alluvial_And_Southeast_USA_Coastal_Plains": "#000099", "Mixed_Wood_Plains": "#FFFF00", "Mixed_Wood_Shield": "#FF0000", "Ozark/Ouachita-Appalachian_Forests": "#0066FF", "South_Central_Semiarid_Prairies": "#00FF00", "Southeastern_USA_Plains": "#FF9900", "Tamaulipas-Texas_Semiarid_Plain": "#CC33FF"};
        //topos.eco3.color = {"Acadian_Plains_and_Hills": "#4D2600", "Driftless_Area": "#FFB3FF", "Eastern_Great_Lakes_Lowlands": "#004D00", "Erie_Drift_Plain": "#990099", "North_Central_Appalachians": "#000000", "North_Central_Hardwood_Forests": "#B35900", "Northeastern_Coastal_Zone": "#000099", "Northern_Appalachian_and_Atlantic_Maritime_Highlands": "#FFFF00", "Northern_Allegheny_Plateau": "#FF0000", "Northern_Lakes_and_Forests": "#0066FF", "Northern_Minnesota_Wetlands": "#00FF00", "Southern_Michigan/Northern_Indiana_Drift_Plains": "#FF9900"};
        topos.colorFunc = function(x) { return d3.interpolateTurbo(x); };

        //******Create area to layer key
        //area2layer = {"Class I Areas":"class1", "Forest Service Wilderness Areas":"fs_wild", "Forest Service Admin Areas":"fs", "Ecoregions Level 3":"eco3", "Ecoregions Level 2":"eco2", "Level 1 Ecoregions":"eco1", "States":"state"};
        area2layer = {"Class I Areas":"class1", "Wilderness Areas":"wild", "Federal Administrative Areas":"admin", "Level III Ecoregions":"eco3", "Level II Ecoregions":"eco2", "Level I Ecoregions":"eco1", "States":"state"};

        //******Get feature ids
        //layers = ["class1", "fs_wild", "fs", "eco3", "eco2", "eco1", "state"];
        layers = ["class1", "admin", "tribal", "wild", "eco3", "eco2", "eco1"];
        layers.forEach(function(layer) {
          topos[layer].names = [];
          topos[layer].color = {};
          topos[layer].agency = {};
          var n = topos[layer].features.length - 1;
          topos[layer].features.forEach(function(d,i) {
            topos[layer].names.push(d.id);
            //topos[layer].color[d.id.replace(/ /g, "_")] = topos.colorFunc(i/n);
            topos[layer].color[d.id.replace(/ /g, "_")] = "#D44821";
            if(layer == "admin") {
              topos[layer].agency[d.id.replace(/ /g, "_")] = d.properties.agency_ful;
            }
          });
          topos[layer].names.sort();
        });

        //******Get species names
        topos.species = {};
        topos.species.latin = speciesNames;
        topos.species.common = speciesTitles;
        topos.species.id = speciesID;
/*
        //******Add covariate TSV files to topojson
        crossCov = readTSV(crossCov, topos.crossings);
        catchCov = readTSV(catchCov, topos.catchments);
        streamCov = readTSV(streamCov, topos.streams);
       
        //******Read in political featureids
        topos.political = strToNum(political);        

        //******Add covariate title and description information
        var tmpLayers = ["crossings", "catchments", "streams", "political"];
        tmpLayers.forEach(function(d) {
          topos[d]["title"] = {};
          topos[d]["title"]["unique_id"] = "Unique ID";
          topos[d]["title"]["featureid"] = "Catchment ID";
          topos[d]["tooltip"] = {};
          topos[d]["unit"] = {};
          topos[d]["direction"] = {};
          topos[d]["data_type"] = {};
          topos[d]["scale"] = {};
          topos[d]["display"] = {};
          topos[d]["conversion"] = {};
          topos[d]["minVal"] = {};
          topos[d]["maxVal"] = {};
          topos[d]["minClip"] = {};
          topos[d]["maxClip"] = {};
          topos[d]["max"] = {};
        });

        covInfo.forEach(function(d) {
          topos[d.layer]["title"][d.short_heading] = d.long_heading;
          topos[d.layer]["tooltip"][d.short_heading] = d.tooltip;
          topos[d.layer]["unit"][d.short_heading] = d.unit;
          topos[d.layer]["direction"][d.short_heading] = d.direction;
          topos[d.layer]["data_type"][d.short_heading] = d.data_type;
          topos[d.layer]["scale"][d.short_heading] = d.scale;
          topos[d.layer]["display"][d.short_heading] = d.display;
          topos[d.layer]["conversion"][d.short_heading] = {};
          if (jQuery.isEmptyObject(d.conversion) == false) {
            topos[d.layer]["conversion"][d.short_heading] = JSON.parse(d.conversion);
          }
          topos[d.layer]["conversion"][d.short_heading]["raw"] = d.conversion;
        });

        //******Get keys for covariate data
        topos.crossings.keys = d3.keys(crossCov[0]);
        topos.catchments.keys = d3.keys(catchCov[0]);
        topos.streams.keys = d3.keys(streamCov[0]);
        topos.political.keys = d3.keys(political[0]);

        //******Transform covariate data if necessary
        var tmpLayers = [[crossCov, "crossings"], [catchCov, "catchments"], [streamCov, "streams"]];
        tmpLayers.forEach(function(d) {
          topos[d[1]].keys.forEach(function(key) {
            var tmpMax = d3.max(d[0], function(data) {return data[key];});
            topos[d[1]]["max"][key] = tmpMax;
            //topos[d[1]]["min"][key] = d3.min(d[0], function(data) { if(data[key] != -9999) {return data[key];} });
            d[0].forEach(function(row) {
              switch(topos[d[1]]["scale"][key]) {
                case "log":
                  if (row[key] != -9999) {
                    row[key] = Math.log(row[key] + 0.1);
                  }
                  break;
                case "log_rec":
                  if (row[key] != -9999) {
                    row[key] = -(Math.log(tmpMax + 0.1 - row[key]));
                  }
              }
            });
          });
        });


        //******Make crossfilter dimensions
        cfDimension(topos.crossings, crossCov);
        cfDimension(topos.catchments, catchCov);
        cfDimension(topos.streams, streamCov);

        //******Release covariate data
        crossingCov = crossCov;  //keep to add weighted ROF covariates to
        crossCov = null;
        catchCov = null;
        streamCov = null;
*/

        //******Set d3 map data
        bounds = d3.geo.bounds(topos.eco1);
        path = d3.geo.path()
                 .projection(projectPoint)
                 .pointRadius(3.5);

        //******Add drop down box to select crossing attribute for styling
        //addLegend(topos.crossings);
        //addLegend(topos.catchments);
        //addLegend(topos.streams);

        //******Add drop down box to select political filter class and type for filtering
        //addPolFilters(topos.political);

        //******Add drop down box to select attributes for filtering
        //addFilterLayers(layers);

        //******Add the pair-wise links to the spatial join div
        //addCFLinks(layers);
        
        //******Add topoJSON layers
        //d3.select("#areaLayer-1").property("checked", true);
        //map.addLayer(areaLayers[1]);

        //******Set area options
        //addAreaNames(1);
        
        //******Set map view
        map.on("viewreset", reset);
        reset();

        //******Display preferences window if first time or not checked
        //if(localStorage.getItem("showPref") != "true") {
        //  toolWindowToggle("preferences");
        //}

        //******Run splash and intro for first time users
        d3.select("#disableSplash").property("checked", function() { if(localStorage.getItem('disableSplash') == "true") { return true; } else { return false; } });
        if(localStorage.getItem('disableSplash') != "true") {
          d3.select("#splashScreen").style("display","flex");
        }
        //else if(localStorage.getItem('doneTour') != 'yeah!') {
        //  startIntro();
        //}

        //******Remove "Loading..." text
        d3.select("#loadingDiv").style("display", "none");
        resizePanels();
        d3.select("#selArea").classed("disabled", false);
      }


      //******Function to toggle tool windows
      function toolWindowToggle(tmpDiv) {
        if (d3.select("#" + tmpDiv + "Div").style("opacity") == "1") {
          d3.select("#" + tmpDiv + "Div").transition().style({"opacity":"0", "visibility":"hidden"});
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to show " + toggleWords[tmpDiv] + " window");
        }
        else {
          d3.select("#" + tmpDiv + "Div").transition().duration(250).ease("cubic").style({"opacity":"1", "display":"block", "visibility":"visible"});            
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to hide " + toggleWords[tmpDiv] + " window");
          setZ(d3.select("#" + tmpDiv + "Div")[0][0]);
          if(tmpDiv == "hist") {get_abiotic_counts();}
        }
      }

      


      //******Add attribute names and values to table
      function getAttributes(tmpFeat, topo, opacity) {
        if (opacity == 0) {return;}
        d3.select("#attributesDiv").style("display", "block");
        d3.select("#attributesControl").property("title", "Click to hide feature attributes window");

        var tmpArray = topo.keys.map(function(d) { return {"att": d, val: formatAtt(topo, d, tmpFeat[d]) }; } );
        var columns = ["att", "val"]

        var rows = d3.select("#attValuesTable").selectAll('.attTR')
          .data(tmpArray);
        rows.exit().remove();
        rows.enter()
          .append('tr')
          .attr("class", "attTR");          

        var cells = rows.selectAll("td")
          .data(function(row) {
            return columns.map(function (column) {
              return {column: column, value: row[column]};
            });
          });
        cells.enter()
            .append('td')
            .attr("class", "attTD");
        cells
          .text(function(d) { if (d.column == "att") {return formatTitle(topo, d.value);} else {return d.value;} })
          .property("title", function(d) {if (d.column == "att") {return topo.tooltip[d.value];} else {return d.value;} });
      }


      //******Format title and units
      function formatTitle(topo, att) {
        if (topo.unit[att]) {
          return topo.title[att]  + " (" + topo.unit[att] + ")";
        }
        else {
          return topo.title[att];
        }
      }


      //******Format data by its data_type
      function formatAtt(topo, att, val) {
        switch (topo.data_type[att]) {
          case "decimal":
            var tmpVal = val.toFixed(2);
            break;
          case "text":
            if (Object.keys(topo.conversion[att]).length == 1) {
              var tmpVal = val;
            }
            else {
              var tmpVal = topo.conversion[att][val];
            }
            break;
          case "integer":
            var tmpVal = val;
            break;
          case "date":
            var tmpTime = d3.time.format("%-m/%-d/%Y");
            var tmpVal = tmpTime(new Date(val));
            break;
        }
        if (Math.floor(val) == -9999) { tmpVal = "No Data"; };
        return tmpVal;
      }




      //******Add checkboxes to link crossfilters
      function addCFLinks(tmpLayers) {
        tmpLayers.forEach(function(layer1, i) {
          tmpLayers.forEach(function(layer2, j) {
            if (j > i) {
              d3.select("#linkLayers")
                .append("div")
                .attr("class", "hoverDiv")
                .attr("id", layer1 + "-" + layer2 + "-link")
                .property("title", "Check to spatially link the " + layer1.slice(0,-1) + " and " + layer2.slice(0,-1) + " layers");

              d3.select("#" + layer1 + "-" + layer2 + "-link")
                .append("input")
                .attr({type: "checkbox", name: layer1 + "-" + layer2 + "-check"})
                .attr("id", layer1 + "-" + layer2 + "-check")
                .attr("class", "linkCheck")
                .property("checked", false)
                .on("click", function() { checkLink("featureid", layer1, true); });   //Layer1 doesn't matter, just a placeholder

              d3.select("#" + layer1 + "-" + layer2 + "-link")
                .append("label")
                .text("Link " + layer1 + " & " + layer2)
                .attr("class", "linkLabel")
                .attr("id", layer1 + "-" + layer2 + "-linkLabel");
            }
          });
        });
      }
     



      //******Add properties to topos and push layer
      function addProps(tmpName, tmpG, tmpID, tmpColor) {
        topos[tmpName].class = tmpName;
        topos[tmpName].g = tmpG;
        topos[tmpName].uniqueID = tmpID;
        topos[tmpName].covType = {};
        topos[tmpName].filter = {};
        topos[tmpName].binWidth = {};
        topos[tmpName].color = tmpColor;
        brush[tmpName] = {};
        hist[tmpName] = {};
        layers.push(tmpName);
      }



      function addPolFilters(topo) {
        d3.select("#classPolFilterCell")
          .append("div")
          .attr("id", "classPolFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Class");

        var select = d3.select("#classPolFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "classPolFilterSelect")
          .property("title", "Select class to use its values as options in the adjacent 'Area' selection box") 
          .on("change", function() { addPolFilterTypes(topo, this.value); });

        var optData = topo.keys.filter(function(key) { return key != "unique_id" && key != "featureid"; });

        select.selectAll("option")
          .data(optData)
          .enter()
            .append("option")
              .attr("value", function (d) { if(d != "featureid") { return d;} })
              .text(function (d) { if(d != "featureid") {return topos.political.title[d];} });

        //******Add attribute selection box
        d3.select("#typePolFilterCell")
          .append("div")
          .attr("id", "typePolFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Area");

        var select = d3.select("#typePolFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "typePolFilterSelect")
          .style("width", "130px");

        //******Add clear all button
        d3.select("#polFilterSelectDiv")
          .append("button")
          .text("Clear All")
          .property("title", "Click to remove all applied filters")
          .on("click", function() { 
            var tmpArray = topos.political.condition.slice();
            tmpArray.forEach(function(cond) {
              var i = cond.indexOf("-") + 1;
              var j = cond.lastIndexOf("-");
              removeCondition(topo, cond, cond.slice(i,j), cond.slice(j+1)); 
            });
          });



        //******Make crossfilter groups
        topo.filter = {};
        var tmpCF = crossfilter(topo);
        topo.filter.all = tmpCF.groupAll();

        topo.keys.forEach(function(key, i) {
          topo.filter[key] = tmpCF.dimension(function(d) { return d[key]; } );
          topo.filter[key + "s"] = topo.filter[key].group();
        });

        //******Make array for holding filter conditions
        topo.condition = [];

        //******Initialise with first layer
        addPolFilterTypes(topo, topo.keys[0]);
      }



      function addPolFilterTypes(topo, tmpKey) {
        var select = d3.select("#typePolFilterSelect")
          .property("title", "Select an area to filter features in the Crossings, Catchments, and Streams layers to those intersecting that area")
          .on("change", function() { addPolFilter(topo, tmpKey, this.value); });

        //Get grouped data from crossfilter
        var optData = topo.filter[tmpKey + "s"].all();
        optData = optData.map(function(d) { return d.key; } );
        optData.splice(0,0, "...");

        var options = select.selectAll("option")
          .data(optData);
       
        options.exit().remove();
        options.enter()
          .append("option");
        options
          .attr("value", function (d, i) { return optData[i].toString().replace(/ /g, "_"); })
          .text(function (d, i) { return optData[i]; });

        //******Set selected index to 0
        d3.select("#typePolFilterSelect")
          .property("selectedIndex", function() {return 0;});
      }

     
      function addPolFilter(topo, tmpClass, tmpArea) {
        var tmpID = "polFilter-" + tmpClass + "-" + tmpArea;

        if (topo.condition.indexOf(tmpID) == -1 && tmpArea != "...") {
          topo.condition.push(tmpID);

          d3.select("#polFilterConditions")
            .append("div")
            .attr("class", "polFilterCond")
            .attr("id", tmpID)
            .append("p")
            //.text(tmpClass.charAt(0).toUpperCase() + tmpClass.slice(1) + " = " + tmpArea.replace(/_/g, " "))
            .text(topo.title[tmpClass] + " = " + tmpArea.replace(/_/g, " "))
            .style("display", "inline-block")
            .style("margin", "0px");

          d3.select("#" + tmpID)
            .append("div")
              .attr("class", "btn btn-default btn-xs pull-right")
              .attr("id", "polFilterRemove-" + tmpClass + "-" + tmpArea)
              .text("x")
              .property("title", "Click to remove filter condition for " + tmpClass.charAt(0).toUpperCase() + tmpClass.slice(1) + " = " + tmpArea.replace(/_/g, " "))
              .on("click", function() { removeCondition(topo, tmpID, tmpClass, tmpArea); });
          
          //******Add filter to crossfilter
          applyPolCrossfilter(topo);
        }
      }


      function applyPolCrossfilter(topo) {
        //******Add filter to crossfilter
        topo.keys.forEach(function(key) {
          var tmpCond = [];
          topo.condition.forEach(function(cond) {
            var i = cond.indexOf("-") + 1;
            var j = cond.lastIndexOf("-");
            if (cond.slice(i,j) == key) {
              tmpCond.push(cond.slice(j + 1).replace(/_/g, " "));
            }
          });
          if (tmpCond.length > 0) {
            topo.filter[key].filterFunction(function(d) { 
              var tmpBi = 0;
              tmpCond.forEach(function(cond) {
                if (d == cond) {tmpBi = 1;}
              });
              return tmpBi;
            });
          }
          else {
            topo.filter[key].filterAll();
          }
        });

        //*******Filter map by applied filters
        checkLink("featureid", topo, true);
      }



      function removeCondition(topo, tmpID, tmpClass, tmpArea) {
        topo.condition.splice(topo.condition.indexOf(tmpID), 1);
        d3.select("#" + tmpID).remove();
        applyPolCrossfilter(topo);
        if (d3.select("#typePolFilterSelect").node().value == tmpArea) {
          d3.select("#typePolFilterSelect").property("selectedIndex", function() {return 0;});
        }
      }




      function addFilterLayers(tmpLayers) {
        d3.select("#layerFilterCell")
          .append("div")
          .attr("id", "layerFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Layer");

        var select = d3.select("#layerFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "layerFilterSelect")
          .property("title", "Select layer to use its attributes as options in the adjacent 'Attribute' selection box") 
          .on("change", function() { addFilterSelect(topos[this.value]); });

        select.selectAll("option")
          .data(tmpLayers)
          .enter()
            .append("option")
              .attr("value", function (d, i) { return tmpLayers[i]; })
              .text(function (d, i) { return tmpLayers[i].charAt(0).toUpperCase() + tmpLayers[i].slice(1); });

        //******Add attribute selection box
        d3.select("#attributeFilterCell")
          .append("div")
          .attr("id", "attributeFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Attribute");

        var select = d3.select("#attributeFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "attributeFilterSelect")
          .style("width", "182px");

        //******Initialise with first layer
        addFilterSelect(topos[tmpLayers[0]]);

        //******Add values to totals portion of charts window
        tmpLayers.forEach(function(d) {
          var topo = topos[d];
          d3.select("#totals")
            .append("div")
            .attr("class", "hoverDiv")
            .property("title", "The number of " + topo.class + " currently selected out of the total number of " + topo.class)
            .html(topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ' selected: ' + '<b><span id="active-' + topo.class + '">' + topo.filter.all.value() + '</span></b> of <b><span id="total">' + topo.filter.all.value() + '</span></b>'); ;
        });
      }
        



      function addFilterSelect(topo) {
        var select = d3.select("#attributeFilterSelect")
          .attr("data-layer", topo.class)
          .property("title", "Select an attribute to display an interactive graph containing the frequency of its values")
          .on("change", function() { addFilter(this.value, topos[this.dataset.layer]); });

        var optData = topo.keys.filter(function(key) { return topo.display[key] == "yes"; });

        optData.splice(0,0, "...");
        topo.title["..."] = "...";
        topo.tooltip["..."] = "Select an attribute to display an interactive graph containing the frequency of its values";

        var options = select.selectAll("option")
          .data(optData);
       
        options.exit().remove();
        options.enter()
          .append("option");
        options
          .attr("value", function (d, i) { return optData[i]; })
          .text(function (d, i) { return topo.title[optData[i]]; });

        //******Set selected index to 0
        d3.select("#attributeFilterSelect")
          .property("selectedIndex", function() {return 0;})
          .property("title", topo.tooltip["..."]);
      }






      function addLegend(topo) {
        d3.select("#legendDiv")
          .append("div")
          .attr("id", topo.class + "Legend")
          .style("margin-bottom", "10px");

        d3.select("#" + topo.class + "Legend")
          .append("hr")
          .attr("class", "hr");

        d3.select("#" + topo.class + "Legend")
          .append("h5")
          .text(topo.class.charAt(0).toUpperCase() + topo.class.slice(1))
          .attr("id", "legHead" + topo.class)
          .attr("class", "layerTitle");

        d3.select("#" + topo.class + "Legend")
          .append("input")
          .attr({type: "range", name: topo.class + "Opacity", min: 0, max: 100, value: 100})
          .attr("id", topo.class + "Slider")
          .property("title", topo.class + " opacity: 100%")
          .style("margin-left", 87 - d3.select("#legHead" + topo.class).property("offsetWidth") + "px")
          .on("input", function() {
            var tmpOpacity = this.value/100; 
            d3.select("#" + topo.class + "Slider").attr("value", this.value);
            var tmpData = topo.filter.featureid.top(Infinity);
            var tmpID = tmpData.map(function(d) {return d.featureid;});
            topo.g.selectAll("." + topo.class).style("opacity", function(d) {
              if(tmpID.indexOf(d.properties.featureid) > -1) {
                return tmpOpacity;
              }
              else {
                return 0;
              }
            });
            this.title = "Opacity: " + this.value + "%"; 
          });

        var select = d3.select("#" + topo.class + "Legend")
          .append("select")
          .attr("class", "legAttrList")
          .attr("id", topo.class + "Select")
          .style("width", "182px")
          .on("change", function () { changeStyle(this.value, topo); });

        var optData = topo.keys.filter(function(key) { return topo.display[key] == "yes"; });

        select.selectAll("option")
          .data(optData)
          .enter().append("option")
          .attr("value", function (d, i) { return optData[i]; })
          .text(function (d, i) { return topo.title[optData[i]]; });
      }







      //*****Reposition the SVG to cover the features.
      function reset() {
        path.pointRadius(3.5 + (((map.getZoom()/10) - 1) * 4));
        
        //******Set bounds (using Deerfield HUC 8 bounds)
        var bottomLeft = projectPoint(bounds[0]);
        var topRight = projectPoint(bounds[1]);
          
        topoSVG.attr('width', topRight[0] - bottomLeft[0])
          .attr('height', bottomLeft[1] - topRight[1])
          .style('margin-left', bottomLeft[0] + 'px')
          .style('margin-top', topRight[1] + 'px');

        var translation = -bottomLeft[0] + ',' + -topRight[1];

        //******Select all layer g elements
        var tmpG = topoSVG.selectAll("g");

        //******Loop through each g element and transform the path
        tmpG[0].forEach(function(g) {
          var curG = d3.select(g);
          var feature = curG.selectAll("path");
          curG.attr('transform', 'translate(' + -bottomLeft[0] + ',' + -topRight[1] + ')');
          feature.attr("d", path);
          feature.style("stroke-width", (map.getZoom()/2)-1 + "px");
        });  
      }






      //******Use Leaflet to implement a D3 geometric transformation.
      function projectPoint(x) {
        var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
        return [point.x, point.y];
      }






      //******Change number strings to values
      function strToNum(tmpData) {
        var tmpKeys = d3.keys(tmpData[0]);

        var tmpCov = tmpData.map(function(d) {
          var tmpJSON = {};
          var tmpVals = d3.values(d);
          tmpVals.forEach(function(val,i){ 
            if (val == "NA") {
              tmpJSON[tmpKeys[i]] = -9999;
            }
            else if (isNaN(val) == false) {
              tmpJSON[tmpKeys[i]] = +d[tmpKeys[i]];
            }
            else {
              if (val.indexOf("/") > -1) {
                tmpJSON[tmpKeys[i]] = Date.parse(val);
              }
              else { 
                tmpJSON[tmpKeys[i]] = d[tmpKeys[i]];
              }
            }
          });
          return tmpJSON;
        });
        return tmpCov
      }



      //******Transform TSV strings to values if appropriate and add to topojson
      function readTSV(tmpData, topo) {
        //******Get keys and values from TSV data and fill out covariate data type
        var tmpKeys = d3.keys(tmpData[0]);
        var tmpVals = d3.values(tmpData[0]);

        tmpVals.forEach(function(val,i){
          if (isNaN(val) == false || val == "NA") {
            topo.covType[tmpKeys[i]] = "number";
          }
          else {
            topo.covType[tmpKeys[i]] = "string";
          }
        });

        //******Change TSV attribute strings to values if appropriate
        var tmpCov = strToNum(tmpData);

        //*******Map TSV to ID_key attribute (in this case either unique_id (crossings, streams) or featureid (catchments)
        var tmpMap = d3.map(tmpCov, function(d) {return d[topo.uniqueID];});

        //*******Add TSV data to topojson
        topo.features.forEach(function(d) { 
          try {
            tmpKeys.forEach(function(key) {
                d.properties[key] = tmpMap.get(d.id)[key];
            });
          }
          catch(err) { 
            console.log("No TSV data for id " + d.id);
          }
        });

        return tmpCov;
      }





      //*******Make crossfilter dimensions and grouped dimensions
      function cfDimension(topo, covariates) {
        //******Assign crossing covariates to a crossfilter variable

        var tmpCF = crossfilter(covariates);
        topo.filter.all = tmpCF.groupAll();
        topo.binWidth = {};
        var lowKey = 0;

        //******Dimension and group each covariate
        topo.keys.forEach(function(key, i) {
          topo.filter[key] = tmpCF.dimension(function(d) { return d[key]; } );
          if (topo.covType[key] == "number") {
            var tmpTop = topo.filter[key].top(1);
            var tmpBot = topo.filter[key].bottom(Infinity);
            for (var i = 0; i < tmpBot.length; i++) {
              if (tmpBot[i][key] > -9999) {
                lowKey = i;
                break;
              }
            }
            topo.minVal[key] = tmpBot[lowKey][key];
            topo.maxVal[key] = tmpTop[0][key];

            var divVal = (tmpTop[0][key] - tmpBot[lowKey][key]) / 40;
            topo.binWidth[key] = divVal;
            topo.filter[key + "s"] = topo.filter[key].group(function(d) {return Math.floor(d / divVal) * divVal;});

            topo.minClip[key] = topo.filter[key + "s"].all()[0].key;
            if (topo.minClip[key] <= -9998) {
              topo.minClip[key] = topo.filter[key + "s"].all()[1].key;
            }
            topo.maxClip[key] = topo.filter[key + "s"].all()[topo.filter[key + "s"].size() - 1].key + topo.binWidth[key];
          }
          else {
            topo.filter[key + "s"] = topo.filter[key].group();
          }
        });
       }






      //*******Show crossings attribute in tooltip
      function showIt(tmpID) {
        tooltip.text(tmpID);
        tooltip.style("visibility", "visible");
        tooltip.property("title", tmpID);
      }




      //*******Transform data
      function transformData(scale, data, tmpMax) {
        switch(scale) {
          case "linear":
            var normVals = data.map(function(d) { return d; });
            break;
          case "log":
            var normVals = data.map(function(d) { return Math.log(d + 0.1); });
            break;
          case "log_rec":
            var normVals = data.map(function(d) { return -(Math.log((tmpMax + 0.1) - d)); });
            break
          case "categorical":
            var normVals = data.map(function(d) { return d; });
            break;
        }

        return normVals;
      }





      //*******Back Transform data
      function backTransformData(scale, data, tmpMax) {
        switch(scale) {
          case "linear":
            var normVals = data.map(function(d) { return d; });
            break;
          case "log":
            var normVals = data.map(function(d) { return Math.exp(d) - 0.1; });
            break;
          case "log_rec":
            var normVals = data.map(function(d) { return tmpMax + 0.1 - Math.exp(-d); });
            break
          case "categorical":
            var normVals = data.map(function(d) { return d; });
            break;
        }

        return normVals;
      }





      //*******Change feature styles
      function changeStyle(tmpAtt, topo) {
        //*******Change tooltip text for select
        //d3.select("#" + topo.class + "Select").property("title", topo.tooltip[tmpAtt]);

        //*******Select features
        var curG = d3.select(topo.g[0][0]);
        var tmpFeat = curG.selectAll("." + topo.class);

        tmpFeat.style({"stroke": function(d) {return topo.color[d.id.replace(/ /g, "_")];}, "stroke-width": (map.getZoom()/2)-1 + "px", "fill": function(d) {return topo.color[d.id.replace(/ /g, "_")];}} );
        tmpFeat.attr("id", function(d) {return d.id;});
/*
        //*******Get data for passed in attribute
        var tmpVals = d3.values(topo.features).map(function(d) { return d.properties[tmpAtt]; });

        //*Filter out "NA" data
        tmpVals = tmpVals.filter(function(val) {if(val > -9999){return true} else {return false};});

        //*******Normalise scale
        var maxVal = d3.max(tmpVals);
        var normVals = transformData(topo.scale[tmpAtt], tmpVals, maxVal);
  
        var tmpSet = d3.set(normVals);
        var tmpMin = d3.min([6, tmpSet.size()])

        //*******Make a color scale
        var colorArray = colorbrewer[topo.color][tmpMin].slice(0);
        if (topo.direction[tmpAtt] == "reverse") {
          colorArray.reverse();
        }
          
        var newColor = d3.scale.quantize()
          .domain([d3.min(normVals), d3.max(normVals)])
          .range(colorArray);

        //*******Style and label crossings by attribute value
        if (topo.class == "streams") {
          tmpFeat.style("stroke", function(d) {
            if (d.properties[tmpAtt] > -9999) { //return newColor(d.properties[tmpAtt]); }
              var tVal = transformData(topo.scale[tmpAtt], [d.properties[tmpAtt]], maxVal);
              return newColor(tVal[0])
            }
            else {return "gray"}; 
          });
        }
        else {
          tmpFeat.style("fill", function(d) {
            if (d.properties[tmpAtt] > -9999) { //return newColor(d.properties[tmpAtt]); }
              var tVal = transformData(topo.scale[tmpAtt], [d.properties[tmpAtt]], maxVal);
              return newColor(tVal[0])
            }
            else {return "gray"}; 
          });
        }

        tmpFeat.attr("id", function(d) { 
          if(d.properties[tmpAtt] > -9999) {
            switch(topo.data_type[tmpAtt]) {
              case "decimal":
                return (topo.title[tmpAtt] + ": " + d.properties[tmpAtt].toFixed(2) + " " + topo.unit[tmpAtt]);
                break;
              case "integer":
                return (topo.title[tmpAtt] + ": " + d.properties[tmpAtt] + " " + topo.unit[tmpAtt]);
                break;
              case "date":
                var formatDate = d3.time.format("%-m/%-d/%Y");
                return (topo.title[tmpAtt] + ": " + formatDate(new Date(d.properties[tmpAtt])));
                break;
              case "text":
                return (topo.title[tmpAtt] + ": " + topo.conversion[tmpAtt][d.properties[tmpAtt]]);
                break;
            }
          }
          else {
            return (topo.title[tmpAtt] + ": No Data");
          }
        })

        //*******Make a legend
        var list = d3.select("#" + topo.class + "-list-inline");
        list.remove();

        var legend = d3.select("#" + topo.class + "Legend")
         .append("ul")
         .attr("id", topo.class + "-list-inline")
         .attr("class", "legend-colors")
         .property("title", topo.tooltip[tmpAtt]);

        var keys = legend.selectAll("li.key")
          .data(newColor.range());

        keys.enter().append("li")
          .attr("class", "key")
          .style("border-top-color", String)
          .text(function(d, i) {
            var r = newColor.invertExtent(d);
            tmpR = backTransformData(topo.scale[tmpAtt], r, topo.max[tmpAtt]);
            switch(topo.data_type[tmpAtt]) {
              case "decimal":
                return tmpR[0].toFixed(2);
                break;
              case "integer":
                return tmpR[0].toFixed(1);
                break;
              case "date":
                var tmpDate = new Date(tmpR[0]);
                var shortDate = d3.time.format("%-m/%Y");
                return shortDate(tmpDate);
                break;
              case "text":
                return topo.conversion[tmpAtt][i+1];
                break;
            }
          });
*/
       }






      //*******Add crossfilter histogram
      function addFilter(tmpKey, topo) {
        //*******Change tooltip text for select
        d3.select("#attributeFilterSelect").property("title", topo.tooltip[tmpKey]);

        if (graphs.indexOf(topo.class + "-" + tmpKey) > -1 || tmpKey == "...") {
          return;
        }
        else {
          graphs.push(topo.class + "-" + tmpKey);
        }

        //******Define graph attributes
        var margin = {top: 10, right: 10, bottom: 20, left: 10},
          width = 380 - margin.left - margin.right,
          height = 100 - margin.top - margin.bottom;

        var x = d3.scale.linear().rangeRound([0, width]);
        var y = d3.scale.linear()
          .range([height, 0]);

        var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

        //**Format ticks for special data types
        switch(topo.data_type[tmpKey]) {
          case "date":
            xAxis.tickFormat(function(d) { var tmpDate = d3.time.format("%-m/%Y"); return tmpDate(new Date(d)); });
            xAxis.ticks(5);
            break;
          case "text":
            xAxis.tickFormat(function(d) { if (isNaN(topo.conversion[tmpKey][d])) {return d + " (" + topo.conversion[tmpKey][d] + ")";} else {return topo.conversion[tmpKey][d];} });
            xAxis.ticks(Object.keys(topo.conversion[tmpKey]).length - 1);
            break;
          default:
            var twoDec = d3.format(".2f");
            switch(topo.scale[tmpKey]) {
              case "log":
                xAxis.tickFormat(function(d) { return twoDec(Math.exp(d)); });
                xAxis.ticks(5);
                break;
              case "log_rec":
                xAxis.tickFormat(function(d) { return twoDec(topo.max[tmpKey] - Math.exp(-d)); });
                xAxis.ticks(5);
                break;
              default:
                xAxis.tickFormat(function(d) { return twoDec(d); });
                xAxis.ticks(5);
            }
        }


        //******Add brush
        brush[topo.class][tmpKey] = d3.svg.brush()
          .x(x)
          .on("brushstart", function() { brushStart(tmpKey, topo); })
          .on("brush", function() { brushMove(tmpKey, topo); })
          .on("brushend", function() { brushEnd(tmpKey, topo); });


        //******Add chart div, title div, and reset option
        d3.select("#charts")
          .append("div")
            .attr("class", "chart")
            .attr("id", topo.class + "-" + tmpKey)
            .property("title", "Click and drag inside chart to select data")
          .append("div")
            .attr("class", "title")
            .attr("id", "title-" + topo.class + "-" + tmpKey)
            .style("margin-left", "2px")
            .property("title", topo.tooltip[tmpKey])
            .text(topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ": " + topo.title[tmpKey])
          .append("a")
            .attr("class", "reset")
            .attr("id", "reset-" + topo.class + "-" + tmpKey)
            .text("reset")
            .style("display", "none")
            .property("title", "Click to clear selection box from chart")
            .on("click", function() { brushReset(tmpKey, topo); });


        //******Add remove button
        d3.select("#title-" + topo.class + "-" + tmpKey)
          .append("div")
            .attr("class", "btn btn-default btn-xs pull-right")
            .attr("id", topo.class + "-" + tmpKey)
            .text("x")
            .property("title", "Click to remove chart for " + topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ": " + topo.title[tmpKey])
            .on("click", function() { removeFilter(this.id, topo); });


        //******Add stats div and extent
        d3.select("#" + topo.class + "-" + tmpKey)
          .append("div")
            .attr("class", "stats")
            .attr("id", "stats-" + topo.class + "-" + tmpKey);

        var statsDiv = d3.select("#stats-" + topo.class + "-" + tmpKey);

        statsDiv.append("input")
          .attr({type: function() {if(topo.data_type[tmpKey] == "date") {return "text";} else { return "number"}} })
          .attr("class", "extent-input")
          .attr("id", "extent-input-lower-" + topo.class + "-" + tmpKey)
          .property("title", "Lower value for selected range of " + topo.title[tmpKey] + " distribution");

        statsDiv.append("p")
          .attr("class", "extent-input-p")
          .text("-");

        statsDiv.append("input")
          .attr({type: function() {if(topo.data_type[tmpKey] == "date") {return "text";} else { return "number"}} })
          .attr("class", "extent-input")
          .attr("id", "extent-input-upper-" + topo.class + "-" + tmpKey)
          .property("title", "Upper value for selected range of " + topo.title[tmpKey] + " distribution");


        //******Add mean to stats div
        d3.select("#stats-" + topo.class + "-" + tmpKey)
          .append("span")
            .attr("class", "mean pull-right")
            .attr("id", "mean-" + topo.class + "-" + tmpKey)
            .property("title", "Average of selected values");


        //******Add svg
        var svg = d3.select("#" + topo.class + "-" + tmpKey)
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("id", "svg-" + topo.class + "-" + tmpKey)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .attr("id", "g-" + topo.class + "-" + tmpKey);

        //******Add clip path rectangle
        svg.append("clipPath")
          .attr("id", "clip-" + topo.class + "-" + tmpKey)
          .append("rect")
            .attr("width", width)
            .attr("height", height);

        //******Get data and make graph
        var tmpData = topo.filter[tmpKey + "s"].all();

        var lowKey = 0;
        if (tmpData[0].key < -9998) {
          lowKey = 1;
        }

        x.domain([tmpData[lowKey].key, tmpData[tmpData.length - 1].key + topo.binWidth[tmpKey]]);
        y.domain([0, d3.max(tmpData, function(d) { if ( d.key > -9999) { return d.value; } })]);

        var tmpX = svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        if (topo.data_type[tmpKey] == "text") {
          tmpX.select("text").style("text-anchor", "start");
        }

        var tmpData = topo.filter[tmpKey + "s"].all();
        hist[topo.class][tmpKey] = {"x": x, "y": y, "height": height, "width": width};
      
        //******Add background bars
        svg.selectAll("background.bar")
            .data(tmpData)
          .enter().append("rect")
            .attr("class", "background bar")
            .attr("x", function(d) { return x(d.key); })
            .attr("width", (x.range()[1] - x.range()[0])/40)  
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });

        //******Add foreground bars
        svg.selectAll(".foreground.bar")
            .data(tmpData)
          .enter().append("rect")
            .attr("class", "foreground bar")
            .attr("x", function(d) { return x(d.key); })
            .attr("width", (x.range()[1] - x.range()[0])/40)  
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });

        svg.selectAll(".foreground.bar")
          .attr("clip-path", "url(#clip-" + topo.class + "-" + tmpKey + ")");
      
        var gBrush = svg.append("g")
          .attr("class", "brush")
          .attr("id", "brush-" + topo.class + "-" + tmpKey)
          .call(brush[topo.class][tmpKey]);

        gBrush.selectAll("rect").attr("height", height);
        gBrush.selectAll(".resize").append("path").attr("d", resizePath);

        //******* Set upper and lower brush properties
        var inpMin = backTransformData(topo.scale[tmpKey], [topo.minClip[tmpKey]], topo.max[tmpKey]);
        var inpMax = backTransformData(topo.scale[tmpKey], [topo.maxClip[tmpKey] + topo.binWidth[tmpKey]], topo.max[tmpKey]);

        var tmpLower = d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey)
          .property("min", Math.floor(inpMin*100)/100)
          .property("max", Math.ceil(inpMax*100)/100)
          .property("step", Math.round((inpMax - inpMin))/100);

        var tmpUpper = d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey)
          .property("min", Math.floor(inpMin*100)/100)
          .property("max", Math.ceil(inpMax*100)/100)
          .property("step", Math.round((inpMax - inpMin))/100);

        d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).on("change", function () {extentChange(tmpKey, topo, tmpLower, tmpUpper); });
        d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).on("change", function () {extentChange(tmpKey, topo, tmpLower, tmpUpper); });      

        brushReset(tmpKey, topo);

        function resizePath(d) {
          var e = +(d == "e"),
            x = e ? 1 : -1,
            y = height / 3;
          return "M" + (0.5 * x) + "," + y + "A6,6 0 0 " + e + " " + (6.5 * x) + "," + (y + 6) + "V" + (2 * y - 6) + "A6,6 0 0 " + e + " " + (0.5 * x) + "," + (2 * y) + "Z" + "M" + (2.5 * x) + "," + (y + 8) + "V" + (2 * y - 8) + "M" + (4.5 * x) + "," + (y + 8) + "V" + (2 * y - 8);
        }

      }








      //******Remove graph from window
      function removeFilter(class_key, topo) {
        var dash = class_key.indexOf("-");
        var tmpClass = class_key.slice(0, dash);
        var key = class_key.slice(dash + 1, class_key.length);

        graphs.splice(graphs.indexOf(class_key), 1);
        brushReset(key, topo);
        var select = d3.select("#" + class_key);
        select.remove();

        //******If select dropdown is this attribute change back to ...
        if (d3.select("#attributeFilterSelect").node().value == key) {
          d3.select("#attributeFilterSelect").property("selectedIndex", function() {return 0;})
        }
      }





      function extentChange(tmpKey, topo, tmpLower, tmpUpper) {
        if (topo.data_type[tmpKey] == "date") {         
          var valLow = Date.parse(tmpLower.property("value"));
          var valHigh = Date.parse(tmpUpper.property("value"));
        }
        else {
          var valLow = parseFloat(tmpLower.property("value"));
          var valHigh = parseFloat(tmpUpper.property("value"));
        }

        if (valLow > valHigh) {
          var tmpHold = tmpUpper.property("value");
          tmpUpper.property("value", tmpLower.property("value"));
          tmpLower.property("value", tmpHold);
          tmpHold = valHigh;
          valHigh = valLow;
          valLow = tmpHold;
        }

        var inpMin = transformData(topo.scale[tmpKey], [valLow], topo.max[tmpKey])[0];
        var inpMax = transformData(topo.scale[tmpKey], [valHigh], topo.max[tmpKey])[0];

        d3.select("#brush-" + topo.class + "-" + tmpKey).call(brush[topo.class][tmpKey].extent([inpMin, inpMax]));
        brushEnd(tmpKey, topo);
      }


      function brushStart(tmpKey, topo) {
       topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);
       checkLink(tmpKey, topo, false);
      }


      function brushMove(tmpKey, topo) {
        topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);
        checkLink(tmpKey, topo, false);
      }


      function brushEnd(tmpKey, topo) {
        topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);       
        checkLink(tmpKey, topo, false);
        d3.select("#reset-" + topo.class + "-" + tmpKey).style("display", "inline-block");
      }


      function brushReset(tmpKey, topo) {
        d3.select("#brush-" + topo.class + "-" + tmpKey).call(brush[topo.class][tmpKey].clear());
        topo.filter[tmpKey].filterAll();
        checkLink(tmpKey, topo, false);
        d3.select("#reset-" + topo.class + "-" + tmpKey).style("display", "none");
      }


      function filterMap(tmpKey, topo, isLink) {
        var tmpSubset = topo.filter[topo.uniqueID].top(Infinity);
        var tmpID = tmpSubset.map(function(d) {return d[topo.uniqueID];});
        var tmpData = d3.selectAll("." + topo.class).data();
        var tmpSel = d3.selectAll("." + topo.class);
        tmpSel.style("opacity", function(d, i) { 
          if (tmpID.indexOf(tmpData[i].properties[topo.uniqueID]) > -1) {
            return d3.select("#" + topo.class + "Slider").attr("value")/100;
          }
          else {
            return 0;
          }
        });

        //******Update crossings selected
        d3.select("#active-" + topo.class).html(topo.filter.all.value());

        //******Update filter range (if isLink == false)
        if (isLink == false) {
          if (brush[topo.class][tmpKey].empty() && topo.filter.all.value() > 0) {
            setInputs(topo, tmpKey, topo.minVal[tmpKey], topo.maxVal[tmpKey], topo.minClip[tmpKey], topo.maxClip[tmpKey]);
          }
          else {
            var extMin = brush[topo.class][tmpKey].extent()[0]
            var extMax = brush[topo.class][tmpKey].extent()[1]
            setInputs(topo, tmpKey, extMin, extMax, extMin, extMax);
          }
        }

        updateStats(tmpKey, topo);

        updateHistogram(tmpKey, topo);
      }



      //******Set lower and upper input values and adjust clip path
      function setInputs(topo, tmpKey, tmpMin, tmpMax, clipMin, clipMax) {
        var inpMin = backTransformData(topo.scale[tmpKey], [clipMin], topo.max[tmpKey])[0];
        var inpMax = Math.ceil(backTransformData(topo.scale[tmpKey], [clipMax], topo.max[tmpKey])[0]*100)/100;

        if (topo.data_type[tmpKey] == "date") {
          var tmpFormat = d3.time.format("%m/%d/%Y");
          d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).property("value", tmpFormat(new Date(inpMin)));
          d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).property("value", tmpFormat(new Date(inpMax)));
        }
        else {
          d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).property("value", Math.round(inpMin*100)/100);
          d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).property("value", Math.round(inpMax*100)/100);
        }

        d3.select("#clip-" + topo.class + "-" + tmpKey + " rect")
          .attr("x", hist[topo.class][tmpKey].x(clipMin))
          .attr("width", hist[topo.class][tmpKey].x(clipMax) - hist[topo.class][tmpKey].x(clipMin));
      }





      //******Set featureid according to which layers are linked and political filters
      function checkLink(tmpKey, topo, isLink) {
        //******Return array of layers that are linked and share featureIDs 
        var linkLayers, IDS = getLinkIDs();

        //******Filter the map based on common featureids
        layers.forEach(function(layer) {
          if (isLink == false && layer == topo.class) {
            filterMap(tmpKey, topos[layer], false);
          }
          else {
            filterMap("featureid", topos[layer], true);
          }
        });
      }




      //******Determine linked layers
      function getLinkIDs() {
        var linkLayers = [];

        layers.forEach(function(layer1, i) {
          layers.forEach(function(layer2, j) {
            if (j > i) {
              topos[layer1].filter.featureid.filterAll();
              topos[layer2].filter.featureid.filterAll();

              if (d3.select("#" + layer1 + "-" + layer2 + "-check").property("checked") == true) {
                if (linkLayers.indexOf(layer1) == -1) {
                  linkLayers.push(layer1);
                }
                if (linkLayers.indexOf(layer2) == -1) {
                  linkLayers.push(layer2);
                }
              }
            }
          });
        });

        var IDs = [];
        linkLayers.forEach(function(layer1, i) {
          var tmpSubset = topos[layer1].filter.featureid.top(Infinity);
          var tmpID1 = tmpSubset.map(function(d) {return d["featureid"];});
          linkLayers.forEach(function(layer2, j) {
            if (j > i) {
              var tmpSubset2 = topos[layer2].filter.featureid.top(Infinity);
              var tmpID2 = tmpSubset2.map(function(d) {return d["featureid"];});
              if (IDs.length == 0 && i == 0) {
                IDs = tmpID1.filter(function(val) {
                  return tmpID2.indexOf(val) != -1;
                });
              }
              else {
                var IDsFilter = IDs.filter(function(val) {
                  return (tmpID1.indexOf(val) != -1 && tmpID2.indexOf(val) != -1);
                });
                IDs = IDsFilter;
              }
            }
          });
        });

        linkLayers.forEach(function(layer) {
          topos[layer].filter.featureid.filterFunction(function(d) { 
            return IDs.indexOf(d) != -1;
          });
        });

        //******Filter by political IDs
        var polSubset = topos.political.filter.featureid.top(Infinity);
        var polIDs = polSubset.map(function(d) {return d["featureid"];});
        layers.forEach(function(layer) {
          topos[layer].filter.featureid.filterFunction(function(d) {
            if(linkLayers.indexOf(layer) == -1) { 
              return polIDs.indexOf(d) != -1;
            }
            else {
              return (polIDs.indexOf(d) != -1 && IDs.indexOf(d) != -1);
            }
          });
        });

        return linkLayers, IDs;
      }



      
      //******Update filter statistics
      function updateStats(tmpKey, topo) {
        //******Update filter mean
        graphs.forEach(function(class_key) {
          var dash = class_key.indexOf("-");
          var tmpClass = class_key.slice(0, dash);
          var key = class_key.slice(dash + 1, class_key.length);

          if (class_key.indexOf(topo.class) > -1) {
            if (topo.filter["all"].value() > 0 ) {
              if (topo.data_type[key] == "date") {
                var tmpFormat = d3.time.format("%-m/%-d/%Y")
                d3.select("#mean-" + class_key).html("Mean: " + tmpFormat(new Date(d3.mean(topo.filter[key].top(Infinity), function(d) { if (d[key] > -9999) {return d[key];} }))));
              }
              else {
                d3.select("#mean-" + class_key).html("Mean: " + d3.mean(topo.filter[key].top(Infinity), function(d) { if (d[key] > -9999) {return d[key];} }).toFixed(2));
              }

              if (brush[tmpClass][key].empty()) {
                setInputs(topo, key, topo.minVal[key], topo.maxVal[key], topo.minClip[key], topo.maxClip[key]);
              }
              else {
                setInputs(topo, key, brush[tmpClass][key].extent()[0], brush[tmpClass][key].extent()[1], brush[tmpClass][key].extent()[0], brush[tmpClass][key].extent()[1]);
              }
            }
            else {
              if (topo.data_type[key] == "date") {
                d3.select("#mean-" + class_key).html("Mean: 0/0/0000");
              }
              else {
                d3.select("#mean-" + class_key).html("Mean: 0.00");
              }
            }
          }  
        });
      }




      //******Update filter histogram based on current brush
      function updateHistogram(tmpKey, topo) {
        graphs.forEach(function(class_key) {
          var dash = class_key.indexOf("-");
          var tmpClass = class_key.slice(0, dash);
          var key = class_key.slice(dash + 1, class_key.length);

          if (class_key.indexOf(topo.class) > -1) { 
            if (class_key != topo.class + "-" + tmpKey) {
              redrawHist(key, topo);
            }
          }
        });
      }

      //******Redraw the histogram
      function redrawHist(key, topo) {
        //******If brush is present, remove it and get featureID's, then add it back
        if (!brush[topo.class][key].empty()) {
          topo.filter[key].filterAll();
          var linkLayers, IDs = getLinkIDs();
          var tmpData = JSON.parse(JSON.stringify(topo.filter[key + "s"].all()));
          topo.filter[key].filterRange([brush[topo.class][key].extent()[0], brush[topo.class][key].extent()[1]]);
          var linkLayers, IDs = getLinkIDs();
        }
        else {
          var tmpData = topo.filter[key + "s"].all();
        }

        var svg = d3.select("#g-" + topo.class + "-" + key);
        var x = hist[topo.class][key].x;
        var y = hist[topo.class][key].y;
        var height = hist[topo.class][key].height;
        var width = hist[topo.class][key].width;
        y.domain([0, d3.max(tmpData, function(d) { if (d.key > -9999) { return d.value; } })]);

        //******update background bars
        var update = svg.selectAll(".background.bar")
          .data(tmpData);

        update.exit().remove();
        update.enter().insert("rect", ":first-child")
          .attr("class", "background bar");
        update
          .attr("x", function(d) { return x(d.key); })
          .attr("width", (x.range()[1] - x.range()[0])/40)  
          .attr("y", function(d) { return y(d.value); })
          .attr("height", function(d) { return height - y(d.value); });

        //******update foreground bars
        var update = svg.selectAll(".foreground.bar")
          .data(tmpData);

        update.exit().remove();
        update.enter().insert("rect", ":first-child")
          .attr("class", "foreground bar");
        update
          .attr("x", function(d) { return x(d.key); })
          .attr("width", (x.range()[1] - x.range()[0])/40)  
          .attr("y", function(d) { return y(d.value); })
          .attr("height", function(d) { return height - y(d.value); });
      }


      //******Tutorial
      function startIntro() {
        var intro = introJs();
        intro.setOptions({
          steps: [
            //0
            { intro: '<p class="heading">Welcome to the Critical Loads Assessment by Site tool!</p><p style="font-size:14px;font-style:italic;">Disclaimer: This tool is still under development</p>' },
            //1
            { element: document.querySelector("#tutorial"), intro: '<p class="heading">Tutorial</p><p>To access this guide at any time, click on the "Tutorial" link.</p>' },
            //2
            { element: document.querySelector("#mapTools"), intro: '<p class="heading">Map Controls</p><p>You can use these controls to change the map baselayer, add overlay layers, and search the map by name, zip code or coordinates.</p>' },
            //3
            { element: document.querySelector("#speciesList"), intro: '<p class="heading">Nationwide CL & EXC Map Layers</p><p>Use this dropdown menu to add nationwide Critical Load, Exceedance, and Current Condition map layers.</p>' },
            //4
            { element: document.querySelector("#abioticList"), intro: '<p class="heading">Deposition Map Layers</p><p>Use this dropdown menu to add nationwide deposition data map layers.</p>' },
            //5
            { element: document.querySelector("#legendControl"), intro: '<p class="heading">Legend</p><p>Click this icon to open or close the legend window.</p>' },
            //6
            { element: document.querySelector("#legendDiv"), intro: '<p class="heading">Legend</p><p>If multiple map layers are selected at once, the layer at the top ot the legend window corresponds to the top layer projected on the map.<br><br>You can change the order of the map layers by dragging and dropping them in the legend window.</p>' },
            //7
            { element: document.querySelector("#resetControl"), intro: '<p class="heading">Deselect Maps</p><p>Click this icon to deselect any active map layers.</p>' },
            //8
            { element: document.querySelector("#welcome"), intro: '<p class="heading">Welcome Box</p><p>Click this icon to re-open the welcome screen.</p>' },
            //9
            { element: document.querySelector("#left_panel_container"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Proceed through the steps in the left-hand side bar to access outputs for a specific area. You will answer preference questions along the way to ensure the results meet your particular needs.</p>' },
            //10
            { element: document.querySelector("#selAreaDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select your <b>Area</b></p><p>Use the "Area Layer" dropdown to select your area category.</p>' },
            //11
            { element: document.querySelector("#selAreaDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select your <b>Area</b></p><ol>To select an area, you can:<li>Type the name of your area into the search bar, or</li><li>Scroll through the search bar list and click on the name of your area, or</li><li>Use the Map viewing panel to click on your area on the map.</li></ol>' },
            //12
            { element: document.querySelector("#selEcoDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select <b>Ecosystem Component(s)</b></p>' },
            //13
            { element: document.querySelector("#selDepDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select <b>Deposition</b><br>For each selected ecosystem component, select which deposition type(s) to map.</p>' },
            //14
            { element: document.querySelector("#selCLDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select <b>CL Type</b><br>For Lichen and Tree ecosystem components, select which critical load type(s) to map.</p>' },
            //15
            { element: document.querySelector("#selSppDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select <b>Species</b></p><ul>For the Trees ecosystem component, select whether you want maps of:<li>individual tree species, and/or</li><li>summary of all species present</li></ul>' },
            //16
            { element: document.querySelector("#selSppDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>Select <b>Species</b></p><ul>Next, indicate your preferred:<li>individual tree species, and/or</li><li>methods for summarizing all species present</li></ul>' },
            //17
            { element: document.querySelector("#selOutDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p><b>Preview</b> your outputs<br>Select the exceedance map formats you would like to receive. To learn more about the format options, click the information icon (<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin:0;opacity:1;"></span>).</p>' },
            //18
            { element: document.querySelector("#selOutDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p><b>Preview</b> your outputs<br><ul><li>If you would like to view a complete list of all the outputs you have selected, click "Preview outputs list".</li><li>If you want to skip the preview list, click "Next".</li></ul></p>' },
            //19
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>View your map <b>Outputs</b><br>Click "View maps" to open a table of outputs.</p>' },
            //20
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>View your map <b>Outputs</b><br>Click on an ecosystem component to open the table of outputs for that component.</p>' },
            //21
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>View your map <b>Outputs</b><br>Click on the N Dep or S Dep tab to access the maps for that deposition type.</p>' },
            //22
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Access Outputs for a Specific Site</p><p>View your map <b>Outputs</b><br>Click on a map name to view it.</p>' },
            //23
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Map Information</p><p>To view additional information for a map layer, add it to the viewing panel, then click the "Map information" button.</p>' },
            //24
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Display maps with Uncertainty</p><p>To view the confidence ratings associated with a map, click on the map to select it, then click on the "Show uncertainty" button.</p>' },
            //25
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Display maps with Uncertainty</p><p>To learn more about the uncertainty metrics used in CLAS, click the information icon (<span class="glyphicon glyphicon-info-sign help-tooltip" style="margin:0;opacity:1;"></span>).</p>' },
            //26
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Download map outputs</p><p>To download an individual map layer, click on the map to select it, then click on the "Download current map" button.</p>' },
            //27
            { element: document.querySelector("#mapDownload"), intro: '<p class="heading">Download map outputs</p><p>Use the file type drop-down list to select your preferred file type before downloading.</p>' },
            //28
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Download map outputs</p><p>To download all of your map outputs at once, click the "Download all map outputs" button.</p>' },
            //29
            { element: document.querySelector("#mapDownload"), intro: '<p class="heading">Download map outputs</p><p>Use the file type drop-down list to select your preferred file type before downloading.</p>' },
            //30
            { element: document.querySelector("#selResDiv"), intro: '<p class="heading">Access additional information</p><p><i>Coming soon</i>: you will e able to view related resources for the area you selected by clicking on this additional CL & EXC information button.</p>' },
            //31
            { element: document.querySelector("#navMenu"), intro: '<p class="heading">Access additional information</p><p>For more detailed information about CLAS, visit these additional tabs.</p>' },
          ],

          tooltipPosition: 'auto',
          positionPrecedence: ['left', 'right', 'bottom', 'top'],
          showStepNumbers: false,
          hidePrev: true,
          hideNext: false,
          scrollToElement: true,
          disableInteraction: true,
        });


        intro.onchange(function() {
          revertIntro();
          switch (this._currentStep) {
            case 0:
              break;
            case 1:
              d3.select("#tutorial").style("color","black").style("opacity", 1);
              break;
            case 2:
              d3.selectAll("#baselayerList, #abioticList, #speciesList, #bingGeocoderSubmit").style("color", "black");
              break;
            case 3:
              d3.select("#speciesList").style("color", "black");
              break;
            case 4:
              d3.select("#abioticList").style("color", "black");
              break;
            case 5:
              d3.select("#legendControl").style("color", "black");
              break;
            case 6:
              $("#abioticListDropdown > div").first().click();
              $("#natMapsAquaticSubMenuN > div").first().click();
              d3.selectAll(".legendTitle").each(function() { $(this).click(); });
              d3.select("#legendDiv").style("opacity", 1).style("display", "block");
              break;
            case 7:
              d3.select("#resetControl").style("color", "black");
              break;            
            case 8:
              d3.select("#welcome").style("color", "black");
              break;  
            case 9:
              d3.select("#left_panel_container").style("background", "#303030");
              break;
            case 10:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selArea").style("visibility", "visible").classed("active", true).select(".material-icons").classed("active", true);;
              d3.select("#selAreaTog").style("display", "block").style("height", "113px").style("background", "#303030");
              break;
            case 11:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selArea").style("visibility", "visible").classed("active", true).select(".material-icons").classed("active", true);;
              d3.select("#selAreaTog").style("display", "block").style("height", "180px").style("background", "#303030");
              d3.select("#areaOptionsSelect").style("display", "flex");
              $("#areaListDropdown>.layerName").first().click();
              break;
            case 12:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selEco").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selEcoTog").style("display", "block").style("height", "155px").style("background", "#303030").style("position", "relative").style("top", "-4px");
              break;
            case 13:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selDep").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);;
              d3.select("#selDepTog").style("display", "block").style("height", "355px").style("background", "#303030").style("position", "relative").style("top", "-8px");
              d3.selectAll(".depChoice").style("display", "block");
              break;
            case 14:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selCL").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);;
              d3.select("#selCLTog").style("display", "block").style("height", "356px").style("background", "#303030").style("position", "relative").style("top", "-9px");
              d3.selectAll(".CLTypeDiv").style("display", "block");
              break;
            case 15:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selSpp").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);;
              d3.select("#selSppTog").style("display", "block").style("height", "165px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              break;
            case 16:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selSpp").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);;
              d3.select("#selSppTog").style("display", "block").style("height", "395px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.selectAll(".sppIndDiv, .sppComDiv").style("display", "block");
              break;
            case 17:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selOut").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selOutTog").style("display", "block").style("height", "250px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              break;
            case 18:
              d3.selectAll(".selDiv").style("visibility", "hidden");
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selOut").style("visibility", "visible").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selOutTog").style("display", "block").style("height", "250px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.selectAll("#outPrevBtn, #selOutNxtBtn").classed("disabled", false);
              break;
            case 19:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 20:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "294px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 21:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "366px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.select("#resMapsAquaticN").classed("active", true);
              d3.select("#resMapsAquaticSubHeaderDiv").classed("in", true);
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 22:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "366px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.select("#resMapsAquaticN").classed("active", true);
              d3.select("#resMapsAquaticSubHeaderDiv").classed("in", true);
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 23:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "366px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.select("#resMapsAquaticN").classed("active", true);
              d3.select("#resMapsAquaticSubHeaderDiv").classed("in", true);
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.select("#resExtDiv").style("z-index", "1000000").style("pointer-events", "none");
              d3.selectAll("#resExtDownloadDataBtn, #togUncBtn").classed("disabled", true);
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 24:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "366px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.select("#resMapsAquaticN").classed("active", true);
              d3.select("#resMapsAquaticSubHeaderDiv").classed("in", true);
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.select("#resExtDiv").style("z-index", "1000000").style("pointer-events", "none");
              d3.selectAll("#resExtDownloadDataBtn, #mapInfoBtn").classed("disabled", true);
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 25:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "366px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.selectAll(".resMapsCompDiv").style("display", "block");
              d3.select("#resMapsMenuDiv").classed("in", true);
              d3.select("#resMapsAquaticN").classed("active", true);
              d3.select("#resMapsAquaticSubHeaderDiv").classed("in", true);
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.select("#resExtDiv").style("z-index", "1000000").style("pointer-events", "none");
              d3.selectAll("#resExtDownloadDataBtn, #mapInfoBtn").classed("disabled", true);
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 26:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.select("#resExtDiv").style("z-index", "1000000").style("pointer-events", "none");
              d3.selectAll("#togUncBtn, #mapInfoBtn").classed("disabled", true);
              d3.selectAll("#resReportsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 27:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block"); //.style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.select("#resExtDiv").style("z-index", "1000000").style("pointer-events", "none");
              d3.selectAll("#togUncBtn, #mapInfoBtn").classed("disabled", true);
              d3.select("#mapDownloadDiv").classed("in", true).classed("tutImp", true).style("display", "flex");
              break;
            case 28:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.selectAll("#resMapsDiv, #resViewReportsDiv").classed("disabled", true);
              break;
            case 29:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.selectAll("#resMapsDiv, #resViewReportsDiv").classed("disabled", true);
              d3.select("#mapDownloadDiv").classed("in", true).classed("tutImp", true).style("display", "flex");
              break;
            case 30:
              d3.select("#left_panel").style("overflow-y", "visible");
              d3.select("#selRes").classed("active", true).classed("disabled", false).select(".material-icons").classed("active", true);
              d3.select("#selResTog").style("display", "block").style("height", "174px").style("background", "#303030").style("position", "relative").style("top", "-18px");
              d3.select("#resViewReportsBtnSpan").text("Selway-Bitterroot Wilderness");
              d3.select("#resMapsAquaticSubMenuN").classed("in", true).html('<p class="resOption n" data-gs="A_CL_NS_2017-2019_class1" data-img="images/aquatic_cl.jpg" data-layer="<p><b>Critical Load for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">CL: <span class="N_span">N+S Dep</span></p><p class="resOption n type1 vis" data-gs="A_EXC_NS_2017-2019_class1_type1" data-img="images/aquatic_exc_type1.jpg" data-layer="<p><b>Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Exceedance: <span class="N_span">N+S Dep</span></p><p class="resOption n type2" data-gs="A_EXC_NS_2017-2019_class1_type2" data-img="images/aquatic_exc_type2.jpg" data-layer="<p><b>Magnitude of Exceedance of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC: <span class="N_span">N+S Dep</span></p><p class="resOption n type3" data-gs="A_EXC_NS_2017-2019_class1_type3" data-img="images/aquatic_exc_type3.jpg" data-layer="<p><b>Magnitude of Exceedance (+/-) of the CL for acidification</b><br>Aquatic<br><span class=&quot;N_span&quot;>N+S Deposition</span></p>" data-dep="T-dep" data-years="2017-2019" onclick="addRes(this)">Magnitude of EXC +/-: <span class="N_span">N+S Dep</span></p>');
              $(".resOption.n.type1.vis").click();
              d3.selectAll("#resMapsDiv, #resReportsDiv").classed("disabled", true);
              break;
            case 31:
              d3.select("#home").classed("disabled", true);
              break;
          }
        });

        intro.onbeforechange(function() { 
          switch (this._currentStep) {
            case 0:
              break;
          }  
        });


        intro.onafterchange(function() { 
          //var objDiv = document.getElementById("left_panel");
          //objDiv.scrollTop = objDiv.scrollHeight;
          window.scrollTo(0,document.body.scrollHeight);
          switch (this._currentStep) {
            case 9:
              d3.select(".introjs-helperLayer").style("height", "388px");
              break;
            case 10:
              d3.select(".introjs-helperLayer").style("height", "186px");
              break;
            case 11:
              d3.select(".introjs-helperLayer").style("height", "253px");
              break;
            case 12:
              d3.select(".introjs-helperLayer").style("height", "230px").style("top", "230px");
              break;
            case 13:
              d3.select(".introjs-helperLayer").style("height", "429px").style("top", "280px");
              break;
            case 14:
              d3.select(".introjs-helperLayer").style("height", "428px").style("top", "329px");
              break;
            case 15:
              d3.select(".introjs-helperLayer").style("height", "239px").style("top", "378px");
              break;
            case 16:
              d3.select(".introjs-helperLayer").style("height", "470px").style("top", "378px");
              break;
            case 17:
              d3.select(".introjs-helperLayer").style("height", "324px").style("top", "427px");
              break;
            case 18:
              d3.select(".introjs-helperLayer").style("height", "324px").style("top", "427px");
              break;
            case 19:
              d3.select(".introjs-helperLayer").style("height", "229px").style("top", "476px");
              break;
            case 20:
              d3.select(".introjs-helperLayer").style("height", "349px").style("top", "476px");
              break;
            case 21:
              d3.select(".introjs-helperLayer").style("height", "421px").style("top", "476px");
              break;
            case 22:
              d3.select(".introjs-helperLayer").style("height", "421px").style("top", "476px");
              break;
            case 23:
              d3.select(".introjs-helperLayer").style("height", "421px").style("top", "476px");
              break;
            case 24:
              d3.select(".introjs-helperLayer").style("height", "421px").style("top", "476px");
              break;
            case 25:
              d3.select(".introjs-helperLayer").style("height", "421px").style("top", "476px");
              break;
            case 26:
              d3.select(".introjs-helperLayer").style("height", "229px").style("top", "476px");
              break;
            case 28:
              d3.select(".introjs-helperLayer").style("height", "229px").style("top", "476px");
              break;
            case 30:
              d3.select(".introjs-helperLayer").style("height", "229px").style("top", "476px");
              break;
            case 31:
              d3.select(".introjs-helperLayer").style("left", "75px").style("width", "726px");
              window.scrollTo(0,0);
              break;
          }  
        });


        intro.oncomplete(function() { 
          //localStorage.setItem('doneTour', 'yeah!'); 
          revertIntro();
        });

        intro.onexit(function() {
          revertIntro();
        });            


        intro.start();



        function revertIntro() {
          if(d3.select("#togUncBtn").text() == "Hide uncertainty") {
            $("#togUncBtn").click();
          }
          d3.selectAll(".selDiv").style("visibility", "");
          d3.select(".selDiv.active").each(function() { 
            if(d3.select(this).classed("collapsed") == false) { 
              $(this).click(); 
            } 
            d3.select(this).classed("active", false).select(".material-icons").classed("active", false);
            d3.selectAll(".resMenuSubHeaderDiv").classed("in", false);
            d3.selectAll(".selDiv").each(function() {
              if(this.id != "selArea") {
                d3.select(this).classed("disabled", true);
              }
            });
          });

          //0
          //1
          d3.select("#tutorial").style("color", "").style("opacity", "");
          //2
          d3.selectAll("#baselayerList, #abioticList, #speciesList, #bingGeocoderSubmit").style("color", "");
          //3
          d3.select("#speciesList").style("color", "");
          //4
          d3.select("#abioticList").style("color", "");
          //5
          d3.select("#legendControl").style("color", "");
          //6
          d3.select("#legendDiv").style("opacity", "").style("display", "");
          $("#resetControl").click();
          //7
          d3.select("#resetControl").style("color", "");
          //8
          d3.select("#welcome").style("color", "");
          //9
          d3.select("#left_panel_container").style("background", "");
          //10
          d3.select("#selAreaTog").style("display", "").style("height", "").style("background", "");
          //11
          resetArea();
          //12
          d3.select("#selEcoTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          //13
          d3.select("#selDepTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          d3.selectAll(".depChoice").style("display", "");
          //14
          d3.select("#selCLTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          d3.selectAll(".CLTypeDiv").style("display", "");
          //15
          d3.select("#selSppTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          d3.selectAll(".sppIndDiv, .sppComDiv").style("display", "");
          //16
          //17
          d3.select("#selOutTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          //18
          d3.selectAll("#outPrevBtn, #selOutNxtBtn").classed("disabled", true);
          //19
          d3.select("#selResTog").style("display", "").style("height", "").style("background", "").style("position", "").style("top", "");
          d3.select("#left_panel").style("overflow-y", "");
          d3.select("#resViewReportsBtnSpan").text("");
          //20
          d3.selectAll(".resMapsCompDiv").style("display", "");
          d3.select("#resMapsMenuDiv").classed("in", false);
          //21
          d3.select("#resMapsAquaticN").classed("active", false);
          d3.select("#resMapsAquaticSubHeaderDiv").classed("in", false);
          d3.select("#resMapsAquaticSubMenuN").classed("in", false).html('');
          //22
          //23
          d3.select("#resExtDiv").style("z-index", "").style("pointer-events", "");
          d3.selectAll("#resExtDownloadDataBtn, #togUncBtn, #mapInfoBtn").classed("disabled", false);
          //24
          //25
          //26
          //27
          d3.select("#mapDownloadDiv").classed("in", false).classed("tutImp", false).style("display", "none");
          //28
          d3.selectAll("#resMapsDiv, #resReportsDiv, #resViewReportsDiv").classed("disabled", false);
          //29
          //30
          //31
          d3.select("#home").classed("disabled", false);
        }
      }

    </script>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <title>N-CLAS Interactive Web Tool</title>
    <link rel="icon" type="image/png" href="images/tree_icon.png">

    <!--link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/-->
    <link rel="stylesheet" href="styles/bootstrap.min.css"/>
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/introjs.min.css"/-->
    <link rel="stylesheet" href="introjs.min.css"/>
    <!--link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/-->
    <link rel="stylesheet" href="leaflet.css"/>
    <!--link rel="stylesheet" href="http://colorbrewer2.org/export/colorbrewer.css"/-->
    <link rel="stylesheet" href="colorbrewer.css"/>
    <link rel="stylesheet" href="styles/Control.BingGeocoder.css"/>
    <link rel="stylesheet" href="styles/Control.maxExtent.css"/>
    <link rel="stylesheet" href="styles/Control.mousePosition.css"/>
    <link rel="stylesheet" href="styles/Control.downLoadFile.css"/>
    <link rel="stylesheet" href="styles/Control.print.css"/>
    <link rel="stylesheet" href="styles/app.css"/>
    <link rel="stylesheet" href="styles/NCLAS.css"/>

    <!--script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script-->
    <script src="leaflet.js"></script>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script-->
    <script src="jquery-3.2.1.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <!--script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script-->
    <script src="bootstrap.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3"></script>
    <!--script src="bundle.js"></script-->
    <script src="Bing_tile.js"></script>
    <script src="Control.BingGeocoder.js"></script>
    <script src="Control.maxExtent.js"></script>
    <script src="Control.mousePosition.js"></script>
    <script src="Control.downLoadFile.js"></script>
    <script src="Control.print.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.4.0/intro.min.js"></script-->
    <script type="text/javascript" src="intro.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js"></script>


    <script src="http://ecosheds.org:3413/socket.io/socket.io.js"></script>
    <script src="socket_emit.js"></script>
    <!--script src="http://d3js.org/d3.v3.min.js"></script-->
    <script src="d3.v3.min.js"></script>
    <!--script src="http://d3js.org/topojson.v1.min.js"></script-->
    <script src="topojson.v1.min.js"></script>
    <!--script src="http://colorbrewer2.org/export/colorbrewer.js"></script-->
    <script src="colorbrewer.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script-->
    <script src="queue.min.js"></script>
    <script src="crossfilter.min.js"></script>

  </head>

  <body>
    <nav id="mainMenu" class="navbar navbar-inverse">
      <div class="container-fluid">
        <ul class="nav navbar-nav">
          <li id="home" class="active"><a href="#">Home</a></li>
          <li id="basics"><a href="#">N-CLAS Basics</a></li>
          <li id="approach"><a href="#">Our Approach</a></li>
          <li id="guide"><a href="#">Users Guide</a></li>
          <li id="tutorial"><a href="#">Tutorial</a></li>
          <li id="preferences"><a href="#">Preferences</a></li>
          <li id="welcome"><a href="#">Welcome</a></li>
        </ul>
      </div>
    </nav>
    
    <div id="container">
      <div id="left_panel">
        <div id="left_panel_container">
          <div class="selDiv selected" id="selArea" style="background:rgb(189,68,65);" title="Select Area">Select<br>Area</div>
          <div class="selDiv disabled" id="selSpp" style="background:rgb(118,147,60);" title="Complete previous step to enable">Select<br>Species</div>
          <div class="selDiv disabled" id="selOut" style="background:rgb(54,96,146);" title="Complete previous step to enable" data-toggle="" data-target="#outputDiv">Select<br>Output</div>
          <div class="selDiv disabled" id="selRes" style="background:rgb(255,192,0);" title="Complete previous step to enable">View Results</div>
        </div>
        <div id="left_collapse"><span id="left_collapse_glyph" class="glyphicon glyphicon-triangle-left"></span></div>
      </div>
      <div id="map">
        <div id="toolbar"></div>
      </div>
      <div id="right_panel">
        <div id="right_panel_container"></div>
        <div id="right_collapse"><span id="right_collapse_glyph" class="glyphicon glyphicon-triangle-right"></span></div>
      </div>
    </div>

    <script type='text/javascript'>
      //******Connect to postgresql database
      socket_emit();

      //******Initialize bootstrap tooltip
      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();   
      });

      //******Call funtion to reposition windows on resize
      window.addEventListener('resize', resizePanels);

      localStorage.removeItem("tailorArray");

      function resizePanels() {
        var htmlRect = {};
        htmlRect.height = Math.max(window.innerHeight, $('html').height());
        htmlRect.top = 0;
        htmlRect.bottom = htmlRect.height;
        htmlRect.width = Math.max(window.innerWidth, $('html').width());
        htmlRect.left = 0;
        htmlRect.right = htmlRect.width;
        var tmpWindows = ["legendDiv", "downloadDiv","preferencesDiv"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > htmlRect.bottom) {
            d3.select("#" + win).style("top", htmlRect.height - winRect.height + "px");
          }
          if(winRect.right > htmlRect.right) {
            d3.select("#" + win).style("left", htmlRect.width - winRect.width + "px");
          }
        });

        var mapRect = document.getElementById("map").getBoundingClientRect();
        var tmpWindows = ["d3Tooltip"];
        
        tmpWindows.forEach(function(win) {
          var winRect = document.getElementById(win).getBoundingClientRect();
          if(winRect.bottom > mapRect.bottom) {
            d3.select("#" + win).style("top", mapRect.height - winRect.height + "px");
          }
          if(winRect.right > mapRect.right) {
            d3.select("#" + win).style("left", mapRect.width - winRect.width + "px");
          }
        });

        //***Resize container-results width
        var tmpWidth = Math.max(window.innerWidth, 1280);

        if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
          tmpWidth -= 165;
        }
        else {
          tmpWidth -= 15;
        }

        if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
          tmpWidth -= 365;
        }
        else {
          tmpWidth -= 15;
        }

        d3.select("#container-results").style({"width":tmpWidth + "px"});

        //***Rescale chart canvas
        if(d3.select("#container-results").style("display") == "block" && d3.select(".canvasChartsLarge")[0][0] != null) {
          var tmpID = d3.select(".canvasChartsLarge").select("canvas").attr("id");
          var tmpIDSmall = tmpID.replace("Large","");
          var xTickFont = setFontSizeLarge(d3.select("#" + tmpIDSmall).attr("value"), tmpID);
          var canRectDiv = document.getElementById("canvasChartsLargeDiv").getBoundingClientRect();
          var widthPercent = (canRectDiv.width - 690)/(1830 - 690);
          var canRect = document.getElementById("container-results").getBoundingClientRect();
          var widthPercentCan = (Math.max(canRect.width, 730) - 730)/(1380 - 730);

          chartCanvas[tmpID].options.title.fontSize = (20 + (20 * widthPercent));

          if(tmpIDSmall == 'fig13b' || tmpIDSmall == 'fig13f' || tmpIDSmall.includes("fig6")) {
            chartCanvas[tmpID].options.legend.labels.fontSize = (9 + (9 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (9 + (9 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (9 + (9 * widthPercent));
          }
          else if(tmpIDSmall.includes('fig9b') || tmpIDSmall.includes('fig13g') || tmpIDSmall.includes('fig13c')) {
            chartCanvas[tmpID].options.legend.labels.fontSize = (13 + (13 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (13 + (13 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (13 + (13 * widthPercent));
          }
          else {
            chartCanvas[tmpID].options.legend.labels.fontSize = (12 + (12 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.boxWidth = (12 + (12 * widthPercent));
            chartCanvas[tmpID].options.legend.labels.padding = (12 + (12 * widthPercent));
          }
          chartCanvas[tmpID].options.scales.xAxes[1].scaleLabel.fontSize = (18 + (18 * widthPercent));          
          chartCanvas[tmpID].options.scales.xAxes[0].ticks.fontSize = (xTickFont + (xTickFont * (widthPercent)));          
          chartCanvas[tmpID].options.scales.xAxes[0].scaleLabel.fontSize = (14 + (14 * widthPercent));          
          chartCanvas[tmpID].options.scales.yAxes[0].scaleLabel.fontSize = (14 + (14 * widthPercent));
          if(tmpID.includes("tab")) {
            chartCanvas[tmpID].options.scales.yAxes[0].ticks.fontSize = (9 + (9 * widthPercent));
          }
          else {
            chartCanvas[tmpID].options.scales.yAxes[0].ticks.fontSize = (12 + (12 * widthPercent));
          }
          chartCanvas[tmpID].options.tooltips.titleFontSize = (16 + (6 * (1 - widthPercentCan)));
          chartCanvas[tmpID].options.tooltips.bodyFontSize = (14 + (6 * (1 - widthPercentCan)));

          if(tmpID.includes("tab4")) {
            chartCanvas[tmpID].options.layout.padding.top = (5 + (5 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (17 + (17 * widthPercentCan));
          }
          else if(tmpID.includes("tab2c") || tmpID.includes("tab1a")) {
            chartCanvas[tmpID].options.layout.padding.top = (15 + (45 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (35 + (20 * widthPercentCan));
          }
          else if(tmpID.includes("tab3")) {
            chartCanvas[tmpID].options.layout.padding.top = (30 + (60 * widthPercentCan));
          }
          else if(tmpID.includes("tab")) {
            chartCanvas[tmpID].options.layout.padding.top = (30 + (60 * widthPercentCan));
            chartCanvas[tmpID].options.scales.xAxes[0].gridLines.tickMarkLength = (17 + (17 * widthPercentCan));
          }
       
          chartCanvas[tmpID].clear();
          chartCanvas[tmpID].render(0, true);
          chartCanvas[tmpID].update();

          if(tmpID.includes("tab")) {
            var tmpPrint = chartCanvas[tmpID];
            var tmpRect = document.getElementById(tmpID).getBoundingClientRect();
            if(tmpRect.width < 730) {
              setTimeout(function() {
                tmpRect = document.getElementById(tmpID).getBoundingClientRect();
                var widthPercentCan = (tmpRect.width - 730)/(1380 - 730);

                addInfo(tmpPrint, chartOpts[tmpIDSmall].large.cl[0], tmpRect, "large", widthPercentCan, tmpID);
              }, 500);
            }
            else {
              addInfo(tmpPrint, chartOpts[tmpIDSmall].large.cl[0], tmpRect, "large", widthPercentCan, tmpID);
            }
          }
        }

        d3.select("#resTabsDiv").selectAll("canvas")[0].forEach(function(tmpCan) {
          chartCanvas[tmpCan.id + "Small"].update();
          var tmpPrint = chartCanvas[tmpCan.id + "Small"];
          var tmpRect = document.getElementById(tmpCan.id).getBoundingClientRect();
          addInfo(tmpPrint, chartOpts[tmpCan.id].small.cl[0], tmpRect, "small", 1, tmpCan.id)
        });

        //***Resize species dropdown list
        d3.select("#speciesListDropdown").style("max-height", window.innerHeight - 143 + "px");
      }


      //******Add Map with custom zoom depending on screen size
      if(window.innerWidth > 1900) {
        var map = new L.Map('map', {center: new L.LatLng(43.5, -80), zoomControl: false, zoom: 6, minZoom: 2, maxZoom: 20, inertiaDeceleration: 1000});
      }
      else {
        var map = new L.Map('map', {center: new L.LatLng(40, -78), zoomControl: false, zoom: 5, minZoom: 2, maxZoom: 20, inertiaDeceleration: 1000});
      }
      d3.select(".leaflet-control-attribution a").property("target", "_blank")

      //******Add map controls
      //******Bottom Right
      L.control.zoom({ position: 'bottomright', zoomInTitle: "Zoom in (can also be done with mouse wheel, double-click, '+' key, or by pressing the 'shift' key while clicking and dragging a rectangle)", zoomOutTitle: "Zoom out (can also be done with the mouse wheel or the '-' key)" }).addTo(map);
      L.control.maxExtent().addTo(map);

      //******Bottom Left
      L.control.scale({ maxWidth: 200 }).addTo(map);
      L.control.mousePosition().addTo(map);

      //***Bing geocoder control
      var tmpPoint = new L.marker;
      var bingGeocoder = new L.Control.BingGeocoder('At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn', { callback: function (results) 
        {
          if(results.statusCode == 200 && results.resourceSets[0].estimatedTotal > 0) {
            if(d3.select("#bingGeocoderSubmit").classed("glyphicon-search")) {
              $(document).ready(function(){
                $('[data-toggle="tooltip"]').tooltip();   
              });
              document.getElementById("bingGeocoderInput").blur();
              var bbox = results.resourceSets[0].resources[0].bbox,
                first = new L.LatLng(bbox[0], bbox[1]),
                second = new L.LatLng(bbox[2], bbox[3]),
                tmpBounds = new L.LatLngBounds([first, second]);
              this._map.fitBounds(tmpBounds);
              this._map.removeLayer(tmpPoint);
              tmpPoint = new L.marker(results.resourceSets[0].resources[0].point.coordinates);  //.bindPopup(results.resourceSets[0].resources[0].address.formattedAddress);
              this._map.addLayer(tmpPoint);
              d3.select("#bingGeocoderInput").property("value", results.resourceSets[0].resources[0].name);
              d3.select(".leaflet-marker-icon")
                .attr("id","mapIcon")
                .attr("value", results.resourceSets[0].resources[0].name)
                .attr("data-toggle", "tooltip")
                .attr("data-container", "body")
                .attr("data-placement", "auto top")
                .attr("data-html", "true")
                .attr("title", '<p><b><center>' + results.resourceSets[0].resources[0].name + '</center></b></p>');
              d3.select(tmpPoint)
                .on("click", function() { clearSearch(); });
              d3.select("#bingGeocoderSubmit")
                .classed("glyphicon-search", false)
                .classed("glyphicon-remove", true)
                .property("title", "Click to clear search results");
            }
            else {
              clearSearch();
            }
          }
          else {
            d3.select("#bingGeocoderInput").property("value","No matching results");            
          }
        }
      });

     

      //******Clear the results of the geo search
      function clearSearch() {
        map.removeLayer(tmpPoint);
        d3.select(".tooltip").remove();
        d3.select("#bingGeocoderInput").property("value", "");

        d3.select("#bingGeocoderSubmit")
          .classed("glyphicon-remove", false)
          .classed("glyphicon-search", true)
          .style({"background":"", "color":""})
          .property("title", "Click to zoom to specified location");
      }

      //******Add base layers
      var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      }); 
      var googleStreet = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });
      var googleTerrain = googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      });

      var bingHybrid = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'AerialWithLabels'});
      var bingSatellite = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Aerial'});
      var bingStreet = new L.BingLayer("At3gymJqaoGjGje-JJ-R5tJOuilUk-gd7SQ0DBZlTXTsRoMfVWU08ZWF1X7QKRRn", {type: 'Road'});
      var usgsTopo = new L.tileLayer('http://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 15,
            zIndex: 0,
            attribution: '<a href="http://www.doi.gov">U.S. Department of the Interior</a> | <a href="http://www.usgs.gov">U.S. Geological Survey</a> | <a href="http://www.usgs.gov/laws/policies_notices.html">Policies</a>'
            });
      var states = new L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
          layers: 'us_states',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      var blank = new L.tileLayer('');




      //******Study region layer
      var studyRegion = new L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
          layers: 'ecoregions_dissolved',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
        });
      

    

      //******Add Geoserver Layers
      //******Abiotic Layers
      var abioticID = ["n", "aspect", "bedrock", "clay", "coarse", "elevation", "permeability", "ph", "slope", "precip_annual", "precip_may_sept", "temp_jan", "temp_jul", "temp_may_sept"];
      var abioticTitles = ["N Deposition (T-Dep)", "Aspect", "Depth to Bedrock", "% Clay in Soil", "% Coarse Sand", "Elevation", "Soil Permeability", "Soil pH", "Slope Gradient", "Precipitation (Annual)", "Precipitation (May-Sept)", "Temperature (Jan)", "Temperature (July)", "Temperature (May-Sept)"];
      var abioticLayers = [];
      var cropImg = {"top67": abioticID.slice(0), "top33":[]};
      cropImg.top67.splice(cropImg.top67.length,0,"cl_mins_min","cl_mins_max","cl_maxs_min","cl_maxs_max");

      abioticID.forEach(function(tmpID, i) {
        abioticLayers[i] = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
          layers: "CL:" + tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });

      //******Species Layers
      var speciesID = ["ab_ba", "ac_ru", "ac_sa", "be_al", "be_pa", "ca_de", "fa_gr", "fr_am", "fr_pe", "ju_ci", "pi_ma", "pi_ru", "pi_re", "pi_ri", "pi_st", "po_gr", "po_tr", "qu_al", "qu_pr", "qu_ru", "th_oc", "ts_ca", "ul_am"];
      var speciesTitles = ["Balsam Fir", "Red Maple", "Sugar Maple", "Yellow Birch", "Paper Birch", "American Chestnut", "American Beech", "White Ash", "Green Ash", "Butternut", "Black Spruce", "Red Spruce", "Red Pine", "Pitch Pine", "White Pine", "Bigtooth Aspen", "Quaking Aspen", "White Oak", "Chestnut Oak", "Red Oak", "Northern White Cedar", "Eastern Hemlock", "American Elm"];
      var speciesNames = ["Abies balsamea", "Acer rubrum", "Acer saccharum", "Betula alleghaniensis", "Betula papyrifera", "Castanea dentata", "Fagus grandifolia", "Fraxinus americana", "Fraxinus pennsylvanica", "Juglans cinerea", "Picea mariana", "Picea rubens", "Pinus resinosa", "Pinus rigida", "Pinus strobus", "Populus grandidentata", "Populus tremuloides", "Quercus alba", "Quercus prinus", "Quercus rubra", "Thuja occidentalis", "Tsuga canadensis", "Ulmus americana"];
      var speciesLayers = [];
      var speciesJSON = {"Abies balsamea":"Balsam Fir", "Acer rubrum":"Red Maple", "Acer saccharum":"Sugar Maple", "Betula alleghaniensis":"Yellow Birch", "Betula papyrifera":"Paper Birch", "Castanea dentata":"American Chestnut", "Fagus grandifolia":"American Beech", "Fraxinus americana":"White Ash", "Fraxinus pennsylvanica":"Green Ash", "Juglans cinerea":"Butternut", "Picea mariana":"Black Spruce", "Picea rubens":"Red Spruce", "Pinus resinosa":"Red Pine", "Pinus rigida":"Pitch Pine", "Pinus strobus":"White Pine", "Populus grandidentata":"Bigtooth Aspen", "Populus tremuloides":"Quaking Aspen", "Quercus alba":"White Oak", "Quercus prinus":"Chestnut Oak", "Quercus rubra":"Red Oak", "Thuja occidentalis":"Northern White Cedar", "Tsuga canadensis":"Eastern Hemlock", "Ulmus americana":"American Elm"};

      var layerExt = ["_cl_mins", "_exc_mins", "_exc_maxs", "_range"];
      var layerExtTitles = ["Critical Load", "Exceedance Min", "Exceedance Max", "Species Range"];

      speciesID.forEach(function(tmpID, i) {
        speciesLayers[i] = [];
        layerExt.forEach(function(tmpExt, j) {
          speciesLayers[i][j] = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
            layers: "CL:" + tmpID + tmpExt,
            format: 'image/png',
            transparent: true,
            version: '1.1.0',
            maxZoom: 20,
            zIndex: 1
          });
        });
      });

      //******Add Community Layers
      var commID = ["cl_mins_min", "cl_maxs_min", "cl_mins_max", "cl_maxs_max", "exc_cl_mins_min", "exc_cl_maxs_min", "exc_cl_mins_max", "exc_cl_maxs_max"]
      var commTitles = ["Most Protective CL", "Low Intermediate CL", "High Intermediate CL", "Least Protective CL", "EXC of Most Protective CL", "EXC of Low Intermediate CL", "EXC of High Intermediate CL", "EXC of Least Protective CL"];
      var commTooltip = ["Most protective Critical Load for most sensitive species (CL A)", "Critical Load at which at least one species is severely at risk (CL D)", "Most Protective CL for least sensitive species (CL C)", "Critical Load at which all species are severely at risk (CL B)", "Exceedance of most protective Critical Load for most sensitive species (EXC of CL A)", "Exceedance of Critical Load at which at least one species is severely at risk (EXC of CL D)", "Exceedance of most protective Critical Load for least sensitive species (EXC of CL C)", "Exceedance of Critical Load at which all species are severely at risk (EXC of CL B)"];
      //var commID = ["cl_mins_min", "cl_mins_max", "cl_maxs_min", "cl_maxs_max", "exc_cl_mins_min", "exc_cl_mins_max", "exc_cl_maxs_min", "exc_cl_maxs_max"]
      //var commTitles = ["Min CL (lower range)", "Max CL (lower range)", "Min CL (upper range)", "Max CL (upper range)", "Exceedance A (min min)", "Exceedance B (max min)", "Exceedance D (min max)", "Exceedance C (max max)"];
      var commLayers = [];

      commID.forEach(function(tmpID, i) {
        commLayers[i] = L.tileLayer.wms("http://felek.cns.umass.edu:8080/geoserver/CL/wms", {
          layers: "CL:" + tmpID,
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
          maxZoom: 20,
          zIndex: 1
        });
      });


      //******Add SVG Layers
      //******Area Select Layers
      var areaID = ["state", "eco", "eco2", "eco3", "fs_wild", "fs", "class1"];
      var areaTitles = ["States", "Ecoregions Combined", "Ecoregions Level 2", "Ecoregions Level 3", "Forest Service Wilderness Areas", "Forest Service Admin Areas", "Class I Areas"];
      var areaLayers = [];

      var topoSVG = d3.select(map.getPanes().overlayPane).append("svg");

      areaID.forEach(function(tmpID, i) {
        topoSVG.append("g").attr("class", "leaflet-zoom-hide").attr("id", tmpID + "G");
      });

      areaID.forEach(function(tmpID, i) {
        areaLayers[i] = d3.select("#" + tmpID + "G");
        areaLayers[i].onAdd = function(map) { addTopo(topos[tmpID]); };
        areaLayers[i].onRemove = function(map) { removeTopo(topos[tmpID]); };
      });


      //******Add topo layer to map
      function addTopo(topo) {
        var tmpFeats = topo.g.selectAll("." + topo.class)
            .data(topo.features)
          .enter().append("path")
            .attr("d", path)
            //.attr("id", function(d) { return d.id.split(" ").join("_"); })
            .attr("class", topo.class)
            .on("mouseenter", function() { 
              if(d3.select(this).style("opacity") > 0) {
                showIt(this.id);
                var tmpID = this.id;
                var tmpBi = 0;
                d3.select("#right_panel").selectAll("label")[0].some(function(d) {
                  if(d3.select(d).property("title") == tmpID) {
                    d3.select(d).style("color", "aqua");
                    tmpBi = 1;
                  }
                  return tmpBi == 1;
                });
              }
            })
            .on("mousemove", function() { tooltip.style("top", (d3.event.pageY-40) + "px").style("left", (d3.event.pageX+15) + "px"); resizePanels(); })
            .on("mouseleave", function() {
              tooltip.style("visibility", "hidden");
              var tmpID = this.id;
              var tmpBi = 0;
              d3.select("#right_panel").selectAll("label")[0].some(function(d) {
                if(d3.select(d).property("title") == tmpID) {
                  d3.select(d).style("color", "");
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });                              
            })
            .on("click", function(data) { 
              if (d3.select(this).style("stroke-opacity") == "1") {
                d3.select(this).style({"fill-opacity": "", "stroke-opacity": ""});
                d3.selectAll(".remCheck").property("checked", function() {if(this.value == data.id) {return false;} });
              } 
              else {
                d3.select(this).style({"fill-opacity": "0.5", "stroke-opacity": "1"});
                d3.selectAll(".remCheck").property("checked", function() {if(this.value == data.id) {return true;} });
              }
              get_spp();
            });
        changeStyle("id", topo);
        //filterMap("featureid", topo, true);
        //d3.select("#" + topo.class + "Legend").style("display", "block");
      }


      //******Remove topo layer from map
      function removeTopo(topo) {
        var tmpFeats = topo.g.selectAll("." + topo.class);
        tmpFeats.remove();
        //d3.select("#" + topo.class + "Legend").style("display", "none");
      }


      //******Add in top menu divs
      d3.select("#container")
        .append("div")
        .attr("id", "container-basics")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Overview</u></b></p>'
          + '<p style="font-size:16px">This tool is designed to synthesize information about nitrogen deposition, species sensitivity, site and current climate conditions into an easy-to-use, web-based geospatial tool (N-CLAS) to facilitate effective resource management across the northern forest region.</p><br>'
          + '<p style="font-size:16px">The N-CLAS tool allows land managers to determine critical loads (CL), quantify exceedance, and set targets for the purposes of land management and restoration. N-CLAS can be used to address questions about selected areas such as:</p>'
          + '<ul style="font-size:16px;">'
            + '<li>What proportion of my area is at risk from air pollution?</li>'
            + '<li>How does the sensitivity of my area compare with other locations?</li>'
            + '<li>What nitrogen deposition level would ensure protection of my forests?</li>'
            + '<li>Which species are the most sensitive?</li>'
          + '</ul><br>'
          + '<p style="font-size:16px">The interactive web interface provides maximum flexibility for the user to assess heterogeneous landscapes for specific areas and species of interest.  Outputs include downloadable maps, tables and figures summarizing critical loads and exceedance based on a range of customizable options, including output products that reflect the minimum CL value, range of CL values, or percent of the target area protected.</p><br>'
          + '<p style="font-size:16px">You can also download base layer maps of <span style="color:orange;font-weight:bold;cursor:pointer;" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>N Deposition</center></b></u></p><p>N Deposition (Total Dep)</p>">N deposition</span>, <span style="color:blue;font-weight:bold;cursor:pointer;" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Climate</center></b></u></p><p>Precipitation (Annual)<br>Precipitation (May-Sept)<br>Temperature (Jan)<br>Temperature (July)<br>Temperature (May-Sept)</p>">climate</span>, <span style="color:red;font-weight:bold;cursor:pointer;" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Soil</center></b></u></p><p>Bedrock Depth<br>Clay<br>Coarse<br>Permeability<br>pH</p>">soil</span>, and <span style="color:green;font-weight:bold;cursor:pointer;" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="<p><u><b><center>Topographic</center></b></u></p><p>Aspect<br>Elevation<br>Slope</p>">topographic</span> parameters.</p><br>'
          + '<p style=font-size:24px;"><b><u>How it Works</u></b></p>'
          + '<p style="font-size:16px">Nitrogen Critical Load Assessment by Site (N-CLAS) is a GIS-based tool designed for resource managers and policy makers to assess the effects of nitrogen deposition and climate change on forest ecosystems in the Northeastern United States.  N-CLAS uses geospatial data layers for key topographic, climactic, soil abiotic factors, and nitrogen deposition levels to predict whether growth at a site will be optimal or suboptimal for each of 23 significant tree species.  N-CLAS can then be used to assess critical loads and exceedance for individual species or summarized for all species combined  for user selected areas.</p><br>'
          + '<p style="font-size:16px"><i>Customize your output by setting your preferences for area unit (acres or hectares), and tree species name (Latin or common).</i><br></p>'
          + '<p style="font-size:16px;"><u><b>Step 1</b></u>: Select your target <span style="color:white;background:rgb(189,68,65);font-weight:bold;padding:2px;border:1px solid black;">Area</span></p>'
          + '<p style="font-size:16px;margin-left:30px">N-CLAS includes data aggregation by state, ecoregion, National Forest, National Park, and wilderness area classes. You can select one, or multiple areas for comparison within each class.</p><br>'
          + '<p style="font-size:16px;"><u><b>Step 2</b></u>: Select your <span style="color:white;background:rgb(118,147,60);font-weight:bold;padding:2px;border:1px solid black;">Species</span> of interest</p>'
          + '<p style="font-size:16px;margin-left:30px">A total of 23 tree species are included in the N-CLAS assessment. You may select a single species of interest, any combination of key species, or all species to better understand the forest as a whole.</p><br>'
          + '<p style="font-size:16px;"><u><b>Step 3</b></u>: Select your preferred <span style="color:white;background:rgb(54,96,146);font-weight:bold;padding:2px;border:1px solid black;">Output</span></p>'
          + '<p style="font-size:16px;margin-left:30px">Three levels of detail are provided for output maps, figures, and tables:</p>'
          + '<ul style="font-size:16px;margin-left:30px">'
            + '<li><b>Basic</b>: Summary figures and tables are limited to assessments for the <b>most protective critical load of most sensitive species</b>.<br></li>'
            + '<li><b>Tailored</b>: A set of screening questions about the key critical load and exceedance questions helps to guide the selection of the most informative output tables, figures, and maps.<br></li>'
            + '<li><b>Comprehensive</b>: All figures and tables. This selection will include outputs to address all range values of critical loads, and output data products.<br><br></li>'
            + '<li><i>You can preview example output and alter selected figures prior to running the analysis for all three levels.</i><br></li>'
          + '</ul><br>'
          + '<p style="font-size:16px;"><u><b>Step 4</b></u>: View your generated <span style="color:white;background:rgb(255,192,0);font-weight:bold;padding:2px;border:1px solid black;">Results</span></p>'
          + '<p style="font-size:16px;margin-left:30px">The results window allows users to explore a variety of graphs, tables, and figures generated according to their customized settings.<br><br></p>'


          + '<p style=font-size:24px;"><b><u>Outputs</u></b></p>'
          + '<p style="font-size:16px">The tool&#39;s output includes downloadable summary tables and figures as well as spatially explicit maps of CL and exceedance values across the landscape of interest.  Some outputs are designed to specifically address common questions  (see overview above), while others are designed to provide detailed comparisons across sites or species.</p><br>'
          + '<p style="font-size:16px">Various types of map products, data aggregation and summary statistics include:</p>'
          + '<ul style="font-size:16px;">'
            + '<li>Basic descriptive metrics for the area in exceedance and magnitude of exceedance for each species and area of interest</li>'
            + '<li>Cumulative frequency graphs to visualize the distribution of various CL and exceedance values across your selected landscape</li>'
            + '<li>Risk assessment (area protected or exceeded) at various deposition levels</li>'
            + '<li>High resolution maps of critical load and exceedance for individual species, as well as a summary of all species combined for a range  of CL thresholds</li>'
          + '</ul><br>'
          + '')
        .style({"display":"none", "background":"beige", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-approach")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Approach</u></b></p>'
          + '<p style="font-size:16px">N-CLAS is a GIS-based tool designed for resource managers to assess the effects of nitrogen deposition and quantify how its impact on forests varies based on species present, site and climate characteristics.</p><br>'
          + '<p style="font-size:16px">Current literature provides a range of critical load values for various forest species (cite reference). N-CLAS uses these critical load ranges reported in the literature and modifies values for individual species based on whether abiotic modifying factors at a given location are likely to contribute to optimal or suboptimal growth for that species. In N-CLAS, suboptimal growth conditions are expected to result in increased sensitivity to N deposition and are thus aligned with the bottom half of the critical loads range reported in the literature.  Optimal growth conditions are expected to result in increased N demand and higher N resilience, and are aligned with the upper half of the critical loads range reported in the literature.</p><br>'
          + '<p style="font-size:16px">The process by which N-CLAS modifies critical load values for each 30m pixel across the landscape includes identification of the species present, evaluation of abiotic modifying factors, weight of evidence for the relationship between growth and that factor and weight of influence for the effect of that factor. N-CLAS uses this information to adjust critical load values to the appropriate end of its range reported in the literature.</p><br>'
          + '<p style="font-size:16px">Modified critical load calculations are reported for each 30m x 30 m pixel across the landscape where a target species is present.  Critical loads can also be assessed for all tree species present in a given location and reported in a combined format highlighting the various CL thresholds (e.g. most or least sensitive species at that location, and most protective or least protective CL thresholds).</p><br>'
          + '<p style="font-size:16px">For more information about critical load ranges for each species or assessment of abiotic factors for modification of critical load estimates see <a href="https://www.fs.usda.gov/treesearch/pubs/55007" target="_blank">https://www.fs.usda.gov/treesearch/pubs/55007</a>.</p><br>'
          + '<p style="font-size:16px">For more information about the N-CLAS calculations, including weights of evidence and weights of influence see <a href="#">(link coming soon)</a>.</p><br>'
          + '')
        .style({"display":"none", "background":"beige", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-guide")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Instructions for Use</u></b></p>'
          + '<p style="font-size:16px;">This interactive web interface provides maximum flexibility for the user to assess heterogeneous landscapes. To get the most from the outputs of the N-CLAS tool and match user needs, there are several customization steps that must be completed before viewing outputs. This includes selecting your target areas of interest, which of the 23 forest species to include in the analyses, and the type of response variable, data aggregation and summary statistics to be reported in the output.  The N-CLAS tool walks users through each of these customization steps:</p><br>'
          + '<p style="font-size:16px;margin-left:30px"><u>Step 1</u>: Select your target <span style="color:white;background:rgb(189,68,65);font-weight:bold;padding:2px;border:1px solid black;">Area</span></p>'
          + '<p style="font-size:16px;margin-left:30px">N-CLAS includes data aggregation by state, ecoregions (levels 2 and 3), National Forest, National Park, and wilderness area classes. You can select one, or multiple areas for comparison within each class.</p><br>'
          + '<p style="font-size:16px;margin-left:30px"><u>Step 2</u>: Select your <span style="color:white;background:rgb(118,147,60);font-weight:bold;padding:2px;border:1px solid black;">Species</span> of interest</p>'
          + '<p style="font-size:16px;margin-left:30px">A total of 23 tree species are included in the N-CLAS assessment. You may select a single species of interest, any combination of key species, or all species to better understand the forest as a whole.</p><br>'
          + '<p style="font-size:16px;margin-left:30px"><u>Step 3</u>: Select your preferred <span style="color:white;background:rgb(54,96,146);font-weight:bold;padding:2px;border:1px solid black;">Output</span></p>'
          + '<p style="font-size:16px;margin-left:30px">Three levels of detail are provided for output maps, figures and tables:</p>'
          + '<ul style="font-size:16px;margin-left:30px">'
            + '<li><b>Basic</b>: Summary figures and tables are limited to assessments for the <b>most protective critical load of most sensitive species</b>.<br><i>This can be used as an efficient assessment of the maximum forest risk from nitrogen deposition.</i><br></li>'
            + '<li><b>Tailored</b>: A set of screening questions about the key research questions helps to guide the selection of informative output tables, figures and maps. Output products can be previewed to ensure that all required results are included, with the ability to remove unnecessary outputs or select additional outputs.<br><i>This may be the best option for many stakeholders to ensure the appropriate level of information without unnecessary outputs.</i><br></li>'
            + '<li><b>Comprehensive</b>: This selection will include outputs to address all ranges of values of critical loads, and output data products. Output products can be previewed to ensure that all required results are included, with the ability to remove unnecessary outputs.<br><i>This may be most useful for those who wish to have the complete set of information available to identify questions or issues that may not have been obvious prior to analysis (for "data mining").</i><br></li>'
          + '</ul><br>'
          + '<p style="font-size:16px;margin-left:30px"><u>Step 4</u>: View your generated <span style="color:white;background:rgb(255,192,0);font-weight:bold;padding:2px;border:1px solid black;">Results</span></p>'
          + '<p style="font-size:16px;margin-left:30px">The results window allows users to explore a variety of graphs, tables, and figures generated according to their customized settings.</p>'
          + '<p style="font-size:16px;margin-left:30px">These products are nested in the results window on the right side of the map interface. Select and expand various result tabs, hover for additional information on each output product, or click for a zoomed view.</p>'
          + '<p style="font-size:16px;margin-left:30px">All products are individually downloadable, and <span style="color:green;"><i>(coming soon)</i></span> can be used to generate a common report for all selected outputs.</p><br>'
          + '<p style="font-size:24px;"><b><u>Tips for New Users</u></b></p>'
          + '<ul style="font-size:16px;">'
            + '<li>When in doubt, <b>hover</b>. Hovering will generally open a brief description of the item of interest.<br></li>'
            + '<li>Many items in the web app contain an <b>info icon</b> (<span class="glyphicon glyphicon-info-sign" style="margin:0;cursor:pointer;" data-toggle="tooltip" data-container="body" data-placement="auto top" data-html="true" title="<p><u><b><center>Information</center></b></u></p><p>Hovering over these icons activates a pop-up containing information about the item.</p>"></span>). Hovering over these icons provides a summary of the function of each item.<br></li>'
            + '<li>The preferences tab will allow you to change the unit of area measurement to acres or hectares, and the tree species names to Latin or common for produced output.<br></li>'
            + '<li>Clicking on output products (tables or figures) in the results pane will enlarge those in the main viewer.<br></li>'
            + '<li>The main viewer can be expanded by collapsing the left and right side panels by clicking on the side arrows.<br></li>'
            + '<li>To clear settings select the refresh button (<span class="glyphicon glyphicon-refresh" style="margin:0;"></span>) in the upper right corner<br></li>'
          + '</ul><br>'
          + '')
        .style({"display":"none", "background":"beige", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-tutorial")
        .attr("class", "container-menu")
        .html(''
          + '<p style="font-size:24px;"><b><u>Tutorials (<span style="color:green;"><i>coming soon</i></span>)</u></b></p>'
          + '<ul style="font-size:16px;">'
            + '<li>N-CLAS starter - various intro buttons<br></li>'
            + '<li>Exploring abiotic factor map layers<br></li>'
            + '<li>User scenarios:<br></li>'
              + '<ul style="font-size:16px;">'
                + '<li>Basic<br></li>'
                + '<li>Example 2<br></li>'
                + '<li>Example 3<br></li>'
              + '</ul>'
            + '<li>Video guides and scenarios<br></li>'
         + '</ul><br>'
          + '')
        .style({"display":"none", "background":"beige", "padding":"30px"});

      d3.select("#container")
        .append("div")
        .attr("id", "container-results")
        //.attr("class", "container-menu")
        .html('<span id="results_glyph" class="glyphicon glyphicon-remove-circle pull-right" onclick="d3.select(\'#container-results\').style(\'display\', \'none\'); d3.selectAll(\'.canvasChart\').classed(\'selected\', false);" title="Click to close results window"></span><img id="resImg">');



      //******Add menu actions
      d3.select("#home").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#right_panel").style("display", "block");});
      d3.select("#basics").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#approach").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#guide").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#tutorial").on("click", function() {d3.select("#mainMenu").selectAll("li").classed("active", false); d3.select(this).classed("active", true); d3.selectAll(".container-menu").style("display", "none"); d3.select("#container-" + this.id).style("display", "block"); d3.select("#right_panel").style("display", "none");});
      d3.select("#preferences").on("click", function() {toolWindowToggle("preferences");});
      d3.select("#welcome").on("click", function() {d3.select("#splashScreen").style("display", "flex");});









      //******Make splash screen
      d3.select("body")
        .append("div")
        .attr("id","splashScreen")
        .attr("class", "msgBackgroundDiv")
        .append("div")
        .attr("id", "splashScreenDiv")
        .append("p")
        .attr("id", "splashWelcome")
        .html('Welcome to the <span style="color:#b3d9ff;font-size:41px;text-shadow:1px 2px black;">N-CLAS</span> tool');

      d3.select("#splashScreenDiv")
        .append("img")
        .attr("src", "images/N-CLAS.png")
        .property("title", "Image showing critical loads of nitrogen deposition for tree communitites across the northeast United States")
        .style({"height":"200px","display":"inline-block","float":"left","border":"1px solid #333333","border-radius":"4px","margin-top":"15px"});

      d3.select("#splashScreenDiv")
        .append("p")
        .html('This tool is designed to calculate critical loads and exceedances for N deposition to forests in the northeastern US. It provides high resolution outputs (maps, graphs, and tables) for multiple areas and accounts for the influence of site, climate, and topographic conditions on 23 key tree species in the region. N-CLAS facilitates assessment of risk to forest ecosystems for resource managers and policy makers.')
        .style({"font-size":"24px","margin":"10px 0px 20px 5px","text-align":"left","display":"inline-block","width":"70%"}); 

      d3.select("#splashScreenDiv")
        .append("p")
        .html('<u><b>Getting Started</b></u>')
        .style({"font-size":"22px","margin":"0px 10px","text-align":"center"});

      d3.select("#splashScreenDiv")
        .append("p")
        .html('<u>Step 1</u>: Select your target <span style="color:white;background:rgb(189,68,65);font-weight:bold;padding:2px;border:1px solid black;">Area</span>')
        .style({"font-size":"18px","margin":"5px 10px","text-align":"left"});

      d3.select("#splashScreenDiv")
        .append("p")
        .html('<u>Step 2</u>: Select your <span style="color:white;background:rgb(118,147,60);font-weight:bold;padding:2px;border:1px solid black;">Species</span> of interest')
        .style({"font-size":"18px","margin":"5px 10px","text-align":"left"});

      d3.select("#splashScreenDiv")
        .append("p")
        .html('<u>Step 3</u>: Select your preferred <span style="color:white;background:rgb(54,96,146);font-weight:bold;padding:2px;border:1px solid black;">Output</span>')
        .style({"font-size":"18px","margin":"5px 10px","text-align":"left"});

      d3.select("#splashScreenDiv")
        .append("div")
        .style({"margin-left":"115px","text-align":"left","font-size":"18px"})
        .html('<p style="margin:5px 10px">-  Basic: Summary figures and tables for most protective critical load of most sensitive species</p><p style="margin:5px 10px">-  Tailored: Answers to screening questions determines appropriate output</p><p style="margin:5px 10px">-  Comprehensive: All figures and tables</p>');

      d3.select("#splashScreenDiv")
        .append("p")
        .html('<u>Step 4</u>: View your generated <span style="color:white;background:rgb(255,192,0);font-weight:bold;padding:2px;border:1px solid black;">Results</span>')
        .style({"font-size":"18px","margin":"5px 10px","text-align":"left"});

      d3.select("#splashScreenDiv")
        .append("div")
        .style({"margin-left":"115px","text-align":"left","font-size":"18px"})
        .html('<p style="margin:5px 10px">-  Explore graph, table, and map output</p><p style="margin:5px 10px">-  Download individual outputs</p><p style="margin:5px 10px">-  Create a report containing all generated output <span style="color:green">(<i>Coming soon</i>)</span></p>');

      d3.select("#splashScreenDiv")
        .append("button")
        .attr("id", "splashButton")
        .attr("class", "btn legendBtn")
        .property("title", "Click to continue to N-CLAS tool")
        .text("Continue...")
        .on("click", function() { 
          d3.select("#splashScreen").style("display", "none");
          localStorage.setItem('disableSplash', d3.select("#disableSplash").property("checked"));
          //if(localStorage.getItem('doneTour') != "yeah!" && disableTutorialSession != true) {
          //  startIntro();
          //}
          //else {
          //  $('#attrSelectModal').modal('show');
          //}
        });
          

      d3.select("#splashScreenDiv")
        .append("div")
        .style({"margin":"10px","float":"right","position":"relative","top":"30px"})
        .append("label")
        .property("title", "Check box to prevent this screen from displaying on future website visits")
        .html('<input type="checkbox" id="disableSplash" style="transform:scale(1.3);margin-right:10px;position:relative;top:3px;">Check to prevent this screen from displaying again</input>');



 







     //******Make layer controller
      //***baselayers
      var layerNames = {};
      layerNames.baseLayers = {"Google Terrain": googleTerrain, "Google Hybrid": googleHybrid, "Google Satellite": googleSatellite, "Google Street": googleStreet, "Bing Hybrid": bingHybrid, "Bing Satellite": bingSatellite, "Bing Street": bingStreet, "USGS Topo": usgsTopo, "State Outlines": states, "None": blank};
      layerNames.baseLayers.keys = d3.keys(layerNames.baseLayers);
      layerNames.baseLayers.values = d3.values(layerNames.baseLayers);

      //***Abiotic layers
      layerNames.abiotics = {};
      abioticTitles.forEach(function(tmpTitle,i) {
        layerNames.abiotics[tmpTitle] = abioticLayers[i];
      });
      layerNames.abiotics.keys = d3.keys(layerNames.abiotics);
      layerNames.abiotics.values = d3.values(layerNames.abiotics);

      //***Area layers
      layerNames.areas = {};
      areaTitles.forEach(function(tmpTitle,i) {
        layerNames.areas[tmpTitle] = areaLayers[i];
      });
      layerNames.areas.keys = d3.keys(layerNames.areas);
      layerNames.areas.values = d3.values(layerNames.areas);
      //***FS Wilderness that are Class 1
      layerNames.areas.fs_wild_class1 = ["Boundary Waters Canoe Area Wilderness", "Great Gulf Wilderness", "Lye Brook Wilderness", "Presidential Range-Dry River Wilderness", "Rainbow Lake Wilderness"];

      //***Species layers
      layerNames.species = {};
      speciesID.forEach(function(tmpTitle,i) {
        layerNames.species[tmpTitle] = {}
        layerExt.forEach(function(tmpExt,j) {
          layerNames.species[tmpTitle][tmpExt] = speciesLayers[i][j];
        });
      });
      layerNames.species.keys = d3.keys(layerNames.species); 
      layerNames.species.values = d3.values(layerNames.species);
      layerNames.species.keys.forEach(function(key) {
        layerNames.species[key].keys = d3.keys(layerNames.species[key]);
        layerNames.species[key].values = d3.values(layerNames.species[key]);
      });

      //***Community layers
      layerNames.community = {};
      commTitles.forEach(function(tmpTitle,i) {
        layerNames.community[tmpTitle] = commLayers[i];
      });
      layerNames.community.keys = d3.keys(layerNames.community);
      layerNames.community.values = d3.values(layerNames.community);
      
      






      //******Add toolbar tools
      //***Baselayers
      d3.select("#toolbar")
        .append("div")
        .attr("id", "mapTools")
        .append("div")
        .attr("id", "baselayerSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "baselayerList")
        .attr("class", "cl_select")
        .property("title", "Click to change map baselayer")
        .html('<span id="baselayerListHeader">Change Map Baselayer</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#baselayerListDropdown").style("display") == "none") {d3.select("#baselayerListDropdown").style("display", "inline-block");} else {d3.select("#baselayerListDropdown").style("display", "none");} });;

      d3.select("#baselayerSelect")
        .append("div")
        .attr("id", "baselayerListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add baselayer options
      d3.select("#baselayerListDropdown").selectAll("div")
        .data(layerNames.baseLayers.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeBaselayer(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeOverlay")
          .style("visibility", function(d,i) { if(i == 8) {return "visible";} else {return "hidden";} });


      //******Initialize baselayer
      map.addLayer(states);
      var oldBaseLayerIndex = 8;



      //******Function to change baselayer on select change
      function changeBaselayer(tmpDiv) {
        //***Remove old layer
        var layerDivs = d3.select("#baselayerListDropdown").selectAll("div");
        
        layerDivs[0].forEach(function(tmpLayer) {
          if(d3.select(tmpLayer).select("span").style("visibility") == "visible") {
            d3.select(tmpLayer).select("span").style("visibility", "hidden");
            map.removeLayer(layerNames.baseLayers.values[d3.select(tmpLayer).property("value")]);
          }
        });

        //***Add new layer
        d3.select(tmpDiv).select("span").style("visibility", "visible");
        map.addLayer(layerNames.baseLayers.values[tmpDiv.value]);
        layerNames.baseLayers.values[tmpDiv.value].bringToBack();       
      }






      //***Abiotic layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "abioticSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "abioticList")
        .attr("class", "cl_select")
        .property("title", "Click to select abiotic layers to display on map")
        .html('<span id="abioticListHeader">View Abiotic Map Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#abioticListDropdown").style("display") == "none") {d3.select("#abioticListDropdown").style("display", "inline-block");} else {d3.select("#abioticListDropdown").style("display", "none");} });;

      d3.select("#abioticSelect")
        .append("div")
        .attr("id", "abioticListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add abiotic options
      d3.select("#abioticListDropdown").selectAll("div")
        .data(layerNames.abiotics.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .property("name", function(d,i) { return abioticID[i]; })
          .on("click", function() { changeAbiotic(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeAbiotic")
          .style("visibility", function(d) { if(d == "Deerfield Watershed") {return "visible";} else {return "hidden";} });

      //******Add Geoserver Deerfield HUC8 layer to map
      //map.addLayer(gsHuc8);

      //******Function to add/remove abiotic layer
      function changeAbiotic(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          map.addLayer(layerNames.abiotics.values[tmpDiv.value]);
          layerNames.abiotics.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.abiotics.values[tmpDiv.value], ["abiotics",tmpDiv.title]);
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
          map.removeLayer(layerNames.abiotics.values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
      }






      //***Species layers
      d3.select("#mapTools")
        .append("div")
        .attr("id", "speciesSelect")
        .attr("class", "layerList")
        .append("div")
        .attr("id", "speciesList")
        .attr("class", "cl_select")
        .property("title", "Click to select species layers to display on map")
        .html('<span id="speciesListHeader">View CL & Exceedance Map Layers</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { if(d3.select("#speciesListDropdown").style("display") == "none") {d3.select("#speciesListDropdown").style("display", "inline-block");} else {d3.select("#speciesListDropdown").style("display", "none");} });;

      d3.select("#speciesSelect")
        .append("div")
        .attr("id", "speciesListDropdown")
        .attr("class", "layerListDropdown")
        .on("mouseleave", function() { d3.select(this).style("display", "none") })
        .on("dblclick", function() { event.stopPropagation(); })
        .on("wheel", function() { event.stopPropagation(); })
        .on("mousemove", function() { event.stopPropagation(); })
        .append("div")
        .attr("id", "indSppDiv")
        .attr("class", "collapse in");

      //******Add species options
      d3.select("#indSppDiv").selectAll("div")
        .data(layerNames.species.keys)
        .enter()
          .append("div")
          .html(function(d,i) { return '<div class="indSpp" value="' + i + '" name="' + d + '" title="' + speciesTitles[i] + " (" + speciesNames[i] + ")" + '" data-toggle="collapse" data-target="#' + d + 'Suboptions">' + speciesTitles[i] + '<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="' + d + 'Suboptions" value="' + i + '" name="' + d + '"></div>'; });

      //***Add species layer suboptions
      d3.selectAll(".sppSuboptDiv")[0].forEach(function(tmpDiv,i) {
        d3.select(tmpDiv).selectAll("div")
          .data(layerNames.species[d3.select(tmpDiv).attr("name")].keys)
          .enter()
            .append("div")
            .attr("class", "sppSubopt")
            .text(function(d,i) { return layerExtTitles[i]; })
            .property("value", function(d,i) { return i; })
            .property("name", function(d,i) { return d3.select(tmpDiv).attr("name") + layerExt[i]; }) 
            .property("title", function(d,i) { return speciesTitles[d3.select(tmpDiv).attr("value")] + " " + layerExtTitles[i]; })
            .on("click", function(d,i) { changeSpecies(this, d3.select(tmpDiv).attr("name"), layerExt[i]); })
            .append("span")
            .attr("class", "glyphicon glyphicon-ok pull-right")
            .style("visibility", "hidden");
      });

      //******Function to add/remove species layer
      function changeSpecies(tmpDiv, spp, filePart) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          if(d3.select(tmpDiv.parentNode).attr("id") == spp + "Suboptions") {
            if(document.getElementById(spp + "SuboptionsMap")) {
              d3.select(d3.select("#" + spp + "SuboptionsMap").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "visible");
            }
          }
          else {
            d3.select(d3.select("#" + spp + "Suboptions").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "visible");
          }
          map.addLayer(layerNames.species[spp].values[tmpDiv.value]);
          layerNames.species[spp].values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, tmpDiv.title, layerNames.species[spp].values[tmpDiv.value], ["species",spp,filePart]);
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
          if(d3.select(tmpDiv.parentNode).attr("id") == spp + "Suboptions") {
            if(document.getElementById(spp + "SuboptionsMap")) {
              d3.select(d3.select("#" + spp + "SuboptionsMap").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "hidden");
            }
          }
          else {
            d3.select(d3.select("#" + spp + "Suboptions").selectAll(".sppSubopt")[0][layerExt.indexOf(filePart)]).select("span").style("visibility", "hidden");
          }
          map.removeLayer(layerNames.species[spp].values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
      }




      //******Add combined species option and suboptions
      d3.select("#speciesListDropdown")
        .insert("div", ":first-child")
        .style("border-top", "2px solid #666666")
        .html('<div class="layerName" title="Individual Species" data-toggle="collapse" data-target="#indSppDiv">Individual Species<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="indSppSuboptions" name="indSpp"></div>');

      d3.select("#speciesListDropdown")
        .insert("div", ":first-child")
        .html('<div class="layerName" name="all" title="Combined Species" data-toggle="collapse" data-target="#allSuboptions">Combined Species<span class="glyphicon glyphicon-triangle-bottom pull-right activeSpecies"></span></div><div class="sppSuboptDiv collapse" id="allSuboptions" name="all"></div>');

      d3.select("#allSuboptions").selectAll("div")
        .data(layerNames.community.keys)
        .enter()
          .append("div")
          .attr("class", "sppSubopt")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("name", function(d,i) { return commID[i]; })
          .property("title", function(d,i) { return commTooltip[i]; })
          .on("click", function() { changeCommunity(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right")
          .style("visibility", "hidden");

      d3.select("#allSuboptions")
        .insert("div", ":nth-child(5)")
        .attr("class", "commTitle")
        .text("Exceedance")
        .property("title", "Exceedance (Exc) layers");

      d3.select("#allSuboptions")
        .insert("div", ":first-child")
        .attr("class", "commTitle")
        .text("Critical Load")
        .property("title", "Critical Load (CL) layers");


      //******Function to add/remove area layer
      function changeCommunity(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "hidden") {
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          if(d3.select(tmpDiv.parentNode).attr("id") == "allSuboptions") {
            if(document.getElementById("allSuboptionsMap")) {
              d3.select(d3.select("#allSuboptionsMap").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "visible");
            }
          }
          else {
            d3.select(d3.select("#allSuboptions").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "visible");
          }
          map.addLayer(layerNames.community.values[tmpDiv.value]);
          layerNames.community.values[tmpDiv.value].bringToFront();
          addLegendImg(tmpDiv.name, d3.select(tmpDiv).text(), layerNames.community.values[tmpDiv.value], ["community", d3.select(tmpDiv).text()]);
        } 
        else {
          d3.select(tmpDiv).select("span").style("visibility", "hidden");
          if(d3.select(tmpDiv.parentNode).attr("id") == "allSuboptions") {
            if(document.getElementById("allSuboptionsMap")) {
              d3.select(d3.select("#allSuboptionsMap").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "hidden");
            }
          }
          else {
            d3.select(d3.select("#allSuboptions").selectAll(".sppSubopt")[0][tmpDiv.value]).select("span").style("visibility", "hidden");
          }
          map.removeLayer(layerNames.community.values[tmpDiv.value]);
          remLegendImg(tmpDiv.name);
        }
      }






      //******Adds images to the legend
      function addLegendImg(tmpName, tmpTitle, tmpLayer, tmpPath) {
        tmpLayer.setOpacity(1);

        legendDivs.push(tmpName);
        d3.selectAll(".layerLegend").style("display", "none");

        d3.select("#legendImgDiv")
          .append("div")
          .attr("id", tmpName + "Legend")
          .attr("value", tmpPath)
          .attr("class", "layerLegend")
          .style({"margin-top":"25px","opacity":"0"})
          .append("h3")
          .attr("class", "legendTitle")
          .text(tmpTitle);

        d3.select("#" + tmpName + "Legend")
          .append("div")
          .attr("id", tmpName + "LegImgDiv")
          .attr("class","legImgDiv")
          .append("img")
          .attr("id", tmpName + "LegendImg")
          .attr("class", "legendImg")
          //.attr("src", "http://felek.cns.umass.edu:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=CL:" + tmpName)
          .property("title", tmpTitle);

        //***Set div width and offset after the image has been loaded
        $("#" + tmpName + "LegendImg").one("load", function() {
          var tmpRect = document.getElementById(tmpName + "LegendImg").getBoundingClientRect();

          if(cropImg.top67.indexOf(tmpName) > -1) {
            d3.select("#" + tmpName + "LegImgDiv").style({"max-height":tmpRect.height - 67 + "px", "max-width": tmpRect.width + "px"});
            d3.select("#" + tmpName + "LegendImg").style("top", "-69px");
          }
          else if(!tmpName.includes("range")) {
            d3.select("#" + tmpName + "LegImgDiv").style({"max-height":tmpRect.height - 33 + "px", "max-width": tmpRect.width + "px"});
            d3.select("#" + tmpName + "LegendImg").style("top", "-33px");
          }
          else {
            d3.select("#" + tmpName + "LegImgDiv").style({"max-width": tmpRect.width + "px"});
          }                   
          d3.select("#" + tmpName + "Legend").style("opacity", "1"); 
    
          resizePanels();
        }).attr("src", "http://felek.cns.umass.edu:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=30&LAYER=CL:" + tmpName);

        d3.select("#" + tmpName + "Legend")
          .append("input")
          .attr({type: "range", name: "layer", min: 0, max: 100, value: 100})
          .attr("id", tmpName + "LegendSlider")
          .property("title", tmpTitle + " Layer Opacity: 100%")
          .on("input", function() { layerOpacity(this, tmpLayer); });

        d3.select("#" + tmpName + "Legend")
          .append("p")
          .attr("class", "legendTrans")
          .text("Transparency");

        d3.select("#legendDefault").style("display", "none");

        d3.select("#legendImgDiv")
          .style("display", "block");
       
        if(legendDivs.length > 1) {
          d3.select("#legendPrev").style("visibility", "visible");
          d3.select("#legendNext").style("visibility", "hidden");
        }

        if(d3.select("#legendDiv").style("opacity") == 0) {
          toolWindowToggle("legend");
        }
      }







      //******Removes images to the legend
      function remLegendImg(tmpName) {
        var tmpBi = 0;
        if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
          tmpBi = 1;
        }

        d3.select("#" + tmpName + "Legend").remove();
        legendDivs.splice(legendDivs.indexOf(tmpName),1);

        //***If removing active legend display the first legend
        if(tmpBi == 1 && legendDivs.length > 0) {
          d3.select("#" + legendDivs[0] + "Legend").style("display", "block");
          var keys = d3.select("#" + legendDivs[0] + "Legend").attr("value").split(",");
          if(keys.length == 2) {
            layerNames[keys[0]][keys[1]].bringToFront();
          }
          else {
            layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
          }
        }

        //***Set div and arrow visibility based on number of legends left
        if(legendDivs.length == 0) {
          d3.select("#legendImgDiv").style("display", "none");
          d3.select("#legendDefault").style("display", "block");
        }
        else if(legendDivs.length == 1) {
          d3.selectAll("#legendPrev,#legendNext").style("visibility", "hidden");
        }
        else if(legendDivs.length == 2) {
          if(d3.select("#" + legendDivs[0] + "Legend").style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "hidden");
            d3.select("#legendNext").style("visibility", "visible");
          }
          else {
            d3.select("#legendPrev").style("visibility", "visible");
            d3.select("#legendNext").style("visibility", "hidden");
          }
        }
        else {
          var tmpLegends = d3.selectAll(".layerLegend")[0];
          if(d3.select(tmpLegends[0]).style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "hidden");
            d3.select("#legendNext").style("visibility", "visible");
          }
          else if(d3.select(tmpLegends[tmpLegends.length - 1]).style("display") == "block") {
            d3.select("#legendPrev").style("visibility", "visible");
            d3.select("#legendNext").style("visibility", "hidden");
          }
          else {            
            d3.selectAll("#legendPrev,#legendNext").style("visibility", "visible");
          }
        }          
      }







      //******Change current legend div
      function changeLegend(tmpDir) {
        var tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            d3.selectAll(".layerLegend").style("display", "none");
            if(tmpDir == "prev") {
              d3.select("#" + legendDivs[i-1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i-1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
            else {
              d3.select("#" + legendDivs[i+1] + "Legend").style("display", "block");
                var keys = d3.select("#" + legendDivs[i+1] + "Legend").attr("value").split(",");
                if(keys.length == 2) {
                  layerNames[keys[0]][keys[1]].bringToFront();
                }
                else {
                  layerNames[keys[0]][keys[1]][keys[2]].bringToFront();
                }
            }
          }
          return tmpBi == 1;
        });

        tmpBi = 0;
        legendDivs.some(function(tmpName,i) {
          if(d3.select("#" + tmpName + "Legend").style("display") == "block") {
            tmpBi = 1;
            if(i == 0) {
              d3.select("#legendPrev").style("visibility", "hidden");
              d3.select("#legendNext").style("visibility", "visible");
            }
            else if(i == (legendDivs.length - 1)) {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "hidden");
            }
            else {
              d3.select("#legendPrev").style("visibility", "visible");
              d3.select("#legendNext").style("visibility", "visible");
            }
          }
          return tmpBi == 1;
        });              
      }
        






      //******Add geolocater
      d3.select("#toolbar")
        .append("div")
        .attr("id", "bingGeoLocate");
        //.attr("class", "layerList");

      document.getElementById('bingGeoLocate').appendChild(bingGeocoder.onAdd(map));
      d3.select("#bingGeocoderInput")
        .on("mouseup", function() { if(this.value == "No matching results") { this.value = ""; } else { $(this).select(); } })
        .on("blur", function() { modifySearch(this, "blur"); })
        .on("keyup", function() { modifySearch(this, "key"); }); // if(d3.event.keyCode == 13) { if(d3.select("#bingGeocoderSubmit").classed("glyphicon-remove") == true) { $("#bingGeocoderSubmit").click(); } } });



      function modifySearch(tmpEl, tmpEvent) {
        if(tmpEvent == "blur") {
          if((tmpEl.value == "" || tmpEl.value == "No matching results") && document.getElementById("mapIcon")) { 
            tmpEl.value = d3.select("#mapIcon").attr("value"); 
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
          else if(tmpEl.value == "No matching results" && !document.getElementById("mapIcon")) {
            tmpEl.value = "";
          }
        } 
        else if(document.getElementById("mapIcon")) {
          if(tmpEl.value != d3.select("#mapIcon").attr("value")) {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", false).classed("glyphicon-search", true);
          }
          else {
            d3.select("#bingGeocoderSubmit").classed("glyphicon-remove", true).classed("glyphicon-search", false);
          }
        }
      }



      //******Make div for legend
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "legendDiv");

      $('#legendDiv').draggable({containment: "html", cancel: ".toggle-group,input,textarea,button,select,option"});

      d3.select("#legendDiv")
        .append("h4")
        .text("Legend")
        .attr("class", "legTitle")
        .attr("id", "legendTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Legend</center></b></u></p><p>Displays legends for added map layers enabling their interpretation along with control over their transparency.</p>"</span>');
 
      d3.select("#legendTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Layers window")
        .on("click", function() { toolWindowToggle("legend"); });

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendDefault")
        .text("Add a map layer to view its legend...");

      d3.select("#legendDiv")
        .append("div")
        .attr("id", "legendImgDiv")
        .html('<span id="legendPrev" class="glyphicon glyphicon-menu-left pull-left" title="View previous legend" onclick="changeLegend(\'prev\')"></span><span id="legendNext" class="glyphicon glyphicon-menu-right pull-right" title="View next legend" onclick="changeLegend(\'next\')"></span>');





      //******Change transparency of current legend layer
      function layerOpacity(tmpSlider, tmpLayer) {
        var tmpOpacity = tmpSlider.value/100; 
        tmpSlider.title = "Opacity: " + tmpSlider.value + "%"; 
        tmpLayer.setOpacity(tmpOpacity);
      } 







      //*****Make div for preferences
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "preferencesDiv");

      $('#preferencesDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#preferencesDiv")
        .append("h4")
        .text("Preferences")
        .attr("class", "legTitle")
        .attr("id", "preferencesTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Preferences</center></b></u></p><p>Set preferences for whether or not to display the boundary of the target ecoregions on the map, and for area measurement unit and species naming convention for output figures and tables.</p>"></span>');
 
      d3.select("#preferencesTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Preferences window")
        .on("click", function() { toolWindowToggle("preferences"); });

      d3.select("#preferencesDiv")
        .append("div")
        .attr("id", "preferencesOptions")
        .append("div")
        .html('<div id="prefOptDivDisplay" class="prefOptDiv" style="margin-bottom:20px">'
          + '<p>Show boundary of target ecoregions on map:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outDisplayShow" value="show" class="prefCheck" name="outDisplay"><span>Show</span></label><label><input type="radio" id="outDisplayHide" value="hide" class="prefCheck" name="outDisplay" checked><span>Hide</span></label>'
          + '</div><div id="prefOptDivUnit" class="prefOptDiv" style="margin-bottom:20px">'
          + '<p>Preferred units for area measurements:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outUnitAcres" value="acres" class="prefCheck" name="outUnit" checked><span>Acres</span></label><label><input type="radio" id="outUnitHectares" value="hectares" class="prefCheck" name="outUnit"><span>Hectares</span></label>'
          + '</div><div id="prefOptDivName" class="prefOptDiv">'
          + '<p>Preferred naming convention for species titles:</p>' //<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outSpeciesLatin" value="latin" class="prefCheck" name="outSpecies" checked><span>Latin Names</span></label><label><input type="radio" id="outSpeciesCommon" value="common" class="prefCheck" name="outSpecies"><span>Common Names</span></label>'
          + '</div>'
          + '<div id="showPrefDiv" style="margin-top:30px;text-align:center;"><label style="font-weight:normal;margin-left:0;" title="Checking this option will prevent this window from automatically displaying on page load"><input type="checkbox" id="showPrefCheck" style="position:relative;top:2px;"></input><span>Check to hide this window on page load</span></label></div>'
        );

      d3.select("#showPrefCheck")
        .property("checked", function() { if(localStorage.getItem("showPref") == "true") { return true; } })
        .on("click", function() { localStorage.setItem('showPref', d3.select(this).property("checked")); });

      d3.select("#prefOptDivDisplay").selectAll("input")
        .on("change", function() { localStorage.setItem('outDisplay', document.querySelector('input[name=outDisplay]:checked').value); if(document.querySelector('input[name=outDisplay]:checked').value == "show") {map.addLayer(studyRegion);} else {map.removeLayer(studyRegion);} })
        .property("checked", function() { if(this.value == "show") { if(localStorage.getItem('outDisplay') == "show") {map.addLayer(studyRegion); return true; }} });

      d3.select("#prefOptDivUnit").selectAll("input")
        .on("change", function() { localStorage.setItem('outUnit', document.querySelector('input[name=outUnit]:checked').value); outUnit = document.querySelector('input[name=outUnit]:checked').value; if(d3.select("#outputQuestions").style("display") == "block") {refineHTML();} if(d3.select("#outputPreview").style("display") == "block") {addThumbs();} })
        .property("checked", function() { if(this.value == "hectares") { if(localStorage.getItem('outUnit') == "hectares") {return true;}} });

      d3.select("#prefOptDivName").selectAll("input")
        .on("change", function() {outSpecies = document.querySelector('input[name=outSpecies]:checked').value; localStorage.setItem('outSpecies', document.querySelector('input[name=outSpecies]:checked').value); })
        .property("checked", function() { if(this.value == "common") { if(localStorage.getItem('outSpecies') == "common") {return true;}}; outSpecies = document.querySelector('input[name=outSpecies]:checked').value });

      var outUnit = document.querySelector('input[name=outUnit]:checked').value;
      var outSpecies = document.querySelector('input[name=outSpecies]:checked').value;







      //*****Make div for downloads
      d3.select("body")
        .append("div")
        .attr("class", "legend gradDown")
        .attr("id", "downloadDiv");

      $('#downloadDiv').draggable({containment: "html", cancel: "input,label,textarea,button,select,option"});

      d3.select("#downloadDiv")
        .append("h4")
        .text("Downloads")
        .attr("class", "legTitle")
        .attr("id", "downloadTitle")
        .append("span")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Downloads</center></b></u></p><p>Download zip files containing GeoTIFFs for Abiotic and Species layers, shapefiles for Area layers, and CSV files for CL, EXC, and Abiotic regional data.</p>"></span>');
 
      d3.select("#downloadTitle")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button")
        .property("title", "Click to hide Downloads window")
        .on("click", function() { toolWindowToggle("download"); });

      d3.select("#downloadDiv")
        .append("div")
        .attr("id", "downloadOptions")
        .append("div")
        .style("height", "123px")
        .html('<select id="downloadCat" class="downloadSelect"></select><select id="downloadSpecies" class="downloadSelect"></select><select id="downloadLayer" class="downloadSelect"></select>');

      d3.select("#downloadOptions")
        .append("div")
        .attr("id", "downloadButton")
        .attr("class", "cl_select disabled")
        .style({"margin":"10px", "width":"calc(100% - 20px)", "padding":"0px"})
        .property("title", "Click to download selected layer")
        .html('<a id="dlLink" href="#"><span> Download Layer </span></a>');

      var dlCat = ["Select category...", "Abiotic Layers", "Area Layers", "Combined Species Layers", "Individual Species Layers", "CL, EXC, & Abiotic Data"];
      d3.select("#downloadCat")
        .property("title", "Select the category containing the layer you wish to download")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  
          d3.select(this).style("font-style", "normal");
          if(d3.select("#downloadCat").property("selectedOptions")[0].value  == "Individual Species Layers") {
            d3.select("#downloadSpecies").style("display", "inline-block");
            d3.select("#downloadLayer").style("display", "none");
             d3.select("#downloadButton").classed("disabled", true);
          }
          else {
            d3.select("#downloadSpecies").style("display", "none");
            dlLoadLayers(d3.select("#downloadCat").property("selectedOptions")[0].value);
          }
        })
        .selectAll("options")
        .data(dlCat)
        .enter()
          .append("option")
          .attr("value", function(d,i) { return d; })
          .property("disabled", function(d, i) { if(i == 0) {return "disabled";} }) 
          .property("title", function(d) { return d; })
          .text(function(d) { return d; });



      d3.select("#downloadSpecies")
        .property("title", "Select the species containing the layer you wish to download")
        .style("display", "none")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  d3.select(this).style("font-style", "normal"); dlLoadLayers("Individual Species Layers"); });

      d3.select("#downloadSpecies").selectAll("option")
        .data(layerNames.species.keys)
        .enter()
          .append("option")
          .attr("value", function(d,i) { return d; })
          .property("title", function(d,i) { return speciesTitles[i] + " (" + speciesNames[i] + ")"; })
          .text(function(d,i) { return speciesTitles[i]; });

        d3.select("#downloadSpecies")
          .style("font-style", "")
          .insert("option", ":first-child")
          .property("disabled", true)
          .text("Select species...");

        d3.select("#downloadSpecies")
          .property("selectedIndex", 0);


        

      d3.select("#downloadLayer")
        .property("title", "Select the layer you wish to download")
        .style("display", "none")
        .on("mousedown", function() {  d3.select(this).select("option").style("display", "none"); })
        .on("change", function() {  
          d3.select(this).style("font-style", "normal"); 
          d3.select("#downloadButton").classed("disabled", false);
          d3.select("#dlLink").attr("href", function() { return set_dl_link(); });
        })
        .append("option")
        .property("disabled", true)
        .text("Select layer...");




      //******Function to load layer names in download select
      function dlLoadLayers(tmpCat) {
        switch (tmpCat) {
          case "Abiotic Layers":
            var tmpData = layerNames.abiotics.keys;
            var tmpVals = abioticID;
            break;
          case "Area Layers":
            var tmpData = layerNames.areas.keys;
            var tmpVals = areaID;
            break;
          case "Combined Species Layers":
            var tmpData = layerNames.community.keys;
            var tmpVals = commID;
            break;
          case "Individual Species Layers":
            var tmpData = layerExtTitles;
            var tmpVals = layerExt;
            break;
          case "CL, EXC, & Abiotic Data":
            var tmpData = ["Data Files"];
            var tmpVals = ["N-CLAS_data_11-10-17"];
        }

        d3.select("#downloadLayer").selectAll("option").remove()

        d3.select("#downloadLayer")
          .style("display", "inline-block")
          .selectAll("option")
          .data(tmpData)
          .enter()
            .append("option")
            .attr("class", "dlOpt")
            .attr("value", function(d,i) { return tmpVals[i]; })
            .text(function(d,i) { return d; });

        d3.select("#downloadLayer")
          .style("font-style", "")
          .insert("option", ":first-child")
          .property("disabled", true)
          .text("Select layer...");

        d3.select("#downloadLayer")
          .property("selectedIndex", 0);

        d3.select("#downloadButton").classed("disabled", true);
      }





     //******Function to set download button href property
     function set_dl_link() {
       if(d3.select("#downloadCat").property("selectedOptions")[0].value == "Individual Species Layers") {
         return "zips/" + d3.select("#downloadSpecies").property("selectedOptions")[0].value + d3.select("#downloadLayer").property("selectedOptions")[0].value + ".zip";
       }
       else {
         return "zips/" + d3.select("#downloadLayer").property("selectedOptions")[0].value + ".zip";
       }
     }






      //******Set z-indexes of moveable divs so that clicked one is always on top
      d3.selectAll("#legendDiv,#polFilterDiv,#attributesDiv,#attrSelectDiv,#chartsDiv,#downloadDiv")
        .on("mousedown", function() { setZ(this); });

      function setZ(tmpWin) {
        if (d3.select("#map").classed("introjs-showElement") == false) {
          d3.selectAll("#legendDiv,#polFilterDiv,#attributesDiv,#attrSelectDiv,#chartsDiv,#downloadDiv").style("z-index", function() { if(d3.select(this).style("opacity") == 1) {return 1001;} else {return 7500;} }); 
          d3.select(tmpWin).style("z-index", function() { if(tmpWin.id == "preferencesDiv") { return 1003;} else { return 1002;} });
        }
      }









      //******Add collapse ability to left_panel
      d3.select("#left_collapse")
        .on("click", function() { toggleSelections(this.id); })
        .property("title", "Click to hide panel");

      //******Add collapse ability to right_panel
      d3.select("#right_collapse")
        .on("click", function() { toggleSelections(this.id); })
        .property("title", "Click to hide panel");

      //******Function to toggle left & right panels
      function toggleSelections(tmpID) {
        var tmpDir = tmpID.slice(0,tmpID.indexOf("_"));

        if(tmpDir == "left") {
          var oppDir = "right";
        }
        else {
          var oppDir = "left";
        }

        if(d3.select("#" + tmpID + "_glyph").classed("glyphicon-triangle-" + tmpDir)) {
          d3.select("#" + tmpID + "_glyph")
            .classed("glyphicon-triangle-" + tmpDir, false)
            .classed("glyphicon-triangle-" + oppDir, true);
          d3.select("#" + tmpID).property("title", "Click to show panel");
          if(tmpDir == "left") {
            d3.select("#left_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"0px"});
            d3.selectAll(".leaflet-left").transition().duration(500).ease("cubic-in-out").style({"margin-left":"20px"});
            if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 380) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 30) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"left":"15px","width":tmpWidth});
          }
          else {
            d3.select("#right_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"0px"});
            d3.selectAll(".leaflet-right").transition().duration(500).ease("cubic-in-out").style({"margin-right":"20px"});
            if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 180) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 30) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"width":tmpWidth});
          }
        }
        else {
          d3.select("#" + tmpID + "_glyph")
            .classed("glyphicon-triangle-" + oppDir, false)
            .classed("glyphicon-triangle-" + tmpDir, true);
          d3.select("#" + tmpID).property("title", "Click to hide panel");
          if(tmpDir == "left") {
            d3.select("#left_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"150px"});
            d3.selectAll(".leaflet-left").transition().duration(500).ease("cubic-in-out").style({"margin-left":"170px"});
            if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-right") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 530) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 180) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"left":"165px","width":tmpWidth});
          }
          else {
            d3.select("#right_panel_container").transition().duration(500).ease("cubic-in-out").style({"width":"350px"});
            d3.selectAll(".leaflet-right").transition().duration(500).ease("cubic-in-out").style({"margin-right":"370px"});
            if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left") == true) {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 530) + "px";
            }
            else {
              var tmpWidth = (Math.max(window.innerWidth, 1280) - 380) + "px";
            }
            d3.select("#container-results").transition().duration(500).ease("cubic-in-out").style({"width":tmpWidth});
          }
        }
        setTimeout(function() {
          resizePanels();
        }, 520);
      }         





      //******Take appropriate action when step is clicked
      function stepAction(tmpEl) {
        if(d3.select(tmpEl).classed("disabled") == false) {
          d3.selectAll(".selDiv").classed("selected", false);
          d3.select(tmpEl).classed("selected", true);
          if(tmpEl.id != "selOut") {
            d3.selectAll(".choice").style("display", "none");
          }
          switch (tmpEl.id) {
            case "selArea":
              d3.select("#areaChoice").style("display", "block");
              classInactive(false);
              if(d3.select("#areaOptions").selectAll("*")[0].length == 0) {
                d3.select("#areaListDropdown").style("display", "inline-block");
              }
              break;
            case "selSpp":
              d3.select("#sppChoice").style("display", "block");
              classInactive(true);
              break;
            case "selRes":
              d3.select("#resChoice").style("display", "block");
              classInactive(true);
              break;
          }
          if(d3.select("#right_collapse_glyph").classed("glyphicon-triangle-left") == true) {
            toggleSelections("right_collapse");
          }
        }
      }

      

      

      function classInactive(tmpSwitch) {
        if(d3.select("#areaList").attr("value")) {
          if(d3.select("." + area2layer[d3.select("#areaList").attr("value")]).classed("inactive") == false) {
            if(tmpSwitch == true) {
              topoClickArray = [];
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])[0].forEach(function(d) {
                topoClickArray.push(d3.select(d).on("click"));
              });
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])
                .classed("inactive", true)
                .on("click", null);
            }
          }
          else {
            if(tmpSwitch == false) {
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")])[0].forEach(function(d,i) {
                d3.select(d).on("click", topoClickArray[i]);
              });
              d3.selectAll("." + area2layer[d3.select("#areaList").attr("value")]).classed("inactive", false)
            }
          }
        }
      }


      //******Add area div
      d3.select("#right_panel_container")
        .append("div")
        .attr("id", "areaChoice")
        .attr("class", "choice")
        .style("display", "block")
        .append("div")
        .attr("id", "areaHeader")
        .html('<div class="choiceHeader" style="background:rgb(189,68,65);">Areas</div>'); 

      d3.select("#areaHeader")
        .append("div")
        .attr("id", "areaSelect")
        .attr("class", "layerList")
        .style("float", "none")
        .append("div")
        .attr("id", "areaList")
        .attr("class", "cl_select")
        .property("title", "Click to display list of area layers")
        .html('<span id="areaListHeader">Select Area Layer</span><span class="glyphicon glyphicon-triangle-bottom pull-right" style="position:relative;top:3px;"></span>')
        .on("click", function() { 
          if(d3.select("#areaListDropdown").style("display") == "none") {
            d3.select("#areaListDropdown").style("display", "inline-block");
          }
          else {
            d3.select("#areaListDropdown").style("display", "none");
          }
        });

      d3.select("#areaHeader")
        .append("p")
        .attr("id", "areaSelectLabel");

      d3.select("#areaHeader")
        .append("hr")
        .style("margin", "5px 0px");

      d3.select("#areaSelect")
        .append("div")
        .attr("id", "areaListDropdown")
        .attr("class", "layerListDropdown")
        .style("display", "inline-block")
        .on("mouseleave", function() { d3.select(this).style("display", "none") });

      //******Add area options
      d3.select("#areaListDropdown").selectAll("div")
        .data(layerNames.areas.keys)
        .enter()
          .append("div")
          .attr("class", "layerName")
          .text(function(d) { return d; })
          .property("value", function(d,i) { return i; })
          .property("title", function(d) { return d; })
          .on("click", function() { changeArea(this); })
          .append("span")
          .attr("class", "glyphicon glyphicon-ok pull-right activeArea")
          .style("visibility", function(d) { if(d == "All Ecoregions") {return "visible";} else {return "hidden";} });

      d3.select("#areaChoice")
        .append("div")
        .attr("id", "areaOptions");


      //******Add procedural steps action
      d3.select("#selArea").on("click", function() { stepAction(this); });

      //******Function to add/remove area layer
      function changeArea(tmpDiv) {
        if(d3.select(tmpDiv).select("span").style("visibility") == "visible") {
          d3.select(tmpDiv).select("span").style("visibility", "hidden")
          d3.select("#areaSelectLabel").text("");
          map.removeLayer(layerNames.areas.values[tmpDiv.value]);
          var allLabels = d3.selectAll(".remLabel,.fs_wild_key")
          allLabels.remove();
        }
        else {
          //***Remove old layer
          d3.select("#areaListDropdown").selectAll("div")[0].forEach(function(tmpLayer) {
            if(d3.select(tmpLayer).select("span").style("visibility") == "visible") {
              d3.select(tmpLayer).select("span").style("visibility", "hidden");
              map.removeLayer(layerNames.areas.values[d3.select(tmpLayer).property("value")]);
            }
          });

          //***Add new layer
          d3.select("#areaList").attr("value", layerNames.areas.keys[tmpDiv.value]);
          d3.select(tmpDiv).select("span").style("visibility", "visible");
          d3.select("#areaSelectLabel").text(layerNames.areas.keys[tmpDiv.value]);
          map.addLayer(layerNames.areas.values[tmpDiv.value]);
          addAreaNames(tmpDiv.value);
          getCoords(tmpDiv.value);
          get_spp();
        }
      }

      function getCoords(i) {
/*
        var tmpLabels = d3.selectAll(".remLabel")[0];
        d3.selectAll("." + areaID[i])[0].forEach(function(d) {
          var tmpBi = 0;
          tmpLabels.some(function(tmpLab) {
            if(tmpLab.title == d.id) {
              var bbox = d3.select(d).node().getBBox();
              var UL = map.containerPointToLatLng([bbox.x, bbox.y]);
              var LR = map.containerPointToLatLng([(bbox.x + bbox.width), (bbox.y + bbox.height)]);
              d3.select(tmpLab)
                .attr("data-ulLat", UL.lat)
                .attr("data-ulLng", UL.lng)
                .attr("data-lrLat", LR.lat)
                .attr("data-lrLng", LR.lng);
              tmpBi = 1;
            }
            return tmpBi == 1;
          });
        });
*/
        var tmpLabels = d3.selectAll(".remLabel")[0];
        topos[areaID[i]].features.forEach(function(d) {
          var tmpBi = 0;
          tmpLabels.some(function(tmpLab) {
            if(tmpLab.title == d.id) {
              var bbox = d3.geo.bounds(d);
              d3.select(tmpLab)
                .attr("data-llLat", bbox[0][1])
                .attr("data-llLng", bbox[0][0])
                .attr("data-urLat", bbox[1][1])
                .attr("data-urLng", bbox[1][0]);
              tmpBi = 1;
            }
            return tmpBi == 1;
          });
        });          
      }


      //******Populate area field with choices
      function addAreaNames(i) {
        var allLabels = d3.selectAll(".remLabel,.fs_wild_key")
        allLabels.remove();
        topos[areaID[i]].names.forEach(function(d,j) {
          d3.select("#areaOptions")
            .append("label")
            .attr("class", "remLabel")
            .property("title", d)
            .on("mouseenter", function() {
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  if(d3.select(tmpLabel).select("input").property("checked") == false) {
                    d3.select(d).style({"fill-opacity":"0.3", "Stroke-opacity":"0.99", "stroke":"aqua"});
                  }
                  else {
                    d3.select(d).style({"stroke":"aqua"});
                  }
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("mouseleave", function() {
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  if(d3.select(tmpLabel).select("input").property("checked") == false) {
                    d3.select(d).style({"fill-opacity":"", "Stroke-opacity":"", "stroke":function() { if(d3.select("#areaList").attr("value").includes("Ecoregion")) { return topos[areaID[areaTitles.indexOf(d3.select("#areaList").attr("value"))]].color[d.id.replace(/ /g, "_")] } else { return ""; } } });
                  }
                  else {
                    d3.select(d).style({"stroke":function() { if(d3.select("#areaList").attr("value").includes("Ecoregion")) { return topos[areaID[areaTitles.indexOf(d3.select("#areaList").attr("value"))]].color[d.id.replace(/ /g, "_")] } else { return ""; } } });
                  }
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("dblclick", function() { 
              var tmpBi = 0;
              var tmpLabel = this;
              d3.selectAll("." + areaID[i])[0].some(function(d) {
                if(d.id == tmpLabel.title) {
                  var bbox = d3.select(d).node().getBBox();
                  var UL = map.containerPointToLatLng([bbox.x, bbox.y]);
                  var LR = map.containerPointToLatLng([(bbox.x + bbox.width), (bbox.y + bbox.height)]);
                  map.fitBounds([[UL.lat, UL.lng],[LR.lat, LR.lng]]);
                  tmpBi = 1;
                }
                return tmpBi == 1;
              });
            })
            .on("click", function() {
              colorFeat(d3.select(this).select("input")[0][0], i);
            })
            .html('<input id="area-' + j + '" class="remCheck" type="checkbox" value="' + d + '" onchange="get_spp()"></input><span value="' + d + '"> ' + d + ' </span><br>');
        });

        d3.selectAll(".remLabel")
          .classed("fsWildClass1",  function() { return (areaID[i] == "fs_wild" && layerNames.areas.fs_wild_class1.indexOf(d3.select(this).property("title")) > -1) })
          .select("span")
            .text(function() { if(areaID[i] == "fs_wild" && layerNames.areas.fs_wild_class1.indexOf(d3.select(this).attr("value")) > -1) {return d3.select(this).text() + "*";} else {return d3.select(this).text();} });

        d3.select("#areaOptions")
          .append("label")
          .attr("id", "areaAllLabel")
          .attr("class", "remLabel")
          .style("margin-top", "10px")
          .property("title", "Select all options")
          .on("click", function() { checkAreas(i); get_spp(); })
          .html('<input id="areaAll" type="checkbox"></input><span> Select All </span>');

        if(areaID[i] == "fs_wild") {
          d3.select("#areaOptions")
            .append("div")
            .attr("class", "fs_wild_key")
            .html('<p style="color:yellow;margin-top:10px;margin-bottom:0px;text-align:right;">Class 1 Area*</p><p style="margin-bottom:0px;text-align:right;">Class 2 Area</p>');
        }

        checkAreas(i);  
      }


      //******Get name values of selected areas and query database for species with positive exceedance values
      function get_spp() {
        //***Remove existing labels
        d3.select("#sppChoice").selectAll("label").remove();

        var tmpVals = [];
        d3.selectAll(".remCheck")[0].forEach(function(d) { if(d.checked) { tmpVals.push(d.value); } });
        if(tmpVals.length > 0) {
          d3.select("#selSpp").classed("disabled", false).property("title", "Select species");
          socket.emit('get_spp', tmpVals);
        }
        else {
          d3.select("#selSpp").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          d3.select("#container-results").style("display", "none");
        }
        checkOutput();
      }


      //******Adjust fill opacity for selected features
      function colorFeat(tmpObj, i) {
        topos[areaID[i]].g.selectAll("." + areaID[i])[0].forEach(function(feat) {
          if(feat.id == tmpObj.value) {
            if(tmpObj.checked == true) {
              d3.select(feat).style({"fill-opacity": "0.5", "stroke-opacity": "1"});
            }
            else {
              d3.select(feat).style({"fill-opacity": "", "stroke-opacity": ""});
            }
          }
        });
      }


      //******Evaluate 'Select All' areas state
      function checkAreas(i) {
        if(d3.select("#areaAll").property("checked") == true) {
          d3.selectAll(".remCheck").property("checked", true);
          d3.select("#areaAllLabel").property("title", "Deselect all options")
            .select("span")
              .text("Deselect All");
        } 
        else { 
          d3.selectAll(".remCheck").property("checked", false);
          d3.select("#areaAllLabel").property("title", "Select all options")
            .select("span")
              .text("Select All");
        }

        d3.selectAll(".remCheck")[0].forEach(function(tmpObj) { colorFeat(tmpObj, i); });
      }







      //******Add species div
      d3.select("#right_panel_container")
        .append("div")
        .attr("id", "sppChoice")
        .attr("class", "choice")
        .append("div")
        .attr("id", "sppHeader")
        .html('<div class="choiceHeader" style="background:rgb(118,147,60);">Individual Species</div><ul id="ulSpp" class="nav nav-pills"><li id="comSpp" class="active"><a href="#">Common Names</a></li><li id="sciSpp"><a href="#">Scientific Names</a></li></ul><hr style="margin-top:5px;margin-bottom:5px;">');  //<label><input id="sppAll" type="checkbox"></input><span> Select All </span><br></input><hr style="margin-top:5px;margin-bottom:5px;"></label>');

      //******Add procedural steps action
      d3.select("#selSpp").on("click", function() { stepAction(this); });

      //******Add pill functionality
      d3.select("#comSpp")
        .on("click", function() {
          d3.select("#ulSpp").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          addSpp(speciesTitles, "normal");
        });

      d3.select("#sciSpp")
        .on("click", function() {
          d3.select("#ulSpp").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          addSpp(speciesNames, "italic");
        });

      d3.select("#sppChoice")
        .append("div")
        .attr("id", "sppOptions");


      //******Add species names
      function addSpeciesNames(ExcArr, NoExcArr) {
        //***Add exceedance species first
        if(ExcArr.length > 0) {
          d3.select("#sppOptions")
            .append("label")
            .attr("class", "sppCheck")
            .text("Species with Exceedance of Minimum CL")
            .style({"text-decoration":"underline","font-size":"15px","color":"lightcoral"});

          speciesNames.forEach(function(spp, i) {
            if(ExcArr.indexOf(spp) > -1) {
              d3.select("#sppOptions")
                .append("label")
                .property("title", speciesTitles[i] + " (" + speciesNames[i] + ")")
                .html('<input id="spp-' + i + '" class="sppCheck excYes" type="checkbox" onclick="checkOutput()" value="' + i + '"></input><span class="sppSpan" value="' + i + '"> ' + speciesTitles[i] + ' </span><br>');
            }
          });

          d3.select("#sppOptions")
            .append("label")
            .attr("id", "sppExcAllLabel")
            .style("margin-top", "10px")
            .property("title", "Select all species with exceedance")
            .on("click", function() { checkSppAll("Yes"); checkOutput(); })
            .html('<input id="sppExcAll" type="checkbox"></input><span>Select All</span>');
        }

        //***Add No exceedance species second
        if(NoExcArr.length > 0) {
          d3.select("#sppOptions")
            .append("label")
            .attr("class", "sppCheck")
            .text("Species without Exceedance of Minimum CL")
            .style({"text-decoration":"underline","font-size":"15px","color":"lightgreen","margin-top":function() {if(ExcArr.lenght == 0) {return "";} else {return "10px";} } });

          speciesNames.forEach(function(spp, i) {
            if(NoExcArr.indexOf(spp) > -1) {
              d3.select("#sppOptions")
                .append("label")
                .property("title", speciesTitles[i] + " (" + speciesNames[i] + ")")
                .html('<input id="spp-' + i + '" class="sppCheck excNo" type="checkbox" onclick="checkOutput()" value="' + i + '"></input><span class="sppSpan" value="' + i + '"> ' + speciesTitles[i] + ' </span><br>');
            }
          });

          d3.select("#sppOptions")
            .append("label")
            .attr("id", "sppNoExcAllLabel")
            .style("margin-top", "10px")
            .property("title", "Select all species without exceedance")
            .on("click", function() { checkSppAll("No"); checkOutput(); })
            .html('<input id="sppNoExcAll" type="checkbox"></input><span>Select All</span>');

        }
      }

      function checkSppAll(type) {
        if(type == "Yes") {
          if(d3.select("#sppExcAll").property("checked") == true) {
            d3.selectAll(".excYes").property("checked", true);
            d3.select("#sppExcAllLabel")
              .property("title", "Deselect all species with exceedance")
              .select("span")
                .text("Deselect All");
          }
          else {
            d3.selectAll(".excYes").property("checked", false);
            d3.select("#sppExcAllLabel")
              .property("title", "Select all species with exceedance")
              .select("span")
                .text("Select All");
          }
        }
        else if(type == "No") {
          if(d3.select("#sppNoExcAll").property("checked") == true) {
            d3.selectAll(".excNo").property("checked", true);
            d3.select("#sppNoExcAllLabel")
              .property("title", "Deselect all species without exceedance")
              .select("span")
                .text("Deselect All");
          }
          else {
            d3.selectAll(".excNo").property("checked", false);
            d3.select("#sppNoExcAllLabel")
              .property("title", "Select all species without exceedance")
              .select("span")
                .text("Select All");
          }
        }
      }
          
        
      //******Swap species names between common and scientific
      function addSpp(sppArray, tmpStyle) {
        var tmpSpp = d3.selectAll(".sppSpan")
          //.data(sppArray);
        tmpSpp[0].forEach(function(spp) {
          d3.select(spp).text(function() { return " " + sppArray[d3.select(spp).attr("value")] + " "; });
        });
        tmpSpp.style("font-style", tmpStyle);
      }

      //******Evaluate 'Select All' species state
      function checkSpp() {
        if(d3.select("#sppAll").property("checked") == true) {
          d3.selectAll(".sppCheck").property("checked", true); 
        } 
        else { 
          d3.selectAll(".sppCheck").property("checked", false);
        }
        //d3.selectAll(".sppCheck")[0].forEach(function(tmpObj) {addSppRange(tmpObj);});
      }

      //******Add species range when species is selected
      function addSppRange(tmpObj) {
        if(tmpObj.checked == true) {
          d3.select("#" + speciesID[tmpObj.value] + "Layer-3").property("checked", true);
          layerToggle(true, speciesLayers[tmpObj.value][3]);
        }
        else {
          d3.select("#" + speciesID[tmpObj.value] + "Layer-3").property("checked", false);
          layerToggle(false, speciesLayers[tmpObj.value][3]);
        }          
      }




      //******Function to enable/disable 'select output' button
      function checkOutput() {
        var tmpBi = 0;
        d3.selectAll(".sppCheck")[0].forEach(function(tmpCheck) {
          if(d3.select(tmpCheck).property("checked") == true) {
            tmpBi = 1;
          }
        });

        if(tmpBi == 0) {
          d3.selectAll("#selOut,#selRes").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          d3.select("#selOut").attr("data-toggle", "");
          if(d3.select("#resChoice").style("display") == "block") {
            d3.select("#resChoice").style("display", "none");
            d3.select("#areaChoice").style("display", "block");
          }
        }
        else {
          d3.select("#selOut").classed("disabled", false).property("title", "Select output").attr("data-toggle", "modal");
          d3.select("#selRes").classed("disabled", true).classed("selected", false).property("title", "Complete previous step to enable");
          if(d3.select("#resChoice").style("display") == "block") {
            d3.select("#resChoice").style("display", "none");
            d3.select("#areaChoice").style("display", "block");
          }
        }
        d3.select("#container-results").style("display", "none");
      }







      //******Add output modal div
      //***Output choice (Basic, Tailored, Comprehensive)
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "outputDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputOptions")

      d3.select("#outputOptions")
        .append("div")
        .attr("id", "outChoice")
        .attr("class", "outChoice")
        .html('<div id="outDiv" class="choiceHeader outputHeader">Select Output Type</div>'); //<ul id="ulOut" class="nav nav-pills"><li id="comOut" class="active"><a href="#">Combined Species</a></li><li id="indOut"><a href="#">Individual Species</a></li></ul><hr style="margin-top:5px;margin-bottom:5px;"><div id="comOutDiv" class="output"></div><div id="indOutDiv" class="output"></div>');

      d3.select("#outDiv")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Output Type</center></b></u></p><p>Choose an option to determine initial output selections to produce.<br><br>All options eventually proceed to a preview window where output selections can be modified before being produced.</p>"></span>');

      d3.select("#outDiv")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Selections");

      //******Add procedural steps action
      d3.select("#selOut").on("click", function() { stepAction(this); });

      //******Add in output options
      d3.select("#outChoice")
        .append("div")
        .attr("id", "outRadioDiv")
        .style({"text-align":"left"})
        .html('<label><input id="outBasic" type="radio" name="outRadio" value="basic" checked></input><span class="outLabel"> Basic Output </span></label><p><i>Simple output maps, summary figures, and tables (most protective critical load: most sensitive of all species present)</i></p><label><input id="outTail" type="radio" name="outRadio" value="tail"></input><span class="outLabel"> Tailored Output </span></label><p><i>Select from a checklist of questions to determine which output materials exactly suit your needs</i></p><label><input id="outComp" type="radio" name="outRadio" value="comp"></input><span class="outLabel"> Comprehensive Output </span></label><p><i>All relevant figures, tables, and maps</i></p>')
        .style("display", "block");

      //******Add button to advance to next screen
      d3.select("#outChoice")
        .append("div")
        .attr("id","outOptButton")
        .attr("class", "outButton")
        .text("Proceed with Selected Output Type")
        .property("title", "Proceed with output selection using the chosen output type")
        .on("click", function() { 
          d3.select("#outputOptions").style("display", "none");
          if(document.querySelector('input[name=outRadio]:checked').value == "tail") {
            d3.select("#areaScreen").text(d3.select("#areaList").attr("value"));
            checkTailorAnswers();
            d3.select("#outputTailor").style("display", "block");
          }
          else {
            addThumbs();
            setFigChecks(document.querySelector('input[name=outRadio]:checked').value);
            d3.select("#outputPreview").style("display", "block");
          }
        });




      //***Output Tailor Screen
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputTailor")
        .append("div")
        .attr("id", "outTailorChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivTailor" class="choiceHeader outputHeader">Tailored Output Screening Questions</div>');

      d3.select("#outDivTailor")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Screening Questions</center></b></u></p><p>These initial creening questions are used to determine which output best match your interests.<br><br>Depending on your answers, as you proceed to the next screen some figures might be excluded and/or some questions may be disabled. Your answers can always be changed by using the <b>Back Arrow</b> located in the lower left corner to return to this screen.</p>"></span>');

      d3.select("#outDivTailor")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Window");

      //******Add screening questions
      d3.select("#outTailorChoice")
        .append("div")
        .attr("id", "outTailorScreen")
        .style("background", "white")
        .html('<p>1. Would you like to see only the most protective CL or CLs for a range of levels of protection?<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen1A" class="outCheck" name="outScreen1"><span>Most Protective CL</span></label><label><input type="radio" id="outScreen1B" class="outCheck" name="outScreen1"><span>Range of CLs</span></label>'
          + '<p>2. Would you like to see outputs for individual species, all species combined, or both?</label><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen2A" class="outCheck" name="outScreen2"><span>Individual Species Outputs</span></label><label><input type="radio" id="outScreen2B" class="outCheck" name="outScreen2"><span>Combined Species Outputs</span></label><label><input type="radio" id="outScreen2C" class="outCheck" name="outScreen2"><span>Both</span></label>'
          + '<p>3. Would you like to compare your site to other <span id="areaScreen"></span>?<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></p>'
          + '<label><input type="radio" id="outScreen3A" class="outCheck" name="outScreen3" style="margin-bottom:20px"><span>Yes</span></label><label><input type="radio" id="outScreen3B" class="outCheck" name="outScreen3"  style="margin-bottom:20px"><span>No</span></label>'
        );

      d3.select("#outTailorScreen").selectAll("label")
        .on("click", function() { checkTailorAnswers(); });

      //******Store screening question answers
      var outArrayStr = localStorage.getItem('outArray');
      if(outArrayStr != null) {
        var outArray = outArrayStr.split(",");
        if(Array.isArray(outArray)) {
          outArray.forEach(function(d) {
            d3.select("#" + d).property("checked", true);
          });
        }
      }

      //******Add back arrow
      d3.select("#outTailorChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputTailor").style("display", "none");
          d3.select("#outputOptions").style("display", "block");
        });
          

      //******Add button to proceed to next window
      d3.select("#outTailorChoice")
        .append("div")
        .attr("id", "outButtonTailor")
        .attr("class", "outButton disabledButton")
        .property("title", "Answer above questions to enable button")
        .text("Proceed to Output Refinement");


      //******Function to assess if all questions are answered
      function checkTailorAnswers() {
        if($("input[name=outScreen1]:checked").length > 0 && $("input[name=outScreen2]:checked").length > 0 && $("input[name=outScreen3]:checked").length > 0) {
          d3.select("#outButtonTailor")
            .classed("disabledButton", false)
            .property("title", "Proceed to further refine output based on the above selections")
            .on("click", function() {
              refineHTML();
              localStorage.setItem('outArray', [document.querySelector('input[name=outScreen1]:checked').id, document.querySelector('input[name=outScreen2]:checked').id, document.querySelector('input[name=outScreen3]:checked').id])
              d3.select("#outputTailor").style("display", "none");
              d3.select("#outputQuestions").style("display", "block");
            });
        }
      }






      //***Output Tailor Questions
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputQuestions")
        .append("div")
        .attr("id", "outQuestionsChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivQuestions" class="choiceHeader outputHeader">Tailored Output Refining Questions</div>');

      d3.select("#outDivQuestions")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Refining Questions</center></b></u></p><p>Refining questions further determine which output best match your interests. Please note that there are four pages of questions which are accessed through the <b><i>Page x</i></b> options below the question panel.<br><br>All but one question have example figures associated with them that will be selected for production if checked. For questions with multiple figures (multiple dots at the bottom of the figure), the additional figures can be viewed by clicking on either of the arrows at the edges of the figure or by clicking on a dot.<br><br>Disabled questions (slightly transparent, no mouse interaction) are the result of your answers to the screening questions on the previous window (use the <b>Back Arrow</b> to return to that window).</p>"></span>');

      d3.select("#outDivQuestions")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Window");

      //******Add screening questions
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "outRefineDiv");


      function refineHTML() {
        $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();   
        });

        if(outUnit == "hectares") {
          var offsetPix = 37;
        }
        else {
          var offsetPix = 71;
        }
        
        d3.select("#outRefineDiv").html('' 
          + '<div id="exampleFigsPageDiv">Page <span id="currentPage" title="The current page of screening questions. To change the page click on the desired &#39;Page&#39; button towards the bottom of the window">1</span> of 4</div>'
          + '<div id="exampleFigs">Example Figures</div>'
          + '<div id="questionsExc" class="outRefineDivs" style="display:block;">'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);border-radius:4px 4px 0 0;">'
              + '<label style="position:relative;top:35px;"><input type="checkbox" class="refCheck" value="0"><span>Is there exceedance in the area?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);">'
              + '<label style="margin-left:50px;"><input type="checkbox" class="refCheck" value="1"><span>What percentage of my area is exceeded?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel1" class="carousel slide" data-ride="carousel" style="margin-left:44px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel1" data-slide-to="0" class="active"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig15a.jpg" alt="fig15a" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel1" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel1" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);">'
              + '<label style="margin-left:50px;"><input type="checkbox" class="refCheck" value="2"><span>How many ' + outUnit + ' have CL exceedance?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel2" class="carousel slide" data-ride="carousel" style="margin-left:' + offsetPix + 'px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel2" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel2" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig15b_' + outUnit + '.jpg" alt="fig15b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig15bi_' + outUnit + '.jpg" alt="fig15bi" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel2" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel2" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(252,242,242);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="3"><span>Which species have the most exceedance?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel3" class="carousel slide" data-ride="carousel" style="margin-left:78px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel3" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel3" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel3" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig2a.jpg" alt="fig2a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig2b_' + outUnit + '.jpg" alt="fig2b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig2bi_' + outUnit + '.jpg" alt="fig2b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel3" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel3" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsExcEM" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);">'
              + '<label><input type="checkbox" class="refCheck" value="4"><span>What is the extent and magnitude of exceedance<br>in my area?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel4" class="carousel slide" data-ride="carousel" style="margin-left:49px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel4" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel4" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel4" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig11a.jpg" alt="fig11a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig12a.jpg" alt="fig12a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig12b.jpg" alt="fig12b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel4" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel4" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(235,239,246);">'
              + '<label><input type="checkbox" class="refCheck" value="5"><span>What is the extent and magnitude of exceedance<br>by species?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel5" class="carousel slide" data-ride="carousel" style="margin-left:49px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel5" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel5" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel5" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig3a.jpg" alt="fig3a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig4a.jpg" alt="fig4a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig4c.jpg" alt="fig4c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel5" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel5" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,254,241);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="6"><span>How sensitive is my area to N deposition based<br>on site conditions?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel6" class="carousel slide" data-ride="carousel" style="margin-left:65px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel6" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel6" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig1a.jpg" alt="fig1a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig1b_' + outUnit + '.jpg" alt="fig1b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel6" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel6" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsNdepExc" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);">'
              + '<label><input type="checkbox" class="refCheck" value="7"><span>What percent of my area is <b>exceeded</b> at a given<br>N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel7" class="carousel slide" data-ride="carousel" style="margin-left:56px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel7" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel7" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel7" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13e.jpg" alt="fig13e" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13h.jpg" alt="fig13h" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13g.jpg" alt="fig13g" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel7" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel7" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);">'
              + '<label><input type="checkbox" class="refCheck" value="8"><span>What percent of my area is <b>exceeded</b> for each<br>species at a given N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel8" class="carousel slide" data-ride="carousel" style="margin-left:73px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel8" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel8" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/tab3b.jpg" alt="tab3b" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig6c.jpg" alt="fig6c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel8" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel8" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(255,240,225);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="9"><span>How does the percentage of my area that is<br><b>exceeded</b> at a given N deposition level<br>compared to other areas of the same<br>type?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel9" class="carousel slide" data-ride="carousel" style="margin-left:106px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel9" data-slide-to="0" class="active"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13f.jpg" alt="fig13f" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel9" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel9" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'


          + '<div id="questionsNdepPro" class="outRefineDivs" style="display:none;">'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);border-radius:4px 4px 0 0;height:39px;"></div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);">'
              + '<label><input type="checkbox" class="refCheck" value="10"><span>What percent of my area is <b>protected</b> at a given<br>N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel10" class="carousel slide" data-ride="carousel" style="margin-left:56px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel10" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel10" data-slide-to="1"></li>'
                  + '<li data-target="#refCarousel10" data-slide-to="2"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13a.jpg" alt="fig13a" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13d.jpg" alt="fig13d" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig13c.jpg" alt="fig13c" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel10" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel10" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);">'
              + '<label><input type="checkbox" class="refCheck" value="11"><span>What percent of my area is <b>protected</b> for each<br>species at a given N deposition level?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel11" class="carousel slide" data-ride="carousel" style="margin-left:73px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel11" data-slide-to="0" class="active"></li>'
                  + '<li data-target="#refCarousel11" data-slide-to="1"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/tab3c.jpg" alt="tab3c" style="width:100%;">'
                  + '</div>'
                  + '<div class="item">'
                    + '<img src="images/fig6a.jpg" alt="fig6a" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel11" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel11" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
            + '<div class="refQuestCatDiv" style="background:rgb(236,241,233);border-radius:0 0 4px 4px;">'
              + '<label><input type="checkbox" class="refCheck" value="12"><span>How does the percentage of my area that is<br><b>protected</b> at a given N deposition level<br>compare to other areas of the same<br>type?</span></input><span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Info</center></b></u></p><p>Write info here.</p>"></span></label>'
              + '<div id="refCarousel12" class="carousel slide" data-ride="carousel" style="margin-left:106px">'
                + '<ol class="carousel-indicators">'
                  + '<li data-target="#refCarousel12" data-slide-to="0" class="active"></li>'
                + '</ol>'
                + '<div class="carousel-inner">'
                  + '<div class="item active">'
                    + '<img src="images/fig13b.jpg" alt="fig13b" style="width:100%;">'
                  + '</div>'
                + '</div>'
                + '<a class="left carousel-control" href="#refCarousel12" data-slide="prev">'
                  + '<span class="glyphicon glyphicon-chevron-left"></span>'
                  + '<span class="sr-only">Previous</span>'
                + '</a>'
                + '<a class="right carousel-control" href="#refCarousel12" data-slide="next">'
                  + '<span class="glyphicon glyphicon-chevron-right"></span>'
                  + '<span class="sr-only">Next</span>'
                + '</a>'
              + '</div>'
            + '</div>'
          + '</div>'
        )

        //***Check boxes for previous in session selections
        var tailorArrayStr = localStorage.getItem('tailorArray');
        if(tailorArrayStr != null) {
          var tailorArray = tailorArrayStr.split(",");
          if(Array.isArray(tailorArray)) {
            d3.select("#outRefineDiv").selectAll(".refCheck")[0].forEach(function(tmpChk,i) {
              if(tailorArray[i] == "true") {
                d3.select(tmpChk).property("checked", true);
              }
              else {
                d3.select(tmpChk).property("checked", false);
              }
            });
          }
        }

        
        //***Add styles and titles
        d3.select("#outRefineDiv").selectAll("label,input")
          .style("cursor", "pointer")
          .property("title", "Check to produce the associated example figures for your output");

        d3.select("#outRefineDiv").selectAll(".carousel").property("title", "Example of output that will be produced when this option is checked");

        //******Adjust images to accomodate screening question answers
        //***Question 1
        if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1A") {
          d3.select(d3.select("#refCarousel4").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel4").select("ol").selectAll("li")[0][2]).remove();

          d3.select(d3.select("#refCarousel7").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel7").select("ol").selectAll("li")[0][2]).remove();
          d3.select(d3.select("#refCarousel7").select("div").selectAll("div")[0][1]).remove();
          d3.select(d3.select("#refCarousel7").select("ol").selectAll("li")[0][1]).remove();

          d3.select(d3.select("#refCarousel10").select("div").selectAll("div")[0][2]).remove();
          d3.select(d3.select("#refCarousel10").select("ol").selectAll("li")[0][2]).remove();
          d3.select(d3.select("#refCarousel10").select("div").selectAll("div")[0][1]).remove();
          d3.select(d3.select("#refCarousel10").select("ol").selectAll("li")[0][1]).remove();
        }

        //***Question 2
        if(document.querySelector('input[name=outScreen2]:checked').id == "outScreen2A") {
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][0]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
        }
        else if(document.querySelector('input[name=outScreen2]:checked').id == "outScreen2B") {
          d3.select(d3.select("#questionsExc").selectAll(".refQuestCatDiv")[0][3]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsExcEM").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsNdepExc").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
          d3.select(d3.select("#questionsNdepPro").selectAll(".refQuestCatDiv")[0][1]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});
        }

        //***Question 3
        if(document.querySelector('input[name=outScreen3]:checked').id == "outScreen3B") {
          d3.select(d3.select("#questionsNdepExc").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});          
          d3.select(d3.select("#questionsNdepPro").selectAll(".refQuestCatDiv")[0][2]).selectAll("*").style({"opacity":"0.6", "pointer-events":"none"});          
        }     

        //***Display div with the active dot
        d3.selectAll(".outRefineDivs").style("display", "none");
        d3.select("#" + d3.select("#refineDots").select(".active").attr("value")).style("display", "block");
        d3.select("#currentPage").text(d3.select("#refineDots").select(".active").attr("data-page"));

        //***Set slide change time
        $('.carousel').carousel({
          interval: false
        })
      }




      //******Add dots to change questions
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "refineDots")
        .html('<div id="dotExc" class="refineDots active" value="questionsExc" data-page="1" title="Exceedance by area and species">Page 1</div><div id="dotExcEM" class="refineDots" value="questionsExcEM" data-page="2" title="Exceedance extent, magnitude, and sensitivity by area, species, and site conditions">Page 2</div><div id="dotNdepExc" class="refineDots" value="questionsNdepExc" data-page="3" title="Area exceedance for a given N deposition level">Page 3</div><div id="dotNdepPro" class="refineDots" value="questionsNdepPro" data-page="4" title="Area protection for a given N deposition level">Page 4</div>');

      d3.selectAll(".refineDots")
        .on("click", function() { 
          d3.selectAll(".refineDots").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".outRefineDivs").style("display", "none");
          d3.select("#" + d3.select(this).attr("value")).style("display", "block");
          d3.select("#currentPage").text(d3.select(this).attr("data-page"));
        });

      //******Add back arrow
      d3.select("#outQuestionsChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputQuestions").style("display", "none");
          d3.select("#outputTailor").style("display", "block");
        });
          

      //******Add button to proceed to next window
      d3.select("#outQuestionsChoice")
        .append("div")
        .attr("id", "outButtonQuestions")
        .attr("class", "outButton")
        .style("margin-top", "0")
        .property("title", "Proceed to preview examples of outputs based on the above selections")
        .text("Proceed to Output Preview")
        .on("click", function() {
          var tailorArray = [];
          d3.select("#outRefineDiv").selectAll(".refCheck")[0].forEach(function(tmpChk,i) {
            tailorArray.push(d3.select(tmpChk).property("checked"));
          });
          localStorage.setItem("tailorArray", tailorArray);
          addThumbs();
          setFigChecks("tail");
          d3.select("#outputQuestions").style("display", "none");
          d3.select("#outputPreview").style("display", "block");
        });







      //******Function to disable figure thumbs for unselected figures
      function setFigChecks(tmpOut) {
        if(tmpOut == "basic") {
          var outArray = {"fig15a": true, ["fig15b_" + outUnit]: true, ["fig15bi_" + outUnit]: false, "fig2a": true, ["fig2b_" + outUnit]: false, ["fig2bi_" + outUnit]: false, "fig11a": false, "fig12a": false, "fig12b": false, "fig3a": false, "fig4a": false, "fig4c": false, "fig1a": false, ["fig1b_" + outUnit]: false, "fig9a": false, "fig9b": false, "fig13e": false, "fig13h": false, "fig13g": false, "fig6c": false, "fig13f": false, "fig13a": false, "fig13d": false, "fig13c": false, "fig6a": false, "fig13b": false, "tab3b": true, "tab3c": true}; //, "tab2c": false, "tab2a": false, "tab1c": false, "tab1a": false};
        }
        else if(tmpOut == "tail") {
          var outArray = {"fig15a": false, ["fig15b_" + outUnit]: false, ["fig15bi_" + outUnit]: false, "fig2a": false, ["fig2b_" + outUnit]: false, ["fig2bi_" + outUnit]: false, "fig11a": false, "fig12a": false, "fig12b": false, "fig3a": false, "fig4a": false, "fig4c": false, "fig1a": false, ["fig1b_" + outUnit]: false, "fig9a": false, "fig9b": false, "fig13e": false, "fig13h": false, "fig13g": false, "fig6c": false, "fig13f": false, "fig13a": false, "fig13d": false, "fig13c": false, "fig6a": false, "fig13b": false, "tab3b": false, "tab3c": false}; //, "tab2c": false, "tab2a": false, "tab1c": false, "tab1a": false};
          var tmpChecked = d3.selectAll(".refCheck")[0];
          tmpChecked.forEach(function(tmpEl) {
            if(d3.select(tmpEl).property("checked")) {
              switch (d3.select(tmpEl).attr("value")) {
                case "0":
                  
                  break;
                case "1":
                  outArray.fig15a = true;
                  break;
                case "2":
                  outArray["fig15b_" + outUnit] = true;
                  outArray["fig15bi_" + outUnit] = true;
                  break;
                case "3":
                  outArray.fig2a = true;
                  outArray["fig2b_" + outUnit] = true;
                  outArray["fig2bi_" + outUnit] = true;
                  break;
                case "4":
                  outArray.fig11a = true;
                  outArray.fig12a = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig12b = true;
                  }
                  break;
                case "5":
                  outArray.fig3a = true;
                  outArray.fig4a = true;
                  outArray.fig4c = true;                  
                  break;
                case "6":
                  outArray.fig1a = true;
                  outArray["fig1b_" + outUnit] = true;
                  break;
                case "7":
                  outArray.fig13e = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig13h = true;
                    outArray.fig13g = true;
                  }
                  break;
                case "8":
                  outArray.fig6c = true;
                  outArray.tab3b = true;
                  break;
                case "9":
                  outArray.fig13f = true;
                  break;
                case "10":
                  outArray.fig13a = true;
                  if(document.querySelector('input[name=outScreen1]:checked').id == "outScreen1B") {
                    outArray.fig13d = true;
                    outArray.fig13c = true;
                  }
                  break;
                case "11":
                  outArray.fig6a = true;
                  outArray.tab3c = true;
                  break;
                case "12":
                  outArray.fig13b = true;
                  break;
              }
            }
          });
        }
        else if(tmpOut == "comp") {
          var outArray = {"fig15a": true, ["fig15b_" + outUnit]: true, ["fig15bi_" + outUnit]: true, "fig2a": true, ["fig2b_" + outUnit]: true, ["fig2bi_" + outUnit]: true, "fig11a": true, "fig12a": true, "fig12b": true, "fig3a": true, "fig4a": true, "fig4c": true, "fig1a": true, ["fig1b_" + outUnit]: true, "fig9a": true, "fig9b": true, "fig13e": true, "fig13h": true, "fig13g": true, "fig6c": true, "fig13f": true, "fig13a": true, "fig13d": true, "fig13c": true, "fig6a": true, "fig13b": true, "tab3b": true, "tab3c": true}; //, "tab2c": true, "tab2a": true, "tab1c": true, "tab1a": true};
        }

        var outArrayKeys = d3.keys(outArray);

        outArrayKeys.forEach(function(key) {
          if(outArray[key] == false) {
            if(d3.select("#" + key + "Check").classed("glyphicon-ok-sign")) {
              $("#" + key + "Check").click();
            }
          }
          else {
            if(d3.select("#" + key + "Check").classed("glyphicon-ban-circle")) {
              $("#" + key + "Check").click();
            }
          }
        });
      }









      //***Output Preview
      d3.select("#outputDiv")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "outputPreview")
        .append("div")
        .attr("id", "outPreviewChoice")
        .attr("class", "outChoice")
        .html('<div id="outDivPreview" class="choiceHeader outputHeader">Preview Examples of Selected Output</div>');

      d3.select("#outDivPreview")
        .append("span")
        .attr("class", "outputInfo")
        .html('<span class="glyphicon glyphicon-info-sign help-tooltip" data-toggle="tooltip" data-container="body" data-placement="auto right" data-html="true" title="<p><u><b><center>Example Output Preview</center></b></u></p><p>This window provides thumbnails of example output figures and serves as a summary of which ones are currently selected to be produced for your data. Selected figures have a blue checkmark symbol in their lower right corner, while unselected figures have a red no symbol. To alternate a figure&#39;s selection status click on this symbol.<br><br>More information about a figure is accessed by clicking on the figure. This will place a copy of the figure in the upper right panel and a text description in the lower right panel. To zoom in on the figure further scroll over it with the cursor.<br><br>Please note that there are two pages of figures which are accessed by clicking on the <b><i>Page x</i></b> option below the thumbnail panel.</p>"></span>');

      d3.select("#outDivPreview")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove pull-right minimize-button outDivSpan")
        .attr("data-toggle", "modal")
        .attr("data-target", "#outputDiv")
        .property("title", "Close Output Selections");

      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "outPreviewDiv")
        .html('<div id="prevThumbs"></div><div id="prevLarge" style="border-radius:0 4px 0 0;border-top:1px solid gray;"><p id="prevLargeP">Click on an image to view here</p><img id="prevLargeImg"></img><p id="prevZoomP">Mouseover above figure to zoom in</p></div><div id="prevDescribe" style="border-radius:0 0 4px 0;"><p id="prevDescribeP"></p></div>');

      d3.select("#prevThumbs")
        .html('<div id="prevExc" class="outPreviewDivs" style="display:block;"></div><div id="prevNdep" class="outPreviewDivs" style="display:none;"></div><div id="prevHoverImgDiv"><img id="prevHoverImg"></img></div>');



      //***Add thumbnail images to preview screen
      function addThumbs() {
        $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();   
        });

        //outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + 
        var thumbArrayExc = [["fig15a", "fig15b_" + outUnit, "fig11a", "fig4c"], ["fig2a", "fig15bi_" + outUnit, "fig12a", "fig3a"], ["fig2b_" + outUnit, "fig2bi_" + outUnit, "fig12b", "fig4a"], ["fig1a", "fig1b_" + outUnit, "fig9a", "fig9b"]];
        var iconTitleArrayExc = [["% Area in EXC of Min CL (site)", "Area in EXC of Min CL (site)", "EXC Magnitude (combined spp.)", "EXC Magnitude (all spp.)"], ["% Area in EXC Min CL (species)", "Area in EXC of Min CL (site)", "EXC Magnitude (combined spp.)", "EXC Magnitude (ind. spp.)"], ["Area in EXC of Min CL (species)", "Area in EXC of Min CL (species)", "EXC Magnitude (multi-CL)", "EXC Magnitude (ind. spp.)"], ["% Area Sensitive to N Dep", "Area Sensitive to N Dep", "Cum. % Area (min CL)", "Cum. % Area (multi-CL)"]];
        var hoverArrayExc = [["% area in exceedance of the most protective CL for all species combined at the selected areas", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of the most protective CL for all species combined at the selected areas", "Info for fig11a", "Info for fig4c"],["% area in exceedance of the most protective CL for all selected individual species at the given site", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of the most protective CL for all species combined at the selected areas (red bars) and the area with NO exceedance (blue bars)", "Info for fig12a", "The extent and magnitude of exceedance of most protective critical load for a single species at the given site"],[outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of most protective critical load for all selected individual species at the given site", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " in exceedance of most protective critical load stacked (for relativity) with area not in exceedance of most protective critical load for all selected individual species at the given site", "Info for fig12b", "The extent and magnitude of exceedance of most protective critical load for a single species at the given site"],["Percent of the area occupied by each species where adjusted CL falls in the more sensitive portion of the CL range based on site and climate conditions", outUnit.charAt(0).toUpperCase() + outUnit.slice(1) + " occupied by each species more sensitive to N deposition (adjusted CL falls into the bottom half of the CL range [purple]) and less sensitive to N deposition (adjusted CL falls into the top half of the CL range [green])", "Info for fig9a", "Info for fig9b"]];
        var figDescArrayExc = [["This figure shows the percent of the area for which at least one species of all the species present has exceedance of the most protective CL. In each pixel, the most protective CL is set based on the most sensitive species. The area in exceedance is at risk of detrimental effects from N deposition.", "This figure shows the area (" + outUnit + ") for which at least one species of all the species present has exceedance of the most protective CL. In each pixel, the most protective CL is set based on the most sensitive species. The area in exceedance is at risk of detrimental effects from N deposition. Since the size of the areas being compared varies, this figure may have a different order of areas in ranking them from lowest to greatest area exceeded than the figure arranged by % of area in exceedance.", "Figure description for fig11a", "Figure description for fig4c"]];
          figDescArrayExc.push(["Figure description for fig2a", "This figure shows the " + outUnit + " for which at least one species of all the species present has exceedance of the most protective CL (red bars) and the area with NO exceedance (blue bars). The area in exceedance is at risk of detrimental effects from N deposition. Since the size of the areas being compared varies, this figure may have a different order of areas in ranking them from lowest to greatest area exceeded than the figure arranged by % of area in exceedance.", "Figure description for fig12a", "Figure description for fig3a"]);
          figDescArrayExc.push(["Figure description for fig2b", "Figure description for fig2bi", "Figure description for fig12b", "Figure description for fig4a"]);
          figDescArrayExc.push(["This figure shows percent of the area occupied by this species that is more susceptible to negative effects from N deposition based on site conditions. This is the percent of area covered by this species for which the CL is adjusted to the bottom half of the CL range (more sensitive) for all selected individual species at the given site. The percent of the area covered by the species may be the same as the total area or it may be less. This figure gives a sense of the extent to which the site conditions create suboptimal growing conditions for the given species, potentially exacerbating the effects of N deposition.", "This figure shows the " + outUnit + " occupied by this species that are more susceptible to negative effects from N deposition based on site conditions (purple bars) and the " + outUnit + " that are less susceptible to negative effects from N deposition (green bars). This is the " + outUnit + " covered by this species for which the CL is adjusted to the bottom half of the CL range (more sensitive-purple bars) or for which the CL is adjusted to the top half of the CL range for all selected individual species at the given site. This figure gives a sense of the area over which optimal or suboptimal growing conditions exist for each species.", "Figure description for fig9a", "Figure description for fig9b"]);

        var figUseArrayExc = [["This information gives an overview of the potential risk of detrimental effects from N deposition. Additional figures will provide information about the area in exceedance and the individual species patterns.", "This information allows comparison of " + outUnit + " in exceedance for different " + d3.select('#areaList').attr('value') + ". Additional figures will provide information about the " + outUnit + " in exceedance and the individual species patterns.", "Application for fig11a", "Application for fig4c"]];
          figUseArrayExc.push(["Application for fig2a", "This information allows comparison of the size of the area in exceedance for different " + d3.select("#areaList").attr("value") + ". It also combines the information from the % area exceeded figure, so that it is possible to see the size of the area in exceedance and also what fraction of the area is exceeded. Additional figures will provide information about the area in exceedance and the individual species patterns.", "Application for fig12a", "Application for fig3a"]);
          figUseArrayExc.push(["Application for fig2b", "Application for fig2bi", "Application for fig12b", "Application for fig4a"]);
          figUseArrayExc.push(["This information is useful in assessing about how the area might respond to other environmental stressors. For example, if most of the area covered by the species has site conditions which are not optimal for growth, another stressor (for example, climate change) might further compromise the success of the species in this area.", "This information can be used to determine the extent (area) of sub-optimal or optimal growing conditions and is useful for determining the extent to which a site might be compromised by N deposition or susceptible to secondary environmental stressors.", "Application for fig9a", "Application for fig9b"]);

        var colorArrayExc = [["pink", "pink", "blue", "blue"], ["pink", "pink", "blue", "blue"], ["pink", "pink", "blue", "blue"], ["yellow", "yellow", "yellow", "yellow"]];



        var thumbArrayNdep = [["fig13e", "tab3b", "fig13a", "tab3c"], ["fig13f", "fig13h", "fig13b", "fig13d"], ["fig13g", "fig6c", "fig13c", "fig6a"]];
        var iconTitleArrayNdep = [["% Area Exceeded (min CL)", "% Area Exceeded (species)", "% Area Protected (min CL)", "% Area Protected (species)"], ["% Area Exceeded (multi-site)", "% Area Exceeded (sensitive CLs)", "% Area Protected (multi-site)", "% Area Protected (sensitive CLs)"], ["% Area Exceeded (multi-CLs)", "% Area Exceeded (species)", "% Area Protected (multi-CLs)", "% Area Protected (species)"]];
        var hoverArrayNdep = [["Cumulative percent of the total area at risk from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios at a single site", "Percent of the selected area occupied by each species at risk from negative N deposition impacts using the most protective CL threshold across a range of N deposition levels", "Cumulative percent of the total area protected from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios at a single site", "Percent of the selected area occupied by each species protected from negative N deposition impacts using the most protective CL threshold across a range of N deposition scenarios and selected sites"],["Cumulative percent of the total area where N deposition is in exceedance of the most protective CL threshold, considering all species present, across a range of N deposition scenarios and selected sites", "Info for fig13h", "Cumulative percent of the total area protected from negative N deposition impacts using the most protective CL threshold, considering all species present, across a range of N deposition scenarios and selected sites", "Info for fig13d"],["Info for fig13g", "Info for fig6c", "Info for fig13c", "Info for fig6a"]];
        var figDescArrayNdep = [["Figure description for fig13e", "This figure gives a sense of how changing N deposition levels may alter the proportion of area occupied by each species that is likely to experience negative impacts across a range of N deposition levels.", "Figure description for fig13a", "This figure gives a sense of how changing N deposition levels may alter the proportion of area occupied by each species that is protected from negative impacts at the selected area."]];
          figDescArrayNdep.push(["This figure gives a sense of how changing N deposition levels may alter the proportion of forest community as a whole (considering all species present) that is likely to experience negative impacts across a range of N deposition levels, with relative comparisons across selected sites.", "Figure description for fig13h", "This figure gives a sense of how changing N deposition levels may alter the proportion of area protected from negative impacts to the forest community as a whole (considering all species present), with relative comparisons across selected sites.", "Figure description for fig13d"]);
          figDescArrayNdep.push(["Figure description for fig13g", "Figure description for fig6c", "Figure description for fig13c", "Figure description for fig6a"]);

        var figUseArrayNdep = [["Application for fig13e", "This information helps understand how the proportion of area negatively impacted by N deposition may change for each species if deposition levels increased (increasing area in exceedance), or decreased (decreasing area in exceedance).", "Application for fig13e", "This information helps understand how the proportion of area protected against negative impacts may change for each species if deposition levels increased (decreasing protected area), or decreased (increasing protected area)."]];
          figUseArrayNdep.push(["This information helps understand how the proportion of overall forested area that may be impacted by N deposition may change if deposition levels increased (increasing area in exceedance), or decreased (decreasing area in exceedance).", "Application for fig13h", "This information helps understand how the proportion of overall forested area protected against negative impacts may change if N deposition levels increased (reducing protected area), or decreased (increasing protected area).", "Application for fig13d"]);
          figUseArrayNdep.push(["Application for fig13g", "Application for fig6c", "Application for fig13c", "Application for fig6a"]);

        var colorArrayNdep = [["mauve", "mauve", "green", "green"], ["mauve", "mauve", "green", "green"], ["mauve", "mauve", "green", "green"]];




        d3.select("#prevExc").selectAll("*").remove();

        thumbArrayExc.forEach(function(rowArray, i) {
          d3.select("#prevExc")
            .append("div")
            .attr("id", "prevExcRow" + i);

          rowArray.forEach(function(fig, j) {
            d3.select("#prevExcRow" + i)
              .append("div")
              .attr("id", fig + "Div")
              .attr("class", function() { return "prevThumbImgDiv " + colorArrayExc[i][j]; })
              .append("p")
              .text(iconTitleArrayExc[i][j]);

            d3.select("#" + fig + "Div")
              .append("img")
              .attr("id", fig + "Img")
              .attr("class", "prevThumbImg Exc")
              .attr("value", [i,j])
              .property("title", hoverArrayExc[i][j])
              .attr("src", "images/" + fig + ".jpg");

            d3.select("#" + fig + "Div")
              .append("div")
              .attr("class", "thumbGlyphsDiv")
              .html('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figDescArrayExc[i][j] + '"></span><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figUseArrayExc[i][j] + '"></span><span id="' + fig + 'Check" value="' + fig + '" class="glyphicon glyphicon-ok-sign figCheck"></span>');
          });
        });

        //***reset large preview image
        d3.select("#prevLargeImg").style("display", "none");
        d3.select("#prevZoomP").style("display", "none");


        //***Add enlarged view links
        d3.selectAll(".prevThumbImg.Exc")
          .on("click", function() {
            var tmpVals = d3.select(this).attr("value").split(",");
            d3.select("#prevLargeP").text(iconTitleArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevLargeImg")
              .attr("src", "images/" + thumbArrayExc[tmpVals[0]][tmpVals[1]] + ".jpg")
              .style("display", "block")
              .on("mouseover", function() { d3.select("#prevHoverImgDiv").style("display", "block"); })
              .on("mouseout", function() { d3.select("#prevHoverImgDiv").style("display", "none"); });
            d3.select("#prevZoomP").style("display", "block");
            d3.select("#prevDescribeP").html('<b><u>Information</u></b><br>' + figDescArrayExc[tmpVals[0]][tmpVals[1]] + '<br><br><b><u>Application</u></b><br>' + figUseArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImgDiv").attr("class", colorArrayExc[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImg").attr("src", "images/" + thumbArrayExc[tmpVals[0]][tmpVals[1]] + ".jpg");
          });





        d3.select("#prevNdep").selectAll("*").remove();
        thumbArrayNdep.forEach(function(rowArray, i) {
          d3.select("#prevNdep")
            .append("div")
            .attr("id", "prevNdepRow" + i);

          rowArray.forEach(function(fig, j) {
            d3.select("#prevNdepRow" + i)
              .append("div")
              .attr("id", fig + "Div")
              .attr("class", function() { return "prevThumbImgDiv " + colorArrayNdep[i][j]; })
              .append("p")
              .text(iconTitleArrayNdep[i][j]);

            d3.select("#" + fig + "Div")
              .append("img")
              .attr("id", fig + "Img")
              .attr("class", "prevThumbImg Ndep")
              .attr("value", [i,j])
              .property("title", hoverArrayNdep[i][j])
              .attr("src", "images/" + fig + ".jpg");

            d3.select("#" + fig + "Div")
              .append("div")
              .attr("class", "thumbGlyphsDiv")
              .html('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figDescArrayNdep[i][j] + '"></span><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-container="body" data-placement="auto bottom" data-html="true" title="' + figUseArrayNdep[i][j] + '"></span><span id="' + fig + 'Check" value="' + fig + '" class="glyphicon glyphicon-ok-sign figCheck"></span>');
          });
        });

        d3.selectAll(".prevThumbImg.Ndep")
          .on("click", function() {
            var tmpVals = d3.select(this).attr("value").split(",");
            d3.select("#prevLargeP").text(iconTitleArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevLargeImg")
              .attr("src", "images/" + thumbArrayNdep[tmpVals[0]][tmpVals[1]] + ".jpg")
              .style("display", "block")
              .on("mouseover", function() { d3.select("#prevHoverImgDiv").style("display", "block"); })
              .on("mouseout", function() { d3.select("#prevHoverImgDiv").style("display", "none"); });
            d3.select("#prevDescribeP").html('<b><u>Information</u></b><br>' + figDescArrayNdep[tmpVals[0]][tmpVals[1]] + '<br><br><b><u>Application</u></b><br>' + figUseArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImgDiv").attr("class", colorArrayNdep[tmpVals[0]][tmpVals[1]]);
            d3.select("#prevHoverImg").attr("src", "images/" + thumbArrayNdep[tmpVals[0]][tmpVals[1]] + ".jpg");
          });


        //***Add disable function to check mark icon
        d3.selectAll(".figCheck")
          .property("title", "Click to exclude figure from produced output")
          .on("click", function() {
            //if(d3.select(this).classed("glyphicon-ok-sign")) {
            if(d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected") == false) {
              d3.select(this)
                //.classed("glyphicon-ok-sign", false)
                //.classed("glyphicon-ban-circle", true)
                .property("title", "Click to include figure in produced output");
              d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected", true);
            }
            else {
              d3.select(this)
                //.classed("unselected", false)
                //.classed("glyphicon-ban-circle", false)
                //.classed("glyphicon-ok-sign", true)
                .property("title", "Click to exclude figure from produced output");
              d3.select("#" + d3.select(this).attr("value") + "Div").classed("unselected", false);
            }
          });
      }




      //******Add dots to change preview graphs
      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "previewDots")
        .html('<div id="prevDotExc" class="previewDots active" value="prevExc" title="Exceedance by area and species">Page 1</div><div id="prevDotNdep" class="previewDots" value="prevNdep" title="Area exceedance/protection for a given N deposition level">Page 2</div>');

      d3.selectAll(".previewDots")
        .on("click", function() { 
          d3.selectAll(".previewDots").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".outPreviewDivs").style("display", "none");
          d3.select("#" + d3.select(this).attr("value")).style("display", "block");
        });

      //******Add back arrow
      d3.select("#outPreviewChoice")
        .append("div")
        .html('<label class="outBackArrow" title="Return to previous window"><span class="glyphicon glyphicon-arrow-left" style="margin-right:5px;"></span>Back</label>')
        .on("click", function() {
          d3.select("#outputPreview").style("display", "none");
          if(document.querySelector('input[name=outRadio]:checked').value == "tail") {
            d3.select("#outputQuestions").style("display", "block");
          }
          else {
            d3.select("#outputOptions").style("display", "block");
          }
        });

      //******Add button to generate results
      d3.select("#outPreviewChoice")
        .append("div")
        .attr("class", "outButton")
        .style("margin-top", "0")
        .text("Generate Results")
        .property("title", "Produce the selected figures and their associated tables for your data")
        .on("click", function() { 
          get_output();
          d3.select("#waitingDiv").style("display", "block");
          d3.select("#container-results").style("display", "none");
          d3.select("#selRes").classed("disabled", false).property("title", "View results");
          //d3.selectAll(".selDiv").classed("selected", false);
          //d3.select("#selRes").classed("selected", true);
        });

      d3.select("#outPreviewChoice")
        .append("div")
        .attr("id", "waitingDiv")
        .html('<img src="images/animated-gears.gif"></img><h3>Processing</h3>');






      function get_output() {
        var tmpAreas = [];
        d3.selectAll(".remCheck")[0].forEach(function(d) { if(d.checked) { tmpAreas.push(d.value); } });

        var tmpSpp = [];
        d3.selectAll(".sppCheck")[0].forEach(function(d) { if(d.checked) { tmpSpp.push(speciesNames[d.value]); } });

        switch(document.querySelector('input[name=outRadio]:checked').value) {
          case "basic":
            var tmpVals = {"type":"comp", "area": d3.select("#areaList").attr("value"), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
          case "tail":
            var tmpVals = {"type":"comp", "area": d3.select("#areaList").attr("value"), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
          case "comp":
            var tmpVals = {"type":"comp", "area": d3.select("#areaList").attr("value"), "areas": tmpAreas, "species": tmpSpp};
            socket.emit('get_output', tmpVals);
            break;
        }
      }







      //******Add results div
      d3.select("#right_panel_container")
        .append("div")
        .attr("id", "resChoice")
        .attr("class", "choice")
        .style("display", "block")
        .append("div")
        .attr("id", "resHeader")
        .html('<div class="choiceHeader" style="background:rgb(255,192,0);">Results</div><ul id="ulRes" class="nav nav-pills"><li id="resFigs" class="active" title="Graph output"><a href="#">Graphs</a></li><li id="resTabs" title="Table output"><a href="#">Tables</a></li><li id="resMaps" title="Critical load and exceedance maps for combined species and selected individual species"><a href="#">Maps</a></li></ul><hr style="margin:0;">');

      d3.select("#resChoice")
        .append("div")
        .attr("id", "resSubHeader")
        .html('<div><ul id="ulResSub" class="nav nav-pills"><li id="resFigsCurrent" class="active" title="Critical load and exceedance output for current N deposition levels"><a href="#" style="background-color:rgb(180,198,231);">Current Condition</a></li><li id="resFigsResponse" title="Cumulative exceedance and protection output for varying levels of N deposition"><a href="#" style="background-color:rgb(255,230,153);">Response to N Dep</a></li></ul></div><hr style="margin:0;"><div id="resSubSubHeader"><div id="resSubSubCurrent" class="resSubSub"><ul id="ulResSubSubCurrent" class="nav nav-pills"></ul></div><div id="resSubSubResponse" class="resSubSub"><ul id="ulResSubSubResponse" class="nav nav-pills"></ul></div><hr style="margin:0;"></div>');

      d3.select("#ulResSubSubCurrent")
        .html('<li id="ExAreaPill" class="li3 active" title="Measures of exceedance for areas and species"><a href="#" class="pink">EXC Area</a></li><li id="ExMagPill" class="li3" title="Extent and magnitude of exceedance for areas and species" style="width:33%;"><a href="#" class="blue">EXC Magnitude</a></li><li id="CLPill" class="li3" title="Critical load sensitivities to N deposition for species and areas based on site conditions"><a href="#" class="yellow">CL</a></li>')
        .selectAll("li")
          .on("click", function() {
            d3.select("#ulResSubSubCurrent").selectAll("li").classed("active", false);
            d3.select(this).classed("active", true);
            setSubHeader();
          });

      d3.select("#ulResSubSubResponse")
        .html('<li id="ExcPill" class="li2 active" title="Cumulative measure of increase in exceedance over varying levels of N deposition"><a href="#" class="mauve">Area Exceeded</a></li><li id="ProPill" class="li2" title="Cumulative measure of decrease in protection over varying levels of N deposition"><a href="#" class="green">Area Protected</a></li>')
        .selectAll("li")
          .on("click", function() {
            d3.select("#ulResSubSubResponse").selectAll("li").classed("active", false);
            d3.select(this).classed("active", true);
            setSubHeader();
          });

      d3.select("#resChoice")
        .append("div")
        .attr("id", "resOptions")
        .html('<div id="resFigsDiv" class="results"><div id="resFigsExArea"></div><div id="resFigsExMag"></div><div id="resFigsCL"></div><div id="resFigsExc"></div><div id="resFigsPro"></div></div><div id="resTabsDiv" class="results"><div id="resTabsCurrent"></div><div id="resTabsResponse"></div></div><div id="resMapsDiv" class="results"></div>');
        //.html('<div id="resFigsDiv" class="results"><div id="resFigsExArea"></div><div id="resFigsExMag"></div><div id="resFigsCL"></div><div id="resFigsExc"></div><div id="resFigsPro"></div></div><div id="resTabsDiv" class="results"><div id="resTabsExArea"></div><div id="resTabsExMag"></div><div id="resTabsCL"></div><div id="resTabsExc"></div><div id="resTabsPro"></div></div><div id="resMapsDiv" class="results"></div>');
      
      d3.select("#resFigsDiv").selectAll("div").attr("class", "resFigsSub");
      d3.select("#resTabsDiv").selectAll("div").attr("class", "resTabsSub");

      //******Add pill functionality
      d3.select("#resFigs")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 166px");
          d3.select("#resFigsDiv").style("display", "block");
        });

      d3.select("#resTabs")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 128px");
          d3.select("#resTabsDiv").style("display", "block");
          setTimeout(function() {
            d3.select("#resTabsDiv").selectAll("canvas")[0].forEach(function(tmpCan) {
              chartCanvas[tmpCan.id + "Small"].update();
              var tmpPrint = chartCanvas[tmpCan.id + "Small"];
              var tmpRect = document.getElementById(tmpCan.id).getBoundingClientRect();
              addInfo(tmpPrint, chartOpts[tmpCan.id].small.cl[0], tmpRect, "small", 1, tmpCan.id);
            });
          }, 300);
        });

      d3.select("#resMaps")
        .on("click", function() {
          d3.select("#ulRes").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          d3.selectAll(".results").style("display", "none");
          d3.select("#resOptions").style("max-height", "calc(100% - 87px");
          d3.select("#resMapsDiv").style("display", "block");
          setSubHeader();
          //d3.select("#speciesListDropdown").style("display", "inline-block");
          d3.select("#container-results").style("display", "none");
          //if(d3.select("#left_collapse_glyph").classed("glyphicon-triangle-left")) {
          //  toggleSelections("left_collapse");
          //}
        });


      //***Subhead pill functionality
      d3.select("#resFigsCurrent")
        .on("click", function() {
          d3.select("#ulResSub").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
        });

      d3.select("#resFigsResponse")
        .on("click", function() {
          d3.select("#ulResSub").selectAll("li").classed("active", false);
          d3.select(this).classed("active", true);
          setSubHeader();
        });



      //******Add procedural steps action
      d3.select("#selRes").on("click", function() { stepAction(this); });

      //*****Initialize display
      setSubHeader();
      d3.select("#resFigsDiv").style("display", "block");




      //*******Function to change which output is displayed
      function setSubHeader() {
        if(d3.select("#ulRes").select(".active").attr("id") == "resFigs") {
          d3.select("#resSubHeader").style("display", "block");
          d3.select("#resSubSubHeader").style("display", "block");         
          d3.selectAll(".resSubSub").style("display", "none");
          d3.selectAll(".resFigsSub").style("display", "none");

          if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsCurrent") {
            d3.select("#resSubSubCurrent").style("display", "block");
            d3.select("#resFigs" + d3.select("#ulResSubSubCurrent").select(".active").attr("id").replace("Pill","")).style("display", "block");              
          }
          else if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsResponse") {
            d3.select("#resSubSubResponse").style("display", "block");
            d3.select("#resFigs" + d3.select("#ulResSubSubResponse").select(".active").attr("id").replace("Pill","")).style("display", "block");
          }
        }
        else if(d3.select("#ulRes").select(".active").attr("id") == "resTabs") {
          d3.select("#resSubHeader").style("display", "block"); 
          d3.select("#resSubSubHeader").style("display", "none");         
          d3.selectAll(".resSubSub").style("display", "none");
          d3.selectAll(".resTabsSub").style("display", "none");

          if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsCurrent") {
            d3.select("#resTabsCurrent").style("display", "block");
            //d3.select("#resSubSubCurrent").style("display", "block");
            //d3.select("#resTabs" + d3.select("#ulResSubSubCurrent").select(".active").attr("id").replace("Pill","")).style("display", "block");              
          }
          else if(d3.select("#ulResSub").select(".active").attr("id") == "resFigsResponse") {
            d3.select("#resTabsResponse").style("display", "block");
            //d3.select("#resSubSubResponse").style("display", "block");
            //d3.select("#resTabs" + d3.select("#ulResSubSubResponse").select(".active").attr("id").replace("Pill","")).style("display", "block");
          }
        }
        else if(d3.select("#ulRes").select(".active").attr("id") == "resMaps") {
          d3.select("#resSubHeader").style("display", "none");
        }

      }




      function addFigure(src) {
        d3.select("#resImg").property("src", src);
        d3.selectAll(".container-menu").style("display", "none");
        d3.select("#container-results").style("display", "block");
      }


      //d3.select("body").append("img").attr("src", "graphs/n_protection_eco3.png").style({"position": "fixed", "top": "100px"});

      //d3.select(".leaflet-control-layers-base").property("title", "Click on radio button to change the baselayer option");
      //d3.select(".leaflet-control-layers-overlays").property("title", "Check the box to add layer to map (may be slight delay)");

      //******Add custom weighting tool
      //var customWeight = new L.Control.customWeight();
      //map.addControl(customWeight);
      //completePrioritization();

      //******Add graph tool
      //L.control.graph().addTo(map);

      //******Add Download tool - use temporarily as graph display
      //var downLoadFile = new L.Control.downLoadFile();
      //map.addControl(downLoadFile);
      //completeGraph();

      //******Add Print/download tool
      //var printMap = new L.Control.print();
      //map.addControl(printMap);
      d3.select("#toolbar") //("#mainMenu").select(".container-fluid")
        .append("div")
        .attr("class", "pull-right")
        .attr("id", "printDownload")
        .html('<span id="resetControl" class="glyphicon glyphicon-refresh" title="Reset all selections" onclick="resetSelections()"></span><span id="legendControl" class="glyphicon glyphicon-list" title="View legend window" onclick="toolWindowToggle(&quot;legend&quot;)"></span><span id="downloadControl" class="glyphicon glyphicon-download-alt" title="Download spatial data" onclick="toolWindowToggle(&quot;download&quot;)"></span><span id="printControl" class="glyphicon glyphicon-print" title="Print current map" onclick="window.print()"></span>');


      //******Function to reset all selections
      function resetSelections() {
        d3.selectAll(".remCheck")[0].forEach(function(d) {
          if(d3.select(d).property("checked") == true) {
            $(d).click();
          }
        });

        d3.selectAll(".activeArea")[0].forEach(function(d) {
          if(d3.select(d).style("visibility") == "visible") {
            $(d).click();
          }
        });
        stepAction(d3.select("#selArea")[0][0]);
        d3.select("#areaListDropdown").style("display", "inline-block");
      }


      //******Make tooltip for displaying attribute data
      var tooltip = d3.select("body")
        .append("div")
        .attr("id", "d3Tooltip")
        .attr("class", "d3Tooltip");

      //******Make header div
      d3.select("body")
        .append("div")
        .attr("class", "header")
        .style({"padding":"5px 10px", "height":"75px", "background-image":"url('images/tree_banner.jpg')", "background-size":"cover", "bottom-border":"2px solid black"})
        .html('<a href="https://www.usda.gov/" target="_blank"><img src="images/USDA color.jpg" title="United States Department of Agriculture" style="height:60px; margin-right:15px; margin-top:3px; border:solid black 1px; border-radius:4px; float:left;"></a><a href="https://www.fs.fed.us/" target="_blank"><img src="images/shield_color.png" title="U.S. Forest Service" style="height:66px; margin-right:15px; float:left;"></a><h2 style="margin:0px; margin-top:0px; font-size:38px;"><b>N-CLAS:</b> Nitrogen Critical Loads Assessment by Site<br><h4 style="margin:0px"><i>High resolution, spatially explicit critical load and exceedance mapping to inform sustainable forest management</i></h4></h2>');

      //*******Make LOADING div
      d3.select("body")
        .append("div")
        .attr("class", "helpBackground")
        .attr("id", "loadingDiv")
        .append("h1")
        .text("LOADING...")
        .style("font-weight", "bold")
        .attr("id", "loading"); 

      //*******Make Help/information div
      d3.select("body")
        .append("div")
        .attr("class", "modal fade ui-draggable in")
        .attr("id", "helpDiv")
        .style("display", "none")
        .append("div")
        .attr("class", "modal-dialog modal-lg")
        .attr("id", "infoDiv")
        .append("div")
        .attr("class", "helpHeader")
        .text("N-CLAS: Nitrogen Critical Loads Explorer")
        .append("span")
        .attr("class", "glyphicon glyphicon-remove-sign pull-right minimize-button")
        .attr("data-toggle", "modal")
        .attr("data-target", "#helpDiv")
        .property("title", "Close help");
        
      d3.select("#infoDiv")
        .append("hr")
        .attr("class", "hr");

      d3.select("#infoDiv")
        .append("div")
        .text("Helpful information coming soon...");

      function changeGlyph(tmpEl) {
        var selEl = d3.select("#" + tmpEl.id);
        if (selEl.classed("glyphicon-minus-sign")) {
          selEl.classed("glyphicon-minus-sign", false);
          selEl.classed("glyphicon-plus-sign", true);
          tmpEl.title = "Click to maximize panel";
        }
        else {
          selEl.classed("glyphicon-plus-sign", false);
          selEl.classed("glyphicon-minus-sign", true);
          tmpEl.title = "Click to minimize panel";
        }
      }




      //******Make variables for d3 topoJSON and TSV data
      var topos = {};  //global topoJSON files variable
      var brush = {};   //global brush variable
      var hist = {};   //global histogram object variable
      var graphs = [];   //global list of current graphs variable
      var layers = [];   //global list of topoJSON map layers
      var area2layer = {};   //global object for getting topojson layer name
      var topoClickArray = []  //global topojson feature click function array for storage when disabling click events
      var layersShow = []; //global list of topoJSON map layer formal names
      var crossingCov = [];  //global array of crossing covariate data 
      var toggleWords = {"legend":"Layers", "preferences":"Preferences", "download":"Downloads"}
      var legendDivs = [];   //global array of active legends
      var chartOpts = {};   //global chart option variable
      var chartCanvas = {};   //global canvas id variable
      var outSpecies = localStorage.getItem('outSpecies');   //global species naming convention for output
      var sppColors = {"Abies balsamea":"255, 0, 0", "Acer rubrum":"255, 79, 0", "Acer saccharum":"255, 116, 0", "Betula alleghaniensis":"255, 146, 0", "Betula papyrifera":"255, 173, 0", "Castanea dentata":"255, 198, 0", "Fagus grandifolia":"255, 223, 0", "Fraxinus americana":"255, 247, 0", "Fraxinus pennsylvanica":"215, 231, 0", "Juglans cinerea":"155, 197, 0", "Picea mariana":"94, 162, 0", "Picea rubens":"0, 128, 0", "Pinus resinosa":"75, 107, 88", "Pinus rigida":"88, 83, 150", "Pinus strobus":"72, 50, 212", "Populus grandidentata":"31, 0, 243", "Populus tremuloides":"60, 0, 208", "Quercus alba":"71, 0, 174", "Quercus prinus":"75, 0, 141", "Quercus rubra":"105, 28, 149", "Thuja occidentalis":"149, 62, 178", "Tsuga canadensis":"193, 96, 208", "Ulmus americana":"238, 130, 238"};  //Colors for species in graphs
      //var sppColors = {"Abies balsamea":"#ff0000", "Acer rubrum":"#ff4f00", "Acer saccharum":"#ff7400", "Betula alleghaniensis":"#ff9200", "Betula papyrifera":"#ffad00", "Castanea dentata":"#ffc600", "Fagus grandifolia":"#ffdf00", "Fraxinus americana":"#fff700", "Fraxinus pennsylvanica":"#d7e700", "Juglans cinerea":"#9bc500", "Picea mariana":"#5ea200", "Picea rubens":"#008000", "Pinus resinosa":"#4b6b58", "Pinus rigida":"#585396", "Pinus strobus":"#4832d4", "Populus grandidentata":"#1f00f3", "Populus tremuloides":"#3c00d0", "Quercus alba":"#4700ae", "Quercus prinus":"#4b008d", "Quercus rubra":"#691c95", "Thuja occidentalis":"#953eb2", "Tsuga canadensis":"#c160d0", "Ulmus americana":"#ee82ee"};  //Colors for species in graphs
      var areaColors = {};
      areaColors["States"] = ['#ff0000','#ff6200','#ff9000','#ffb700','#ffdc00','#ffff00','#a7cc00','#4c9900','#427147','#584da2','#0000ff','#3e00cb','#4a009a','#6c1f97','#ac50c2','#ee82ee'];
      areaColors["Ecoregions Combined"] = ['#ffa500'];
      areaColors["Ecoregions Level 2"] = ['#cc5200','#0000ff','#00e600'];
      areaColors["Ecoregions Level 3"] = ['#4D2600','#FFB3FF','#004D00','#990099','#000000','#B35900','#000099','#FFFF00','#FF0000','#0066FF','#00FF00','#FF9900'];
      areaColors["Forest Service Wilderness Areas"] = ['#ff0000','#ff4300','#ff6200','#ff7a00','#ff9000','#ffa500','#ffb700','#ffca00','#ffdc00','#ffed00','#ffff00','#d3e500','#a7cc00','#7bb200','#4c9900','#008000','#427147','#556075','#584da2','#4b35d0','#0000ff','#2e00e5','#3e00cb','#4600b2','#4a009a','#4b0082','#6c1f97','#8c38ac','#ac50c2','#cd69d8','#ee82ee'];
      areaColors["Forest Service Admin Areas"] = ['#ff0000','#ff8b00','#ffd300','#c8df00','#008000','#503cc4','#4200bf','#74259c','#ee82ee'];
      areaColors["Class I Areas"] = ['#ff0000','#ff7a00','#ffb700','#ffed00','#a7cc00','#008000','#584da2','#2e00e5','#4a009a','#8c38ac','#ee82ee'];
      var legImg = [];
      legImg[0] = new Image();
      legImg[0].src = "images/tab3bLegend.jpg";
      legImg[1] = new Image();
      legImg[1].src = "images/tab3cLegend.jpg";


      Chart.plugins.register({
        beforeDraw: function(chartInstance) {
          var ctx = chartInstance.chart.ctx;
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
        }
      });

      Chart.defaults.global.defaultFontColor = 'black';
      //var red_white_red
      chartOpts.default = {};
      chartOpts.default.bar = {
        type: 'bar',
        data: {
          //labels: tmpAreasFiltSplit,
          datasets: [{
            //data: tmpPercentFilt,
            backgroundColor: 'rgba(192, 0, 0, 1)',
            borderColor: 'rgba(192, 0, 0, 1)',
            borderWidth: 2,
            hoverBackgroundColor: 'rgba(192, 0, 0, 0.8)',
            hoverBorderColor : 'black'
          }]
        },
        options: {
          layout: {
            padding: {
              layout: {
                left: 5,
                right: 5,
                top: 5,
                bottom: 5
              }
            }
          },
          title: {
            display: true,
            fontSize: 8,
            //text: 'Exceedance of Most Protective Critical Load'
          },
          legend: {
            display: false,
            labels: {
              padding: 10
            }
          },
          scales: {
            yAxes: [{
              position: 'left',
              scaleLabel: {
                display: true,
                //labelString: '% Area in Exceedance of CL',
                fontSize: 7
              },
              ticks: {
                beginAtZero:true,
                fontSize: 6,
                maxTicksLimit: 6
              },
              gridLines: {
                color: 'rgba(0,0,0,0.3)'
              }
            }],
            xAxes: [{
              position: 'bottom',
              barPercentage: 0.3,
              categoryPercentage: 1,
              ticks: {
                autoSkip: false,
                beginAtZero: true,
                min: 0,
                display: true,
                fontStyle: 'normal',
                //fontSize: setFontSizeSmall(d3.select("#areaList").attr("value")),
                stepSize: 1
              },
              gridLines: {
                color: 'rgba(0,0,0,0.3)',
                display: false
              }
            }, {
              position: 'top',
              barPercentage: 0.3,
              categoryPercentage: 1,
              scaleLabel: {
                display: true,
                //labelString: d3.select("#areaList").attr("value") + ", Combined Species",
                fontSize: 8
              },
              ticks: {
                display: false
              },
              gridLines: {
                display: false
              }
            }]
          }
        }
      }



      //******Add in custom color pallate for streams
      colorbrewer.streams = {};
      colorbrewer.streams["5"] = ["#081d58","#253494","#225ea8","#1d91c0","#41b6c4"];
      colorbrewer.streams["6"] = ["#081d58","#253494","#225ea8","#1d91c0","#41b6c4", "#7fcdbb"];



      //******Wait for all topoJSON files to load
      queue()
        .defer(d3.json, 'class_1_areas_topo.json')
        .defer(d3.json, 'fs_wilderness_topo.json')
        .defer(d3.json, 'fs_admin_areas_topo.json')
        .defer(d3.json, 'ecoregions_level_3_topo.json')
        .defer(d3.json, 'ecoregions_level_2_topo.json')
        .defer(d3.json, 'ecoregions_topo.json')
        .defer(d3.json, 'states_topo.json')
        //.defer(d3.tsv, 'crossings_covariates_rof_delay.tsv')
        //.defer(d3.tsv, 'catchments_covariates.tsv')
        //.defer(d3.tsv, 'streams_covariates.tsv')
        //.defer(d3.tsv, 'catchments_political.tsv')
        //.defer(d3.tsv, 'covariate_info.tsv')
        .await(displayIt);







      //******Bind topoJSON data
      function displayIt(error, class1Data, fsWildData, fsData, eco3Data, eco2Data, ecoData, stateData) {
        topos.class1 = topojson.feature(class1Data, class1Data.objects.class_1_wilderness_areas_ecoregions_wgs84);
        topos.fs_wild = topojson.feature(fsWildData, fsWildData.objects.fs_wilderness_ecoregions_wgs84);
        topos.fs = topojson.feature(fsData, fsData.objects.fs_admin_areas_ecoregions_wgs84);
        topos.eco3 = topojson.feature(eco3Data, eco3Data.objects.ecoregions_level_3_L3NAME_dissolved_wgs84);
        topos.eco2 = topojson.feature(eco2Data, eco2Data.objects.ecoregions_level_2_L2NAME_dissolved_wgs84);
        topos.eco = topojson.feature(ecoData, ecoData.objects.ecoregions_dissolved_wgs84);
        topos.state = topojson.feature(stateData, stateData.objects.states_names_ecoregions_wgs84);

        //******Add properties to topos and push layer (class name, SVG g object, unique identifier short_heading, colorbrewer class)
        areaID.forEach(function(tmpID, i) {
          addProps(tmpID, areaLayers[i], "unique_id", "RdYlBu");
        });

        topos.eco.color = {"All_Ecoregions": "orange"};
        topos.eco2.color = {"Atlantic_Highlands": "#cc5200", "Mixed_Wood_Plains": "#0000ff", "Mixed_Wood_Shield": "#00e600"};
        topos.eco3.color = {"Acadian_Plains_and_Hills": "#4D2600", "Driftless_Area": "#FFB3FF", "Eastern_Great_Lakes_Lowlands": "#004D00", "Erie_Drift_Plain": "#990099", "North_Central_Appalachians": "#000000", "North_Central_Hardwood_Forests": "#B35900", "Northeastern_Coastal_Zone": "#000099", "Northern_Appalachian_and_Atlantic_Maritime_Highlands": "#FFFF00", "Northern_Allegheny_Plateau": "#FF0000", "Northern_Lakes_and_Forests": "#0066FF", "Northern_Minnesota_Wetlands": "#00FF00", "Southern_Michigan/Northern_Indiana_Drift_Plains": "#FF9900"};

        //******Create area to layer key
        area2layer = {"Class I Areas":"class1", "Forest Service Wilderness Areas":"fs_wild", "Forest Service Admin Areas":"fs", "Ecoregions Level 3":"eco3", "Ecoregions Level 2":"eco2", "Ecoregions Combined":"eco", "States":"state"};

        //******Get feature ids
        layers = ["class1", "fs_wild", "fs", "eco3", "eco2", "eco", "state"];
        layers.forEach(function(layer) {
          topos[layer].names = [];
          topos[layer].features.forEach(function(d) {
            topos[layer].names.push(d.id);
          });
          topos[layer].names.sort();
        });

        //******Get species names
        topos.species = {};
        topos.species.latin = speciesNames;
        topos.species.common = speciesTitles;
        topos.species.id = speciesID;
/*
        //******Add covariate TSV files to topojson
        crossCov = readTSV(crossCov, topos.crossings);
        catchCov = readTSV(catchCov, topos.catchments);
        streamCov = readTSV(streamCov, topos.streams);
       
        //******Read in political featureids
        topos.political = strToNum(political);        

        //******Add covariate title and description information
        var tmpLayers = ["crossings", "catchments", "streams", "political"];
        tmpLayers.forEach(function(d) {
          topos[d]["title"] = {};
          topos[d]["title"]["unique_id"] = "Unique ID";
          topos[d]["title"]["featureid"] = "Catchment ID";
          topos[d]["tooltip"] = {};
          topos[d]["unit"] = {};
          topos[d]["direction"] = {};
          topos[d]["data_type"] = {};
          topos[d]["scale"] = {};
          topos[d]["display"] = {};
          topos[d]["conversion"] = {};
          topos[d]["minVal"] = {};
          topos[d]["maxVal"] = {};
          topos[d]["minClip"] = {};
          topos[d]["maxClip"] = {};
          topos[d]["max"] = {};
        });

        covInfo.forEach(function(d) {
          topos[d.layer]["title"][d.short_heading] = d.long_heading;
          topos[d.layer]["tooltip"][d.short_heading] = d.tooltip;
          topos[d.layer]["unit"][d.short_heading] = d.unit;
          topos[d.layer]["direction"][d.short_heading] = d.direction;
          topos[d.layer]["data_type"][d.short_heading] = d.data_type;
          topos[d.layer]["scale"][d.short_heading] = d.scale;
          topos[d.layer]["display"][d.short_heading] = d.display;
          topos[d.layer]["conversion"][d.short_heading] = {};
          if (jQuery.isEmptyObject(d.conversion) == false) {
            topos[d.layer]["conversion"][d.short_heading] = JSON.parse(d.conversion);
          }
          topos[d.layer]["conversion"][d.short_heading]["raw"] = d.conversion;
        });

        //******Get keys for covariate data
        topos.crossings.keys = d3.keys(crossCov[0]);
        topos.catchments.keys = d3.keys(catchCov[0]);
        topos.streams.keys = d3.keys(streamCov[0]);
        topos.political.keys = d3.keys(political[0]);

        //******Transform covariate data if necessary
        var tmpLayers = [[crossCov, "crossings"], [catchCov, "catchments"], [streamCov, "streams"]];
        tmpLayers.forEach(function(d) {
          topos[d[1]].keys.forEach(function(key) {
            var tmpMax = d3.max(d[0], function(data) {return data[key];});
            topos[d[1]]["max"][key] = tmpMax;
            //topos[d[1]]["min"][key] = d3.min(d[0], function(data) { if(data[key] != -9999) {return data[key];} });
            d[0].forEach(function(row) {
              switch(topos[d[1]]["scale"][key]) {
                case "log":
                  if (row[key] != -9999) {
                    row[key] = Math.log(row[key] + 0.1);
                  }
                  break;
                case "log_rec":
                  if (row[key] != -9999) {
                    row[key] = -(Math.log(tmpMax + 0.1 - row[key]));
                  }
              }
            });
          });
        });


        //******Make crossfilter dimensions
        cfDimension(topos.crossings, crossCov);
        cfDimension(topos.catchments, catchCov);
        cfDimension(topos.streams, streamCov);

        //******Release covariate data
        crossingCov = crossCov;  //keep to add weighted ROF covariates to
        crossCov = null;
        catchCov = null;
        streamCov = null;
*/

        //******Set d3 map data
        bounds = d3.geo.bounds(topos.state);
        path = d3.geo.path()
                 .projection(projectPoint)
                 .pointRadius(3.5);

        //******Add drop down box to select crossing attribute for styling
        //addLegend(topos.crossings);
        //addLegend(topos.catchments);
        //addLegend(topos.streams);

        //******Add drop down box to select political filter class and type for filtering
        //addPolFilters(topos.political);

        //******Add drop down box to select attributes for filtering
        //addFilterLayers(layers);

        //******Add the pair-wise links to the spatial join div
        //addCFLinks(layers);
        
        //******Add topoJSON layers
        //d3.select("#areaLayer-1").property("checked", true);
        //map.addLayer(areaLayers[1]);

        //******Set area options
        //addAreaNames(1);
        
        //******Set map view
        map.on("viewreset", reset);
        reset();

        //******Display preferences window if first time or not checked
        if(localStorage.getItem("showPref") != "true") {
          toolWindowToggle("preferences");
        }

        //******Run splash and intro for first time users
        d3.select("#disableSplash").property("checked", function() { if(localStorage.getItem('disableSplash') == "true") { return true; } else { return false; } });
        if(localStorage.getItem('disableSplash') != "true") {
          d3.select("#splashScreen").style("display","flex");
        }
        //else if(localStorage.getItem('doneTour') != 'yeah!') {
        //  startIntro();
        //}

        //******Remove "Loading..." text
        d3.select("#loadingDiv").style("display", "none");
        resizePanels();
      }


      //******Function to toggle tool windows
      function toolWindowToggle(tmpDiv) {
        if (d3.select("#" + tmpDiv + "Div").style("opacity") == "1") {
          d3.select("#" + tmpDiv + "Div").transition().style({"opacity":"0", "visibility":"hidden"});
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to show " + toggleWords[tmpDiv] + " window");
          
        }
        else {
          d3.select("#" + tmpDiv + "Div").transition().duration(250).ease("cubic").style({"opacity":"1", "display":"block", "visibility":"visible"});            
          d3.select("#hc" + tmpDiv.charAt(0).toUpperCase() + tmpDiv.slice(1) + "Div").property("title", "Click to hide " + toggleWords[tmpDiv] + " window");
          setZ(d3.select("#" + tmpDiv + "Div")[0][0]);
        }
      }

      


      //******Add attribute names and values to table
      function getAttributes(tmpFeat, topo, opacity) {
        if (opacity == 0) {return;}
        d3.select("#attributesDiv").style("display", "block");
        d3.select("#attributesControl").property("title", "Click to hide feature attributes window");

        var tmpArray = topo.keys.map(function(d) { return {"att": d, val: formatAtt(topo, d, tmpFeat[d]) }; } );
        var columns = ["att", "val"]

        var rows = d3.select("#attValuesTable").selectAll('.attTR')
          .data(tmpArray);
        rows.exit().remove();
        rows.enter()
          .append('tr')
          .attr("class", "attTR");          

        var cells = rows.selectAll("td")
          .data(function(row) {
            return columns.map(function (column) {
              return {column: column, value: row[column]};
            });
          });
        cells.enter()
            .append('td')
            .attr("class", "attTD");
        cells
          .text(function(d) { if (d.column == "att") {return formatTitle(topo, d.value);} else {return d.value;} })
          .property("title", function(d) {if (d.column == "att") {return topo.tooltip[d.value];} else {return d.value;} });
      }


      //******Format title and units
      function formatTitle(topo, att) {
        if (topo.unit[att]) {
          return topo.title[att]  + " (" + topo.unit[att] + ")";
        }
        else {
          return topo.title[att];
        }
      }


      //******Format data by its data_type
      function formatAtt(topo, att, val) {
        switch (topo.data_type[att]) {
          case "decimal":
            var tmpVal = val.toFixed(2);
            break;
          case "text":
            if (Object.keys(topo.conversion[att]).length == 1) {
              var tmpVal = val;
            }
            else {
              var tmpVal = topo.conversion[att][val];
            }
            break;
          case "integer":
            var tmpVal = val;
            break;
          case "date":
            var tmpTime = d3.time.format("%-m/%-d/%Y");
            var tmpVal = tmpTime(new Date(val));
            break;
        }
        if (Math.floor(val) == -9999) { tmpVal = "No Data"; };
        return tmpVal;
      }




      //******Add checkboxes to link crossfilters
      function addCFLinks(tmpLayers) {
        tmpLayers.forEach(function(layer1, i) {
          tmpLayers.forEach(function(layer2, j) {
            if (j > i) {
              d3.select("#linkLayers")
                .append("div")
                .attr("class", "hoverDiv")
                .attr("id", layer1 + "-" + layer2 + "-link")
                .property("title", "Check to spatially link the " + layer1.slice(0,-1) + " and " + layer2.slice(0,-1) + " layers");

              d3.select("#" + layer1 + "-" + layer2 + "-link")
                .append("input")
                .attr({type: "checkbox", name: layer1 + "-" + layer2 + "-check"})
                .attr("id", layer1 + "-" + layer2 + "-check")
                .attr("class", "linkCheck")
                .property("checked", false)
                .on("click", function() { checkLink("featureid", layer1, true); });   //Layer1 doesn't matter, just a placeholder

              d3.select("#" + layer1 + "-" + layer2 + "-link")
                .append("label")
                .text("Link " + layer1 + " & " + layer2)
                .attr("class", "linkLabel")
                .attr("id", layer1 + "-" + layer2 + "-linkLabel");
            }
          });
        });
      }
     



      //******Add properties to topos and push layer
      function addProps(tmpName, tmpG, tmpID, tmpColor) {
        topos[tmpName].class = tmpName;
        topos[tmpName].g = tmpG;
        topos[tmpName].uniqueID = tmpID;
        topos[tmpName].covType = {};
        topos[tmpName].filter = {};
        topos[tmpName].binWidth = {};
        topos[tmpName].color = tmpColor;
        brush[tmpName] = {};
        hist[tmpName] = {};
        layers.push(tmpName);
      }



      function addPolFilters(topo) {
        d3.select("#classPolFilterCell")
          .append("div")
          .attr("id", "classPolFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Class");

        var select = d3.select("#classPolFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "classPolFilterSelect")
          .property("title", "Select class to use its values as options in the adjacent 'Area' selection box") 
          .on("change", function() { addPolFilterTypes(topo, this.value); });

        var optData = topo.keys.filter(function(key) { return key != "unique_id" && key != "featureid"; });

        select.selectAll("option")
          .data(optData)
          .enter()
            .append("option")
              .attr("value", function (d) { if(d != "featureid") { return d;} })
              .text(function (d) { if(d != "featureid") {return topos.political.title[d];} });

        //******Add attribute selection box
        d3.select("#typePolFilterCell")
          .append("div")
          .attr("id", "typePolFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Area");

        var select = d3.select("#typePolFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "typePolFilterSelect")
          .style("width", "130px");

        //******Add clear all button
        d3.select("#polFilterSelectDiv")
          .append("button")
          .text("Clear All")
          .property("title", "Click to remove all applied filters")
          .on("click", function() { 
            var tmpArray = topos.political.condition.slice();
            tmpArray.forEach(function(cond) {
              var i = cond.indexOf("-") + 1;
              var j = cond.lastIndexOf("-");
              removeCondition(topo, cond, cond.slice(i,j), cond.slice(j+1)); 
            });
          });



        //******Make crossfilter groups
        topo.filter = {};
        var tmpCF = crossfilter(topo);
        topo.filter.all = tmpCF.groupAll();

        topo.keys.forEach(function(key, i) {
          topo.filter[key] = tmpCF.dimension(function(d) { return d[key]; } );
          topo.filter[key + "s"] = topo.filter[key].group();
        });

        //******Make array for holding filter conditions
        topo.condition = [];

        //******Initialise with first layer
        addPolFilterTypes(topo, topo.keys[0]);
      }



      function addPolFilterTypes(topo, tmpKey) {
        var select = d3.select("#typePolFilterSelect")
          .property("title", "Select an area to filter features in the Crossings, Catchments, and Streams layers to those intersecting that area")
          .on("change", function() { addPolFilter(topo, tmpKey, this.value); });

        //Get grouped data from crossfilter
        var optData = topo.filter[tmpKey + "s"].all();
        optData = optData.map(function(d) { return d.key; } );
        optData.splice(0,0, "...");

        var options = select.selectAll("option")
          .data(optData);
       
        options.exit().remove();
        options.enter()
          .append("option");
        options
          .attr("value", function (d, i) { return optData[i].toString().replace(/ /g, "_"); })
          .text(function (d, i) { return optData[i]; });

        //******Set selected index to 0
        d3.select("#typePolFilterSelect")
          .property("selectedIndex", function() {return 0;});
      }

     
      function addPolFilter(topo, tmpClass, tmpArea) {
        var tmpID = "polFilter-" + tmpClass + "-" + tmpArea;

        if (topo.condition.indexOf(tmpID) == -1 && tmpArea != "...") {
          topo.condition.push(tmpID);

          d3.select("#polFilterConditions")
            .append("div")
            .attr("class", "polFilterCond")
            .attr("id", tmpID)
            .append("p")
            //.text(tmpClass.charAt(0).toUpperCase() + tmpClass.slice(1) + " = " + tmpArea.replace(/_/g, " "))
            .text(topo.title[tmpClass] + " = " + tmpArea.replace(/_/g, " "))
            .style("display", "inline-block")
            .style("margin", "0px");

          d3.select("#" + tmpID)
            .append("div")
              .attr("class", "btn btn-default btn-xs pull-right")
              .attr("id", "polFilterRemove-" + tmpClass + "-" + tmpArea)
              .text("x")
              .property("title", "Click to remove filter condition for " + tmpClass.charAt(0).toUpperCase() + tmpClass.slice(1) + " = " + tmpArea.replace(/_/g, " "))
              .on("click", function() { removeCondition(topo, tmpID, tmpClass, tmpArea); });
          
          //******Add filter to crossfilter
          applyPolCrossfilter(topo);
        }
      }


      function applyPolCrossfilter(topo) {
        //******Add filter to crossfilter
        topo.keys.forEach(function(key) {
          var tmpCond = [];
          topo.condition.forEach(function(cond) {
            var i = cond.indexOf("-") + 1;
            var j = cond.lastIndexOf("-");
            if (cond.slice(i,j) == key) {
              tmpCond.push(cond.slice(j + 1).replace(/_/g, " "));
            }
          });
          if (tmpCond.length > 0) {
            topo.filter[key].filterFunction(function(d) { 
              var tmpBi = 0;
              tmpCond.forEach(function(cond) {
                if (d == cond) {tmpBi = 1;}
              });
              return tmpBi;
            });
          }
          else {
            topo.filter[key].filterAll();
          }
        });

        //*******Filter map by applied filters
        checkLink("featureid", topo, true);
      }



      function removeCondition(topo, tmpID, tmpClass, tmpArea) {
        topo.condition.splice(topo.condition.indexOf(tmpID), 1);
        d3.select("#" + tmpID).remove();
        applyPolCrossfilter(topo);
        if (d3.select("#typePolFilterSelect").node().value == tmpArea) {
          d3.select("#typePolFilterSelect").property("selectedIndex", function() {return 0;});
        }
      }




      function addFilterLayers(tmpLayers) {
        d3.select("#layerFilterCell")
          .append("div")
          .attr("id", "layerFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Layer");

        var select = d3.select("#layerFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "layerFilterSelect")
          .property("title", "Select layer to use its attributes as options in the adjacent 'Attribute' selection box") 
          .on("change", function() { addFilterSelect(topos[this.value]); });

        select.selectAll("option")
          .data(tmpLayers)
          .enter()
            .append("option")
              .attr("value", function (d, i) { return tmpLayers[i]; })
              .text(function (d, i) { return tmpLayers[i].charAt(0).toUpperCase() + tmpLayers[i].slice(1); });

        //******Add attribute selection box
        d3.select("#attributeFilterCell")
          .append("div")
          .attr("id", "attributeFilterCellDiv")
          .attr("class", "cellDiv")
          .append("h5")
          .attr("class", "filterTitle")
          .text("Attribute");

        var select = d3.select("#attributeFilterCellDiv")
          .append("select")
          .attr("class", "filterAttrList")
          .attr("id", "attributeFilterSelect")
          .style("width", "182px");

        //******Initialise with first layer
        addFilterSelect(topos[tmpLayers[0]]);

        //******Add values to totals portion of charts window
        tmpLayers.forEach(function(d) {
          var topo = topos[d];
          d3.select("#totals")
            .append("div")
            .attr("class", "hoverDiv")
            .property("title", "The number of " + topo.class + " currently selected out of the total number of " + topo.class)
            .html(topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ' selected: ' + '<b><span id="active-' + topo.class + '">' + topo.filter.all.value() + '</span></b> of <b><span id="total">' + topo.filter.all.value() + '</span></b>'); ;
        });
      }
        



      function addFilterSelect(topo) {
        var select = d3.select("#attributeFilterSelect")
          .attr("data-layer", topo.class)
          .property("title", "Select an attribute to display an interactive graph containing the frequency of its values")
          .on("change", function() { addFilter(this.value, topos[this.dataset.layer]); });

        var optData = topo.keys.filter(function(key) { return topo.display[key] == "yes"; });

        optData.splice(0,0, "...");
        topo.title["..."] = "...";
        topo.tooltip["..."] = "Select an attribute to display an interactive graph containing the frequency of its values";

        var options = select.selectAll("option")
          .data(optData);
       
        options.exit().remove();
        options.enter()
          .append("option");
        options
          .attr("value", function (d, i) { return optData[i]; })
          .text(function (d, i) { return topo.title[optData[i]]; });

        //******Set selected index to 0
        d3.select("#attributeFilterSelect")
          .property("selectedIndex", function() {return 0;})
          .property("title", topo.tooltip["..."]);
      }






      function addLegend(topo) {
        d3.select("#legendDiv")
          .append("div")
          .attr("id", topo.class + "Legend")
          .style("margin-bottom", "10px");

        d3.select("#" + topo.class + "Legend")
          .append("hr")
          .attr("class", "hr");

        d3.select("#" + topo.class + "Legend")
          .append("h5")
          .text(topo.class.charAt(0).toUpperCase() + topo.class.slice(1))
          .attr("id", "legHead" + topo.class)
          .attr("class", "layerTitle");

        d3.select("#" + topo.class + "Legend")
          .append("input")
          .attr({type: "range", name: topo.class + "Opacity", min: 0, max: 100, value: 100})
          .attr("id", topo.class + "Slider")
          .property("title", topo.class + " opacity: 100%")
          .style("margin-left", 87 - d3.select("#legHead" + topo.class).property("offsetWidth") + "px")
          .on("input", function() {
            var tmpOpacity = this.value/100; 
            d3.select("#" + topo.class + "Slider").attr("value", this.value);
            var tmpData = topo.filter.featureid.top(Infinity);
            var tmpID = tmpData.map(function(d) {return d.featureid;});
            topo.g.selectAll("." + topo.class).style("opacity", function(d) {
              if(tmpID.indexOf(d.properties.featureid) > -1) {
                return tmpOpacity;
              }
              else {
                return 0;
              }
            });
            this.title = "Opacity: " + this.value + "%"; 
          });

        var select = d3.select("#" + topo.class + "Legend")
          .append("select")
          .attr("class", "legAttrList")
          .attr("id", topo.class + "Select")
          .style("width", "182px")
          .on("change", function () { changeStyle(this.value, topo); });

        var optData = topo.keys.filter(function(key) { return topo.display[key] == "yes"; });

        select.selectAll("option")
          .data(optData)
          .enter().append("option")
          .attr("value", function (d, i) { return optData[i]; })
          .text(function (d, i) { return topo.title[optData[i]]; });
      }







      //*****Reposition the SVG to cover the features.
      function reset() {
        path.pointRadius(3.5 + (((map.getZoom()/10) - 1) * 4));
        
        //******Set bounds (using Deerfield HUC 8 bounds)
        var bottomLeft = projectPoint(bounds[0]);
        var topRight = projectPoint(bounds[1]);
          
        topoSVG.attr('width', topRight[0] - bottomLeft[0])
          .attr('height', bottomLeft[1] - topRight[1])
          .style('margin-left', bottomLeft[0] + 'px')
          .style('margin-top', topRight[1] + 'px');

        var translation = -bottomLeft[0] + ',' + -topRight[1];

        //******Select all layer g elements
        var tmpG = topoSVG.selectAll("g");

        //******Loop through each g element and transform the path
        tmpG[0].forEach(function(g) {
          var curG = d3.select(g);
          var feature = curG.selectAll("path");
          curG.attr('transform', 'translate(' + -bottomLeft[0] + ',' + -topRight[1] + ')');
          feature.attr("d", path);
          feature.style("stroke-width", (map.getZoom()/2)-1 + "px");
        });  
      }






      //******Use Leaflet to implement a D3 geometric transformation.
      function projectPoint(x) {
        var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
        return [point.x, point.y];
      }






      //******Change number strings to values
      function strToNum(tmpData) {
        var tmpKeys = d3.keys(tmpData[0]);

        var tmpCov = tmpData.map(function(d) {
          var tmpJSON = {};
          var tmpVals = d3.values(d);
          tmpVals.forEach(function(val,i){ 
            if (val == "NA") {
              tmpJSON[tmpKeys[i]] = -9999;
            }
            else if (isNaN(val) == false) {
              tmpJSON[tmpKeys[i]] = +d[tmpKeys[i]];
            }
            else {
              if (val.indexOf("/") > -1) {
                tmpJSON[tmpKeys[i]] = Date.parse(val);
              }
              else { 
                tmpJSON[tmpKeys[i]] = d[tmpKeys[i]];
              }
            }
          });
          return tmpJSON;
        });
        return tmpCov
      }



      //******Transform TSV strings to values if appropriate and add to topojson
      function readTSV(tmpData, topo) {
        //******Get keys and values from TSV data and fill out covariate data type
        var tmpKeys = d3.keys(tmpData[0]);
        var tmpVals = d3.values(tmpData[0]);

        tmpVals.forEach(function(val,i){
          if (isNaN(val) == false || val == "NA") {
            topo.covType[tmpKeys[i]] = "number";
          }
          else {
            topo.covType[tmpKeys[i]] = "string";
          }
        });

        //******Change TSV attribute strings to values if appropriate
        var tmpCov = strToNum(tmpData);

        //*******Map TSV to ID_key attribute (in this case either unique_id (crossings, streams) or featureid (catchments)
        var tmpMap = d3.map(tmpCov, function(d) {return d[topo.uniqueID];});

        //*******Add TSV data to topojson
        topo.features.forEach(function(d) { 
          try {
            tmpKeys.forEach(function(key) {
                d.properties[key] = tmpMap.get(d.id)[key];
            });
          }
          catch(err) { 
            console.log("No TSV data for id " + d.id);
          }
        });

        return tmpCov;
      }





      //*******Make crossfilter dimensions and grouped dimensions
      function cfDimension(topo, covariates) {
        //******Assign crossing covariates to a crossfilter variable

        var tmpCF = crossfilter(covariates);
        topo.filter.all = tmpCF.groupAll();
        topo.binWidth = {};
        var lowKey = 0;

        //******Dimension and group each covariate
        topo.keys.forEach(function(key, i) {
          topo.filter[key] = tmpCF.dimension(function(d) { return d[key]; } );
          if (topo.covType[key] == "number") {
            var tmpTop = topo.filter[key].top(1);
            var tmpBot = topo.filter[key].bottom(Infinity);
            for (var i = 0; i < tmpBot.length; i++) {
              if (tmpBot[i][key] > -9999) {
                lowKey = i;
                break;
              }
            }
            topo.minVal[key] = tmpBot[lowKey][key];
            topo.maxVal[key] = tmpTop[0][key];

            var divVal = (tmpTop[0][key] - tmpBot[lowKey][key]) / 40;
            topo.binWidth[key] = divVal;
            topo.filter[key + "s"] = topo.filter[key].group(function(d) {return Math.floor(d / divVal) * divVal;});

            topo.minClip[key] = topo.filter[key + "s"].all()[0].key;
            if (topo.minClip[key] <= -9998) {
              topo.minClip[key] = topo.filter[key + "s"].all()[1].key;
            }
            topo.maxClip[key] = topo.filter[key + "s"].all()[topo.filter[key + "s"].size() - 1].key + topo.binWidth[key];
          }
          else {
            topo.filter[key + "s"] = topo.filter[key].group();
          }
        });
       }






      //*******Show crossings attribute in tooltip
      function showIt(tmpID) {
        tooltip.text(tmpID);
        tooltip.style("visibility", "visible");
        tooltip.property("title", tmpID);
      }




      //*******Transform data
      function transformData(scale, data, tmpMax) {
        switch(scale) {
          case "linear":
            var normVals = data.map(function(d) { return d; });
            break;
          case "log":
            var normVals = data.map(function(d) { return Math.log(d + 0.1); });
            break;
          case "log_rec":
            var normVals = data.map(function(d) { return -(Math.log((tmpMax + 0.1) - d)); });
            break
          case "categorical":
            var normVals = data.map(function(d) { return d; });
            break;
        }

        return normVals;
      }





      //*******Back Transform data
      function backTransformData(scale, data, tmpMax) {
        switch(scale) {
          case "linear":
            var normVals = data.map(function(d) { return d; });
            break;
          case "log":
            var normVals = data.map(function(d) { return Math.exp(d) - 0.1; });
            break;
          case "log_rec":
            var normVals = data.map(function(d) { return tmpMax + 0.1 - Math.exp(-d); });
            break
          case "categorical":
            var normVals = data.map(function(d) { return d; });
            break;
        }

        return normVals;
      }





      //*******Change feature styles
      function changeStyle(tmpAtt, topo) {
        //*******Change tooltip text for select
        //d3.select("#" + topo.class + "Select").property("title", topo.tooltip[tmpAtt]);

        //*******Select features
        var curG = d3.select(topo.g[0][0]);
        var tmpFeat = curG.selectAll("." + topo.class);

        tmpFeat.style({"stroke": function(d) {return topo.color[d.id.replace(/ /g, "_")];}, "stroke-width": (map.getZoom()/2)-1 + "px", "fill": function(d) {return topo.color[d.id.replace(/ /g, "_")];}} );
        tmpFeat.attr("id", function(d) {return d.id;});
/*
        //*******Get data for passed in attribute
        var tmpVals = d3.values(topo.features).map(function(d) { return d.properties[tmpAtt]; });

        //*Filter out "NA" data
        tmpVals = tmpVals.filter(function(val) {if(val > -9999){return true} else {return false};});

        //*******Normalise scale
        var maxVal = d3.max(tmpVals);
        var normVals = transformData(topo.scale[tmpAtt], tmpVals, maxVal);
  
        var tmpSet = d3.set(normVals);
        var tmpMin = d3.min([6, tmpSet.size()])

        //*******Make a color scale
        var colorArray = colorbrewer[topo.color][tmpMin].slice(0);
        if (topo.direction[tmpAtt] == "reverse") {
          colorArray.reverse();
        }
          
        var newColor = d3.scale.quantize()
          .domain([d3.min(normVals), d3.max(normVals)])
          .range(colorArray);

        //*******Style and label crossings by attribute value
        if (topo.class == "streams") {
          tmpFeat.style("stroke", function(d) {
            if (d.properties[tmpAtt] > -9999) { //return newColor(d.properties[tmpAtt]); }
              var tVal = transformData(topo.scale[tmpAtt], [d.properties[tmpAtt]], maxVal);
              return newColor(tVal[0])
            }
            else {return "gray"}; 
          });
        }
        else {
          tmpFeat.style("fill", function(d) {
            if (d.properties[tmpAtt] > -9999) { //return newColor(d.properties[tmpAtt]); }
              var tVal = transformData(topo.scale[tmpAtt], [d.properties[tmpAtt]], maxVal);
              return newColor(tVal[0])
            }
            else {return "gray"}; 
          });
        }

        tmpFeat.attr("id", function(d) { 
          if(d.properties[tmpAtt] > -9999) {
            switch(topo.data_type[tmpAtt]) {
              case "decimal":
                return (topo.title[tmpAtt] + ": " + d.properties[tmpAtt].toFixed(2) + " " + topo.unit[tmpAtt]);
                break;
              case "integer":
                return (topo.title[tmpAtt] + ": " + d.properties[tmpAtt] + " " + topo.unit[tmpAtt]);
                break;
              case "date":
                var formatDate = d3.time.format("%-m/%-d/%Y");
                return (topo.title[tmpAtt] + ": " + formatDate(new Date(d.properties[tmpAtt])));
                break;
              case "text":
                return (topo.title[tmpAtt] + ": " + topo.conversion[tmpAtt][d.properties[tmpAtt]]);
                break;
            }
          }
          else {
            return (topo.title[tmpAtt] + ": No Data");
          }
        })

        //*******Make a legend
        var list = d3.select("#" + topo.class + "-list-inline");
        list.remove();

        var legend = d3.select("#" + topo.class + "Legend")
         .append("ul")
         .attr("id", topo.class + "-list-inline")
         .attr("class", "legend-colors")
         .property("title", topo.tooltip[tmpAtt]);

        var keys = legend.selectAll("li.key")
          .data(newColor.range());

        keys.enter().append("li")
          .attr("class", "key")
          .style("border-top-color", String)
          .text(function(d, i) {
            var r = newColor.invertExtent(d);
            tmpR = backTransformData(topo.scale[tmpAtt], r, topo.max[tmpAtt]);
            switch(topo.data_type[tmpAtt]) {
              case "decimal":
                return tmpR[0].toFixed(2);
                break;
              case "integer":
                return tmpR[0].toFixed(1);
                break;
              case "date":
                var tmpDate = new Date(tmpR[0]);
                var shortDate = d3.time.format("%-m/%Y");
                return shortDate(tmpDate);
                break;
              case "text":
                return topo.conversion[tmpAtt][i+1];
                break;
            }
          });
*/
       }






      //*******Add crossfilter histogram
      function addFilter(tmpKey, topo) {
        //*******Change tooltip text for select
        d3.select("#attributeFilterSelect").property("title", topo.tooltip[tmpKey]);

        if (graphs.indexOf(topo.class + "-" + tmpKey) > -1 || tmpKey == "...") {
          return;
        }
        else {
          graphs.push(topo.class + "-" + tmpKey);
        }

        //******Define graph attributes
        var margin = {top: 10, right: 10, bottom: 20, left: 10},
          width = 380 - margin.left - margin.right,
          height = 100 - margin.top - margin.bottom;

        var x = d3.scale.linear().rangeRound([0, width]);
        var y = d3.scale.linear()
          .range([height, 0]);

        var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

        //**Format ticks for special data types
        switch(topo.data_type[tmpKey]) {
          case "date":
            xAxis.tickFormat(function(d) { var tmpDate = d3.time.format("%-m/%Y"); return tmpDate(new Date(d)); });
            xAxis.ticks(5);
            break;
          case "text":
            xAxis.tickFormat(function(d) { if (isNaN(topo.conversion[tmpKey][d])) {return d + " (" + topo.conversion[tmpKey][d] + ")";} else {return topo.conversion[tmpKey][d];} });
            xAxis.ticks(Object.keys(topo.conversion[tmpKey]).length - 1);
            break;
          default:
            var twoDec = d3.format(".2f");
            switch(topo.scale[tmpKey]) {
              case "log":
                xAxis.tickFormat(function(d) { return twoDec(Math.exp(d)); });
                xAxis.ticks(5);
                break;
              case "log_rec":
                xAxis.tickFormat(function(d) { return twoDec(topo.max[tmpKey] - Math.exp(-d)); });
                xAxis.ticks(5);
                break;
              default:
                xAxis.tickFormat(function(d) { return twoDec(d); });
                xAxis.ticks(5);
            }
        }


        //******Add brush
        brush[topo.class][tmpKey] = d3.svg.brush()
          .x(x)
          .on("brushstart", function() { brushStart(tmpKey, topo); })
          .on("brush", function() { brushMove(tmpKey, topo); })
          .on("brushend", function() { brushEnd(tmpKey, topo); });


        //******Add chart div, title div, and reset option
        d3.select("#charts")
          .append("div")
            .attr("class", "chart")
            .attr("id", topo.class + "-" + tmpKey)
            .property("title", "Click and drag inside chart to select data")
          .append("div")
            .attr("class", "title")
            .attr("id", "title-" + topo.class + "-" + tmpKey)
            .style("margin-left", "2px")
            .property("title", topo.tooltip[tmpKey])
            .text(topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ": " + topo.title[tmpKey])
          .append("a")
            .attr("class", "reset")
            .attr("id", "reset-" + topo.class + "-" + tmpKey)
            .text("reset")
            .style("display", "none")
            .property("title", "Click to clear selection box from chart")
            .on("click", function() { brushReset(tmpKey, topo); });


        //******Add remove button
        d3.select("#title-" + topo.class + "-" + tmpKey)
          .append("div")
            .attr("class", "btn btn-default btn-xs pull-right")
            .attr("id", topo.class + "-" + tmpKey)
            .text("x")
            .property("title", "Click to remove chart for " + topo.class.charAt(0).toUpperCase() + topo.class.slice(1) + ": " + topo.title[tmpKey])
            .on("click", function() { removeFilter(this.id, topo); });


        //******Add stats div and extent
        d3.select("#" + topo.class + "-" + tmpKey)
          .append("div")
            .attr("class", "stats")
            .attr("id", "stats-" + topo.class + "-" + tmpKey);

        var statsDiv = d3.select("#stats-" + topo.class + "-" + tmpKey);

        statsDiv.append("input")
          .attr({type: function() {if(topo.data_type[tmpKey] == "date") {return "text";} else { return "number"}} })
          .attr("class", "extent-input")
          .attr("id", "extent-input-lower-" + topo.class + "-" + tmpKey)
          .property("title", "Lower value for selected range of " + topo.title[tmpKey] + " distribution");

        statsDiv.append("p")
          .attr("class", "extent-input-p")
          .text("-");

        statsDiv.append("input")
          .attr({type: function() {if(topo.data_type[tmpKey] == "date") {return "text";} else { return "number"}} })
          .attr("class", "extent-input")
          .attr("id", "extent-input-upper-" + topo.class + "-" + tmpKey)
          .property("title", "Upper value for selected range of " + topo.title[tmpKey] + " distribution");


        //******Add mean to stats div
        d3.select("#stats-" + topo.class + "-" + tmpKey)
          .append("span")
            .attr("class", "mean pull-right")
            .attr("id", "mean-" + topo.class + "-" + tmpKey)
            .property("title", "Average of selected values");


        //******Add svg
        var svg = d3.select("#" + topo.class + "-" + tmpKey)
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("id", "svg-" + topo.class + "-" + tmpKey)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .attr("id", "g-" + topo.class + "-" + tmpKey);

        //******Add clip path rectangle
        svg.append("clipPath")
          .attr("id", "clip-" + topo.class + "-" + tmpKey)
          .append("rect")
            .attr("width", width)
            .attr("height", height);

        //******Get data and make graph
        var tmpData = topo.filter[tmpKey + "s"].all();

        var lowKey = 0;
        if (tmpData[0].key < -9998) {
          lowKey = 1;
        }

        x.domain([tmpData[lowKey].key, tmpData[tmpData.length - 1].key + topo.binWidth[tmpKey]]);
        y.domain([0, d3.max(tmpData, function(d) { if ( d.key > -9999) { return d.value; } })]);

        var tmpX = svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        if (topo.data_type[tmpKey] == "text") {
          tmpX.select("text").style("text-anchor", "start");
        }

        var tmpData = topo.filter[tmpKey + "s"].all();
        hist[topo.class][tmpKey] = {"x": x, "y": y, "height": height, "width": width};
      
        //******Add background bars
        svg.selectAll("background.bar")
            .data(tmpData)
          .enter().append("rect")
            .attr("class", "background bar")
            .attr("x", function(d) { return x(d.key); })
            .attr("width", (x.range()[1] - x.range()[0])/40)  
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });

        //******Add foreground bars
        svg.selectAll(".foreground.bar")
            .data(tmpData)
          .enter().append("rect")
            .attr("class", "foreground bar")
            .attr("x", function(d) { return x(d.key); })
            .attr("width", (x.range()[1] - x.range()[0])/40)  
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });

        svg.selectAll(".foreground.bar")
          .attr("clip-path", "url(#clip-" + topo.class + "-" + tmpKey + ")");
      
        var gBrush = svg.append("g")
          .attr("class", "brush")
          .attr("id", "brush-" + topo.class + "-" + tmpKey)
          .call(brush[topo.class][tmpKey]);

        gBrush.selectAll("rect").attr("height", height);
        gBrush.selectAll(".resize").append("path").attr("d", resizePath);

        //******* Set upper and lower brush properties
        var inpMin = backTransformData(topo.scale[tmpKey], [topo.minClip[tmpKey]], topo.max[tmpKey]);
        var inpMax = backTransformData(topo.scale[tmpKey], [topo.maxClip[tmpKey] + topo.binWidth[tmpKey]], topo.max[tmpKey]);

        var tmpLower = d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey)
          .property("min", Math.floor(inpMin*100)/100)
          .property("max", Math.ceil(inpMax*100)/100)
          .property("step", Math.round((inpMax - inpMin))/100);

        var tmpUpper = d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey)
          .property("min", Math.floor(inpMin*100)/100)
          .property("max", Math.ceil(inpMax*100)/100)
          .property("step", Math.round((inpMax - inpMin))/100);

        d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).on("change", function () {extentChange(tmpKey, topo, tmpLower, tmpUpper); });
        d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).on("change", function () {extentChange(tmpKey, topo, tmpLower, tmpUpper); });      

        brushReset(tmpKey, topo);

        function resizePath(d) {
          var e = +(d == "e"),
            x = e ? 1 : -1,
            y = height / 3;
          return "M" + (0.5 * x) + "," + y + "A6,6 0 0 " + e + " " + (6.5 * x) + "," + (y + 6) + "V" + (2 * y - 6) + "A6,6 0 0 " + e + " " + (0.5 * x) + "," + (2 * y) + "Z" + "M" + (2.5 * x) + "," + (y + 8) + "V" + (2 * y - 8) + "M" + (4.5 * x) + "," + (y + 8) + "V" + (2 * y - 8);
        }

      }








      //******Remove graph from window
      function removeFilter(class_key, topo) {
        var dash = class_key.indexOf("-");
        var tmpClass = class_key.slice(0, dash);
        var key = class_key.slice(dash + 1, class_key.length);

        graphs.splice(graphs.indexOf(class_key), 1);
        brushReset(key, topo);
        var select = d3.select("#" + class_key);
        select.remove();

        //******If select dropdown is this attribute change back to ...
        if (d3.select("#attributeFilterSelect").node().value == key) {
          d3.select("#attributeFilterSelect").property("selectedIndex", function() {return 0;})
        }
      }





      function extentChange(tmpKey, topo, tmpLower, tmpUpper) {
        if (topo.data_type[tmpKey] == "date") {         
          var valLow = Date.parse(tmpLower.property("value"));
          var valHigh = Date.parse(tmpUpper.property("value"));
        }
        else {
          var valLow = parseFloat(tmpLower.property("value"));
          var valHigh = parseFloat(tmpUpper.property("value"));
        }

        if (valLow > valHigh) {
          var tmpHold = tmpUpper.property("value");
          tmpUpper.property("value", tmpLower.property("value"));
          tmpLower.property("value", tmpHold);
          tmpHold = valHigh;
          valHigh = valLow;
          valLow = tmpHold;
        }

        var inpMin = transformData(topo.scale[tmpKey], [valLow], topo.max[tmpKey])[0];
        var inpMax = transformData(topo.scale[tmpKey], [valHigh], topo.max[tmpKey])[0];

        d3.select("#brush-" + topo.class + "-" + tmpKey).call(brush[topo.class][tmpKey].extent([inpMin, inpMax]));
        brushEnd(tmpKey, topo);
      }


      function brushStart(tmpKey, topo) {
       topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);
       checkLink(tmpKey, topo, false);
      }


      function brushMove(tmpKey, topo) {
        topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);
        checkLink(tmpKey, topo, false);
      }


      function brushEnd(tmpKey, topo) {
        topo.filter[tmpKey].filterRange([brush[topo.class][tmpKey].extent()[0], brush[topo.class][tmpKey].extent()[1]]);       
        checkLink(tmpKey, topo, false);
        d3.select("#reset-" + topo.class + "-" + tmpKey).style("display", "inline-block");
      }


      function brushReset(tmpKey, topo) {
        d3.select("#brush-" + topo.class + "-" + tmpKey).call(brush[topo.class][tmpKey].clear());
        topo.filter[tmpKey].filterAll();
        checkLink(tmpKey, topo, false);
        d3.select("#reset-" + topo.class + "-" + tmpKey).style("display", "none");
      }


      function filterMap(tmpKey, topo, isLink) {
        var tmpSubset = topo.filter[topo.uniqueID].top(Infinity);
        var tmpID = tmpSubset.map(function(d) {return d[topo.uniqueID];});
        var tmpData = d3.selectAll("." + topo.class).data();
        var tmpSel = d3.selectAll("." + topo.class);
        tmpSel.style("opacity", function(d, i) { 
          if (tmpID.indexOf(tmpData[i].properties[topo.uniqueID]) > -1) {
            return d3.select("#" + topo.class + "Slider").attr("value")/100;
          }
          else {
            return 0;
          }
        });

        //******Update crossings selected
        d3.select("#active-" + topo.class).html(topo.filter.all.value());

        //******Update filter range (if isLink == false)
        if (isLink == false) {
          if (brush[topo.class][tmpKey].empty() && topo.filter.all.value() > 0) {
            setInputs(topo, tmpKey, topo.minVal[tmpKey], topo.maxVal[tmpKey], topo.minClip[tmpKey], topo.maxClip[tmpKey]);
          }
          else {
            var extMin = brush[topo.class][tmpKey].extent()[0]
            var extMax = brush[topo.class][tmpKey].extent()[1]
            setInputs(topo, tmpKey, extMin, extMax, extMin, extMax);
          }
        }

        updateStats(tmpKey, topo);

        updateHistogram(tmpKey, topo);
      }



      //******Set lower and upper input values and adjust clip path
      function setInputs(topo, tmpKey, tmpMin, tmpMax, clipMin, clipMax) {
        var inpMin = backTransformData(topo.scale[tmpKey], [clipMin], topo.max[tmpKey])[0];
        var inpMax = Math.ceil(backTransformData(topo.scale[tmpKey], [clipMax], topo.max[tmpKey])[0]*100)/100;

        if (topo.data_type[tmpKey] == "date") {
          var tmpFormat = d3.time.format("%m/%d/%Y");
          d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).property("value", tmpFormat(new Date(inpMin)));
          d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).property("value", tmpFormat(new Date(inpMax)));
        }
        else {
          d3.select("#extent-input-lower-" + topo.class + "-" + tmpKey).property("value", Math.round(inpMin*100)/100);
          d3.select("#extent-input-upper-" + topo.class + "-" + tmpKey).property("value", Math.round(inpMax*100)/100);
        }

        d3.select("#clip-" + topo.class + "-" + tmpKey + " rect")
          .attr("x", hist[topo.class][tmpKey].x(clipMin))
          .attr("width", hist[topo.class][tmpKey].x(clipMax) - hist[topo.class][tmpKey].x(clipMin));
      }





      //******Set featureid according to which layers are linked and political filters
      function checkLink(tmpKey, topo, isLink) {
        //******Return array of layers that are linked and share featureIDs 
        var linkLayers, IDS = getLinkIDs();

        //******Filter the map based on common featureids
        layers.forEach(function(layer) {
          if (isLink == false && layer == topo.class) {
            filterMap(tmpKey, topos[layer], false);
          }
          else {
            filterMap("featureid", topos[layer], true);
          }
        });
      }




      //******Determine linked layers
      function getLinkIDs() {
        var linkLayers = [];

        layers.forEach(function(layer1, i) {
          layers.forEach(function(layer2, j) {
            if (j > i) {
              topos[layer1].filter.featureid.filterAll();
              topos[layer2].filter.featureid.filterAll();

              if (d3.select("#" + layer1 + "-" + layer2 + "-check").property("checked") == true) {
                if (linkLayers.indexOf(layer1) == -1) {
                  linkLayers.push(layer1);
                }
                if (linkLayers.indexOf(layer2) == -1) {
                  linkLayers.push(layer2);
                }
              }
            }
          });
        });

        var IDs = [];
        linkLayers.forEach(function(layer1, i) {
          var tmpSubset = topos[layer1].filter.featureid.top(Infinity);
          var tmpID1 = tmpSubset.map(function(d) {return d["featureid"];});
          linkLayers.forEach(function(layer2, j) {
            if (j > i) {
              var tmpSubset2 = topos[layer2].filter.featureid.top(Infinity);
              var tmpID2 = tmpSubset2.map(function(d) {return d["featureid"];});
              if (IDs.length == 0 && i == 0) {
                IDs = tmpID1.filter(function(val) {
                  return tmpID2.indexOf(val) != -1;
                });
              }
              else {
                var IDsFilter = IDs.filter(function(val) {
                  return (tmpID1.indexOf(val) != -1 && tmpID2.indexOf(val) != -1);
                });
                IDs = IDsFilter;
              }
            }
          });
        });

        linkLayers.forEach(function(layer) {
          topos[layer].filter.featureid.filterFunction(function(d) { 
            return IDs.indexOf(d) != -1;
          });
        });

        //******Filter by political IDs
        var polSubset = topos.political.filter.featureid.top(Infinity);
        var polIDs = polSubset.map(function(d) {return d["featureid"];});
        layers.forEach(function(layer) {
          topos[layer].filter.featureid.filterFunction(function(d) {
            if(linkLayers.indexOf(layer) == -1) { 
              return polIDs.indexOf(d) != -1;
            }
            else {
              return (polIDs.indexOf(d) != -1 && IDs.indexOf(d) != -1);
            }
          });
        });

        return linkLayers, IDs;
      }



      
      //******Update filter statistics
      function updateStats(tmpKey, topo) {
        //******Update filter mean
        graphs.forEach(function(class_key) {
          var dash = class_key.indexOf("-");
          var tmpClass = class_key.slice(0, dash);
          var key = class_key.slice(dash + 1, class_key.length);

          if (class_key.indexOf(topo.class) > -1) {
            if (topo.filter["all"].value() > 0 ) {
              if (topo.data_type[key] == "date") {
                var tmpFormat = d3.time.format("%-m/%-d/%Y")
                d3.select("#mean-" + class_key).html("Mean: " + tmpFormat(new Date(d3.mean(topo.filter[key].top(Infinity), function(d) { if (d[key] > -9999) {return d[key];} }))));
              }
              else {
                d3.select("#mean-" + class_key).html("Mean: " + d3.mean(topo.filter[key].top(Infinity), function(d) { if (d[key] > -9999) {return d[key];} }).toFixed(2));
              }

              if (brush[tmpClass][key].empty()) {
                setInputs(topo, key, topo.minVal[key], topo.maxVal[key], topo.minClip[key], topo.maxClip[key]);
              }
              else {
                setInputs(topo, key, brush[tmpClass][key].extent()[0], brush[tmpClass][key].extent()[1], brush[tmpClass][key].extent()[0], brush[tmpClass][key].extent()[1]);
              }
            }
            else {
              if (topo.data_type[key] == "date") {
                d3.select("#mean-" + class_key).html("Mean: 0/0/0000");
              }
              else {
                d3.select("#mean-" + class_key).html("Mean: 0.00");
              }
            }
          }  
        });
      }




      //******Update filter histogram based on current brush
      function updateHistogram(tmpKey, topo) {
        graphs.forEach(function(class_key) {
          var dash = class_key.indexOf("-");
          var tmpClass = class_key.slice(0, dash);
          var key = class_key.slice(dash + 1, class_key.length);

          if (class_key.indexOf(topo.class) > -1) { 
            if (class_key != topo.class + "-" + tmpKey) {
              redrawHist(key, topo);
            }
          }
        });
      }

      //******Redraw the histogram
      function redrawHist(key, topo) {
        //******If brush is present, remove it and get featureID's, then add it back
        if (!brush[topo.class][key].empty()) {
          topo.filter[key].filterAll();
          var linkLayers, IDs = getLinkIDs();
          var tmpData = JSON.parse(JSON.stringify(topo.filter[key + "s"].all()));
          topo.filter[key].filterRange([brush[topo.class][key].extent()[0], brush[topo.class][key].extent()[1]]);
          var linkLayers, IDs = getLinkIDs();
        }
        else {
          var tmpData = topo.filter[key + "s"].all();
        }

        var svg = d3.select("#g-" + topo.class + "-" + key);
        var x = hist[topo.class][key].x;
        var y = hist[topo.class][key].y;
        var height = hist[topo.class][key].height;
        var width = hist[topo.class][key].width;
        y.domain([0, d3.max(tmpData, function(d) { if (d.key > -9999) { return d.value; } })]);

        //******update background bars
        var update = svg.selectAll(".background.bar")
          .data(tmpData);

        update.exit().remove();
        update.enter().insert("rect", ":first-child")
          .attr("class", "background bar");
        update
          .attr("x", function(d) { return x(d.key); })
          .attr("width", (x.range()[1] - x.range()[0])/40)  
          .attr("y", function(d) { return y(d.value); })
          .attr("height", function(d) { return height - y(d.value); });

        //******update foreground bars
        var update = svg.selectAll(".foreground.bar")
          .data(tmpData);

        update.exit().remove();
        update.enter().insert("rect", ":first-child")
          .attr("class", "foreground bar");
        update
          .attr("x", function(d) { return x(d.key); })
          .attr("width", (x.range()[1] - x.range()[0])/40)  
          .attr("y", function(d) { return y(d.value); })
          .attr("height", function(d) { return height - y(d.value); });
      }


    </script>
  </body>
</html>